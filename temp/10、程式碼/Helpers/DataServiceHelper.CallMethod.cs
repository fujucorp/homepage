using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;

using Fuju;
using Fuju.DB;
using Fuju.DB.Data;
using Fuju.Web.Services;

using Entities;

namespace Helpers
{
    #region CallMethod Name Const
    public abstract class CallMethodName
    {
        /// <summary>
        /// 複製代收費用別
        /// </summary>
        public const string CopyDep = "CopyDep";
        public const string CopyReceive = "CopyReceive";
        public const string CopyCollege = "CopyCollege";
        public const string CopyMajor = "CopyMajor";
        public const string CopyClass = "CopyClass";
        public const string CopyReduce = "CopyReduce";
        public const string CopyDorm = "CopyDorm";
        public const string CopyIdentify = "CopyIdentify";
        public const string CopyLoan = "CopyLoan";
        public const string CopyReturn = "CopyReturn";
        public const string RenewGroupRight = "RenewGroupRight";
        public const string CopyMappingXlsData = "CopyMappingXlsData";
        public const string CopyMappingTxtData = "CopyMappingTxtData";
        public const string UpdateCancelDatas = "UpdateCancelDatas";

        #region [MDY:20160125] 整批刪除學生資料
        /// <summary>
        /// 整批刪除學生資料 (勾選的資料)
        /// </summary>
        public const string DeleteStudentReceiveByPKeys = "DeleteStudentReceiveByPKeys";
        /// <summary>
        /// 整批刪除學生資料 (條件的資料)
        /// </summary>
        public const string DeleteStudentReceiveByWhere = "DeleteStudentReceiveByWhere";
        #endregion

        public const string DeleteProblemListDatas = "DeleteProblemListDatas";
        public const string UpdateStudentReturnDatas = "UpdateStudentReturnDatas";

        public const string CopyGeneralStandard = "CopyGeneralStandard";
        public const string CopyCredit2Standard = "CopyCredit2Standard";
        public const string CopyCreditStandard = "CopyCreditStandard";
        public const string CopyDormStandard = "CopyDormStandard";
        public const string CopyCreditbStandard = "CopyCreditbStandard";
        public const string CopyIdentifyStandard = "CopyIdentifyStandard";
        public const string CopyClassStandard = "CopyClassStandard";
        public const string CopyReduceStandard = "CopyReduceStandard";
        public const string CopyLoanStandard = "CopyLoanStandard";
        public const string CopyReturnStandard = "CopyReturnStandard";

        public const string DelDep = "DelDep";
        public const string DelReceive = "DelReceive";
        public const string DelCollege = "DelCollege";
        public const string DelMajor = "DelMajor";
        public const string DelClass = "DelClass";
        public const string DelReduce = "DelReduce";
        public const string DelDorm = "DelDorm";
        public const string DelIdentify = "DelIdentify";
        public const string DelLoan = "DelLoan";
        public const string DelReturn = "DelReturn";

        public const string DelGeneralStandard = "DelGeneralStandard";
        public const string DelCredit2Standard = "DelCredit2Standard";
        public const string DelCreditStandard = "DelCreditStandard";
        public const string DelDormStandard = "DelDormStandard";
        public const string DelCreditbStandard = "DelCreditbStandard";
        public const string DelIdentifyStandard = "DelIdentifyStandard";
        public const string DelClassStandard = "DelClassStandard";
        public const string DelReduceStandard = "DelReduceStandard";
        public const string DelLoanStandard = "DelLoanStandard";
        public const string DelReturnStandard = "DelReturnStandard";


        /// <summary>
        /// 複製基本資料
        /// </summary>
        public const string CopyBaseData = "CopyBaseData";

        /// <summary>
        /// 刪除基本資料
        /// </summary>
        public const string DeleteBaseData = "DeleteBaseData";


        /// <summary>
        /// 取得 S530001 (使用者管理) 頁面用的編輯資料
        /// </summary>
        public const string S530001GetEditData = "S530001GetEditData";
        /// <summary>
        /// 新增 S530001 (使用者管理) 頁面用的新增資料
        /// </summary>
        public const string S530001InsertData = "S530001InsertData";
        /// <summary>
        /// 更新 S530001 (使用者管理) 頁面用的修改資料
        /// </summary>
        public const string S530001UpdateData = "S530001UpdateData";
        /// <summary>
        /// 刪除 S530001 (使用者管理) 頁面用的刪除資料
        /// </summary>
        public const string S530001DeleteData = "S530001DeleteData";

        #region [Old] 取消放行
        ///// <summary>
        ///// 核可 S530001 (使用者管理) 頁面用的核可資料
        ///// </summary>
        //public const string S530001ApproveData = "S530001ApproveData";
        #endregion

        /// <summary>
        /// 整批刪除課程收費標準 Class_Standard
        /// </summary>
        public const string DeleteAllClassStandard = "DeleteAllClassStandard";


        /// <summary>
        /// 取得授權的商家代號 CodeText 清單
        /// </summary>
        public const string GetMyReceiveTypeCodeTexts = "GetMyReceiveTypeCodeTexts";

        #region [MDY:20220530] Checkmarx 調整
        /// <summary>
        /// 變更使用者密碼
        /// </summary>
        public const string ChangeUserPXX = "ChangeUserPXX";
        #endregion

        /// <summary>
        /// 新增批次處理佇列 For D15 類
        /// </summary>
        public const string InsertJobCubeForD15 = "InsertJobCubeForD15";

        /// <summary>
        /// 新增批次處理佇列 For PDF 類
        /// </summary>
        public const string InsertJobCubeForPDF = "InsertJobCubeForPDF";

        /// <summary>
        /// 新增批次處理佇列 For PDF 類
        /// </summary>
        public const string InsertJobCubeForPDFByAsync = "InsertJobCubeForPDFByAsync";

        /// <summary>
        /// 新增批次處理佇列 For D38 類
        /// </summary>
        public const string InsertJobCubeForD38 = "InsertJobCubeForD38";

        /// <summary>
        /// 執行 B2100002 特殊需求 (計算金額、產生PDF繳費單、產生PDF繳費收據)
        /// </summary>
        public const string ExecB2100002Request = "ExecB2100002Request";

        /// <summary>
        /// 取得 B2100002 (維護學生繳費資料) 合計資料
        /// </summary>
        public const string GetB2100002Summary = "GetB2100002Summary";

        /// <summary>
        /// 取得 C3700006 (中心入帳資料查詢) 合計資料
        /// </summary>
        public const string GetC3700006Summary = "GetC3700006Summary";

        /// <summary>
        /// 新增 B2300003 的資料 (產生Email繳費通知)
        /// </summary>
        public const string InsertB2300003Data = "InsertB2300003Data";

        /// <summary>
        /// 取得 C3400001 查詢結果 (每日銷帳結果查詢)
        /// </summary>
        public const string GetC3400001Result = "GetC3400001Result";

        /// <summary>
        /// 匯出 B2100005 的委扣檔案
        /// </summary>
        public const string ExportB2100005File = "ExportB2100005File";

        /// <summary>
        /// 匯入 B2100007 的委扣回復檔案
        /// </summary>
        public const string ImportB2100007File = "ImportB2100007File";

        /// <summary>
        /// 匯出 B2100003 學生繳費資料媒體檔 (下載銷帳資料也使用此方法)
        /// </summary>
        public const string ExportB2100003File = "ExportB2100003File";

        /// <summary>
        /// 匯出 C3700007 銷帳資料 (固定格式)
        /// </summary>
        public const string ExportC3700007File = "ExportC3700007File";

        /// <summary>
        /// 產生匯出資料檔
        /// </summary>
        public const string GenExportFileData = "GenExportFileData";

        /// <summary>
        /// 匯出繳費銷帳總表
        /// </summary>
        public const string ExportReportA = "ExportReportA";

        /// <summary>
        /// 匯出繳費銷帳總表
        /// </summary>
        public const string ExportReportA2 = "ExportReportA2";

        /// <summary>
        /// 匯出繳費銷帳明細表
        /// </summary>
        public const string ExportReportB = "ExportReportB";

        /// <summary>
        /// 匯出學生繳費名冊
        /// </summary>
        public const string ExportReportC = "ExportReportC";

        /// <summary>
        /// 匯出手續費統計報表
        /// </summary>
        public const string ExportReportD = "ExportReportD";


        /// <summary>
        /// 繳費收費項目
        /// </summary>
        public const string ExportReportE = "ExportReportE";

        /// <summary>
        /// 匯出查詢結果的 Excel 檔 (C3600001:查詢問題檔、C3700006:中心入帳資料查詢、S5400003:排程作業查詢)
        /// </summary>
        public const string ExportQueryResult = "ExportQueryResult";

        /// <summary>
        /// 取得 BankPM 的 TempFile
        /// </summary>
        public const string GetBankPMTempFile = "GetBankPMTempFile";

        #region [Old] 20150605 取消前擋後，改回後踢前
        ///// <summary>
        ///// 強迫登出指定帳號
        ///// </summary>
        //public const string ForcedLogoutUser = "ForcedLogoutUser";
        #endregion

        #region [Old] 土銀沒有
        ///// <summary>
        ///// 呼叫 N162 查詢電文
        ///// </summary>
        //public const string CallN162Request = "CallN162Request";
        #endregion

        /// <summary>
        /// 呼叫 D00I71
        /// </summary>
        public const string CallD00I71Request = "CallD00I71Request";

        /// <summary>
        /// 新增所有學年的 第一學期 第二學期
        /// </summary>
        public const string InsertTermListDatas = "InsertTermListDatas";

        /// <summary>
        /// 清除虛擬帳號
        /// </summary>
        public const string ClearCancelNo = "ClearCancelNo";


        /// <summary>
        /// 上傳中國信託繳費單資料
        /// </summary>
        public const string ImportQueueCTCBFile = "ImportQueueCTCBFile";

        /// <summary>
        /// 處理流程資料
        /// </summary>
        public const string ProcessFlowData = "ProcessFlowData";


        /// <summary>
        /// 取得 C3700009 所有選項陣列
        /// </summary>
        public const string GetC3700009AllOptions = "GetC3700009AllOptions";

        /// <summary>
        /// 上傳D00I70
        /// </summary>
        public const string ImportD00I70File = "ImportD00I70File";

        #region [MDY:20160321] 維護就貸資料
        /// <summary>
        /// 取得 C3700009 所有選項陣列
        /// </summary>
        public const string EditStudentLoanData = "EditStudentLoanData";
        #endregion

        #region [MDY:2018xxxx] 取得指定代碼資料表的資料選項陣列
        public const string GetCodeTableAllOptions = "GetCodeTableAllOptions";
        #endregion

        #region [MDY:2018xxxx] 取得指定代收費用檔、合計項目設定、學生基本資料、學生繳費單的資料
        public const string GetStudentBillDatas = "GetStudentBillDatas";
        #endregion

        #region [MDY:2018xxxx] 更新學生基本資料、學生繳費單的資料
        public const string UpdateStudentBillDatas = "UpdateStudentBillDatas";
        #endregion

        #region [MDY:20190226] 匯出異業代收款檔資料檔
        /// <summary>
        /// 匯出異業代收款檔資料檔
        /// </summary>
        public const string ExportEDPData = "ExportEDPData";
        #endregion

        #region [MDY:20191014] M201910_01 (2019擴充案+小修正) 產生測試繳款單
        /// <summary>
        /// 產生測試繳款單
        /// </summary>
        public const string GenSMBarcodePDF = "GenSMBarcodePDF";
        #endregion

        #region [MDY:202203XX] 2022擴充案 取得商家代號是否啟用英文資料
        /// <summary>
        /// 取得商家代號是否啟用英文資料
        /// </summary>
        public const string GetReceiveTypeEngEabled = "GetReceiveTypeEngEabled";
        #endregion

        #region [MDY:202203XX] 2022擴充案 學生專區取得繳費單 相關
        /// <summary>
        /// 學生專區取得指定學號的繳費單清單
        /// </summary>
        public const string GetStudentReceiveViews = "GetStudentReceiveViews";

        /// <summary>
        /// 學生專區取得指定繳費單
        /// </summary>
        public const string GetStudentReceiveView = "GetStudentReceiveView";
        #endregion
    }
    #endregion

    public partial class DataServiceHelper
    {
        /// <summary>
        /// 複製部門別代碼
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyDep(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製部門別

            int count = 0;

            #region 刪除目的地部門別資料

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", DeptListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId2);
            delParameters.Add("@TERM_ID", termId2);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}舊部門別代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}舊部門別代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //string logErrmsg = this.ReleaseDBLogger(true);
                //dbLogger.Dispose();
                //dbLogger = null;
            }
            #endregion

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }

            #endregion

            #region 新增目的地部門別資料
            StringBuilder insertSql = new StringBuilder();
            insertSql
                .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dept_Id, Dept_Name, status, crt_date, crt_user) ", DeptListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dept_Id, Dept_Name, status, GETDATE() crt_date, '{0}' crt_user ", commandAsker.UserId).AppendLine()
                .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", DeptListEntity.TABLE_NAME).AppendLine();

            KeyValueList insParameters = new KeyValueList(5);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@YEAR_ID1", yearId1);
            insParameters.Add("@TERM_ID1", termId1);
            insParameters.Add("@YEAR_ID2", yearId2);
            insParameters.Add("@TERM_ID2", termId2);

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1} (複製) 部門別代碼成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1} (複製) 部門別代碼失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            }
            #endregion

            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 複製代收費用別
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyReceive(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製代收費用別

            int count = 0;

            #region 刪除目的地資料

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", ReceiveListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId2);
            delParameters.Add("@TERM_ID", termId2);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}舊代收費用別代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}舊代收費用別代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //string logErrmsg = this.ReleaseDBLogger(true);
                //dbLogger.Dispose();
                //dbLogger = null;
            }
            #endregion

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }

            #endregion

            #region 新增目的地資料
            StringBuilder insertSql = new StringBuilder();
            insertSql
                .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dep_Id, Receive_Id, Receive_Name, status, crt_date, crt_user) ", ReceiveListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dep_Id, Receive_Id, Receive_Name, status, GETDATE() crt_date, '{0}' crt_user ", commandAsker.UserId).AppendLine()
                .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", ReceiveListEntity.TABLE_NAME).AppendLine();
            
            KeyValueList insParameters = new KeyValueList(5);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@YEAR_ID1", yearId1);
            insParameters.Add("@TERM_ID1", termId1);
            insParameters.Add("@YEAR_ID2", yearId2);
            insParameters.Add("@TERM_ID2", termId2);

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1} (複製) 代收費用別成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1} (複製) 代收費用別失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            }
            #endregion

            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 複製科系代碼
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyMajor(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製科系代碼

            int count = 0;

            #region 刪除目的地資料
            
            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", MajorListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId2);
            delParameters.Add("@TERM_ID", termId2);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}舊科系代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}舊科系代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //string logErrmsg = this.ReleaseDBLogger(true);
                //dbLogger.Dispose();
                //dbLogger = null;
            }
            #endregion

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }
            #endregion

            #region 新增目的地資料
            StringBuilder insertSql = new StringBuilder();
            insertSql
                .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dep_Id, Major_Id, Major_Name, status, crt_date, crt_user) ", MajorListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dep_Id, Major_Id, Major_Name, status, GETDATE() crt_date, '{0}' crt_user ", commandAsker.UserId).AppendLine()
                .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", MajorListEntity.TABLE_NAME).AppendLine();
            
            KeyValueList insParameters = new KeyValueList(5);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@YEAR_ID1", yearId1);
            insParameters.Add("@TERM_ID1", termId1);
            insParameters.Add("@YEAR_ID2", yearId2);
            insParameters.Add("@TERM_ID2", termId2);

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1} (複製) 科系成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1} (複製) 科系失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            }
            #endregion

            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 複製院別
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyCollege(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製院別代碼

            int count = 0;

            #region 刪除目的地資料

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", CollegeListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId2);
            delParameters.Add("@TERM_ID", termId2);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}舊院別代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}舊院別代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //string logErrmsg = this.ReleaseDBLogger(true);
                //dbLogger.Dispose();
                //dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }
            #endregion

            #endregion

            #region 新增目的地資料
            StringBuilder insertSql = new StringBuilder();
            insertSql
                .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dep_Id, College_Id, College_Name, status, crt_date, crt_user) ", CollegeListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dep_Id, College_Id, College_Name, status, GETDATE() crt_date, '{0}' crt_user ", commandAsker.UserId).AppendLine()
                .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", CollegeListEntity.TABLE_NAME).AppendLine();

            KeyValueList insParameters = new KeyValueList(5);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@YEAR_ID1", yearId1);
            insParameters.Add("@TERM_ID1", termId1);
            insParameters.Add("@YEAR_ID2", yearId2);
            insParameters.Add("@TERM_ID2", termId2);

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1} (複製) 院別成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1} (複製) 院別失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            }
            #endregion

            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 複製班別代碼
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyClass(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製班別代碼

            int count = 0;

            #region 刪除目的地資料

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", ClassListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId2);
            delParameters.Add("@TERM_ID", termId2);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}舊班別代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}舊班別代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //string logErrmsg = this.ReleaseDBLogger(true);
                //dbLogger.Dispose();
                //dbLogger = null;
            }
            #endregion

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }

            #endregion

            #region 新增目的地資料
            StringBuilder insertSql = new StringBuilder();
            insertSql
                .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dep_Id, Class_Id, Class_Name, status, crt_date, crt_user) ", ClassListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dep_Id, Class_Id, Class_Name, status, GETDATE() crt_date, '{0}' crt_user ", commandAsker.UserId).AppendLine()
                .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", ClassListEntity.TABLE_NAME).AppendLine();

            KeyValueList insParameters = new KeyValueList(5);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@YEAR_ID1", yearId1);
            insParameters.Add("@TERM_ID1", termId1);
            insParameters.Add("@YEAR_ID2", yearId2);
            insParameters.Add("@TERM_ID2", termId2);

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1} (複製) 班別成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1} (複製) 班別失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            }
            #endregion

            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 複製減免類別代碼
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyReduce(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製減免類別

            int count = 0;

            #region 刪除目的地資料

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", ReduceListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId2);
            delParameters.Add("@TERM_ID", termId2);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}舊減免類別資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}舊減免類別資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //string logErrmsg = this.ReleaseDBLogger(true);
                //dbLogger.Dispose();
                //dbLogger = null;
            }
            #endregion

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }

            #endregion

            #region 新增目的地資料
            StringBuilder insertSql = new StringBuilder();
            insertSql
                .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dep_Id, Reduce_Id, Reduce_Name, status, crt_date, crt_user) ", ReduceListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dep_Id, Reduce_Id, Reduce_Name, status, GETDATE() crt_date, '{0}' crt_user ", commandAsker.UserId).AppendLine()
                .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", ReduceListEntity.TABLE_NAME).AppendLine();

            KeyValueList insParameters = new KeyValueList(5);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@YEAR_ID1", yearId1);
            insParameters.Add("@TERM_ID1", termId1);
            insParameters.Add("@YEAR_ID2", yearId2);
            insParameters.Add("@TERM_ID2", termId2);

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1} (複製) 減免類別成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1} (複製) 減免類別失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            }
            #endregion

            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 複製住宿代碼
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyDorm(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製住宿代碼

            int count = 0;

            #region 刪除目的地資料

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", DormListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId2);
            delParameters.Add("@TERM_ID", termId2);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}舊住宿代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}舊住宿代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //string logErrmsg = this.ReleaseDBLogger(true);
                //dbLogger.Dispose();
                //dbLogger = null;
            }
            #endregion

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }

            #endregion

            #region 新增目的地資料
            StringBuilder insertSql = new StringBuilder();
            insertSql
                .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dep_Id, Dorm_Id, Dorm_Name, status, crt_date, crt_user) ", DormListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dep_Id, Dorm_Id, Dorm_Name, status, GETDATE() crt_date, '{0}' crt_user ", commandAsker.UserId).AppendLine()
                .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", DormListEntity.TABLE_NAME).AppendLine();

            KeyValueList insParameters = new KeyValueList(5);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@YEAR_ID1", yearId1);
            insParameters.Add("@TERM_ID1", termId1);
            insParameters.Add("@YEAR_ID2", yearId2);
            insParameters.Add("@TERM_ID2", termId2);

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1} (複製) 住宿成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1} (複製) 住宿失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            }
            #endregion

            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 複製就貸代碼
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyLoan(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製就貸代碼

            int count = 0;

            #region 刪除目的地資料

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", LoanListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId2);
            delParameters.Add("@TERM_ID", termId2);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}舊就貸代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}舊就貸代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //string logErrmsg = this.ReleaseDBLogger(true);
                //dbLogger.Dispose();
                //dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }
            #endregion

            #endregion

            #region 新增目的地資料
            StringBuilder insertSql = new StringBuilder();
            insertSql
                .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dep_Id, Loan_Id, Loan_Name, status, crt_date, crt_user) ", LoanListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dep_Id, Loan_Id, Loan_Name, status, GETDATE() crt_date, '{0}' crt_user ", commandAsker.UserId).AppendLine()
                .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", LoanListEntity.TABLE_NAME).AppendLine();

            KeyValueList insParameters = new KeyValueList(5);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@YEAR_ID1", yearId1);
            insParameters.Add("@TERM_ID1", termId1);
            insParameters.Add("@YEAR_ID2", yearId2);
            insParameters.Add("@TERM_ID2", termId2);

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1} (複製) 就貸成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1} (複製) 就貸失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            }
            #endregion

            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 複製退費代碼
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyReturn(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製退費代碼

            int count = 0;

            #region 刪除目的地資料

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", ReturnListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId2);
            delParameters.Add("@TERM_ID", termId2);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}舊退費代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}舊退費代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //string logErrmsg = this.ReleaseDBLogger(true);
                //dbLogger.Dispose();
                //dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }
            #endregion

            #endregion

            #region 新增目的地資料
            StringBuilder insertSql = new StringBuilder();
            insertSql
                .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dep_Id, Return_Id, Return_Name, status, crt_date, crt_user) ", ReturnListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dep_Id, Return_Id, Return_Name, status, GETDATE() crt_date, '{0}' crt_user ", commandAsker.UserId).AppendLine()
                .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", ReturnListEntity.TABLE_NAME).AppendLine();

            KeyValueList insParameters = new KeyValueList(5);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@YEAR_ID1", yearId1);
            insParameters.Add("@TERM_ID1", termId1);
            insParameters.Add("@YEAR_ID2", yearId2);
            insParameters.Add("@TERM_ID2", termId2);

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1} (複製) 退費代碼成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1} (複製) 退費代碼失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            }
            #endregion

            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;
            #endregion
        }

        /// <summary>
        /// 複製身分註記代碼
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyIdentify(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製身分註記代碼

            int count = 0;

            List<string> listTableName = new List<string>();
            listTableName.Add(IdentifyList1Entity.TABLE_NAME);
            listTableName.Add(IdentifyList2Entity.TABLE_NAME);
            listTableName.Add(IdentifyList3Entity.TABLE_NAME);
            listTableName.Add(IdentifyList4Entity.TABLE_NAME);
            listTableName.Add(IdentifyList5Entity.TABLE_NAME);
            listTableName.Add(IdentifyList6Entity.TABLE_NAME);

            #region 刪除目的地資料

            #region [old]
            //switch (IdentifyType)
            //{
            //    case "1":
            //        tableName = IdentifyList1Entity.TABLE_NAME;
            //        break;
            //    case "2":
            //        tableName = IdentifyList2Entity.TABLE_NAME;
            //        break;
            //    case "3":
            //        tableName = IdentifyList3Entity.TABLE_NAME;
            //        break;
            //    case "4":
            //        tableName = IdentifyList4Entity.TABLE_NAME;
            //        break;
            //    case "5":
            //        tableName = IdentifyList5Entity.TABLE_NAME;
            //        break;
            //    case "6":
            //        tableName = IdentifyList6Entity.TABLE_NAME;
            //        break;
            //}
            #endregion

            foreach(string tableName in listTableName)
            {
                StringBuilder deleteSql = new StringBuilder();
                deleteSql.AppendFormat("DELETE {0} WHERE ", tableName).AppendLine();
                deleteSql.AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

                KeyValueList delParameters = new KeyValueList(3);
                delParameters.Add("@RECEIVE_TYPE", receiveType);
                delParameters.Add("@YEAR_ID", yearId2);
                delParameters.Add("@TERM_ID", termId2);
                Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

                #region 儲存日誌資料並釋放資料庫日誌記錄器
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}舊身分註記代碼({3})資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count, tableName);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}舊身分註記代碼({3})資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message, tableName);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                    //string logErrmsg = this.ReleaseDBLogger(true);
                    //dbLogger.Dispose();
                    //dbLogger = null;
                }

                if (!result.IsSuccess)
                {
                    count = 0;
                    if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                    }
                    else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                    }
                    return result;
                }
                #endregion
            }

            #endregion

            #region 新增目的地資料
            foreach (string tableName in listTableName)
            {
                StringBuilder insertSql = new StringBuilder();
                insertSql
                    .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dep_Id, Identify_Id, Identify_Name, status, crt_date, crt_user) ", tableName).AppendLine()
                    .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dep_Id, Identify_Id, Identify_Name, status, GETDATE() crt_date, '{0}' crt_user ", commandAsker.UserId).AppendLine()
                    .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", tableName).AppendLine();

                KeyValueList insParameters = new KeyValueList(5);
                insParameters.Add("@RECEIVE_TYPE", receiveType);
                insParameters.Add("@YEAR_ID1", yearId1);
                insParameters.Add("@TERM_ID1", termId1);
                insParameters.Add("@YEAR_ID2", yearId2);
                insParameters.Add("@TERM_ID2", termId2);

                Result result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
                if (!result.IsSuccess)
                {
                    count = 0;
                    if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                    }
                    else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                    }
                }

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 身分註記代碼({3})成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, count, tableName);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 身分註記代碼({3})失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message, tableName);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                }
                #endregion
            }
            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return new Result(true);

            #endregion
        }

        /// <summary>
        /// 複製一般收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyGeneralStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製一般收費標準

            int count = 0;

            #region 刪除目的地資料

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", GeneralStandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId2);
            delParameters.Add("@TERM_ID", termId2);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}舊一般收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}舊一般收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //string logErrmsg = this.ReleaseDBLogger(true);
                //dbLogger.Dispose();
                //dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }
            #endregion

            #endregion

            #region 新增目的地資料
            StringBuilder insertSql = new StringBuilder();
            string strInsertFields = string.Empty;
            string strSelectFields = string.Empty;
            bool hasCRT_USER = false;

            GeneralStandardEntity entity = new GeneralStandardEntity();
            FieldSpec[] fields = entity.FieldsSpec;
            foreach (FieldSpec field in fields)
            {
                strInsertFields = strInsertFields + "," + field.FieldName;
                switch (field.FieldName.ToUpper())
                {
                    case "YEAR_ID":
                        strSelectFields = strSelectFields + ",@YEAR_ID2 Year_Id";
                        break;
                    case "TERM_ID":
                        strSelectFields = strSelectFields + ",@TERM_ID2 Term_Id";
                        break;
                    case "CRT_USER":
                        strSelectFields = strSelectFields + ",@CRT_USER crt_user";
                        hasCRT_USER = true;
                        break;
                    default:
                        strSelectFields = strSelectFields + "," + field.FieldName;
                        break;
                }
            }

            strInsertFields = strInsertFields.Substring(1);
            strSelectFields = strSelectFields.Substring(1);

            insertSql
                .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, strInsertFields).AppendLine()
                .AppendFormat("SELECT {0} ", strSelectFields).AppendLine()
                .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", entity.TableName).AppendLine();

            KeyValueList insParameters = new KeyValueList(6);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@YEAR_ID1", yearId1);
            insParameters.Add("@TERM_ID1", termId1);
            insParameters.Add("@YEAR_ID2", yearId2);
            insParameters.Add("@TERM_ID2", termId2);
            if (hasCRT_USER)
            {
                insParameters.Add("@CRT_USER", commandAsker.UserId);
            }

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1} (複製) 一般收費標準成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1} (複製) 一般收費標準失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            }
            #endregion

            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 複製小於基數其他收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyCredit2Standard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製小於基數其他收費標準

            int count = 0;

            #region 刪除目的地資料

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", Credit2StandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId2);
            delParameters.Add("@TERM_ID", termId2);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}舊小於基數其他收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}舊小於基數其他收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //string logErrmsg = this.ReleaseDBLogger(true);
                //dbLogger.Dispose();
                //dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }
            #endregion

            #endregion

            #region 新增目的地資料
            StringBuilder insertSql = new StringBuilder();
            string strInsertFields = string.Empty;
            string strSelectFields = string.Empty;
            bool hasCRT_USER = false;

            Credit2StandardEntity entity = new Credit2StandardEntity();
            FieldSpec[] fields = entity.FieldsSpec;
            foreach (FieldSpec field in fields)
            {
                strInsertFields = strInsertFields + "," + field.FieldName;
                switch (field.FieldName.ToUpper())
                {
                    case "YEAR_ID":
                        strSelectFields = strSelectFields + ",@YEAR_ID2 Year_Id";
                        break;
                    case "TERM_ID":
                        strSelectFields = strSelectFields + ",@TERM_ID2 Term_Id";
                        break;
                    case "CRT_USER":
                        strSelectFields = strSelectFields + ",@CRT_USER crt_user";
                        hasCRT_USER = true;
                        break;
                    default:
                        strSelectFields = strSelectFields + "," + field.FieldName;
                        break;
                }
            }

            strInsertFields = strInsertFields.Substring(1);
            strSelectFields = strSelectFields.Substring(1);

            insertSql
                .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, strInsertFields).AppendLine()
                .AppendFormat("SELECT {0} ", strSelectFields).AppendLine()
                .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", entity.TableName).AppendLine();

            KeyValueList insParameters = new KeyValueList(6);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@YEAR_ID1", yearId1);
            insParameters.Add("@TERM_ID1", termId1);
            insParameters.Add("@YEAR_ID2", yearId2);
            insParameters.Add("@TERM_ID2", termId2);
            if (hasCRT_USER)
            {
                insParameters.Add("@CRT_USER", commandAsker.UserId);
            }

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1} (複製) 小於基數其他收費標準成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1} (複製) 小於基數其他收費標準失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            }
            #endregion

            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 複製學分費收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyCreditStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製學分費收費標準

            int count = 0;

            #region 刪除目的地資料

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", CreditStandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId2);
            delParameters.Add("@TERM_ID", termId2);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}舊學分費收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}舊學分費收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //string logErrmsg = this.ReleaseDBLogger(true);
                //dbLogger.Dispose();
                //dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }
            #endregion

            #endregion

            #region 新增目的地資料
            StringBuilder insertSql = new StringBuilder();
            string strInsertFields = string.Empty;
            string strSelectFields = string.Empty;
            bool hasCRT_USER = false;

            CreditStandardEntity entity = new CreditStandardEntity();
            FieldSpec[] fields = entity.FieldsSpec;
            foreach (FieldSpec field in fields)
            {
                strInsertFields = strInsertFields + "," + field.FieldName;
                switch (field.FieldName.ToUpper())
                {
                    case "YEAR_ID":
                        strSelectFields = strSelectFields + ",@YEAR_ID2 Year_Id";
                        break;
                    case "TERM_ID":
                        strSelectFields = strSelectFields + ",@TERM_ID2 Term_Id";
                        break;
                    case "CRT_USER":
                        strSelectFields = strSelectFields + ",@CRT_USER crt_user";
                        hasCRT_USER = true;
                        break;
                    default:
                        strSelectFields = strSelectFields + "," + field.FieldName;
                        break;
                }
            }

            strInsertFields = strInsertFields.Substring(1);
            strSelectFields = strSelectFields.Substring(1);

            insertSql
                .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, strInsertFields).AppendLine()
                .AppendFormat("SELECT {0} ", strSelectFields).AppendLine()
                .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", entity.TableName).AppendLine();

            KeyValueList insParameters = new KeyValueList(6);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@YEAR_ID1", yearId1);
            insParameters.Add("@TERM_ID1", termId1);
            insParameters.Add("@YEAR_ID2", yearId2);
            insParameters.Add("@TERM_ID2", termId2);
            if (hasCRT_USER)
            {
                insParameters.Add("@CRT_USER", commandAsker.UserId);
            }

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1} (複製) 學分費收費標準成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1} (複製) 學分費收費標準失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            }
            #endregion

            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 複製住宿費收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyDormStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製住宿費收費標準

            int count = 0;

            #region 刪除目的地資料

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", DormStandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId2);
            delParameters.Add("@TERM_ID", termId2);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}舊住宿費收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}舊住宿費收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //string logErrmsg = this.ReleaseDBLogger(true);
                //dbLogger.Dispose();
                //dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }
            #endregion

            #endregion

            #region 新增目的地資料
            StringBuilder insertSql = new StringBuilder();
            string strInsertFields = string.Empty;
            string strSelectFields = string.Empty;
            bool hasCRT_USER = false;

            DormStandardEntity entity = new DormStandardEntity();
            FieldSpec[] fields = entity.FieldsSpec;
            foreach (FieldSpec field in fields)
            {
                strInsertFields = strInsertFields + "," + field.FieldName;
                switch (field.FieldName.ToUpper())
                {
                    case "YEAR_ID":
                        strSelectFields = strSelectFields + ",@YEAR_ID2 Year_Id";
                        break;
                    case "TERM_ID":
                        strSelectFields = strSelectFields + ",@TERM_ID2 Term_Id";
                        break;
                    case "CRT_USER":
                        strSelectFields = strSelectFields + ",@CRT_USER crt_user";
                        hasCRT_USER = true;
                        break;
                    default:
                        strSelectFields = strSelectFields + "," + field.FieldName;
                        break;
                }
            }

            strInsertFields = strInsertFields.Substring(1);
            strSelectFields = strSelectFields.Substring(1);

            insertSql
                .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, strInsertFields).AppendLine()
                .AppendFormat("SELECT {0} ", strSelectFields).AppendLine()
                .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", entity.TableName).AppendLine();

            KeyValueList insParameters = new KeyValueList(6);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@YEAR_ID1", yearId1);
            insParameters.Add("@TERM_ID1", termId1);
            insParameters.Add("@YEAR_ID2", yearId2);
            insParameters.Add("@TERM_ID2", termId2);
            if (hasCRT_USER)
            {
                insParameters.Add("@CRT_USER", commandAsker.UserId);
            }

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1} (複製) 住宿費收費標準成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1} (複製) 住宿費收費標準失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            }
            #endregion

            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 複製學分費基準收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyCreditbStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製學分費基準收費標準

            int count = 0;

            #region 刪除目的地資料

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", CreditbStandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId2);
            delParameters.Add("@TERM_ID", termId2);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}舊學分費基準收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}舊學分費基準收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //string logErrmsg = this.ReleaseDBLogger(true);
                //dbLogger.Dispose();
                //dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }
            #endregion

            #endregion

            #region 新增目的地資料
            StringBuilder insertSql = new StringBuilder();
            string strInsertFields = string.Empty;
            string strSelectFields = string.Empty;
            bool hasCRT_USER = false;

            CreditbStandardEntity entity = new CreditbStandardEntity();
            FieldSpec[] fields = entity.FieldsSpec;
            foreach (FieldSpec field in fields)
            {
                strInsertFields = strInsertFields + "," + field.FieldName;
                switch (field.FieldName.ToUpper())
                {
                    case "YEAR_ID":
                        strSelectFields = strSelectFields + ",@YEAR_ID2 Year_Id";
                        break;
                    case "TERM_ID":
                        strSelectFields = strSelectFields + ",@TERM_ID2 Term_Id";
                        break;
                    case "CRT_USER":
                        strSelectFields = strSelectFields + ",@CRT_USER crt_user";
                        hasCRT_USER = true;
                        break;
                    default:
                        strSelectFields = strSelectFields + "," + field.FieldName;
                        break;
                }
            }

            strInsertFields = strInsertFields.Substring(1);
            strSelectFields = strSelectFields.Substring(1);

            insertSql
                .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, strInsertFields).AppendLine()
                .AppendFormat("SELECT {0} ", strSelectFields).AppendLine()
                .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", entity.TableName).AppendLine();

            KeyValueList insParameters = new KeyValueList(6);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@YEAR_ID1", yearId1);
            insParameters.Add("@TERM_ID1", termId1);
            insParameters.Add("@YEAR_ID2", yearId2);
            insParameters.Add("@TERM_ID2", termId2);
            if (hasCRT_USER)
            {
                insParameters.Add("@CRT_USER", commandAsker.UserId);
            }

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1} (複製) 學分費基準收費標準成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1} (複製) 學分費基準收費標準失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            }
            #endregion

            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 複製課程收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyClassStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製課程收費標準

            int count = 0;

            #region 刪除目的地資料

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", ClassStandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId2);
            delParameters.Add("@TERM_ID", termId2);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}舊課程收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}舊課程收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //string logErrmsg = this.ReleaseDBLogger(true);
                //dbLogger.Dispose();
                //dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }
            #endregion

            #endregion

            #region 新增目的地資料
            StringBuilder insertSql = new StringBuilder();
            string strInsertFields = string.Empty;
            string strSelectFields = string.Empty;
            bool hasCRT_USER = false;

            ClassStandardEntity entity = new ClassStandardEntity();
            FieldSpec[] fields = entity.FieldsSpec;
            foreach (FieldSpec field in fields)
            {
                strInsertFields = strInsertFields + "," + field.FieldName;
                switch (field.FieldName.ToUpper())
                {
                    case "YEAR_ID":
                        strSelectFields = strSelectFields + ",@YEAR_ID2 Year_Id";
                        break;
                    case "TERM_ID":
                        strSelectFields = strSelectFields + ",@TERM_ID2 Term_Id";
                        break;
                    case "CRT_USER":
                        strSelectFields = strSelectFields + ",@CRT_USER crt_user";
                        hasCRT_USER = true;
                        break;
                    default:
                        strSelectFields = strSelectFields + "," + field.FieldName;
                        break;
                }
            }

            strInsertFields = strInsertFields.Substring(1);
            strSelectFields = strSelectFields.Substring(1);

            insertSql
                .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, strInsertFields).AppendLine()
                .AppendFormat("SELECT {0} ", strSelectFields).AppendLine()
                .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", entity.TableName).AppendLine();

            KeyValueList insParameters = new KeyValueList(6);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@YEAR_ID1", yearId1);
            insParameters.Add("@TERM_ID1", termId1);
            insParameters.Add("@YEAR_ID2", yearId2);
            insParameters.Add("@TERM_ID2", termId2);
            if (hasCRT_USER)
            {
                insParameters.Add("@CRT_USER", commandAsker.UserId);
            }

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1} (複製) 課程收費標準成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1} (複製) 課程收費標準失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            }
            #endregion

            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 複製身分註記收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyIdentifyStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製身分註記收費標準

            int count = 0;

            List<string> listTableName = new List<string>();
            listTableName.Add(IdentifyStandard1Entity.TABLE_NAME);
            listTableName.Add(IdentifyStandard2Entity.TABLE_NAME);
            listTableName.Add(IdentifyStandard3Entity.TABLE_NAME);
            listTableName.Add(IdentifyStandard4Entity.TABLE_NAME);
            listTableName.Add(IdentifyStandard5Entity.TABLE_NAME);
            listTableName.Add(IdentifyStandard6Entity.TABLE_NAME);

            #region 刪除目的地資料
            
            foreach (string tableName in listTableName)
            {
                StringBuilder deleteSql = new StringBuilder();
                deleteSql.AppendFormat("DELETE {0} WHERE ", tableName).AppendLine();
                deleteSql.AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

                KeyValueList delParameters = new KeyValueList(3);
                delParameters.Add("@RECEIVE_TYPE", receiveType);
                delParameters.Add("@YEAR_ID", yearId2);
                delParameters.Add("@TERM_ID", termId2);
                Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

                #region 儲存日誌資料並釋放資料庫日誌記錄器
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}舊身分註記收費標準({3})資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count, tableName);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}舊身分註記收費標準({3})資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message, tableName);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                    //string logErrmsg = this.ReleaseDBLogger(true);
                    //dbLogger.Dispose();
                    //dbLogger = null;
                }

                if (!result.IsSuccess)
                {
                    count = 0;
                    if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                    }
                    else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                    }
                    return result;
                }
                #endregion
            }

            #endregion

            #region 新增目的地資料
            foreach (string tableName in listTableName)
            {
                StringBuilder insertSql = new StringBuilder();
                string strInsertFields = string.Empty;
                string strSelectFields = string.Empty;
                bool hasCRT_USER = false;
                switch (tableName)
                {
                    case IdentifyStandard1Entity.TABLE_NAME:
                        #region IdentifyStandard1Entity
                        {
                            IdentifyStandard1Entity entity = new IdentifyStandard1Entity();
                            FieldSpec[] fields = entity.FieldsSpec;
                            foreach (FieldSpec field in fields)
                            {
                                strInsertFields = strInsertFields + "," + field.FieldName;
                                switch (field.FieldName.ToUpper())
                                {
                                    case "YEAR_ID":
                                        strSelectFields = strSelectFields + ",@YEAR_ID2 Year_Id";
                                        break;
                                    case "TERM_ID":
                                        strSelectFields = strSelectFields + ",@TERM_ID2 Term_Id";
                                        break;
                                    case "CRT_USER":
                                        strSelectFields = strSelectFields + ",@CRT_USER crt_user";
                                        hasCRT_USER = true;
                                        break;
                                    default:
                                        strSelectFields = strSelectFields + "," + field.FieldName;
                                        break;
                                }
                            }
                        }
                        #endregion
                        break;
                    case IdentifyStandard2Entity.TABLE_NAME:
                        #region IdentifyStandard2Entity
                        {
                            IdentifyStandard2Entity entity = new IdentifyStandard2Entity();
                            FieldSpec[] fields = entity.FieldsSpec;
                            foreach (FieldSpec field in fields)
                            {
                                strInsertFields = strInsertFields + "," + field.FieldName;
                                switch (field.FieldName.ToUpper())
                                {
                                    case "YEAR_ID":
                                        strSelectFields = strSelectFields + ",@YEAR_ID2 Year_Id";
                                        break;
                                    case "TERM_ID":
                                        strSelectFields = strSelectFields + ",@TERM_ID2 Term_Id";
                                        break;
                                    case "CRT_USER":
                                        strSelectFields = strSelectFields + ",@CRT_USER crt_user";
                                        hasCRT_USER = true;
                                        break;
                                    default:
                                        strSelectFields = strSelectFields + "," + field.FieldName;
                                        break;
                                }
                            }
                        }
                        #endregion
                        break;
                    case IdentifyStandard3Entity.TABLE_NAME:
                        #region IdentifyStandard3Entity
                        {
                            IdentifyStandard3Entity entity = new IdentifyStandard3Entity();
                            FieldSpec[] fields = entity.FieldsSpec;
                            foreach (FieldSpec field in fields)
                            {
                                strInsertFields = strInsertFields + "," + field.FieldName;
                                switch (field.FieldName.ToUpper())
                                {
                                    case "YEAR_ID":
                                        strSelectFields = strSelectFields + ",@YEAR_ID2 Year_Id";
                                        break;
                                    case "TERM_ID":
                                        strSelectFields = strSelectFields + ",@TERM_ID2 Term_Id";
                                        break;
                                    case "CRT_USER":
                                        strSelectFields = strSelectFields + ",@CRT_USER crt_user";
                                        hasCRT_USER = true;
                                        break;
                                    default:
                                        strSelectFields = strSelectFields + "," + field.FieldName;
                                        break;
                                }
                            }
                        }
                        #endregion
                        break;
                    case IdentifyStandard4Entity.TABLE_NAME:
                        #region IdentifyStandard4Entity
                        {
                            IdentifyStandard4Entity entity = new IdentifyStandard4Entity();
                            FieldSpec[] fields = entity.FieldsSpec;
                            foreach (FieldSpec field in fields)
                            {
                                strInsertFields = strInsertFields + "," + field.FieldName;
                                switch (field.FieldName.ToUpper())
                                {
                                    case "YEAR_ID":
                                        strSelectFields = strSelectFields + ",@YEAR_ID2 Year_Id";
                                        break;
                                    case "TERM_ID":
                                        strSelectFields = strSelectFields + ",@TERM_ID2 Term_Id";
                                        break;
                                    case "CRT_USER":
                                        strSelectFields = strSelectFields + ",@CRT_USER crt_user";
                                        hasCRT_USER = true;
                                        break;
                                    default:
                                        strSelectFields = strSelectFields + "," + field.FieldName;
                                        break;
                                }
                            }
                        }
                        #endregion
                        break;
                    case IdentifyStandard5Entity.TABLE_NAME:
                        #region IdentifyStandard5Entity
                        {
                            IdentifyStandard5Entity entity = new IdentifyStandard5Entity();
                            FieldSpec[] fields = entity.FieldsSpec;
                            foreach (FieldSpec field in fields)
                            {
                                strInsertFields = strInsertFields + "," + field.FieldName;
                                switch (field.FieldName.ToUpper())
                                {
                                    case "YEAR_ID":
                                        strSelectFields = strSelectFields + ",@YEAR_ID2 Year_Id";
                                        break;
                                    case "TERM_ID":
                                        strSelectFields = strSelectFields + ",@TERM_ID2 Term_Id";
                                        break;
                                    case "CRT_USER":
                                        strSelectFields = strSelectFields + ",@CRT_USER crt_user";
                                        hasCRT_USER = true;
                                        break;
                                    default:
                                        strSelectFields = strSelectFields + "," + field.FieldName;
                                        break;
                                }
                            }
                        }
                        #endregion
                        break;
                    case IdentifyStandard6Entity.TABLE_NAME:
                        #region IdentifyStandard6Entity
                        {
                            IdentifyStandard6Entity entity = new IdentifyStandard6Entity();
                            FieldSpec[] fields = entity.FieldsSpec;
                            foreach (FieldSpec field in fields)
                            {
                                strInsertFields = strInsertFields + "," + field.FieldName;
                                switch (field.FieldName.ToUpper())
                                {
                                    case "YEAR_ID":
                                        strSelectFields = strSelectFields + ",@YEAR_ID2 Year_Id";
                                        break;
                                    case "TERM_ID":
                                        strSelectFields = strSelectFields + ",@TERM_ID2 Term_Id";
                                        break;
                                    case "CRT_USER":
                                        strSelectFields = strSelectFields + ",@CRT_USER crt_user";
                                        hasCRT_USER = true;
                                        break;
                                    default:
                                        strSelectFields = strSelectFields + "," + field.FieldName;
                                        break;
                                }
                            }
                        }
                        #endregion
                        break;
                }

                strInsertFields = strInsertFields.Substring(1);
                strSelectFields = strSelectFields.Substring(1);

                insertSql
                    .AppendFormat("INSERT INTO {0}({1}) ", tableName, strInsertFields).AppendLine()
                    .AppendFormat("SELECT {0} ", strSelectFields).AppendLine()
                    .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", tableName).AppendLine();

                KeyValueList insParameters = new KeyValueList(6);
                insParameters.Add("@RECEIVE_TYPE", receiveType);
                insParameters.Add("@YEAR_ID1", yearId1);
                insParameters.Add("@TERM_ID1", termId1);
                insParameters.Add("@YEAR_ID2", yearId2);
                insParameters.Add("@TERM_ID2", termId2);
                if (hasCRT_USER)
                {
                    insParameters.Add("@CRT_USER", commandAsker.UserId);
                }

                Result result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
                if (!result.IsSuccess)
                {
                    count = 0;
                    if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                    }
                    else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                    }
                }

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 身分註記收費標準({3})成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count, tableName);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 身分註記收費標準({3})失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message, tableName);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion
            }
            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return new Result(true);

            #endregion
        }

        /// <summary>
        /// 複製減免收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyReduceStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製減免收費標準

            int count = 0;

            #region 刪除目的地資料

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", ReduceStandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId2);
            delParameters.Add("@TERM_ID", termId2);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}舊減免收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}舊減免收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //string logErrmsg = this.ReleaseDBLogger(true);
                //dbLogger.Dispose();
                //dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }
            #endregion

            #endregion

            #region 新增目的地資料
            StringBuilder insertSql = new StringBuilder();
            string strInsertFields = string.Empty;
            string strSelectFields = string.Empty;
            bool hasCRT_USER = false;

            ReduceStandardEntity entity = new ReduceStandardEntity();
            FieldSpec[] fields = entity.FieldsSpec;
            foreach (FieldSpec field in fields)
            {
                strInsertFields = strInsertFields + "," + field.FieldName;
                switch (field.FieldName.ToUpper())
                {
                    case "YEAR_ID":
                        strSelectFields = strSelectFields + ",@YEAR_ID2 Year_Id";
                        break;
                    case "TERM_ID":
                        strSelectFields = strSelectFields + ",@TERM_ID2 Term_Id";
                        break;
                    case "CRT_USER":
                        strSelectFields = strSelectFields + ",@CRT_USER crt_user";
                        hasCRT_USER = true;
                        break;
                    default:
                        strSelectFields = strSelectFields + "," + field.FieldName;
                        break;
                }
            }

            strInsertFields = strInsertFields.Substring(1);
            strSelectFields = strSelectFields.Substring(1);

            insertSql
                .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, strInsertFields).AppendLine()
                .AppendFormat("SELECT {0} ", strSelectFields).AppendLine()
                .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", entity.TableName).AppendLine();

            KeyValueList insParameters = new KeyValueList(6);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@YEAR_ID1", yearId1);
            insParameters.Add("@TERM_ID1", termId1);
            insParameters.Add("@YEAR_ID2", yearId2);
            insParameters.Add("@TERM_ID2", termId2);
            if (hasCRT_USER)
            {
                insParameters.Add("@CRT_USER", commandAsker.UserId);
            }

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1} (複製) 減免收費標準成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1} (複製) 減免收費標準失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            }
            #endregion

            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 複製就貸收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyLoanStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製就貸收費標準

            int count = 0;

            #region 刪除目的地資料

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", LoanStandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId2);
            delParameters.Add("@TERM_ID", termId2);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}舊就貸收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}舊就貸收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //string logErrmsg = this.ReleaseDBLogger(true);
                //dbLogger.Dispose();
                //dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }
            #endregion

            #endregion

            #region 新增目的地資料
            StringBuilder insertSql = new StringBuilder();
            string strInsertFields = string.Empty;
            string strSelectFields = string.Empty;
            bool hasCRT_USER = false;

            LoanStandardEntity entity = new LoanStandardEntity();
            FieldSpec[] fields = entity.FieldsSpec;
            foreach (FieldSpec field in fields)
            {
                strInsertFields = strInsertFields + "," + field.FieldName;
                switch (field.FieldName.ToUpper())
                {
                    case "YEAR_ID":
                        strSelectFields = strSelectFields + ",@YEAR_ID2 Year_Id";
                        break;
                    case "TERM_ID":
                        strSelectFields = strSelectFields + ",@TERM_ID2 Term_Id";
                        break;
                    case "CRT_USER":
                        strSelectFields = strSelectFields + ",@CRT_USER crt_user";
                        hasCRT_USER = true;
                        break;
                    default:
                        strSelectFields = strSelectFields + "," + field.FieldName;
                        break;
                }
            }

            strInsertFields = strInsertFields.Substring(1);
            strSelectFields = strSelectFields.Substring(1);

            insertSql
                .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, strInsertFields).AppendLine()
                .AppendFormat("SELECT {0} ", strSelectFields).AppendLine()
                .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", entity.TableName).AppendLine();

            KeyValueList insParameters = new KeyValueList(6);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@YEAR_ID1", yearId1);
            insParameters.Add("@TERM_ID1", termId1);
            insParameters.Add("@YEAR_ID2", yearId2);
            insParameters.Add("@TERM_ID2", termId2);
            if (hasCRT_USER)
            {
                insParameters.Add("@CRT_USER", commandAsker.UserId);
            }

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1} (複製) 就貸收費標準成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1} (複製) 就貸收費標準失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            }
            #endregion

            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 複製退費收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyReturnStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製退費收費標準

            int count = 0;

            #region 刪除目的地資料

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", ReturnStandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId2);
            delParameters.Add("@TERM_ID", termId2);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}舊退費收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}舊退費收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //string logErrmsg = this.ReleaseDBLogger(true);
                //dbLogger.Dispose();
                //dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }
            #endregion

            #endregion

            #region 新增目的地資料
            StringBuilder insertSql = new StringBuilder();
            string strInsertFields = string.Empty;
            string strSelectFields = string.Empty;
            bool hasCRT_USER = false;

            ReturnStandardEntity entity = new ReturnStandardEntity();
            FieldSpec[] fields = entity.FieldsSpec;
            foreach (FieldSpec field in fields)
            {
                strInsertFields = strInsertFields + "," + field.FieldName;
                switch (field.FieldName.ToUpper())
                {
                    case "YEAR_ID":
                        strSelectFields = strSelectFields + ",@YEAR_ID2 Year_Id";
                        break;
                    case "TERM_ID":
                        strSelectFields = strSelectFields + ",@TERM_ID2 Term_Id";
                        break;
                    case "CRT_USER":
                        strSelectFields = strSelectFields + ",@CRT_USER crt_user";
                        hasCRT_USER = true;
                        break;
                    default:
                        strSelectFields = strSelectFields + "," + field.FieldName;
                        break;
                }
            }

            strInsertFields = strInsertFields.Substring(1);
            strSelectFields = strSelectFields.Substring(1);

            insertSql
                .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, strInsertFields).AppendLine()
                .AppendFormat("SELECT {0} ", strSelectFields).AppendLine()
                .AppendFormat("FROM {0} where Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID1 and Term_Id=@TERM_ID1 ", entity.TableName).AppendLine();

            KeyValueList insParameters = new KeyValueList(6);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@YEAR_ID1", yearId1);
            insParameters.Add("@TERM_ID1", termId1);
            insParameters.Add("@YEAR_ID2", yearId2);
            insParameters.Add("@TERM_ID2", termId2);
            if (hasCRT_USER)
            {
                insParameters.Add("@CRT_USER", commandAsker.UserId);
            }

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1} (複製) 退費收費標準成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1} (複製) 退費收費標準失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            }
            #endregion

            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                //string notation = null;
                //if (result.IsSuccess)
                //{
                //    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                //}
                //else
                //{
                //    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                //}
                //dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 刪除部別代碼
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelDep(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除部別

            int count = 0;

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", DeptListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId);
            delParameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}部別代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}部別代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
            }

            return result;

            #endregion
        }

        /// <summary>
        /// 刪除院別代碼
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelCollege(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除院別代碼

            int count = 0;

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", CollegeListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId);
            delParameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}院別代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}院別代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
            }

            return result;

            #endregion
        }

        /// <summary>
        /// 刪除科系代碼
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelMajor(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除科系代碼

            int count = 0;

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", MajorListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId);
            delParameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}科系代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}科系代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 刪除班別代碼
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelClass(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除班別代碼

            int count = 0;

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", ClassListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId);
            delParameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}班別代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}班別代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 刪除減免類別代碼
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelReduce(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除減免類別代碼

            int count = 0;

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", ReduceListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId);
            delParameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}減免類別資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}減免類別資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 刪除住宿代碼
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelDorm(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除住宿代碼

            int count = 0;

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", DormListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId);
            delParameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}住宿代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}住宿代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 刪除身分註記代碼
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelIdentify(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除身分註記代碼

            List<string> listTableName = new List<string>();
            listTableName.Add(IdentifyList1Entity.TABLE_NAME);
            listTableName.Add(IdentifyList2Entity.TABLE_NAME);
            listTableName.Add(IdentifyList3Entity.TABLE_NAME);
            listTableName.Add(IdentifyList4Entity.TABLE_NAME);
            listTableName.Add(IdentifyList5Entity.TABLE_NAME);
            listTableName.Add(IdentifyList6Entity.TABLE_NAME);

            foreach (string tableName in listTableName)
            {
                int count = 0;
                StringBuilder deleteSql = new StringBuilder();
                deleteSql
                    .AppendFormat("DELETE {0} WHERE ", tableName).AppendLine()
                    .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

                KeyValueList delParameters = new KeyValueList(3);
                delParameters.Add("@RECEIVE_TYPE", receiveType);
                delParameters.Add("@YEAR_ID", yearId);
                delParameters.Add("@TERM_ID", termId);

                Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

                #region 儲存日誌資料並釋放資料庫日誌記錄器
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}身分註記代碼({3})資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count, tableName);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}身分註記代碼({3})資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message, tableName);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                }

                if (!result.IsSuccess)
                {
                    count = 0;
                    if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                    }
                    else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                    }
                }
                #endregion
            }

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return new Result(true);

            #endregion
        }

        /// <summary>
        /// 刪除就貸代碼
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelLoan(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除就貸代碼

            int count = 0;

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", LoanListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId);
            delParameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}就貸代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}就貸代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 刪除退費代碼
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelReturn(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除退費代碼

            int count = 0;

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", ReturnListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId);
            delParameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}退費代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}退費代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 刪除代收費用別
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelReceive(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除代收費用別

            int count = 0;

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", ReceiveListEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId);
            delParameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}代收費用別資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}代收費用別資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 刪除一般收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelGeneralStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除一般收費標準

            int count = 0;

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", GeneralStandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId);
            delParameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}一般收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}一般收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 刪除小於基數其他收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelCredit2Standard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除小於基數其他收費標準

            int count = 0;

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", Credit2StandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId);
            delParameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}小於基數其他收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}小於基數其他收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 刪除學分費收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelCreditStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除學分費收費標準

            int count = 0;

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", CreditStandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId);
            delParameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}學分費收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}學分費收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 刪除住宿費收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelDormStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除住宿費收費標準

            int count = 0;

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", DormStandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId);
            delParameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}住宿費收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}住宿費收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 刪除學分費基準收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelCreditbStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除學分費基準收費標準

            int count = 0;

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", CreditbStandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId);
            delParameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}學分費基準收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}學分費基準收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 刪除身分註記收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelIdentifyStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除身分註記收費標準

            List<string> listTableName = new List<string>();
            listTableName.Add(IdentifyStandard1Entity.TABLE_NAME);
            listTableName.Add(IdentifyStandard2Entity.TABLE_NAME);
            listTableName.Add(IdentifyStandard3Entity.TABLE_NAME);
            listTableName.Add(IdentifyStandard4Entity.TABLE_NAME);
            listTableName.Add(IdentifyStandard5Entity.TABLE_NAME);
            listTableName.Add(IdentifyStandard6Entity.TABLE_NAME);

            foreach (string tableName in listTableName)
            {
                int count = 0;
                StringBuilder deleteSql = new StringBuilder();
                deleteSql
                    .AppendFormat("DELETE {0} WHERE ", tableName).AppendLine()
                    .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

                KeyValueList delParameters = new KeyValueList(3);
                delParameters.Add("@RECEIVE_TYPE", receiveType);
                delParameters.Add("@YEAR_ID", yearId);
                delParameters.Add("@TERM_ID", termId);

                Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

                #region 儲存日誌資料並釋放資料庫日誌記錄器
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}身分註記收費標準({3})資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count, tableName);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}身分註記收費標準({3})資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message, tableName);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                    string logErrmsg = this.ReleaseDBLogger(true);
                    dbLogger.Dispose();
                    dbLogger = null;
                }

                if (!result.IsSuccess)
                {
                    count = 0;
                    if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                    }
                    else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                    }
                }
                #endregion

            }

            return new Result(true);

            #endregion
        }

        /// <summary>
        /// 刪除課程收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelClassStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除課程收費標準

            int count = 0;

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", ClassStandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId);
            delParameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}課程收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}課程收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 刪除減免收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelReduceStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除減免收費標準

            int count = 0;

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", ReduceStandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId);
            delParameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}減免收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}減免收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 刪除就貸收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelLoanStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除就貸收費標準

            int count = 0;

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", LoanStandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId);
            delParameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}就貸收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}就貸收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 刪除退費收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DelReturnStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除退費收費標準

            int count = 0;

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", ReturnStandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(3);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearId);
            delParameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}退費收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}退費收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
            }
            #endregion

            return result;

            #endregion
        }

        /// <summary>
        /// 更新群組權限資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result RenewGroupRight(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 取得功能選單資料
            FuncMenuEntity[] funcMenus = null;
            {
                Expression where = new Expression(FuncMenuEntity.Field.Status, DataStatusCodeTexts.NORMAL);
                KeyValueList<OrderByEnum> orderbys = new KeyValueList<OrderByEnum>();
                orderbys.Add(FuncMenuEntity.Field.FuncId, OrderByEnum.Asc);
                Result result = _Factory.SelectAll<FuncMenuEntity>(where, orderbys, out funcMenus);

                #region 儲存日誌資料並釋放資料庫日誌記錄器
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, funcMenus == null ? 0 : funcMenus.Length);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                }
                #endregion

                if (!result.IsSuccess)
                {
                    if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                    }
                    else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                    }

                    #region 儲存日誌資料並釋放資料庫日誌記錄器
                    string logErrmsg = this.ReleaseDBLogger(true);
                    if (dbLogger != null)
                    {
                        dbLogger.Dispose();
                        dbLogger = null;
                    }
                    #endregion

                    return result;
                }

                if (funcMenus == null)
                {
                    funcMenus = new FuncMenuEntity[0];
                }
            }
            #endregion

            #region 處理執行參數
            string groupID = null;
            KeyValueList<string> funcRights = new KeyValueList<string>();
            foreach (KeyValue<string> argument in arguments)
            {
                string funcId = argument.Key;
                if (funcId.Equals("GroupID", StringComparison.CurrentCultureIgnoreCase))
                {
                    groupID = argument.Value == null ? null : argument.Value.Trim();
                }
                else if (funcId.Length > 3 && funcMenus != null && funcMenus.Length > 0)    //funcId.Length < 3 視為 Menu，不處理
                {
                    string rightCode = GroupRightEntity.FormatRightCode(argument.Value == null ? null : argument.Value.Trim());
                    if (rightCode != GroupRightEntity.None_RightCode)
                    {
                        FuncMenuEntity myFuncMenu = null;
                        myFuncMenu = Array.Find<FuncMenuEntity>(funcMenus, x => x.FuncId == funcId);
                        if (myFuncMenu != null)
                        {
                            funcRights.Add(funcId, rightCode);

                            #region 有父層且為 Menu (parnetId.Length <= 3) 且未加入
                            string parnetId = myFuncMenu.ParentId;
                            if (!String.IsNullOrEmpty(parnetId) && parnetId.Length <= 3 && funcRights.GetKeyFirstIndex(parnetId) < 0)
                            {
                                FuncMenuEntity myParentMenu = Array.Find<FuncMenuEntity>(funcMenus, x => x.FuncId == parnetId);
                                if (myParentMenu != null)
                                {
                                    funcRights.Add(parnetId, GroupRightEntity.All_RightCode);

                                    #region 最多有三層，要處理父層的父層
                                    string grandParnetId = myParentMenu.ParentId;
                                    if (!String.IsNullOrEmpty(grandParnetId) && grandParnetId.Length <= 3 && funcRights.GetKeyFirstIndex(grandParnetId) < 0)
                                    {
                                        FuncMenuEntity myGrandParentMenu = Array.Find<FuncMenuEntity>(funcMenus, x => x.FuncId == grandParnetId);
                                        if (myGrandParentMenu != null)
                                        {
                                            funcRights.Add(grandParnetId, GroupRightEntity.All_RightCode);
                                        }
                                    }
                                    #endregion
                                }
                            }
                            #endregion
                        }
                    }
                }
            }
            if (String.IsNullOrEmpty(groupID))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 更新群組權限資料 (使用交易)
            using (EntityFactory tsFactory = _Factory.CloneForTransaction())
            {
                Result result = null;

                try
                {
                    #region 刪除群組權限資料資料
                    {
                        string sql = String.Format(@"DELETE {0} WHERE Group_Id=@GROUP_ID", GroupRightEntity.TABLE_NAME);
                            KeyValue[] parameters = new KeyValue[] {
                            new KeyValue("@GROUP_ID", groupID)
                        };
                        int count = 0;
                        result = tsFactory.ExecuteNonQuery(sql, parameters, out count);

                        #region 新增日誌資料
                        if (dbLogger != null)
                        {
                            string notation = null;
                            if (result.IsSuccess)
                            {
                                notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                            }
                            else
                            {
                                notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                            }
                            dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                        }
                        #endregion
                    }
                    #endregion

                    #region 新增群組權限資料
                    if (result.IsSuccess)
                    {
                        int totoalCount = 0;
                        string sql = String.Format(@"INSERT INTO {0}(Group_Id, Func_Id, Right_Code, status, crt_date, crt_user) Values(@GroupId, @FuncId, @RightCode, @Status, GETDATE(), @CrtUser) ", GroupRightEntity.TABLE_NAME);
                        foreach (KeyValue<string> funcRightCode in funcRights)
                        {
                            KeyValue[] parameters = new KeyValue[] {
                                new KeyValue("@GroupId", groupID),
                                new KeyValue("@FuncId", funcRightCode.Key),
                                new KeyValue("@RightCode", funcRightCode.Value),
                                new KeyValue("@Status", DataStatusCodeTexts.NORMAL),
                                new KeyValue("@CrtUser", commandAsker.UserId)
                            };

                            int count = 0;
                            result = tsFactory.ExecuteNonQuery(sql, parameters, out count);

                            if (result.IsSuccess)
                            {
                                totoalCount += count;
                            }
                            else
                            {
                                break;
                            }
                        }

                        #region 新增日誌資料
                        if (dbLogger != null)
                        {
                            string notation = null;
                            if (result.IsSuccess)
                            {
                                notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, totoalCount);
                            }
                            else
                            {
                                notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                            }
                            dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                        }
                        #endregion
                    }
                    #endregion
                }
                catch (Exception ex)
                {
                    string notation = String.Format("[{0}] {1}資料發生例外 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, ex.Message);
                    result = new Result(false, notation, CoreStatusCode.UNKNOWN_EXCEPTION, ex);

                    #region 新增日誌資料
                    if (dbLogger != null)
                    {
                        dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.UPDATE, commandAsker.UserId, notation);
                    }
                    #endregion
                }
                finally
                {
                    if (!result.IsSuccess)
                    {
                        if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                        {
                            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_UPDATE_DATA_EXCEPTION, result.Exception);
                        }
                        else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                        {
                            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_UPDATE_DATA_FAILURE, result.Exception);
                        }
                        tsFactory.Rollback();
                    }
                    else
                    {
                        tsFactory.Commit();
                    }

                    #region 儲存日誌資料並釋放資料庫日誌記錄器
                    string logErrmsg = this.ReleaseDBLogger(true);
                    if (dbLogger != null)
                    {
                        dbLogger.Dispose();
                        dbLogger = null;
                    }
                    #endregion
                }

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 複製上傳繳費資料對照表 (Xls)
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyMappingXlsData(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string mappingId = null;
            string mappingName = null;
            string tableName = null;
            string insertFieldsName = string.Empty;
            string insertFieldsValue = string.Empty;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "MAPPINGID":
                        mappingId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "MAPPINGNAME":
                        mappingName = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TABLENAME":
                        tableName = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    default:
                        insertFieldsName += ", " + argument.Key;
                        insertFieldsValue += ", '" + argument.Value + "'";
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(mappingId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製上傳繳費資料對照表 (Xls)

            int count = 0;

            using (EntityFactory tsFactory = _Factory.CloneForTransaction())
            {
                #region 刪除原本的對照表資料
                StringBuilder deleteSql = new StringBuilder();
                deleteSql
                    .AppendFormat("DELETE {0} WHERE ", tableName).AppendLine()
                    .AppendFormat("Receive_Type=@RECEIVE_TYPE and Mapping_Id=@MAPPING_ID ").AppendLine();

                KeyValueList delParameters = new KeyValueList(4);
                delParameters.Add("@RECEIVE_TYPE", receiveType);
                delParameters.Add("@MAPPING_ID", mappingId);
                Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}舊資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}舊資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                }
                #endregion

                if (!result.IsSuccess)
                {
                    tsFactory.Rollback();

                    #region 儲存日誌資料並釋放資料庫日誌記錄器
                    string logErrmsg = this.ReleaseDBLogger(true);
                    if (dbLogger != null)
                    {
                        dbLogger.Dispose();
                        dbLogger = null;
                    }
                    #endregion

                    count = 0;
                    if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                    }
                    else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                    }
                    return result;
                }
                #endregion

                #region 新增對照表資料
                StringBuilder insertSql = new StringBuilder();
                insertSql
                    .AppendFormat("INSERT INTO {0}(Receive_Type, Mapping_Id, Mapping_Name, status, crt_date, crt_user{1}) values( ", tableName, insertFieldsName).AppendLine()
                    .AppendFormat("@RECEIVE_TYPE, @MAPPING_ID, @MAPPING_NAME, '0', GETDATE(), '{0}'{1}) ", commandAsker.UserId, insertFieldsValue).AppendLine();

                KeyValueList insParameters = new KeyValueList(5);
                insParameters.Add("@RECEIVE_TYPE", receiveType);
                insParameters.Add("@MAPPING_ID", mappingId);
                insParameters.Add("@MAPPING_NAME", mappingName);
                result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}新增對照表成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}新增對照表失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                }
                #endregion

                #region 儲存日誌資料並釋放資料庫日誌記錄器
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                    string logErrmsg = this.ReleaseDBLogger(true);
                    dbLogger.Dispose();
                    dbLogger = null;
                }
                #endregion

                if (!result.IsSuccess)
                {
                    tsFactory.Rollback();

                    count = 0;
                    if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                    }
                    else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                    }
                }
                else
                {
                    tsFactory.Commit();
                }

                return result;
                #endregion
            }
            #endregion
        }

        /// <summary>
        /// 複製上傳繳費資料對照表 (Txt)
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyMappingTxtData(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string mappingId = null;
            string mappingName = null;
            string tableName = null;
            string insertFieldsName = string.Empty;
            string insertFieldsValue = string.Empty;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "MAPPINGID":
                        mappingId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "MAPPINGNAME":
                        mappingName = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TABLENAME":
                        tableName = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    default:
                        insertFieldsName += ", " + argument.Key;
                        insertFieldsValue += ", " + argument.Value;
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(mappingId))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 複製上傳繳費資料對照表 (Txt)

            int count = 0;

            #region 刪除原本的對照表資料

            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", tableName).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Mapping_Id=@MAPPING_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(4);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@MAPPING_ID", mappingId);
            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                }
                return result;
            }

            #endregion

            #region 新增對照表資料
            StringBuilder insertSql = new StringBuilder();

            insertSql
                .AppendFormat("INSERT INTO {0}(Receive_Type, Mapping_Id, Mapping_Name, status, crt_date, crt_user{1}) values( ", tableName, insertFieldsName).AppendLine()
                .AppendFormat("@RECEIVE_TYPE, @MAPPING_ID, @MAPPING_NAME, '0', GETDATE(), '{0}'{1}) ", commandAsker.UserId, insertFieldsValue).AppendLine();

            KeyValueList insParameters = new KeyValueList(5);
            insParameters.Add("@RECEIVE_TYPE", receiveType);
            insParameters.Add("@MAPPING_ID", mappingId);
            insParameters.Add("@MAPPING_NAME", mappingName);

            result = _Factory.ExecuteNonQuery(insertSql.ToString(), insParameters, out count);
            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}新增對照表成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                }
                else
                {
                    notation = String.Format("[{0}] {1}新增對照表失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
            }
            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;
            #endregion

            #endregion
        }

        #region 對照檔
        ///// <summary>
        ///// 複製上傳繳費資料對照表 (Xls)
        ///// </summary>
        ///// <param name="commandAsker"></param>
        ///// <param name="arguments"></param>
        ///// <param name="data"></param>
        ///// <returns></returns>
        //public Result SetMappingXlsData(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        //{
        //    data = null;

        //    #region 檢查參數
        //    if (arguments == null || arguments.Count == 0)
        //    {
        //        return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
        //    }
        //    #endregion

        //    #region 取得執行參數
        //    string tableName = null;
        //    string receiveType = null;
        //    string mappingId = null;
        //    string mappingName = null;
        //    KeyValueList<string> fieldDatas = new KeyValueList<string>(arguments.Count - 4);
        //    foreach (KeyValue<string> argument in arguments)
        //    {
        //        string argName = argument.Key.ToUpper();
        //        switch (argName)
        //        {
        //            case "TABLENAME":
        //                tableName = argument.Value == null ? null : argument.Value.Trim();
        //                break;
        //            case "RECEIVETYPE":
        //                receiveType = argument.Value == null ? null : argument.Value.Trim();
        //                break;
        //            case "MAPPINGID":
        //                mappingId = argument.Value == null ? null : argument.Value.Trim();
        //                break;
        //            case "MAPPINGNAME":
        //                mappingName = argument.Value == null ? null : argument.Value.Trim();
        //                break;
        //            default:
        //                fieldDatas.Add(argName, argument.Value == null ? null : argument.Value.Trim());
        //                break;
        //        }
        //    }
        //    string[] tableNames = new string[] {
        //        MappingcsTxtEntity.TABLE_NAME, MappingcsXlsmdbEntity.TABLE_NAME,
        //        MappingloTxtEntity.TABLE_NAME, MappingloXlsmdbEntity.TABLE_NAME,
        //        MappingreTxtEntity.TABLE_NAME, MappingreXlsmdbEntity.TABLE_NAME,
        //        MappingrrTxtEntity.TABLE_NAME, MappingrrXlsmdbEntity.TABLE_NAME,
        //        MappingrtTxtEntity.TABLE_NAME, MappingrtXlsmdbEntity.TABLE_NAME
        //    };
        //    if (String.IsNullOrEmpty(tableName) || !tableNames.Contains(tableName)
        //        || String.IsNullOrEmpty(receiveType)
        //        || String.IsNullOrEmpty(mappingId)
        //        || String.IsNullOrEmpty(mappingName)
        //        || fieldDatas.Count == 0)
        //    {
        //        return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
        //    }
        //    #endregion

        //    #region 取得初始化的資料庫日誌記錄器
        //    DBLogger dbLogger = this.InitialDBLogger(commandAsker);
        //    #endregion

        //    #region 使用交易設定對照檔資料
        //    int count = 0;

        //    using (EntityFactory tsFactory = _Factory.CloneForTransaction())
        //    {
        //        #region 刪除原本的對照表資料
        //        {
        //            string sql = String.Format("DELETE {0} WHERE Receive_Type = @RECEIVE_TYPE AND Mapping_Id = @MAPPING_ID", tableName);

        //            KeyValueList delParameters = new KeyValueList(2);
        //            delParameters.Add("@RECEIVE_TYPE", receiveType);
        //            delParameters.Add("@MAPPING_ID", mappingId);
        //            Result result = _Factory.ExecuteNonQuery(sql.ToString(), delParameters.ToArray(), out count);

        //            #region 新增日誌資料
        //            if (dbLogger != null)
        //            {
        //                string notation = null;
        //                if (result.IsSuccess)
        //                {
        //                    notation = String.Format("[{0}] {1}舊資料 ({2}) 成功 (共{3}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, tableName, count);
        //                }
        //                else
        //                {
        //                    notation = String.Format("[{0}] {1}舊資料 ({2}) 失敗 (錯誤訊息：{3})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, tableName, result.Message);
        //                }
        //                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
        //            }
        //            #endregion

        //            #region 失敗就 Rollback 並離開
        //            if (!result.IsSuccess)
        //            {
        //                tsFactory.Rollback();

        //                #region 儲存日誌資料並釋放資料庫日誌記錄器
        //                string logErrmsg = this.ReleaseDBLogger(true);
        //                if (dbLogger != null)
        //                {
        //                    dbLogger.Dispose();
        //                    dbLogger = null;
        //                }
        //                #endregion

        //                count = 0;
        //                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
        //                {
        //                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
        //                }
        //                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
        //                {
        //                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
        //                }
        //                return result;
        //            }
        //            #endregion
        //        }
        //        #endregion

        //        #region 新增對照表資料
        //        {
        //            StringBuilder sql = new StringBuilder();
        //            sql
        //                .AppendFormat("INSERT INTO {0}(Receive_Type, Mapping_Id, Mapping_Name, status, crt_date, crt_user{1}) values( ", tableName, insertFieldsName).AppendLine()
        //                .AppendFormat("@RECEIVE_TYPE, @MAPPING_ID, @MAPPING_NAME, '0', GETDATE(), '{0}'{1}) ", commandAsker.UserId, insertFieldsValue).AppendLine();

        //            KeyValueList insParameters = new KeyValueList(5);
        //            insParameters.Add("@RECEIVE_TYPE", receiveType);
        //            insParameters.Add("@MAPPING_ID", mappingId);
        //            insParameters.Add("@MAPPING_NAME", mappingName);
        //            result = _Factory.ExecuteNonQuery(sql.ToString(), insParameters, out count);

        //            #region 新增日誌資料
        //            if (dbLogger != null)
        //            {
        //                string notation = null;
        //                if (result.IsSuccess)
        //                {
        //                    notation = String.Format("[{0}] {1}新增對照表成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
        //                }
        //                else
        //                {
        //                    notation = String.Format("[{0}] {1}新增對照表失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
        //                }
        //                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
        //            }
        //            #endregion

        //            #region 儲存日誌資料並釋放資料庫日誌記錄器
        //            if (dbLogger != null)
        //            {
        //                string notation = null;
        //                if (result.IsSuccess)
        //                {
        //                    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
        //                }
        //                else
        //                {
        //                    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
        //                }
        //                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
        //                string logErrmsg = this.ReleaseDBLogger(true);
        //                dbLogger.Dispose();
        //                dbLogger = null;
        //            }
        //            #endregion

        //            if (!result.IsSuccess)
        //            {
        //                tsFactory.Rollback();

        //                count = 0;
        //                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
        //                {
        //                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
        //                }
        //                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
        //                {
        //                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
        //                }
        //            }
        //            else
        //            {
        //                tsFactory.Commit();
        //            }

        //            return result;
        //        }
        //        #endregion
        //    }
        //    #endregion
        //}
        #endregion

        #region 複製 / 刪除 代碼檔與標準檔相關
        /// <summary>
        /// 複製代碼檔與標準檔
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result CopyBaseData(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId1 = null;
            string yearId2 = null;
            string termId1 = null;
            string termId2 = null;
            List<string> entityNames = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID1":
                        yearId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID2":
                        yearId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID1":
                        termId1 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID2":
                        termId2 = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "ENTITYNAMES":
                        if (!String.IsNullOrWhiteSpace(argument.Value))
                        {
                            string[] values = argument.Value.Trim().Split(new char[] { ',' });
                            entityNames = new List<string>(values.Length);
                            foreach(string value in values)
                            {
                                if (!String.IsNullOrWhiteSpace(value))
                                {
                                    entityNames.Add(value.Trim());
                                }
                            }
                        }
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId1)
                || String.IsNullOrEmpty(yearId2)
                || String.IsNullOrEmpty(termId1)
                || String.IsNullOrEmpty(termId2)
                || entityNames == null || entityNames.Count == 0)
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            StringBuilder msgs = new StringBuilder();

            #region 複製部別代碼
            if (entityNames.Contains(DeptListEntity.TABLE_NAME))
            {
                Result result = this.CopyDeptListData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製部別代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製部別代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 複製院別代碼
            if (entityNames.Contains(CollegeListEntity.TABLE_NAME))
            {
                Result result = this.CopyCollegeListData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製院別代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製院別代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 複製科系代碼
            if (entityNames.Contains(MajorListEntity.TABLE_NAME))
            {
                Result result = this.CopyMajorListData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製科系代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製科系代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 複製班別代碼
            if (entityNames.Contains(ClassListEntity.TABLE_NAME))
            {
                Result result = this.CopyClassListData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製班別代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製班別代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 複製減免類別代碼
            if (entityNames.Contains(ReduceListEntity.TABLE_NAME))
            {
                Result result = this.CopyReduceListData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製減免類別代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製減免類別代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 複製住宿代碼
            if (entityNames.Contains(DormListEntity.TABLE_NAME))
            {
                Result result = this.CopyDormListData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製住宿代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製住宿代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 複製就貸代碼
            if (entityNames.Contains(LoanListEntity.TABLE_NAME))
            {
                Result result = this.CopyLoanListData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製就貸代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製就貸代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 複製退費代碼
            if (entityNames.Contains(ReturnListEntity.TABLE_NAME))
            {
                Result result = this.CopyReturnListData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製退費代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製退費代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 複製身分註記代碼
            if (entityNames.Contains(IdentifyList1Entity.TABLE_NAME))
            {
                string[] tableNames = new string[] {
                    IdentifyList1Entity.TABLE_NAME, IdentifyList2Entity.TABLE_NAME, IdentifyList3Entity.TABLE_NAME,
                    IdentifyList4Entity.TABLE_NAME, IdentifyList5Entity.TABLE_NAME, IdentifyList6Entity.TABLE_NAME
                };
                int no = 0;
                foreach (string tableName in tableNames)
                {
                    no++;
                    Result result = this.CopyIdentifyListData(commandAsker, dbLogger, tableName, receiveType, yearId1, termId1, yearId2, termId2);
                    if (result.IsSuccess)
                    {
                        msgs.AppendFormat("複製身分註記{0}代碼資料成功", no).AppendLine();
                    }
                    else
                    {
                        msgs.AppendFormat("複製身分註記{0}代碼資料失敗，錯誤訊息：{1}", no, result.Message).AppendLine();
                    }
                }
            }
            #endregion

            #region 複製代收費用別代碼
            if (entityNames.Contains(ReceiveListEntity.TABLE_NAME))
            {
                Result result = this.CopyReceiveListData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製代收費用別代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製代收費用別代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 複製代收費用別設定
            if (entityNames.Contains(SchoolRidEntity.TABLE_NAME))
            {
                Result result = this.CopySchoolRidData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製代收費用別代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製代收費用別代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion


            #region 一般收費標準
            if (entityNames.Contains(GeneralStandardEntity.TABLE_NAME))
            {
                Result result = this.CopyGeneralStandardData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製一般收費標準資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製一般收費標準資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 小於基數其他收費標準
            if (entityNames.Contains(Credit2StandardEntity.TABLE_NAME))
            {
                Result result = this.CopyCredit2StandardData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製小於基數其他收費標準資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製小於基數其他收費標準資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 學分費收費標準
            if (entityNames.Contains(CreditStandardEntity.TABLE_NAME))
            {
                Result result = this.CopyCreditStandardData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製學分費收費標準資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製學分費收費標準資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 住宿費收費標準
            if (entityNames.Contains(DormStandardEntity.TABLE_NAME))
            {
                Result result = this.CopyDormStandardData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製住宿費收費標準資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製住宿費收費標準資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 學分費基準收費標準
            if (entityNames.Contains(CreditbStandardEntity.TABLE_NAME))
            {
                Result result = this.CopyCreditbStandardData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製學分費基準收費標準資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製學分費基準收費標準資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 課程收費標準
            if (entityNames.Contains(ClassStandardEntity.TABLE_NAME))
            {
                Result result = this.CopyClassStandardData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製課程收費標準資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製課程收費標準資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 減免收費標準
            if (entityNames.Contains(ReduceStandardEntity.TABLE_NAME))
            {
                Result result = this.CopyReduceStandardData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製減免收費標準資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製減免收費標準資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 就貸收費標準
            if (entityNames.Contains(LoanStandardEntity.TABLE_NAME))
            {
                Result result = this.CopyLoanStandardData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製就貸收費標準資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製就貸收費標準資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 退費收費標準
            if (entityNames.Contains(ReturnStandardEntity.TABLE_NAME))
            {
                Result result = this.CopyReturnStandardData(commandAsker, dbLogger, receiveType, yearId1, termId1, yearId2, termId2);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("複製退費收費標準資料成功");
                }
                else
                {
                    msgs.AppendFormat("複製退費收費標準資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 複製身分註記收費標準
            if (entityNames.Contains(IdentifyStandard1Entity.TABLE_NAME))
            {
                string[] tableNames = new string[] {
                    IdentifyStandard1Entity.TABLE_NAME, IdentifyStandard2Entity.TABLE_NAME, IdentifyStandard3Entity.TABLE_NAME,
                    IdentifyStandard4Entity.TABLE_NAME, IdentifyStandard5Entity.TABLE_NAME, IdentifyStandard6Entity.TABLE_NAME
                };
                int no = 0;
                foreach (string tableName in tableNames)
                {
                    no++;
                    Result result = this.CopyIdentifyStandardData(commandAsker, dbLogger, tableName, receiveType, yearId1, termId1, yearId2, termId2);
                    if (result.IsSuccess)
                    {
                        msgs.AppendFormat("複製身分註記{0}收費標準資料成功", no).AppendLine();
                    }
                    else
                    {
                        msgs.AppendFormat("複製身分註記{0}收費標準資料失敗，錯誤訊息：{1}", no, result.Message).AppendLine();
                    }
                }
            }
            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            data = msgs.ToString();

            return new Result(true);
        }

        /// <summary>
        /// 刪除代碼檔與標準檔
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DeleteBaseData(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            List<string> entityNames = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "ENTITYNAMES":
                        if (!String.IsNullOrWhiteSpace(argument.Value))
                        {
                            string[] values = argument.Value.Trim().Split(new char[] { ',' });
                            entityNames = new List<string>(values.Length);
                            foreach (string value in values)
                            {
                                if (!String.IsNullOrWhiteSpace(value))
                                {
                                    entityNames.Add(value.Trim());
                                }
                            }
                        }
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId)
                || entityNames == null || entityNames.Count == 0)
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            StringBuilder msgs = new StringBuilder();

            #region 刪除部別代碼
            if (entityNames.Contains(DeptListEntity.TABLE_NAME))
            {
                Result result = this.DeleteDeptListData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除部別代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除部別代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 刪除院別代碼
            if (entityNames.Contains(CollegeListEntity.TABLE_NAME))
            {
                Result result = this.DeleteCollegeListData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除院別代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除院別代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 刪除科系代碼
            if (entityNames.Contains(MajorListEntity.TABLE_NAME))
            {
                Result result = this.DeleteMajorListData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除科系代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除科系代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 刪除班別代碼
            if (entityNames.Contains(ClassListEntity.TABLE_NAME))
            {
                Result result = this.DeleteClassListData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除班別代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除班別代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 刪除減免類別代碼
            if (entityNames.Contains(ReduceListEntity.TABLE_NAME))
            {
                Result result = this.DeleteReduceListData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除減免類別代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除減免類別代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 刪除住宿代碼
            if (entityNames.Contains(DormListEntity.TABLE_NAME))
            {
                Result result = this.DeleteDormListData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除住宿代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除住宿代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 刪除就貸代碼
            if (entityNames.Contains(LoanListEntity.TABLE_NAME))
            {
                Result result = this.DeleteLoanListData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除就貸代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除就貸代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 刪除退費代碼
            if (entityNames.Contains(ReturnListEntity.TABLE_NAME))
            {
                Result result = this.DeleteReturnListData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除退費代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除退費代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 刪除身分註記代碼
            if (entityNames.Contains(IdentifyList1Entity.TABLE_NAME))
            {
                string[] tableNames = new string[] {
                    IdentifyList1Entity.TABLE_NAME, IdentifyList2Entity.TABLE_NAME, IdentifyList3Entity.TABLE_NAME,
                    IdentifyList4Entity.TABLE_NAME, IdentifyList5Entity.TABLE_NAME, IdentifyList6Entity.TABLE_NAME
                };
                int no = 0;
                foreach (string tableName in tableNames)
                {
                    no++;
                    Result result = this.DeleteIdentifyListData(commandAsker, dbLogger, tableName, receiveType, yearId, termId);
                    if (result.IsSuccess)
                    {
                        msgs.AppendFormat("刪除身分註記{0}代碼資料成功", no).AppendLine();
                    }
                    else
                    {
                        msgs.AppendFormat("刪除身分註記{0}代碼資料失敗，錯誤訊息：{1}", no, result.Message).AppendLine();
                    }
                }
            }
            #endregion

            #region 刪除代收費用別代碼
            if (entityNames.Contains(ReceiveListEntity.TABLE_NAME))
            {
                Result result = this.DeleteReceiveListData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除代收費用別代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除代收費用別代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 刪除代收費用別設定
            if (entityNames.Contains(SchoolRidEntity.TABLE_NAME))
            {
                Result result = this.DeleteSchoolRidData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除代收費用別代碼資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除代收費用別代碼資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion


            #region 一般收費標準
            if (entityNames.Contains(GeneralStandardEntity.TABLE_NAME))
            {
                Result result = this.DeleteGeneralStandardData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除一般收費標準資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除一般收費標準資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 小於基數其他收費標準
            if (entityNames.Contains(Credit2StandardEntity.TABLE_NAME))
            {
                Result result = this.DeleteCredit2StandardData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除小於基數其他收費標準資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除小於基數其他收費標準資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 學分費收費標準
            if (entityNames.Contains(CreditStandardEntity.TABLE_NAME))
            {
                Result result = this.DeleteCreditStandardData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除學分費收費標準資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除學分費收費標準資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 住宿費收費標準
            if (entityNames.Contains(DormStandardEntity.TABLE_NAME))
            {
                Result result = this.DeleteDormStandardData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除住宿費收費標準資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除住宿費收費標準資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 學分費基準收費標準
            if (entityNames.Contains(CreditbStandardEntity.TABLE_NAME))
            {
                Result result = this.DeleteCreditbStandardData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除學分費基準收費標準資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除學分費基準收費標準資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 課程收費標準
            if (entityNames.Contains(ClassStandardEntity.TABLE_NAME))
            {
                Result result = this.DeleteClassStandardData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除課程收費標準資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除課程收費標準資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 減免收費標準
            if (entityNames.Contains(ReduceStandardEntity.TABLE_NAME))
            {
                Result result = this.DeleteReduceStandardData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除減免收費標準資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除減免收費標準資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 就貸收費標準
            if (entityNames.Contains(LoanStandardEntity.TABLE_NAME))
            {
                Result result = this.DeleteLoanStandardData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除就貸收費標準資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除就貸收費標準資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 退費收費標準
            if (entityNames.Contains(ReturnStandardEntity.TABLE_NAME))
            {
                Result result = this.DeleteReturnStandardData(commandAsker, dbLogger, receiveType, yearId, termId);
                if (result.IsSuccess)
                {
                    msgs.AppendLine("刪除退費收費標準資料成功");
                }
                else
                {
                    msgs.AppendFormat("刪除退費收費標準資料失敗，錯誤訊息：{0}", result.Message).AppendLine();
                }
            }
            #endregion

            #region 刪除身分註記收費標準
            if (entityNames.Contains(IdentifyStandard1Entity.TABLE_NAME))
            {
                string[] tableNames = new string[] {
                    IdentifyStandard1Entity.TABLE_NAME, IdentifyStandard2Entity.TABLE_NAME, IdentifyStandard3Entity.TABLE_NAME,
                    IdentifyStandard4Entity.TABLE_NAME, IdentifyStandard5Entity.TABLE_NAME, IdentifyStandard6Entity.TABLE_NAME
                };
                int no = 0;
                foreach (string tableName in tableNames)
                {
                    no++;
                    Result result = this.DeleteIdentifyStandardData(commandAsker, dbLogger, tableName, receiveType, yearId, termId);
                    if (result.IsSuccess)
                    {
                        msgs.AppendFormat("刪除身分註記{0}收費標準資料成功", no).AppendLine();
                    }
                    else
                    {
                        msgs.AppendFormat("刪除身分註記{0}收費標準資料失敗，錯誤訊息：{1}", no, result.Message).AppendLine();
                    }
                }
            }
            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            data = msgs.ToString();

            return new Result(true);
        }

        #region 代碼檔
        /// <summary>
        /// 刪除部別代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteDeptListData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", DeptListEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}部別代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}部別代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製部別代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns>傳回處理結果</returns>
        private Result CopyDeptListData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteDeptListData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                StringBuilder sql = new StringBuilder();

                #region [MDY:202203XX] 2022擴充案 部別英文名稱 欄位
                sql
                    .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dept_Id, Dept_Name, status, crt_date, crt_user, Dept_EName) ", DeptListEntity.TABLE_NAME).AppendLine()
                    .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dept_Id, Dept_Name, status, GETDATE() crt_date, '{0}' crt_user, Dept_EName ", commandAsker.UserId).AppendLine()
                    .AppendFormat("  FROM {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID1 AND Term_Id=@TERM_ID1 ", DeptListEntity.TABLE_NAME).AppendLine();
                #endregion

                KeyValueList parameters = new KeyValueList(5);
                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);
                parameters.Add("@YEAR_ID2", tagYearId);
                parameters.Add("@TERM_ID2", tagTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 部別代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 部別代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除院別代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteCollegeListData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", CollegeListEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}院別代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}院別代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製院別代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns>傳回處理結果</returns>
        private Result CopyCollegeListData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteCollegeListData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                StringBuilder sql = new StringBuilder();

                #region [MDY:202203XX] 2022擴充案 院別英文名稱 欄位
                sql
                    .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dep_Id, College_Id, College_Name, status, crt_date, crt_user, College_EName) ", CollegeListEntity.TABLE_NAME).AppendLine()
                    .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dep_Id, College_Id, College_Name, status, GETDATE() crt_date, '{0}' crt_user, College_EName ", commandAsker.UserId).AppendLine()
                    .AppendFormat("  FROM {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID1 AND Term_Id=@TERM_ID1 ", CollegeListEntity.TABLE_NAME).AppendLine();
                #endregion

                KeyValueList parameters = new KeyValueList(5);
                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);
                parameters.Add("@YEAR_ID2", tagYearId);
                parameters.Add("@TERM_ID2", tagTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 院別代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 院別代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除科系代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteMajorListData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", MajorListEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}科系代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}科系代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製科系代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns>傳回處理結果</returns>
        private Result CopyMajorListData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteMajorListData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                StringBuilder sql = new StringBuilder();

                #region [MDY:202203XX] 2022擴充案 科系英文名稱 欄位
                sql
                    .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dep_Id, Major_Id, Major_Name, status, crt_date, crt_user, Major_EName) ", MajorListEntity.TABLE_NAME).AppendLine()
                    .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dep_Id, Major_Id, Major_Name, status, GETDATE() crt_date, '{0}' crt_user, Major_EName ", commandAsker.UserId).AppendLine()
                    .AppendFormat("  FROM {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID1 AND Term_Id=@TERM_ID1 ", MajorListEntity.TABLE_NAME).AppendLine();
                #endregion

                KeyValueList parameters = new KeyValueList(5);
                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);
                parameters.Add("@YEAR_ID2", tagYearId);
                parameters.Add("@TERM_ID2", tagTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 科系代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 科系代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除班別代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteClassListData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", ClassListEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}班別代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}班別代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製班別代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns>傳回處理結果</returns>
        private Result CopyClassListData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteClassListData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                StringBuilder sql = new StringBuilder();

                #region [MDY:202203XX] 2022擴充案 班別英文名稱 欄位
                sql
                    .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dep_Id, Class_Id, Class_Name, status, crt_date, crt_user, Class_EName) ", ClassListEntity.TABLE_NAME).AppendLine()
                    .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dep_Id, Class_Id, Class_Name, status, GETDATE() crt_date, '{0}' crt_user, Class_EName ", commandAsker.UserId).AppendLine()
                    .AppendFormat("  FROM {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID1 AND Term_Id=@TERM_ID1 ", ClassListEntity.TABLE_NAME).AppendLine();
                #endregion

                KeyValueList parameters = new KeyValueList(5);
                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);
                parameters.Add("@YEAR_ID2", tagYearId);
                parameters.Add("@TERM_ID2", tagTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 班別代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 班別代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除減免類別代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteReduceListData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", ReduceListEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}減免類別代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}減免類別代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製減免類別代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns>傳回處理結果</returns>
        private Result CopyReduceListData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteReduceListData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                StringBuilder sql = new StringBuilder();

                #region [MDY:202203XX] 2022擴充案 減免類別英文名稱 欄位
                sql
                    .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dep_Id, Reduce_Id, Reduce_Name, status, crt_date, crt_user, Reduce_EName) ", ReduceListEntity.TABLE_NAME).AppendLine()
                    .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dep_Id, Reduce_Id, Reduce_Name, status, GETDATE() crt_date, '{0}' crt_user, Reduce_EName ", commandAsker.UserId).AppendLine()
                    .AppendFormat("  FROM {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID1 AND Term_Id=@TERM_ID1 ", ReduceListEntity.TABLE_NAME).AppendLine();
                #endregion

                KeyValueList parameters = new KeyValueList(5);
                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);
                parameters.Add("@YEAR_ID2", tagYearId);
                parameters.Add("@TERM_ID2", tagTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 減免類別代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 減免類別代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除住宿代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteDormListData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", DormListEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}住宿代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}住宿代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製住宿代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns>傳回處理結果</returns>
        private Result CopyDormListData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteDormListData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                StringBuilder sql = new StringBuilder();

                #region [MDY:202203XX] 2022擴充案 住宿英文名稱 欄位
                sql
                    .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dep_Id, Dorm_Id, Dorm_Name, status, crt_date, crt_user, Dorm_EName) ", DormListEntity.TABLE_NAME).AppendLine()
                    .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dep_Id, Dorm_Id, Dorm_Name, status, GETDATE() crt_date, '{0}' crt_user, Dorm_EName ", commandAsker.UserId).AppendLine()
                    .AppendFormat("  FROM {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID1 AND Term_Id=@TERM_ID1 ", DormListEntity.TABLE_NAME).AppendLine();
                #endregion

                KeyValueList parameters = new KeyValueList(5);
                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);
                parameters.Add("@YEAR_ID2", tagYearId);
                parameters.Add("@TERM_ID2", tagTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 住宿代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 住宿代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除就貸代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteLoanListData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", LoanListEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}就貸代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}就貸代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製就貸代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns>傳回處理結果</returns>
        private Result CopyLoanListData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteLoanListData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                StringBuilder sql = new StringBuilder();

                #region [MDY:202203XX] 2022擴充案 就貸英文名稱 欄位
                sql
                    .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dep_Id, Loan_Id, Loan_Name, status, crt_date, crt_user, Loan_EName) ", LoanListEntity.TABLE_NAME).AppendLine()
                    .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dep_Id, Loan_Id, Loan_Name, status, GETDATE() crt_date, '{0}' crt_user, Loan_EName ", commandAsker.UserId).AppendLine()
                    .AppendFormat("  FROM {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID1 AND Term_Id=@TERM_ID1 ", LoanListEntity.TABLE_NAME).AppendLine();
                #endregion

                KeyValueList parameters = new KeyValueList(5);
                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);
                parameters.Add("@YEAR_ID2", tagYearId);
                parameters.Add("@TERM_ID2", tagTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 就貸代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 就貸代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除退費代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteReturnListData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", ReturnListEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}退費代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}退費代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製退費代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns>傳回處理結果</returns>
        private Result CopyReturnListData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteReturnListData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                StringBuilder sql = new StringBuilder();

                #region [MDY:202203XX] 2022擴充案 退費英文名稱 欄位
                sql
                    .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dep_Id, Return_Id, Return_Name, status, crt_date, crt_user, Return_EName) ", ReturnListEntity.TABLE_NAME).AppendLine()
                    .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dep_Id, Return_Id, Return_Name, status, GETDATE() crt_date, '{0}' crt_user, Return_EName ", commandAsker.UserId).AppendLine()
                    .AppendFormat(" FROM {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID1 AND Term_Id=@TERM_ID1 ", ReturnListEntity.TABLE_NAME).AppendLine();
                #endregion

                KeyValueList parameters = new KeyValueList(5);
                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);
                parameters.Add("@YEAR_ID2", tagYearId);
                parameters.Add("@TERM_ID2", tagTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 退費代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 退費代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除身分註記代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="tableName">指定身分註記資料表</param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteIdentifyListData(CommandAsker commandAsker, DBLogger dbLogger, string tableName, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", tableName).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}身分註記代碼({3})資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count, tableName);
                }
                else
                {
                    notation = String.Format("[{0}] {1}身分註記代碼({3})資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message, tableName);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製身分註記代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="tableName">指定身分註記資料表</param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns>傳回處理結果</returns>
        private Result CopyIdentifyListData(CommandAsker commandAsker, DBLogger dbLogger, string tableName, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteIdentifyListData(commandAsker, dbLogger, tableName, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                StringBuilder sql = new StringBuilder();

                #region [MDY:202203XX] 2022擴充案 身分註記英文名稱 欄位
                sql
                    .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dep_Id, Identify_Id, Identify_Name, status, crt_date, crt_user, Identify_EName) ", tableName).AppendLine()
                    .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dep_Id, Identify_Id, Identify_Name, status, GETDATE() crt_date, '{0}' crt_user, Identify_EName ", commandAsker.UserId).AppendLine()
                    .AppendFormat("  FROM {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID1 AND Term_Id=@TERM_ID1 ", tableName).AppendLine();
                #endregion

                KeyValueList parameters = new KeyValueList(5);
                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);
                parameters.Add("@YEAR_ID2", tagYearId);
                parameters.Add("@TERM_ID2", tagTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 身分註記代碼({3})資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count, tableName);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 身分註記代碼({3})資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message, tableName);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除身分註記代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteReceiveListData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", ReceiveListEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}代收費用別代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}代收費用別代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製代收費用別代碼資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns>傳回處理結果</returns>
        private Result CopyReceiveListData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteReceiveListData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                StringBuilder sql = new StringBuilder();

                #region [MDY:202203XX] 2022擴充案 代收費用別英文名稱 欄位
                sql
                    .AppendFormat("INSERT INTO {0}(Receive_Type, Year_Id, Term_Id, Dep_Id, Receive_Id, Receive_Name, status, crt_date, crt_user, Receive_EName) ", ReceiveListEntity.TABLE_NAME).AppendLine()
                    .AppendFormat("SELECT Receive_Type, @YEAR_ID2 Year_Id, @TERM_ID2 Term_Id, Dep_Id, Receive_Id, Receive_Name, status, GETDATE() crt_date, '{0}' crt_user, Receive_EName ", commandAsker.UserId).AppendLine()
                    .AppendFormat("  FROM {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID1 AND Term_Id=@TERM_ID1 ", ReceiveListEntity.TABLE_NAME).AppendLine();
                #endregion

                KeyValueList parameters = new KeyValueList(5);
                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);
                parameters.Add("@YEAR_ID2", tagYearId);
                parameters.Add("@TERM_ID2", tagTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 代收費用別代碼資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 代收費用別代碼資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除代收費用別設定資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteSchoolRidData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", SchoolRidEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}代收費用別設定資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}代收費用別設定資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製代收費用別設定資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns>傳回處理結果</returns>
        private Result CopySchoolRidData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteSchoolRidData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                #region [Old]
//                StringBuilder sql = new StringBuilder();
//                sql
//                    .AppendFormat(@"INSERT INTO {0}([Receive_Type], [Receive_status], [Year_Id], [Term_Id], [Dep_Id], [Receive_Id]
//     , [Sch_Word], [Sch_Accounting], [Sch_Cashier], [Pay_Date], [DelM_Date], [Student_Type]
//     , [CS_Type], [Credit_Item], [Return_Item], [Credit_Basic], [Billing_Type]
//     , [Receive_Item01], [Receive_Item02], [Receive_Item03], [Receive_Item04], [Receive_Item05]
//     , [Receive_Item06], [Receive_Item07], [Receive_Item08], [Receive_Item09], [Receive_Item10]
//     , [Receive_Item11], [Receive_Item12], [Receive_Item13], [Receive_Item14], [Receive_Item15]
//     , [Receive_Item16], [Receive_Item17], [Receive_Item18], [Receive_Item19], [Receive_Item20]
//     , [Receive_Item21], [Receive_Item22], [Receive_Item23], [Receive_Item24], [Receive_Item25]
//     , [Receive_Item26], [Receive_Item27], [Receive_Item28], [Receive_Item29], [Receive_Item30]
//     , [Receive_Item31], [Receive_Item32], [Receive_Item33], [Receive_Item34], [Receive_Item35]
//     , [Receive_Item36], [Receive_Item37], [Receive_Item38], [Receive_Item39], [Receive_Item40]
//     , [Loan_Item01], [Loan_Item02], [Loan_Item03], [Loan_Item04], [Loan_Item05]
//     , [Loan_Item06], [Loan_Item07], [Loan_Item08], [Loan_Item09], [Loan_Item10]
//     , [Loan_Item11], [Loan_Item12], [Loan_Item13], [Loan_Item14], [Loan_Item15]
//     , [Loan_Item16], [Loan_Item17], [Loan_Item18], [Loan_Item19], [Loan_Item20]
//     , [Loan_Item21], [Loan_Item22], [Loan_Item23], [Loan_Item24], [Loan_Item25]
//     , [Loan_Item26], [Loan_Item27], [Loan_Item28], [Loan_Item29], [Loan_Item30]
//     , [Loan_Item31], [Loan_Item32], [Loan_Item33], [Loan_Item34], [Loan_Item35]
//     , [Loan_Item36], [Loan_Item37], [Loan_Item38], [Loan_Item39], [Loan_Item40]
//     , [Loan_Fee] 
//     , [Agency_Item01], [Agency_Item02], [Agency_Item03], [Agency_Item04], [Agency_Item05]
//     , [Agency_Item06], [Agency_Item07], [Agency_Item08], [Agency_Item09], [Agency_Item10]
//     , [Agency_Item11], [Agency_Item12], [Agency_Item13], [Agency_Item14], [Agency_Item15]
//     , [Agency_Item16], [Agency_Item17], [Agency_Item18], [Agency_Item19], [Agency_Item20]
//     , [Agency_Item21], [Agency_Item22], [Agency_Item23], [Agency_Item24], [Agency_Item25]
//     , [Agency_Item26], [Agency_Item27], [Agency_Item28], [Agency_Item29], [Agency_Item30]
//     , [Agency_Item31], [Agency_Item32], [Agency_Item33], [Agency_Item34], [Agency_Item35]
//     , [Agency_Item36], [Agency_Item37], [Agency_Item38], [Agency_Item39], [Agency_Item40]
//     , [Agency_Check01], [Agency_Check02], [Agency_Check03], [Agency_Check04], [Agency_Check05]
//     , [Agency_Check06], [Agency_Check07], [Agency_Check08], [Agency_Check09], [Agency_Check10]
//     , [Agency_Check11], [Agency_Check12], [Agency_Check13], [Agency_Check14], [Agency_Check15]
//     , [Agency_Check16], [Agency_Check17], [Agency_Check18], [Agency_Check19], [Agency_Check20]
//     , [Agency_Check21], [Agency_Check22], [Agency_Check23], [Agency_Check24], [Agency_Check25]
//     , [Agency_Check26], [Agency_Check27], [Agency_Check28], [Agency_Check29], [Agency_Check30]
//     , [Agency_Check31], [Agency_Check32], [Agency_Check33], [Agency_Check34], [Agency_Check35]
//     , [Agency_Check36], [Agency_Check37], [Agency_Check38], [Agency_Check39], [Agency_Check40]
//     , [Receive_Memo], [File_Name], [File_Path], [Flag_RL], [fee_flag], [PayStyle]
//     , [A_Title1], [A_Name1], [A_Title2], [A_Name2], [A_Title3], [A_Name3]
//     , [B_Title1], [B_Name1], [B_Title2], [B_Name2], [B_Title3], [B_Name3]
//     , [ItemA1], [ItemA2], [ItemA3], [ItemA4], [ItemA5], [ItemA6], [ItemA7], [ItemA8] 
//     , [ItemA9], [ItemA10], [ItemA11], [ItemA12], [ItemA13], [ItemA14], [ItemA15], [ItemA16]
//     , [Receive_MemoA], [Receive_MemoB], [Update_Who], [Update_Time], [Extra_Days], [loan_qual]
//     , [brief1], [brief2], [brief3], [brief4], [brief5], [brief6]
//     , [Bill_Valid_Date], [hide], [sch_level], [edu_tax], [stay_tax], [enabled_tax], [Bill_Close_Date], [BillForm_id]
//     , [isSubsidy01], [isSubsidy02], [isSubsidy03], [isSubsidy04], [isSubsidy05] 
//     , [isSubsidy06], [isSubsidy07], [isSubsidy08], [isSubsidy09], [isSubsidy10]
//     , [isSubsidy11], [isSubsidy12], [isSubsidy13], [isSubsidy14], [isSubsidy15]
//     , [isSubsidy16], [isSubsidy17], [isSubsidy18], [isSubsidy19], [isSubsidy20]
//     , [isSubsidy21], [isSubsidy22], [isSubsidy23], [isSubsidy24], [isSubsidy25]
//     , [isSubsidy26], [isSubsidy27], [isSubsidy28], [isSubsidy29], [isSubsidy30]
//     , [isSubsidy31], [isSubsidy32], [isSubsidy33], [isSubsidy34], [isSubsidy35]
//     , [isSubsidy36], [isSubsidy37], [isSubsidy38], [isSubsidy39], [isSubsidy40]
//     , [Post_Extra_Days], [C_Title1], [C_Name1], [C_Title2], [C_Name2], [C_Title3], [C_Name3], [Receive_MemoC] 
//     , [useStamp], [A_Stamp1], [A_Stamp2], [A_Stamp3], [B_Stamp1], [B_Stamp2], [B_Stamp3], [C_Stamp1], [C_Stamp2], [C_Stamp3]
//     , [useWaterMark], [watermark], [invoiceform_id], [usePostDueDay], [Loan_Item_Others] 
//     , [isSubsidy_Others], [Agency_Item_Others], [Agency_Check_Others], [Pay_Due_Date2], [Pay_Due_Date3]
//     , [Memo_Title01], [Memo_Title02], [Memo_Title03], [Memo_Title04], [Memo_Title05]
//     , [Memo_Title06], [Memo_Title07], [Memo_Title08], [Memo_Title09], [Memo_Title10])
//SELECT [Receive_Type], [Receive_status], @YEAR_ID2 [Year_Id], @TERM_ID2 [Term_Id], [Dep_Id], [Receive_Id]
//     , [Sch_Word], [Sch_Accounting], [Sch_Cashier], [Pay_Date], [DelM_Date], [Student_Type]
//     , [CS_Type], [Credit_Item], [Return_Item], [Credit_Basic], [Billing_Type]
//     , [Receive_Item01], [Receive_Item02], [Receive_Item03], [Receive_Item04], [Receive_Item05]
//     , [Receive_Item06], [Receive_Item07], [Receive_Item08], [Receive_Item09], [Receive_Item10]
//     , [Receive_Item11], [Receive_Item12], [Receive_Item13], [Receive_Item14], [Receive_Item15]
//     , [Receive_Item16], [Receive_Item17], [Receive_Item18], [Receive_Item19], [Receive_Item20]
//     , [Receive_Item21], [Receive_Item22], [Receive_Item23], [Receive_Item24], [Receive_Item25]
//     , [Receive_Item26], [Receive_Item27], [Receive_Item28], [Receive_Item29], [Receive_Item30]
//     , [Receive_Item31], [Receive_Item32], [Receive_Item33], [Receive_Item34], [Receive_Item35]
//     , [Receive_Item36], [Receive_Item37], [Receive_Item38], [Receive_Item39], [Receive_Item40]
//     , [Loan_Item01], [Loan_Item02], [Loan_Item03], [Loan_Item04], [Loan_Item05]
//     , [Loan_Item06], [Loan_Item07], [Loan_Item08], [Loan_Item09], [Loan_Item10]
//     , [Loan_Item11], [Loan_Item12], [Loan_Item13], [Loan_Item14], [Loan_Item15]
//     , [Loan_Item16], [Loan_Item17], [Loan_Item18], [Loan_Item19], [Loan_Item20]
//     , [Loan_Item21], [Loan_Item22], [Loan_Item23], [Loan_Item24], [Loan_Item25]
//     , [Loan_Item26], [Loan_Item27], [Loan_Item28], [Loan_Item29], [Loan_Item30]
//     , [Loan_Item31], [Loan_Item32], [Loan_Item33], [Loan_Item34], [Loan_Item35]
//     , [Loan_Item36], [Loan_Item37], [Loan_Item38], [Loan_Item39], [Loan_Item40]
//     , [Loan_Fee] 
//     , [Agency_Item01], [Agency_Item02], [Agency_Item03], [Agency_Item04], [Agency_Item05]
//     , [Agency_Item06], [Agency_Item07], [Agency_Item08], [Agency_Item09], [Agency_Item10]
//     , [Agency_Item11], [Agency_Item12], [Agency_Item13], [Agency_Item14], [Agency_Item15]
//     , [Agency_Item16], [Agency_Item17], [Agency_Item18], [Agency_Item19], [Agency_Item20]
//     , [Agency_Item21], [Agency_Item22], [Agency_Item23], [Agency_Item24], [Agency_Item25]
//     , [Agency_Item26], [Agency_Item27], [Agency_Item28], [Agency_Item29], [Agency_Item30]
//     , [Agency_Item31], [Agency_Item32], [Agency_Item33], [Agency_Item34], [Agency_Item35]
//     , [Agency_Item36], [Agency_Item37], [Agency_Item38], [Agency_Item39], [Agency_Item40]
//     , [Agency_Check01], [Agency_Check02], [Agency_Check03], [Agency_Check04], [Agency_Check05]
//     , [Agency_Check06], [Agency_Check07], [Agency_Check08], [Agency_Check09], [Agency_Check10]
//     , [Agency_Check11], [Agency_Check12], [Agency_Check13], [Agency_Check14], [Agency_Check15]
//     , [Agency_Check16], [Agency_Check17], [Agency_Check18], [Agency_Check19], [Agency_Check20]
//     , [Agency_Check21], [Agency_Check22], [Agency_Check23], [Agency_Check24], [Agency_Check25]
//     , [Agency_Check26], [Agency_Check27], [Agency_Check28], [Agency_Check29], [Agency_Check30]
//     , [Agency_Check31], [Agency_Check32], [Agency_Check33], [Agency_Check34], [Agency_Check35]
//     , [Agency_Check36], [Agency_Check37], [Agency_Check38], [Agency_Check39], [Agency_Check40]
//     , [Receive_Memo], [File_Name], [File_Path], [Flag_RL], [fee_flag], [PayStyle]
//     , [A_Title1], [A_Name1], [A_Title2], [A_Name2], [A_Title3], [A_Name3]
//     , [B_Title1], [B_Name1], [B_Title2], [B_Name2], [B_Title3], [B_Name3]
//     , [ItemA1], [ItemA2], [ItemA3], [ItemA4], [ItemA5], [ItemA6], [ItemA7], [ItemA8] 
//     , [ItemA9], [ItemA10], [ItemA11], [ItemA12], [ItemA13], [ItemA14], [ItemA15], [ItemA16]
//     , [Receive_MemoA], [Receive_MemoB], [Update_Who], [Update_Time], [Extra_Days], [loan_qual]
//     , [brief1], [brief2], [brief3], [brief4], [brief5], [brief6]
//     , [Bill_Valid_Date], [hide], [sch_level], [edu_tax], [stay_tax], [enabled_tax], [Bill_Close_Date], [BillForm_id]
//     , [isSubsidy01], [isSubsidy02], [isSubsidy03], [isSubsidy04], [isSubsidy05] 
//     , [isSubsidy06], [isSubsidy07], [isSubsidy08], [isSubsidy09], [isSubsidy10]
//     , [isSubsidy11], [isSubsidy12], [isSubsidy13], [isSubsidy14], [isSubsidy15]
//     , [isSubsidy16], [isSubsidy17], [isSubsidy18], [isSubsidy19], [isSubsidy20]
//     , [isSubsidy21], [isSubsidy22], [isSubsidy23], [isSubsidy24], [isSubsidy25]
//     , [isSubsidy26], [isSubsidy27], [isSubsidy28], [isSubsidy29], [isSubsidy30]
//     , [isSubsidy31], [isSubsidy32], [isSubsidy33], [isSubsidy34], [isSubsidy35]
//     , [isSubsidy36], [isSubsidy37], [isSubsidy38], [isSubsidy39], [isSubsidy40]
//     , [Post_Extra_Days], [C_Title1], [C_Name1], [C_Title2], [C_Name2], [C_Title3], [C_Name3], [Receive_MemoC] 
//     , [useStamp], [A_Stamp1], [A_Stamp2], [A_Stamp3], [B_Stamp1], [B_Stamp2], [B_Stamp3], [C_Stamp1], [C_Stamp2], [C_Stamp3]
//     , [useWaterMark], [watermark], [invoiceform_id], [usePostDueDay], [Loan_Item_Others] 
//     , [isSubsidy_Others], [Agency_Item_Others], [Agency_Check_Others], [Pay_Due_Date2], [Pay_Due_Date3]
//     , [Memo_Title01], [Memo_Title02], [Memo_Title03], [Memo_Title04], [Memo_Title05]
//     , [Memo_Title06], [Memo_Title07], [Memo_Title08], [Memo_Title09], [Memo_Title10]
//  FROM {0} 
// WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID1 AND Term_Id=@TERM_ID1 ", SchoolRidEntity.TABLE_NAME).AppendLine();

//                KeyValueList parameters = new KeyValueList(5);
//                parameters.Add("@RECEIVE_TYPE", receiveType);
//                parameters.Add("@YEAR_ID1", srcYearId);
//                parameters.Add("@TERM_ID1", srcTermId);
//                parameters.Add("@YEAR_ID2", tagYearId);
//                parameters.Add("@TERM_ID2", tagTermId);
                #endregion

                List<string> insertFields = new List<string>();
                List<string> selectFields = new List<string>();
                KeyValueList parameters = new KeyValueList();

                SchoolRidEntity entity = new SchoolRidEntity();
                FieldSpec[] fields = entity.FieldsSpec;
                foreach (FieldSpec field in fields)
                {
                    string fieldName = field.FieldName;
                    string sqlFieldName = String.Concat("[", fieldName, "]");
                    insertFields.Add(sqlFieldName);
                    switch (fieldName)
                    {
                        case SchoolRidEntity.Field.YearId:
                            selectFields.Add(String.Format("@YEAR_ID2 {0}", sqlFieldName));
                            parameters.Add("@YEAR_ID2", tagYearId);
                            break;
                        case SchoolRidEntity.Field.TermId:
                            selectFields.Add(String.Format("@TERM_ID2 {0}", sqlFieldName));
                            parameters.Add("@TERM_ID2", tagTermId);
                            break;
                        default:
                            selectFields.Add(sqlFieldName);
                            break;
                    }
                }

                StringBuilder sql = new StringBuilder();
                sql
                    .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, String.Join(", ", insertFields)).AppendLine()
                    .AppendFormat("SELECT {0} ", String.Join(", ", selectFields)).AppendLine()
                    .AppendFormat("  FROM {0} WHERE [Receive_Type]=@RECEIVE_TYPE AND [Year_Id]=@YEAR_ID1 AND [Term_Id]=@TERM_ID1 ", entity.TableName).AppendLine();

                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 代收費用別設定資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 代收費用別設定資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }
        #endregion

        #region 標準檔
        /// <summary>
        /// 刪除一般收費標準資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteGeneralStandardData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", GeneralStandardEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}一般收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}一般收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製一般收費標準資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns></returns>
        private Result CopyGeneralStandardData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteGeneralStandardData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                List<string> insertFields = new List<string>();
                List<string> selectFields = new List<string>();
                KeyValueList parameters = new KeyValueList();

                GeneralStandardEntity entity = new GeneralStandardEntity();
                FieldSpec[] fields = entity.FieldsSpec;
                foreach (FieldSpec field in fields)
                {
                    string fieldName = field.FieldName;
                    string sqlFieldName = String.Concat("[", fieldName, "]");
                    insertFields.Add(sqlFieldName);
                    switch (fieldName)
                    {
                        case GeneralStandardEntity.Field.YearId:
                            selectFields.Add(String.Format("@YEAR_ID2 {0}", sqlFieldName));
                            parameters.Add("@YEAR_ID2", tagYearId);
                            break;
                        case GeneralStandardEntity.Field.TermId:
                            selectFields.Add(String.Format("@TERM_ID2 {0}", sqlFieldName));
                            parameters.Add("@TERM_ID2", tagTermId);
                            break;
                        case GeneralStandardEntity.Field.CrtUser:
                            selectFields.Add(String.Format("@CRT_USER {0}", sqlFieldName));
                            parameters.Add("@CRT_USER", commandAsker.UserId);
                            break;
                        case GeneralStandardEntity.Field.CrtDate:
                            selectFields.Add(String.Format("GETDATE() {0}", sqlFieldName));
                            break;
                        case GeneralStandardEntity.Field.MdyDate:
                        case GeneralStandardEntity.Field.MdyUser:
                            selectFields.Add(String.Format("NULL {0}", sqlFieldName));
                            break;
                        default:
                            selectFields.Add(sqlFieldName);
                            break;
                    }
                }

                StringBuilder sql = new StringBuilder();
                sql
                    .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, String.Join(", ", insertFields)).AppendLine()
                    .AppendFormat("SELECT {0} ", String.Join(", ", selectFields)).AppendLine()
                    .AppendFormat("  FROM {0} WHERE [Receive_Type]=@RECEIVE_TYPE AND [Year_Id]=@YEAR_ID1 AND [Term_Id]=@TERM_ID1 ", entity.TableName).AppendLine();

                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 一般收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 一般收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除小於基數其他收費標準資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteCredit2StandardData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", Credit2StandardEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}小於基數其他收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}小於基數其他收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製小於基數其他收費標準資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns></returns>
        private Result CopyCredit2StandardData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteCredit2StandardData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                List<string> insertFields = new List<string>();
                List<string> selectFields = new List<string>();
                KeyValueList parameters = new KeyValueList();

                Credit2StandardEntity entity = new Credit2StandardEntity();
                FieldSpec[] fields = entity.FieldsSpec;
                foreach (FieldSpec field in fields)
                {
                    string fieldName = field.FieldName;
                    string sqlFieldName = String.Concat("[", fieldName, "]");
                    insertFields.Add(sqlFieldName);
                    switch (fieldName)
                    {
                        case Credit2StandardEntity.Field.YearId:
                            selectFields.Add(String.Format("@YEAR_ID2 {0}", sqlFieldName));
                            parameters.Add("@YEAR_ID2", tagYearId);
                            break;
                        case Credit2StandardEntity.Field.TermId:
                            selectFields.Add(String.Format("@TERM_ID2 {0}", sqlFieldName));
                            parameters.Add("@TERM_ID2", tagTermId);
                            break;
                        case Credit2StandardEntity.Field.CrtUser:
                            selectFields.Add(String.Format("@CRT_USER {0}", sqlFieldName));
                            parameters.Add("@CRT_USER", commandAsker.UserId);
                            break;
                        case Credit2StandardEntity.Field.CrtDate:
                            selectFields.Add(String.Format("GETDATE() {0}", sqlFieldName));
                            break;
                        case Credit2StandardEntity.Field.MdyDate:
                        case Credit2StandardEntity.Field.MdyUser:
                            selectFields.Add(String.Format("NULL {0}", sqlFieldName));
                            break;
                        default:
                            selectFields.Add(sqlFieldName);
                            break;
                    }
                }

                StringBuilder sql = new StringBuilder();
                sql
                    .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, String.Join(", ", insertFields)).AppendLine()
                    .AppendFormat("SELECT {0} ", String.Join(", ", selectFields)).AppendLine()
                    .AppendFormat("  FROM {0} WHERE [Receive_Type]=@RECEIVE_TYPE AND [Year_Id]=@YEAR_ID1 AND [Term_Id]=@TERM_ID1 ", entity.TableName).AppendLine();

                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 一般收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 一般收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除學分費收費標準資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteCreditStandardData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", CreditStandardEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}學分費收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}學分費收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製學分費收費標準資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns></returns>
        private Result CopyCreditStandardData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteCreditStandardData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                List<string> insertFields = new List<string>();
                List<string> selectFields = new List<string>();
                KeyValueList parameters = new KeyValueList();

                CreditStandardEntity entity = new CreditStandardEntity();
                FieldSpec[] fields = entity.FieldsSpec;
                foreach (FieldSpec field in fields)
                {
                    string fieldName = field.FieldName;
                    string sqlFieldName = String.Concat("[", fieldName, "]");
                    insertFields.Add(sqlFieldName);
                    switch (fieldName)
                    {
                        case CreditStandardEntity.Field.YearId:
                            selectFields.Add(String.Format("@YEAR_ID2 {0}", sqlFieldName));
                            parameters.Add("@YEAR_ID2", tagYearId);
                            break;
                        case CreditStandardEntity.Field.TermId:
                            selectFields.Add(String.Format("@TERM_ID2 {0}", sqlFieldName));
                            parameters.Add("@TERM_ID2", tagTermId);
                            break;
                        case CreditStandardEntity.Field.CrtUser:
                            selectFields.Add(String.Format("@CRT_USER {0}", sqlFieldName));
                            parameters.Add("@CRT_USER", commandAsker.UserId);
                            break;
                        case CreditStandardEntity.Field.CrtDate:
                            selectFields.Add(String.Format("GETDATE() {0}", sqlFieldName));
                            break;
                        case CreditStandardEntity.Field.MdyDate:
                        case CreditStandardEntity.Field.MdyUser:
                            selectFields.Add(String.Format("NULL {0}", sqlFieldName));
                            break;
                        default:
                            selectFields.Add(sqlFieldName);
                            break;
                    }
                }

                StringBuilder sql = new StringBuilder();
                sql
                    .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, String.Join(", ", insertFields)).AppendLine()
                    .AppendFormat("SELECT {0} ", String.Join(", ", selectFields)).AppendLine()
                    .AppendFormat("  FROM {0} WHERE [Receive_Type]=@RECEIVE_TYPE AND [Year_Id]=@YEAR_ID1 AND [Term_Id]=@TERM_ID1 ", entity.TableName).AppendLine();

                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 學分費收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 學分費收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除住宿費收費標準資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteDormStandardData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", DormStandardEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}住宿費收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}住宿費收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製住宿費收費標準資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns></returns>
        private Result CopyDormStandardData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteDormStandardData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                List<string> insertFields = new List<string>();
                List<string> selectFields = new List<string>();
                KeyValueList parameters = new KeyValueList();

                DormStandardEntity entity = new DormStandardEntity();
                FieldSpec[] fields = entity.FieldsSpec;
                foreach (FieldSpec field in fields)
                {
                    string fieldName = field.FieldName;
                    string sqlFieldName = String.Concat("[", fieldName, "]");
                    insertFields.Add(sqlFieldName);
                    switch (fieldName)
                    {
                        case DormStandardEntity.Field.YearId:
                            selectFields.Add(String.Format("@YEAR_ID2 {0}", sqlFieldName));
                            parameters.Add("@YEAR_ID2", tagYearId);
                            break;
                        case DormStandardEntity.Field.TermId:
                            selectFields.Add(String.Format("@TERM_ID2 {0}", sqlFieldName));
                            parameters.Add("@TERM_ID2", tagTermId);
                            break;
                        case DormStandardEntity.Field.CrtUser:
                            selectFields.Add(String.Format("@CRT_USER {0}", sqlFieldName));
                            parameters.Add("@CRT_USER", commandAsker.UserId);
                            break;
                        case DormStandardEntity.Field.CrtDate:
                            selectFields.Add(String.Format("GETDATE() {0}", sqlFieldName));
                            break;
                        case DormStandardEntity.Field.MdyDate:
                        case DormStandardEntity.Field.MdyUser:
                            selectFields.Add(String.Format("NULL {0}", sqlFieldName));
                            break;
                        default:
                            selectFields.Add(sqlFieldName);
                            break;
                    }
                }

                StringBuilder sql = new StringBuilder();
                sql
                    .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, String.Join(", ", insertFields)).AppendLine()
                    .AppendFormat("SELECT {0} ", String.Join(", ", selectFields)).AppendLine()
                    .AppendFormat("  FROM {0} WHERE [Receive_Type]=@RECEIVE_TYPE AND [Year_Id]=@YEAR_ID1 AND [Term_Id]=@TERM_ID1 ", entity.TableName).AppendLine();

                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 住宿費收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 住宿費收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除學分費基準收費標準資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteCreditbStandardData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", CreditbStandardEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}學分費基準收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}學分費基準收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製學分費基準收費標準資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns></returns>
        private Result CopyCreditbStandardData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteCreditbStandardData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                List<string> insertFields = new List<string>();
                List<string> selectFields = new List<string>();
                KeyValueList parameters = new KeyValueList();

                CreditbStandardEntity entity = new CreditbStandardEntity();
                FieldSpec[] fields = entity.FieldsSpec;
                foreach (FieldSpec field in fields)
                {
                    string fieldName = field.FieldName;
                    string sqlFieldName = String.Concat("[", fieldName, "]");
                    insertFields.Add(sqlFieldName);
                    switch (fieldName)
                    {
                        case CreditbStandardEntity.Field.YearId:
                            selectFields.Add(String.Format("@YEAR_ID2 {0}", sqlFieldName));
                            parameters.Add("@YEAR_ID2", tagYearId);
                            break;
                        case CreditbStandardEntity.Field.TermId:
                            selectFields.Add(String.Format("@TERM_ID2 {0}", sqlFieldName));
                            parameters.Add("@TERM_ID2", tagTermId);
                            break;
                        case CreditbStandardEntity.Field.CrtUser:
                            selectFields.Add(String.Format("@CRT_USER {0}", sqlFieldName));
                            parameters.Add("@CRT_USER", commandAsker.UserId);
                            break;
                        case CreditbStandardEntity.Field.CrtDate:
                            selectFields.Add(String.Format("GETDATE() {0}", sqlFieldName));
                            break;
                        case CreditbStandardEntity.Field.MdyDate:
                        case CreditbStandardEntity.Field.MdyUser:
                            selectFields.Add(String.Format("NULL {0}", sqlFieldName));
                            break;
                        default:
                            selectFields.Add(sqlFieldName);
                            break;
                    }
                }

                StringBuilder sql = new StringBuilder();
                sql
                    .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, String.Join(", ", insertFields)).AppendLine()
                    .AppendFormat("SELECT {0} ", String.Join(", ", selectFields)).AppendLine()
                    .AppendFormat("  FROM {0} WHERE [Receive_Type]=@RECEIVE_TYPE AND [Year_Id]=@YEAR_ID1 AND [Term_Id]=@TERM_ID1 ", entity.TableName).AppendLine();

                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 學分費基準收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 學分費基準收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除課程收費標準資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteClassStandardData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", ClassStandardEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}課程收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}課程收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製課程收費標準資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns></returns>
        private Result CopyClassStandardData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteClassStandardData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                List<string> insertFields = new List<string>();
                List<string> selectFields = new List<string>();
                KeyValueList parameters = new KeyValueList();

                ClassStandardEntity entity = new ClassStandardEntity();
                FieldSpec[] fields = entity.FieldsSpec;
                foreach (FieldSpec field in fields)
                {
                    string fieldName = field.FieldName;
                    string sqlFieldName = String.Concat("[", fieldName, "]");
                    insertFields.Add(sqlFieldName);
                    switch (fieldName)
                    {
                        case ClassStandardEntity.Field.YearId:
                            selectFields.Add(String.Format("@YEAR_ID2 {0}", sqlFieldName));
                            parameters.Add("@YEAR_ID2", tagYearId);
                            break;
                        case ClassStandardEntity.Field.TermId:
                            selectFields.Add(String.Format("@TERM_ID2 {0}", sqlFieldName));
                            parameters.Add("@TERM_ID2", tagTermId);
                            break;
                        #region [Old]
                        //case ClassStandardEntity.Field.CrtUser:
                        //    selectFields.Add(String.Format("@CRT_USER {0}", sqlFieldName));
                        //    parameters.Add("@CRT_USER", commandAsker.UserId);
                        //    break;
                        //case ClassStandardEntity.Field.CrtDate:
                        //    selectFields.Add(String.Format("GETDATE() {0}", sqlFieldName));
                        //    break;
                        //case ClassStandardEntity.Field.MdyDate:
                        //case ClassStandardEntity.Field.MdyUser:
                        //    selectFields.Add(String.Format("NULL {0}", sqlFieldName));
                        //    break;
                        #endregion
                        default:
                            selectFields.Add(sqlFieldName);
                            break;
                    }
                }

                StringBuilder sql = new StringBuilder();
                sql
                    .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, String.Join(", ", insertFields)).AppendLine()
                    .AppendFormat("SELECT {0} ", String.Join(", ", selectFields)).AppendLine()
                    .AppendFormat("  FROM {0} WHERE [Receive_Type]=@RECEIVE_TYPE AND [Year_Id]=@YEAR_ID1 AND [Term_Id]=@TERM_ID1 ", entity.TableName).AppendLine();

                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 課程收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 課程收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除減免收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteReduceStandardData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", ReduceStandardEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}減免收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}減免收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製減免收費標準資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns></returns>
        private Result CopyReduceStandardData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteReduceStandardData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                List<string> insertFields = new List<string>();
                List<string> selectFields = new List<string>();
                KeyValueList parameters = new KeyValueList();

                ReduceStandardEntity entity = new ReduceStandardEntity();
                FieldSpec[] fields = entity.FieldsSpec;
                foreach (FieldSpec field in fields)
                {
                    string fieldName = field.FieldName;
                    string sqlFieldName = String.Concat("[", fieldName, "]");
                    insertFields.Add(sqlFieldName);
                    switch (fieldName)
                    {
                        case ReduceStandardEntity.Field.YearId:
                            selectFields.Add(String.Format("@YEAR_ID2 {0}", sqlFieldName));
                            parameters.Add("@YEAR_ID2", tagYearId);
                            break;
                        case ReduceStandardEntity.Field.TermId:
                            selectFields.Add(String.Format("@TERM_ID2 {0}", sqlFieldName));
                            parameters.Add("@TERM_ID2", tagTermId);
                            break;
                        case ReduceStandardEntity.Field.CrtUser:
                            selectFields.Add(String.Format("@CRT_USER {0}", sqlFieldName));
                            parameters.Add("@CRT_USER", commandAsker.UserId);
                            break;
                        case ReduceStandardEntity.Field.CrtDate:
                            selectFields.Add(String.Format("GETDATE() {0}", sqlFieldName));
                            break;
                        case ReduceStandardEntity.Field.MdyDate:
                        case ReduceStandardEntity.Field.MdyUser:
                            selectFields.Add(String.Format("NULL {0}", sqlFieldName));
                            break;
                        default:
                            selectFields.Add(sqlFieldName);
                            break;
                    }
                }

                StringBuilder sql = new StringBuilder();
                sql
                    .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, String.Join(", ", insertFields)).AppendLine()
                    .AppendFormat("SELECT {0} ", String.Join(", ", selectFields)).AppendLine()
                    .AppendFormat("  FROM {0} WHERE [Receive_Type]=@RECEIVE_TYPE AND [Year_Id]=@YEAR_ID1 AND [Term_Id]=@TERM_ID1 ", entity.TableName).AppendLine();

                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 減免收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 減免收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除就貸收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteLoanStandardData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", LoanStandardEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}就貸收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}就貸收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製就貸收費標準資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns></returns>
        private Result CopyLoanStandardData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteLoanStandardData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                List<string> insertFields = new List<string>();
                List<string> selectFields = new List<string>();
                KeyValueList parameters = new KeyValueList();

                LoanStandardEntity entity = new LoanStandardEntity();
                FieldSpec[] fields = entity.FieldsSpec;
                foreach (FieldSpec field in fields)
                {
                    string fieldName = field.FieldName;
                    string sqlFieldName = String.Concat("[", fieldName, "]");
                    insertFields.Add(sqlFieldName);
                    switch (fieldName)
                    {
                        case LoanStandardEntity.Field.YearId:
                            selectFields.Add(String.Format("@YEAR_ID2 {0}", sqlFieldName));
                            parameters.Add("@YEAR_ID2", tagYearId);
                            break;
                        case LoanStandardEntity.Field.TermId:
                            selectFields.Add(String.Format("@TERM_ID2 {0}", sqlFieldName));
                            parameters.Add("@TERM_ID2", tagTermId);
                            break;
                        case LoanStandardEntity.Field.CrtUser:
                            selectFields.Add(String.Format("@CRT_USER {0}", sqlFieldName));
                            parameters.Add("@CRT_USER", commandAsker.UserId);
                            break;
                        case LoanStandardEntity.Field.CrtDate:
                            selectFields.Add(String.Format("GETDATE() {0}", sqlFieldName));
                            break;
                        case LoanStandardEntity.Field.MdyDate:
                        case LoanStandardEntity.Field.MdyUser:
                            selectFields.Add(String.Format("NULL {0}", sqlFieldName));
                            break;
                        default:
                            selectFields.Add(sqlFieldName);
                            break;
                    }
                }

                StringBuilder sql = new StringBuilder();
                sql
                    .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, String.Join(", ", insertFields)).AppendLine()
                    .AppendFormat("SELECT {0} ", String.Join(", ", selectFields)).AppendLine()
                    .AppendFormat("  FROM {0} WHERE [Receive_Type]=@RECEIVE_TYPE AND [Year_Id]=@YEAR_ID1 AND [Term_Id]=@TERM_ID1 ", entity.TableName).AppendLine();

                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 就貸收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 就貸收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除退費收費標準
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteReturnStandardData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", ReturnStandardEntity.TABLE_NAME).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}退費收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}退費收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製退費收費標準資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns></returns>
        private Result CopyReturnStandardData(CommandAsker commandAsker, DBLogger dbLogger, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteReturnStandardData(commandAsker, dbLogger, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                List<string> insertFields = new List<string>();
                List<string> selectFields = new List<string>();
                KeyValueList parameters = new KeyValueList();

                ReturnStandardEntity entity = new ReturnStandardEntity();
                FieldSpec[] fields = entity.FieldsSpec;
                foreach (FieldSpec field in fields)
                {
                    string fieldName = field.FieldName;
                    string sqlFieldName = String.Concat("[", fieldName, "]");
                    insertFields.Add(sqlFieldName);
                    switch (fieldName)
                    {
                        case ReturnStandardEntity.Field.YearId:
                            selectFields.Add(String.Format("@YEAR_ID2 {0}", sqlFieldName));
                            parameters.Add("@YEAR_ID2", tagYearId);
                            break;
                        case ReturnStandardEntity.Field.TermId:
                            selectFields.Add(String.Format("@TERM_ID2 {0}", sqlFieldName));
                            parameters.Add("@TERM_ID2", tagTermId);
                            break;
                        case ReturnStandardEntity.Field.CrtUser:
                            selectFields.Add(String.Format("@CRT_USER {0}", sqlFieldName));
                            parameters.Add("@CRT_USER", commandAsker.UserId);
                            break;
                        case ReturnStandardEntity.Field.CrtDate:
                            selectFields.Add(String.Format("GETDATE() {0}", sqlFieldName));
                            break;
                        case ReturnStandardEntity.Field.MdyDate:
                        case ReturnStandardEntity.Field.MdyUser:
                            selectFields.Add(String.Format("NULL {0}", sqlFieldName));
                            break;
                        default:
                            selectFields.Add(sqlFieldName);
                            break;
                    }
                }

                StringBuilder sql = new StringBuilder();
                sql
                    .AppendFormat("INSERT INTO {0}({1}) ", entity.TableName, String.Join(", ", insertFields)).AppendLine()
                    .AppendFormat("SELECT {0} ", String.Join(", ", selectFields)).AppendLine()
                    .AppendFormat("  FROM {0} WHERE [Receive_Type]=@RECEIVE_TYPE AND [Year_Id]=@YEAR_ID1 AND [Term_Id]=@TERM_ID1 ", entity.TableName).AppendLine();

                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 退費收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 退費收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除身分註記收費標準資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="tableName"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">學年</param>
        /// <param name="srcTermId">學期</param>
        /// <returns></returns>
        private Result DeleteIdentifyStandardData(CommandAsker commandAsker, DBLogger dbLogger, string tableName, string receiveType, string yearId, string termId)
        {
            int count = 0;
            StringBuilder sql = new StringBuilder();
            sql
                .AppendFormat("DELETE {0} WHERE Receive_Type=@RECEIVE_TYPE AND Year_Id=@YEAR_ID AND Term_Id=@TERM_ID", tableName).AppendLine();

            KeyValueList parameters = new KeyValueList(3);
            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);

            Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}身分註記收費標準資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}身分註記收費標準資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 刪除並複製身分註記收費標準資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="dbLogger"></param>
        /// <param name="tableName"></param>
        /// <param name="receiveType">商家代號</param>
        /// <param name="srcYearId">資料來源學年</param>
        /// <param name="srcTermId">資料來源學期</param>
        /// <param name="tagYearId">資料目的學年</param>
        /// <param name="tagTermId">資料目的學期</param>
        /// <returns></returns>
        private Result CopyIdentifyStandardData(CommandAsker commandAsker, DBLogger dbLogger, string tableName, string receiveType, string srcYearId, string srcTermId, string tagYearId, string tagTermId)
        {
            int count = 0;

            #region 刪除目的資料
            {
                Result result = this.DeleteIdentifyStandardData(commandAsker, dbLogger, tableName, receiveType, tagYearId, tagTermId);
                if (!result.IsSuccess)
                {
                    return result;
                }
            }
            #endregion

            #region 新增目的資料
            {
                List<string> insertFields = new List<string>();
                List<string> selectFields = new List<string>();
                KeyValueList parameters = new KeyValueList();

                switch (tableName)
                {
                    case IdentifyStandard1Entity.TABLE_NAME:
                        #region IdentifyStandard1Entity
                        {
                            IdentifyStandard1Entity entity = new IdentifyStandard1Entity();
                            FieldSpec[] fields = entity.FieldsSpec;
                            foreach (FieldSpec field in fields)
                            {
                                string fieldName = field.FieldName;
                                string sqlFieldName = String.Concat("[", fieldName, "]");
                                insertFields.Add(sqlFieldName);
                                switch (fieldName)
                                {
                                    case IdentifyStandard1Entity.Field.YearId:
                                        selectFields.Add(String.Format("@YEAR_ID2 {0}", sqlFieldName));
                                        parameters.Add("@YEAR_ID2", tagYearId);
                                        break;
                                    case IdentifyStandard1Entity.Field.TermId:
                                        selectFields.Add(String.Format("@TERM_ID2 {0}", sqlFieldName));
                                        parameters.Add("@TERM_ID2", tagTermId);
                                        break;
                                    case IdentifyStandard1Entity.Field.CrtUser:
                                        selectFields.Add(String.Format("@CRT_USER {0}", sqlFieldName));
                                        parameters.Add("@CRT_USER", commandAsker.UserId);
                                        break;
                                    case IdentifyStandard1Entity.Field.CrtDate:
                                        selectFields.Add(String.Format("GETDATE() {0}", sqlFieldName));
                                        break;
                                    case IdentifyStandard1Entity.Field.MdyDate:
                                    case IdentifyStandard1Entity.Field.MdyUser:
                                        selectFields.Add(String.Format("NULL {0}", sqlFieldName));
                                        break;
                                    default:
                                        selectFields.Add(sqlFieldName);
                                        break;
                                }
                            }
                        }
                        #endregion
                        break;
                    case IdentifyStandard2Entity.TABLE_NAME:
                        #region IdentifyStandard2Entity
                        {
                            IdentifyStandard2Entity entity = new IdentifyStandard2Entity();
                            FieldSpec[] fields = entity.FieldsSpec;
                            foreach (FieldSpec field in fields)
                            {
                                string fieldName = field.FieldName;
                                string sqlFieldName = String.Concat("[", fieldName, "]");
                                insertFields.Add(sqlFieldName);
                                switch (fieldName)
                                {
                                    case IdentifyStandard2Entity.Field.YearId:
                                        selectFields.Add(String.Format("@YEAR_ID2 {0}", sqlFieldName));
                                        parameters.Add("@YEAR_ID2", tagYearId);
                                        break;
                                    case IdentifyStandard2Entity.Field.TermId:
                                        selectFields.Add(String.Format("@TERM_ID2 {0}", sqlFieldName));
                                        parameters.Add("@TERM_ID2", tagTermId);
                                        break;
                                    case IdentifyStandard2Entity.Field.CrtUser:
                                        selectFields.Add(String.Format("@CRT_USER {0}", sqlFieldName));
                                        parameters.Add("@CRT_USER", commandAsker.UserId);
                                        break;
                                    case IdentifyStandard2Entity.Field.CrtDate:
                                        selectFields.Add(String.Format("GETDATE() {0}", sqlFieldName));
                                        break;
                                    case IdentifyStandard2Entity.Field.MdyDate:
                                    case IdentifyStandard2Entity.Field.MdyUser:
                                        selectFields.Add(String.Format("NULL {0}", sqlFieldName));
                                        break;
                                    default:
                                        selectFields.Add(sqlFieldName);
                                        break;
                                }
                            }
                        }
                        #endregion
                        break;
                    case IdentifyStandard3Entity.TABLE_NAME:
                        #region IdentifyStandard3Entity
                        {
                            IdentifyStandard3Entity entity = new IdentifyStandard3Entity();
                            FieldSpec[] fields = entity.FieldsSpec;
                            foreach (FieldSpec field in fields)
                            {
                                string fieldName = field.FieldName;
                                string sqlFieldName = String.Concat("[", fieldName, "]");
                                insertFields.Add(sqlFieldName);
                                switch (fieldName)
                                {
                                    case IdentifyStandard3Entity.Field.YearId:
                                        selectFields.Add(String.Format("@YEAR_ID2 {0}", sqlFieldName));
                                        parameters.Add("@YEAR_ID2", tagYearId);
                                        break;
                                    case IdentifyStandard3Entity.Field.TermId:
                                        selectFields.Add(String.Format("@TERM_ID2 {0}", sqlFieldName));
                                        parameters.Add("@TERM_ID2", tagTermId);
                                        break;
                                    case IdentifyStandard3Entity.Field.CrtUser:
                                        selectFields.Add(String.Format("@CRT_USER {0}", sqlFieldName));
                                        parameters.Add("@CRT_USER", commandAsker.UserId);
                                        break;
                                    case IdentifyStandard3Entity.Field.CrtDate:
                                        selectFields.Add(String.Format("GETDATE() {0}", sqlFieldName));
                                        break;
                                    case IdentifyStandard3Entity.Field.MdyDate:
                                    case IdentifyStandard3Entity.Field.MdyUser:
                                        selectFields.Add(String.Format("NULL {0}", sqlFieldName));
                                        break;
                                    default:
                                        selectFields.Add(sqlFieldName);
                                        break;
                                }
                            }
                        }
                        #endregion
                        break;
                    case IdentifyStandard4Entity.TABLE_NAME:
                        #region IdentifyStandard4Entity
                        {
                            IdentifyStandard4Entity entity = new IdentifyStandard4Entity();
                            FieldSpec[] fields = entity.FieldsSpec;
                            foreach (FieldSpec field in fields)
                            {
                                string fieldName = field.FieldName;
                                string sqlFieldName = String.Concat("[", fieldName, "]");
                                insertFields.Add(sqlFieldName);
                                switch (fieldName)
                                {
                                    case IdentifyStandard4Entity.Field.YearId:
                                        selectFields.Add(String.Format("@YEAR_ID2 {0}", sqlFieldName));
                                        parameters.Add("@YEAR_ID2", tagYearId);
                                        break;
                                    case IdentifyStandard4Entity.Field.TermId:
                                        selectFields.Add(String.Format("@TERM_ID2 {0}", sqlFieldName));
                                        parameters.Add("@TERM_ID2", tagTermId);
                                        break;
                                    case IdentifyStandard4Entity.Field.CrtUser:
                                        selectFields.Add(String.Format("@CRT_USER {0}", sqlFieldName));
                                        parameters.Add("@CRT_USER", commandAsker.UserId);
                                        break;
                                    case IdentifyStandard4Entity.Field.CrtDate:
                                        selectFields.Add(String.Format("GETDATE() {0}", sqlFieldName));
                                        break;
                                    case IdentifyStandard4Entity.Field.MdyDate:
                                    case IdentifyStandard4Entity.Field.MdyUser:
                                        selectFields.Add(String.Format("NULL {0}", sqlFieldName));
                                        break;
                                    default:
                                        selectFields.Add(sqlFieldName);
                                        break;
                                }
                            }
                        }
                        #endregion
                        break;
                    case IdentifyStandard5Entity.TABLE_NAME:
                        #region IdentifyStandard5Entity
                        {
                            IdentifyStandard5Entity entity = new IdentifyStandard5Entity();
                            FieldSpec[] fields = entity.FieldsSpec;
                            foreach (FieldSpec field in fields)
                            {
                                string fieldName = field.FieldName;
                                string sqlFieldName = String.Concat("[", fieldName, "]");
                                insertFields.Add(sqlFieldName);
                                switch (fieldName)
                                {
                                    case IdentifyStandard5Entity.Field.YearId:
                                        selectFields.Add(String.Format("@YEAR_ID2 {0}", sqlFieldName));
                                        parameters.Add("@YEAR_ID2", tagYearId);
                                        break;
                                    case IdentifyStandard5Entity.Field.TermId:
                                        selectFields.Add(String.Format("@TERM_ID2 {0}", sqlFieldName));
                                        parameters.Add("@TERM_ID2", tagTermId);
                                        break;
                                    case IdentifyStandard5Entity.Field.CrtUser:
                                        selectFields.Add(String.Format("@CRT_USER {0}", sqlFieldName));
                                        parameters.Add("@CRT_USER", commandAsker.UserId);
                                        break;
                                    case IdentifyStandard5Entity.Field.CrtDate:
                                        selectFields.Add(String.Format("GETDATE() {0}", sqlFieldName));
                                        break;
                                    case IdentifyStandard5Entity.Field.MdyDate:
                                    case IdentifyStandard5Entity.Field.MdyUser:
                                        selectFields.Add(String.Format("NULL {0}", sqlFieldName));
                                        break;
                                    default:
                                        selectFields.Add(sqlFieldName);
                                        break;
                                }
                            }
                        }
                        #endregion
                        break;
                    case IdentifyStandard6Entity.TABLE_NAME:
                        #region IdentifyStandard6Entity
                        {
                            IdentifyStandard6Entity entity = new IdentifyStandard6Entity();
                            FieldSpec[] fields = entity.FieldsSpec;
                            foreach (FieldSpec field in fields)
                            {
                                string fieldName = field.FieldName;
                                string sqlFieldName = String.Concat("[", fieldName, "]");
                                insertFields.Add(sqlFieldName);
                                switch (fieldName)
                                {
                                    case IdentifyStandard6Entity.Field.YearId:
                                        selectFields.Add(String.Format("@YEAR_ID2 {0}", sqlFieldName));
                                        parameters.Add("@YEAR_ID2", tagYearId);
                                        break;
                                    case IdentifyStandard6Entity.Field.TermId:
                                        selectFields.Add(String.Format("@TERM_ID2 {0}", sqlFieldName));
                                        parameters.Add("@TERM_ID2", tagTermId);
                                        break;
                                    case IdentifyStandard6Entity.Field.CrtUser:
                                        selectFields.Add(String.Format("@CRT_USER {0}", sqlFieldName));
                                        parameters.Add("@CRT_USER", commandAsker.UserId);
                                        break;
                                    case IdentifyStandard6Entity.Field.CrtDate:
                                        selectFields.Add(String.Format("GETDATE() {0}", sqlFieldName));
                                        break;
                                    case IdentifyStandard6Entity.Field.MdyDate:
                                    case IdentifyStandard6Entity.Field.MdyUser:
                                        selectFields.Add(String.Format("NULL {0}", sqlFieldName));
                                        break;
                                    default:
                                        selectFields.Add(sqlFieldName);
                                        break;
                                }
                            }
                        }
                        #endregion
                        break;
                }

                StringBuilder sql = new StringBuilder();
                sql
                    .AppendFormat("INSERT INTO {0}({1}) ", tableName, String.Join(", ", insertFields)).AppendLine()
                    .AppendFormat("SELECT {0} ", String.Join(", ", selectFields)).AppendLine()
                    .AppendFormat("  FROM {0} WHERE [Receive_Type]=@RECEIVE_TYPE AND [Year_Id]=@YEAR_ID1 AND [Term_Id]=@TERM_ID1 ", tableName).AppendLine();

                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID1", srcYearId);
                parameters.Add("@TERM_ID1", srcTermId);

                Result result = _Factory.ExecuteNonQuery(sql.ToString(), parameters, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1} (複製) 身分註記收費標準({3})資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count, tableName);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1} (複製) 身分註記收費標準({3})資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message, tableName);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion

                return result;
            }
            #endregion
        }
        #endregion
        #endregion


        /// <summary>
        /// 取得 S530001 (使用者管理) 頁面用的編輯資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result S530001GetEditData(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string userId = null;
            string groupId = null;
            string receiveType = null;
            string bankId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "USERID":
                        userId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "GROUPID":
                        groupId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "BANKID":
                        bankId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(userId)        //必要參數且不可為空字串
                || String.IsNullOrEmpty(groupId)    //必要參數且不可為空字串
                || receiveType == null              //必要參數
                || bankId == null                   //必要參數
                || (String.IsNullOrEmpty(receiveType) && String.IsNullOrEmpty(bankId)))  //不可同時為空字串
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            Result result = null;

            #region 取得使用者資料
            UsersEntity user = null;
            {
                Expression where = new Expression(UsersEntity.Field.UId, userId)
                    .And(UsersEntity.Field.UGrp, groupId)
                    .And(UsersEntity.Field.URt, receiveType ?? String.Empty)
                    .And(UsersEntity.Field.UBank, bankId ?? String.Empty);
                KeyValueList<OrderByEnum> orderbys = new KeyValueList<OrderByEnum>(2);
                orderbys.Add(UsersEntity.Field.URt, OrderByEnum.Asc);
                orderbys.Add(UsersEntity.Field.UBank, OrderByEnum.Asc);
                result = _Factory.SelectFirst<UsersEntity>(where, orderbys, out user);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}使用者資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, (user == null ? 0 : 1));
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}使用者資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                }
                #endregion

                if (result.IsSuccess && user == null)
                {
                    result = new Result(false, "查無使用者資料", CoreStatusCode.S_SELECT_DATA_FAILURE, null);
                }
                if (!result.IsSuccess)
                {
                    if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
                    }
                    else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
                    }

                    string logErrmsg = this.ReleaseDBLogger(true);
                    if (dbLogger != null)
                    {
                        dbLogger.Dispose();
                        dbLogger = null;
                    }
                    return result;
                }
            }
            #endregion

            #region 取得群組資料
            GroupListEntity group = null;
            {
                Expression where = new Expression(GroupListEntity.Field.GroupId, groupId);
                result = _Factory.SelectFirst<GroupListEntity>(where, null, out group);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}群組資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, (group == null ? 0 : 1));
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}群組資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                }
                #endregion

                if (result.IsSuccess && group == null)
                {
                    result = new Result(false, "查無群組資料", CoreStatusCode.S_SELECT_DATA_FAILURE, null);
                }
                if (!result.IsSuccess)
                {
                    if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
                    }
                    else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
                    }

                    string logErrmsg = this.ReleaseDBLogger(true);
                    if (dbLogger != null)
                    {
                        dbLogger.Dispose();
                        dbLogger = null;
                    }
                    return result;
                }
            }
            #endregion

            #region 功能、群組權限、使用者權限資料
            CodeText[] funcMenus = null;
            GroupRightEntity[] groupRights = null;

            #region [MDY:20161015] 土銀不使用使用者權限，所以都不用取
            //UsersRightEntity[] usersRights = null;

            //if (group.RoleType == RoleTypeCodeTexts.USER)
            //{
            //    #region 取得功能資料 (代碼名稱)
            //    {
            //        FuncMenuEntity[] instances = null;
            //        Expression where = new Expression(FuncMenuEntity.Field.Status, DataStatusCodeTexts.NORMAL);
            //        KeyValueList<OrderByEnum> orderbys = new KeyValueList<OrderByEnum>();
            //        orderbys.Add(FuncMenuEntity.Field.FuncId, OrderByEnum.Asc);
            //        result = _Factory.SelectAll<FuncMenuEntity>(where, orderbys, out instances);

            //        #region 新增日誌資料
            //        if (dbLogger != null)
            //        {
            //            string notation = null;
            //            if (result.IsSuccess)
            //            {
            //                notation = String.Format("[{0}] {1}功能資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, (instances == null ? 0 : instances.Length));
            //            }
            //            else
            //            {
            //                notation = String.Format("[{0}] {1}功能資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
            //            }
            //            dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
            //        }
            //        #endregion

            //        if (result.IsSuccess)
            //        {
            //            if (instances != null && instances.Length > 0)
            //            {
            //                funcMenus = new CodeText[instances.Length];
            //                int idx = 0;
            //                foreach (FuncMenuEntity instance in instances)
            //                {
            //                    funcMenus[idx++] = new CodeText(instance.FuncId, instance.FuncName);
            //                }
            //            }
            //        }
            //        else
            //        {
            //            if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
            //            {
            //                result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
            //            }
            //            else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
            //            {
            //                result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
            //            }

            //            string logErrmsg = this.ReleaseDBLogger(true);
            //            if (dbLogger != null)
            //            {
            //                dbLogger.Dispose();
            //                dbLogger = null;
            //            }
            //            return result;
            //        }
            //    }
            //    #endregion

            //    #region 取得群組權限資料
            //    {
            //        Expression where = new Expression(GroupRightEntity.Field.GroupId, groupId)
            //            .And(GroupRightEntity.Field.RightCode, RelationEnum.In, new string[] { "1", "2" }); //只取有權限的
            //        KeyValueList<OrderByEnum> orderbys = new KeyValueList<OrderByEnum>();
            //        orderbys.Add(GroupRightEntity.Field.FuncId, OrderByEnum.Asc);
            //        result = _Factory.SelectAll<GroupRightEntity>(where, orderbys, out groupRights);

            //        #region 新增日誌資料
            //        if (dbLogger != null)
            //        {
            //            string notation = null;
            //            if (result.IsSuccess)
            //            {
            //                notation = String.Format("[{0}] {1}群組權限資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, (groupRights == null ? 0 : groupRights.Length));
            //            }
            //            else
            //            {
            //                notation = String.Format("[{0}] {1}群組權限資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
            //            }
            //            dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
            //        }
            //        #endregion

            //        if (!result.IsSuccess)
            //        {
            //            if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
            //            {
            //                result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
            //            }
            //            else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
            //            {
            //                result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
            //            }

            //            string logErrmsg = this.ReleaseDBLogger(true);
            //            if (dbLogger != null)
            //            {
            //                dbLogger.Dispose();
            //                dbLogger = null;
            //            }
            //            return result;
            //        }
            //    }
            //    #endregion

            //    #region [Old] 土銀不使用使用者權限
            //    //#region 取得使用者權限資料
            //    //{
            //    //    Expression where = new Expression(UsersRightEntity.Field.UGrp, groupId)
            //    //        .And(UsersRightEntity.Field.UId, userId)
            //    //        .And(UsersRightEntity.Field.URt, receiveType ?? String.Empty)
            //    //        .And(UsersRightEntity.Field.UBank, bankId ?? String.Empty)
            //    //        .And(UsersRightEntity.Field.RightCode, RelationEnum.In, new string[] { "1", "2" }); //只取有權限的
            //    //    KeyValueList<OrderByEnum> orderbys = new KeyValueList<OrderByEnum>(2);
            //    //    orderbys.Add(UsersRightEntity.Field.URt, OrderByEnum.Asc);
            //    //    orderbys.Add(UsersRightEntity.Field.UBank, OrderByEnum.Asc);

            //    //    result = _Factory.SelectAll<UsersRightEntity>(where, orderbys, out usersRights);

            //    //    #region 新增日誌資料
            //    //    if (dbLogger != null)
            //    //    {
            //    //        string notation = null;
            //    //        if (result.IsSuccess)
            //    //        {
            //    //            notation = String.Format("[{0}] {1}使用者權限資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, (usersRights == null ? 0 : usersRights.Length));
            //    //        }
            //    //        else
            //    //        {
            //    //            notation = String.Format("[{0}] {1}使用者權限資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
            //    //        }
            //    //        dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
            //    //    }
            //    //    #endregion

            //    //    if (!result.IsSuccess)
            //    //    {
            //    //        if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
            //    //        {
            //    //            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
            //    //        }
            //    //        else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
            //    //        {
            //    //            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
            //    //        }

            //    //        string logErrmsg = this.ReleaseDBLogger(true);
            //    //        if (dbLogger != null)
            //    //        {
            //    //            dbLogger.Dispose();
            //    //            dbLogger = null;
            //    //        }
            //    //        return result;
            //    //    }
            //    //}
            //    //#endregion
            //    #endregion
            //}
            #endregion
            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            #region 將 user、group、funcMenus、groupRights、usersRights 轉成 KeyValue<string>[] 傳回
            {
                KeyValueList<string> xmls = new KeyValueList<string>(4);

                #region 將使用者資料序列化
                {
                    string xml = null;
                    if (Common.TryToXmlExplicitly<UsersEntity>(user, out xml))
                    {
                        xmls.Add("UsersEntity", xml);
                    }
                    else
                    {
                        return new Result(false, "序列化使用者資料失敗", ErrorCode.S_SERIALIZED_FAILURE, null);
                    }
                }
                #endregion

                #region 將群組資料序列化
                {
                    string xml = null;
                    if (Common.TryToXmlExplicitly<GroupListEntity>(group, out xml))
                    {
                        xmls.Add("GroupListEntity", xml);
                    }
                    else
                    {
                        return new Result(false, "序列化群組資料失敗", ErrorCode.S_SERIALIZED_FAILURE, null);
                    }
                }
                #endregion

                #region 將功能資料序列化
                if (funcMenus != null)
                {
                    string xml = null;
                    if (Common.TryToXmlExplicitly<CodeText[]>(funcMenus, out xml))
                    {
                        xmls.Add("FuncMenuCodeText", xml);
                    }
                    else
                    {
                        return new Result(false, "序列化功能資料失敗", ErrorCode.S_SERIALIZED_FAILURE, null);
                    }
                }
                #endregion

                #region 將群組權限資料序列化
                if (groupRights != null)
                {
                    string xml = null;
                    if (Common.TryToXmlExplicitly<GroupRightEntity[]>(groupRights, out xml))
                    {
                        xmls.Add("GroupRightEntity", xml);
                    }
                    else
                    {
                        return new Result(false, "序列化群組權限資料失敗", ErrorCode.S_SERIALIZED_FAILURE, null);
                    }
                }
                #endregion

                #region [Old] 土銀不使用使用者權限
                //#region 將使用者權限資料序列化
                //if (groupRights != null)
                //{
                //    string xml = null;
                //    if (Common.TryToXmlExplicitly<UsersRightEntity[]>(usersRights, out xml))
                //    {
                //        xmls.Add("UsersRightEntity", xml);
                //    }
                //    else
                //    {
                //        return new Result(false, "序列化使用者權限資料失敗", ErrorCode.S_SERIALIZED_FAILURE, null);
                //    }
                //}
                //#endregion
                #endregion

                data = xmls.ToArray();
            }
            #endregion

            return new Result(true);
        }

        /// <summary>
        /// 新增 S530001 (使用者管理) 頁面用的新增資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result S530001InsertData(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments)
        {
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string userId = null;
            string groupId = null;
            string receiveType = null;
            string bankId = null;

            #region [MDY:20220530] Checkmarx 調整
            string userPXX = null;
            #endregion

            string userName = null;
            string tel = null;
            string title = null;
            string email = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "USERID":
                        userId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "GROUPID":
                        groupId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "BANKID":
                        bankId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;

                    #region [MDY:20220530] Checkmarx 調整
                    case "USERPXX":
                        userPXX = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    #endregion

                    case "USERNAME":
                        userName = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "TEL":
                        tel = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "EMAIL":
                        email = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(userId)        //必要參數且不可為空字串
                || String.IsNullOrEmpty(groupId)    //必要參數且不可為空字串
                || String.IsNullOrEmpty(bankId)     //必要參數且不可為空字串
                || receiveType == null              //必要參數
                || String.IsNullOrEmpty(userName))  //必要參數且不可為空字串
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            Result result = null;

            #region 取得群組資料
            GroupListEntity group = null;
            {
                Expression where = new Expression(GroupListEntity.Field.GroupId, groupId);
                result = _Factory.SelectFirst<GroupListEntity>(where, null, out group);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}群組資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, (group == null ? 0 : 1));
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}群組資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                }
                #endregion

                if (result.IsSuccess)
                {
                    if (group == null)
                    {
                        result = new Result(false, "查無群組資料", CoreStatusCode.S_SELECT_DATA_FAILURE, null);
                    }
                    //else if (group.Role != RoleCodeTexts.SCHOOL)
                    //{
                    //    result = new Result(false, "此功能僅限維護學校的群組", CoreStatusCode.INVALID_PARAMETER, null);
                    //}
                }
                if (!result.IsSuccess)
                {
                    if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
                    }
                    else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
                    }

                    string logErrmsg = this.ReleaseDBLogger(true);
                    if (dbLogger != null)
                    {
                        dbLogger.Dispose();
                        dbLogger = null;
                    }
                    return result;
                }
            }
            #endregion

            #region 檢查商家代號
            if (group.Role == RoleCodeTexts.STAFF)
            {
                receiveType = String.Empty; //行員的授權商家代號，固定設為空字串
            }
            else
            {
                #region [MDY:20220530] Checkmarx 調整
                if (String.IsNullOrEmpty(userPXX))
                {
                    //學校帳號必須有密碼且不可為空字串
                    return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                }

                #region [MDY:20160921] 使用者密碼加密
                userPXX = DataFormat.GetUserPXXEncode(userPXX);
                if (String.IsNullOrEmpty(userPXX))
                {
                    return new Result(false, "密碼加解密處理失敗", CoreStatusCode.UNKNOWN_ERROR, null);
                }
                #endregion
                #endregion

                if (group.RoleType == RoleTypeCodeTexts.MANAGER)
                {
                    receiveType = "*";  //學校管理者的授權商家代號，固定設為 *
                }
                else if (String.IsNullOrEmpty(receiveType))
                {
                    receiveType = ",";
                }
                else
                {
                    string[] receiveTypes = receiveType.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
                    for (int idx = 0; idx < receiveTypes.Length; idx++)
                    {
                        receiveTypes[idx] = receiveTypes[idx].Trim();
                    }
                    receiveType = "," + String.Join(",", receiveTypes) + ",";
                    int count = 0;
                    Expression where = new Expression(SchoolRTypeEntity.Field.ReceiveType, receiveTypes)
                        .And(SchoolRTypeEntity.Field.Status, DataStatusCodeTexts.NORMAL);
                    result = _Factory.SelectCount<SchoolRTypeEntity>(where, out count);

                    #region 新增日誌資料
                    if (dbLogger != null)
                    {
                        string notation = null;
                        if (result.IsSuccess)
                        {
                            notation = String.Format("[{0}] {1}商家代號是否存在成功 ({2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, (count > 0 ? "存在" : "不存在"));
                        }
                        else
                        {
                            notation = String.Format("[{0}] {1}商家代號是否存在失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                        }
                        dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                    }
                    #endregion

                    if (result.IsSuccess && count != receiveTypes.Length)
                    {
                        result = new Result(false, "所屬商家代號參數包含無效的值", CoreStatusCode.INVALID_PARAMETER, null);
                    }
                    if (!result.IsSuccess)
                    {
                        if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                        {
                            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
                        }
                        else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                        {
                            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
                        }

                        string logErrmsg = this.ReleaseDBLogger(true);
                        if (dbLogger != null)
                        {
                            dbLogger.Dispose();
                            dbLogger = null;
                        }
                        return result;
                    }
                }
            }
            #endregion

            #region 檢查使用者帳號是否存在
            {
                Expression where = null;

                #region [MDY:20161013] 行員的帳號為所有銀行唯一，學校的帳號為該校唯一
                if (group.Role == RoleCodeTexts.STAFF)
                {
                    where = new Expression(UsersEntity.Field.UBank, RelationEnum.Like, DataFormat.MyBankID + "___")
                        .And(UsersEntity.Field.UId, userId);
                }
                else
                {
                    where = new Expression(UsersEntity.Field.UBank, bankId)
                        .And(UsersEntity.Field.UId, userId);
                }
                #endregion
                int count = 0;
                result = _Factory.SelectCount<UsersEntity>(where, out count);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}使用者帳號是否存在成功 ({2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, (count > 0 ? "存在" : "不存在"));
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}使用者帳號是否存在失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                }
                #endregion

                if (result.IsSuccess && count > 0)
                {
                    result = new Result(false, "使用者帳號已存在", ErrorCode.D_DATA_EXISTS, null);
                }
                if (!result.IsSuccess)
                {
                    if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
                    }
                    else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
                    }

                    string logErrmsg = this.ReleaseDBLogger(true);
                    if (dbLogger != null)
                    {
                        dbLogger.Dispose();
                        dbLogger = null;
                    }
                    return result;
                }
            }
            #endregion

            #region 取得 commandAsker 的使用者資料
            //UsersEntity asker = null;
            //{
            //    result = this.GetUserByCommandAsker(dbLogger, commandAsker, out asker);
            //    if (!result.IsSuccess)
            //    {
            //        if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
            //        {
            //            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
            //        }
            //        else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
            //        {
            //            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
            //        }

            //        string logErrmsg = this.ReleaseDBLogger(true);
            //        if (dbLogger != null)
            //        {
            //            dbLogger.Dispose();
            //            dbLogger = null;
            //        }
            //        return result;
            //    }
            //}
            #endregion

            #region 新增資料 (使用交易)
            {
                DateTime now = DateTime.Now;
                result = new Result(true);

                EntityFactory tsFactory = _Factory.CloneForTransaction();
                try
                {
                    #region 新增使用者
                    UsersEntity user = new UsersEntity();
                    if (result.IsSuccess)
                    {
                        user.UId = userId;
                        user.UGrp = groupId;
                        user.URt = receiveType;
                        user.UBank = bankId;
                        user.UName = userName;
                        user.Tel = tel ?? String.Empty;
                        user.Title = title ?? String.Empty;
                        user.Email = email ?? String.Empty;

                        #region [MDY:20220530] Checkmarx 調整
                        user.UPXX = userPXX;
                        #endregion

                        user.ULock = "N";

                        user.ResetUid = commandAsker.UserId;    //asker.UId;
                        user.Resetdate = now.ToString("yyyyMMdd");

                        #region [MDY:20220530] Checkmarx 調整
                        user.ResetPXX = user.UPXX;
                        #endregion

                        user.LastApproveUser = null;
                        user.LastApproveTime = null;
                        user.Flag = "0";

                        #region [MDY:20220530] Checkmarx 調整
                        //如果要讓首次登入強迫變更密碼，user.InitPXX 要設定為 userPXX
                        user.InitPXX = userPXX;    //String.Empty;
                        #endregion

                        user.UNum = null;

                        #region [MDY:20220530] Checkmarx 調整
                        user.UPXX1 = null;
                        #endregion

                        user.Sessionid = null;
                        user.Remark = String.Empty;

                        user.Createdate = Common.GetTWDate7(now);
                        user.Creator = commandAsker.UserId; // asker.UId;
                        user.Approver = String.Empty;
                        user.Approvedate = null;

                        user.DataStatus = "0";
                        user.ProcessStatus = "0";
                        user.LastModifyUser = commandAsker.UserId;
                        user.LastModifyTime = now;

                        #region [MDY:20220530] Checkmarx 調整
                        user.PXXChangeDate = String.Empty;
                        #endregion

                        int count = 0;
                        result = tsFactory.Insert(user, out count);

                        if (result.IsSuccess && count == 0)
                        {
                            result = new Result(false, "無使用者資料被新增", CoreStatusCode.D_NOT_DATA_INSERT, null);
                        }

                        #region 新增日誌資料
                        if (dbLogger != null)
                        {
                            string notation = null;
                            if (result.IsSuccess)
                            {
                                notation = String.Format("[{0}] {1}使用者資料成功 (userId={2}, groupId={3}, receiveType={4}, bankId={5})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, user.UId, user.UGrp, user.URt, user.UBank);
                            }
                            else
                            {
                                notation = String.Format("[{0}] {1}使用者資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                            }
                            dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                        }
                        #endregion
                    }
                    #endregion

                    #region [Old] 土銀不使用使用者權限
//                    #region 新增使用者權限
//                    if (result.IsSuccess && group.RoleType == RoleTypeCodeTexts.USER)
//                    {
//                        string sql = String.Format(@"INSERT INTO [{0}]
//([{1}], [{2}], [{3}], [{4}], [{5}], [{6}], [{7}], [{8}], [{9}]) 
//SELECT @UserId, @GroupId, @ReceiveType, @BankId, [{10}], [{11}], [{12}], @CrtDate, @CrtUser
//    FROM [{13}] 
//    WHERE [{14}] = @GroupId"
//                                        , UsersRightEntity.TABLE_NAME
//                                        , UsersRightEntity.Field.UId     //1
//                                        , UsersRightEntity.Field.UGrp
//                                        , UsersRightEntity.Field.URt
//                                        , UsersRightEntity.Field.UBank
//                                        , UsersRightEntity.Field.FuncId
//                                        , UsersRightEntity.Field.RightCode
//                                        , UsersRightEntity.Field.Status
//                                        , UsersRightEntity.Field.CrtDate
//                                        , UsersRightEntity.Field.CrtUser    //9
//                                        , GroupRightEntity.Field.FuncId     //10
//                                        , GroupRightEntity.Field.RightCode
//                                        , GroupRightEntity.Field.Status
//                                        , GroupRightEntity.TABLE_NAME
//                                        , GroupRightEntity.Field.GroupId);   //14
//                        KeyValue[] parameters = new KeyValue[6];
//                        parameters[0] = new KeyValue("@UserId", user.UId);
//                        parameters[1] = new KeyValue("@GroupId", user.UGrp);
//                        parameters[2] = new KeyValue("@ReceiveType", user.URt);
//                        parameters[3] = new KeyValue("@BankId", user.UBank);
//                        parameters[4] = new KeyValue("@CrtDate", now);
//                        parameters[5] = new KeyValue("@CrtUser", commandAsker.UserId);

//                        int count = 0;
//                        result = tsFactory.ExecuteNonQuery(sql, parameters, out count);

//                        #region 新增日誌資料
//                        if (dbLogger != null)
//                        {
//                            string notation = null;
//                            if (result.IsSuccess)
//                            {
//                                notation = String.Format("[{0}] {1}使用者權限資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
//                            }
//                            else
//                            {
//                                notation = String.Format("[{0}] {1}使用者權限資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
//                            }
//                            dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
//                        }
//                        #endregion
//                    }
//                    #endregion
                    #endregion
                }
                catch (Exception ex)
                {
                    string notation = String.Format("[{0}] {1}新增資料發生例外 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, ex.Message);
                    result = new Result(false, notation, CoreStatusCode.UNKNOWN_EXCEPTION, ex);

                    #region 新增日誌資料
                    if (dbLogger != null)
                    {
                        dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                    }
                    #endregion
                }
                finally
                {
                    if (tsFactory != null)
                    {
                        if (result.IsSuccess)
                        {
                            tsFactory.Commit();
                        }
                        else
                        {
                            tsFactory.Rollback();
                        }
                        tsFactory.Dispose();
                        tsFactory = null;
                    }

                    #region Release DBLogger
                    if (!result.IsSuccess)
                    {
                        if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                        {
                            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                        }
                        else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                        {
                            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                        }
                    }
                    string logErrmsg = this.ReleaseDBLogger(true);
                    if (dbLogger != null)
                    {
                        dbLogger.Dispose();
                        dbLogger = null;
                    }
                    #endregion
                }

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 更新 S530001 (使用者管理) 頁面用的修改資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <returns></returns>
        public Result S530001UpdateData(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments)
        {
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string userId = null;
            string groupId = null;
            string receiveType = null;
            string bankId = null;

            string newReceiveType = null;

            string userName = null;

            #region [MDY:20220530] Checkmarx 調整
            string userPXX = null;
            #endregion

            string title = null;
            string tel = null;
            string email = null;
            string locked = null;

            string userRightsTxt = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "USERID":
                        userId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "GROUPID":
                        groupId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "BANKID":
                        bankId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;

                    case "NEWRECEIVETYPE":
                        newReceiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;

                    #region [MDY:20220530] Checkmarx 調整
                    case "USERPXX":
                        userPXX = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    #endregion

                    case "USERNAME":
                        userName = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "TITLE":
                        title = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "TEL":
                        tel = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "EMAIL":
                        email = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "LOCKED":
                        locked = argument.Value == null ? String.Empty : argument.Value.Trim().ToUpper();
                        break;

                    case "USERRIGHTS":
                        userRightsTxt = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                }
            }

            #region [MDY:20220530] Checkmarx 調整
            if (String.IsNullOrEmpty(userId)        //必要參數且不可為空字串
                || String.IsNullOrEmpty(groupId)    //必要參數且不可為空字串
                || String.IsNullOrEmpty(bankId)     //必要參數且不可為空字串
                || receiveType == null              //必要參數
                || newReceiveType == null           //必要參數
                || userPXX == null                 //必要參數
                || String.IsNullOrEmpty(userName)   //必要參數且不可為空字串
                || (locked != "Y" && locked != "N") //必要參數且限 "Y" / "N"
                || userRightsTxt == null)           //必要參數
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            Result result = null;

            #region [Old] 土銀不使用使用者權限
            //#region 處理 userRightsTxt 參數
            //KeyValueList<string> userRights = new KeyValueList<string>();
            //if (!String.IsNullOrEmpty(userRightsTxt))
            //{
            //    KeyValueList<string> rights = KeyValueList<string>.Split(userRightsTxt);
            //    if (rights == null)
            //    {
            //        return new Result(false, "無效的使用者權限參數", CoreStatusCode.INVALID_PARAMETER, null);
            //    }
            //    if (rights.Count > 0)
            //    {
            //        #region 取得功能選單資料
            //        FuncMenuEntity[] funcMenus = null;
            //        {
            //            Expression where = new Expression(FuncMenuEntity.Field.Status, DataStatusCodeTexts.NORMAL);
            //            KeyValueList<OrderByEnum> orderbys = new KeyValueList<OrderByEnum>();
            //            orderbys.Add(FuncMenuEntity.Field.FuncId, OrderByEnum.Asc);
            //            result = _Factory.SelectAll<FuncMenuEntity>(where, orderbys, out funcMenus);

            //            #region 儲存日誌資料並釋放資料庫日誌記錄器
            //            if (dbLogger != null)
            //            {
            //                string notation = null;
            //                if (result.IsSuccess)
            //                {
            //                    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, funcMenus == null ? 0 : funcMenus.Length);
            //                }
            //                else
            //                {
            //                    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
            //                }
            //                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
            //            }
            //            #endregion

            //            if (!result.IsSuccess)
            //            {
            //                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
            //                {
            //                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
            //                }
            //                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
            //                {
            //                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
            //                }

            //                #region 儲存日誌資料並釋放資料庫日誌記錄器
            //                string logErrmsg = this.ReleaseDBLogger(true);
            //                if (dbLogger != null)
            //                {
            //                    dbLogger.Dispose();
            //                    dbLogger = null;
            //                }
            //                #endregion

            //                return result;
            //            }

            //            if (funcMenus == null)
            //            {
            //                funcMenus = new FuncMenuEntity[0];
            //            }
            //        }
            //        #endregion

            //        if (funcMenus != null && funcMenus.Length > 0)
            //        {
            //            foreach (KeyValue<string> right in rights)
            //            {
            //                string funcId = right.Key;
            //                string rightCode = GroupRightEntity.FormatRightCode(right.Value == null ? null : right.Value.Trim());
            //                if (funcId.Length > 3 && rightCode != GroupRightEntity.None_RightCode)    //funcId.Length < 3 視為 Menu，不處理
            //                {
            //                    FuncMenuEntity myFuncMenu = null;
            //                    myFuncMenu = Array.Find<FuncMenuEntity>(funcMenus, x => x.FuncId == funcId);
            //                    if (myFuncMenu != null)
            //                    {
            //                        userRights.Add(funcId, rightCode);

            //                        #region 有父層且為 Menu (parnetId.Length <= 3) 且未加入
            //                        string parnetId = myFuncMenu.ParentId;
            //                        if (!String.IsNullOrEmpty(parnetId) && parnetId.Length <= 3 && userRights.GetKeyFirstIndex(parnetId) < 0)
            //                        {
            //                            FuncMenuEntity myParentMenu = Array.Find<FuncMenuEntity>(funcMenus, x => x.FuncId == parnetId);
            //                            if (myParentMenu != null)
            //                            {
            //                                userRights.Add(parnetId, GroupRightEntity.All_RightCode);

            //                                #region 最多有三層，要處理父層的父層
            //                                string grandParnetId = myParentMenu.ParentId;
            //                                if (!String.IsNullOrEmpty(grandParnetId) && grandParnetId.Length <= 3 && userRights.GetKeyFirstIndex(grandParnetId) < 0)
            //                                {
            //                                    FuncMenuEntity myGrandParentMenu = Array.Find<FuncMenuEntity>(funcMenus, x => x.FuncId == grandParnetId);
            //                                    if (myGrandParentMenu != null)
            //                                    {
            //                                        userRights.Add(grandParnetId, GroupRightEntity.All_RightCode);
            //                                    }
            //                                }
            //                                #endregion
            //                            }
            //                        }
            //                        #endregion
            //                    }
            //                }
            //            }
            //        }
            //    }
            //}
            //#endregion
            #endregion

            #region 取得群組資料
            GroupListEntity group = null;
            {
                Expression where = new Expression(GroupListEntity.Field.GroupId, groupId);
                result = _Factory.SelectFirst<GroupListEntity>(where, null, out group);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}群組資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, (group == null ? 0 : 1));
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}群組資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                }
                #endregion

                if (result.IsSuccess)
                {
                    if (group == null)
                    {
                        result = new Result(false, "查無群組資料", CoreStatusCode.S_SELECT_DATA_FAILURE, null);
                    }
                    //else if (group.Role != RoleCodeTexts.SCHOOL)
                    //{
                    //    result = new Result(false, "此功能僅限維護學校的群組", CoreStatusCode.INVALID_PARAMETER, null);
                    //}
                }
                if (!result.IsSuccess)
                {
                    if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
                    }
                    else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
                    }

                    string logErrmsg = this.ReleaseDBLogger(true);
                    if (dbLogger != null)
                    {
                        dbLogger.Dispose();
                        dbLogger = null;
                    }
                    return result;
                }
            }
            #endregion

            #region 處理原商家代號
            if (!String.IsNullOrEmpty(receiveType) && receiveType != "*")
            {
                string[] receiveTypes = receiveType.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
                for (int idx = 0; idx < receiveTypes.Length; idx++)
                {
                    receiveTypes[idx] = receiveTypes[idx].Trim();
                }
                receiveType = "," + String.Join(",", receiveTypes) + ",";
            }
            #endregion

            #region 檢查新商家代號
            if (group.Role == RoleCodeTexts.STAFF)
            {
                newReceiveType = String.Empty; //行員的授權商家代號，固定設為空字串
            }
            else
            {
                if (group.RoleType == RoleTypeCodeTexts.MANAGER)
                {
                    newReceiveType = "*";  //學校管理者的授權商家代號，固定設為 *
                }
                else if (String.IsNullOrEmpty(newReceiveType))
                {
                    newReceiveType = ",";   //學校經辦未指定授權商家代號，要設為逗號，避免與行員相同
                }
                else
                {
                    string[] newReceiveTypes = newReceiveType.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
                    for (int idx = 0; idx < newReceiveTypes.Length; idx++)
                    {
                        newReceiveTypes[idx] = newReceiveTypes[idx].Trim();
                    }
                    newReceiveType = "," + String.Join(",", newReceiveTypes) + ",";
                    int count = 0;
                    Expression where = new Expression(SchoolRTypeEntity.Field.ReceiveType, newReceiveTypes)
                        .And(SchoolRTypeEntity.Field.Status, DataStatusCodeTexts.NORMAL);
                    result = _Factory.SelectCount<SchoolRTypeEntity>(where, out count);

                    #region 新增日誌資料
                    if (dbLogger != null)
                    {
                        string notation = null;
                        if (result.IsSuccess)
                        {
                            notation = String.Format("[{0}] {1}商家代號是否存在成功 ({2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, (count > 0 ? "存在" : "不存在"));
                        }
                        else
                        {
                            notation = String.Format("[{0}] {1}商家代號是否存在失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                        }
                        dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                    }
                    #endregion

                    if (result.IsSuccess && count != newReceiveTypes.Length)
                    {
                        result = new Result(false, "所屬商家代號參數包含無效的值", CoreStatusCode.INVALID_PARAMETER, null);
                    }
                    if (!result.IsSuccess)
                    {
                        if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                        {
                            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
                        }
                        else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                        {
                            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
                        }

                        string logErrmsg = this.ReleaseDBLogger(true);
                        if (dbLogger != null)
                        {
                            dbLogger.Dispose();
                            dbLogger = null;
                        }
                        return result;
                    }
                }
            }
            #endregion

            #region [Old] 檢查商家代號代碼
            //if (!String.IsNullOrEmpty(newReceiveType))
            //{
            //    string[] receiveTypes = newReceiveType.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
            //    for (int idx = 0; idx < receiveTypes.Length; idx++)
            //    {
            //        receiveTypes[idx] = receiveTypes[idx].Trim();
            //    }
            //    newReceiveType = "," + String.Join(",", receiveTypes) + ",";
            //    int count = 0;
            //    Expression where = new Expression(SchoolRTypeEntity.Field.ReceiveType, receiveTypes)
            //        .And(SchoolRTypeEntity.Field.Status, DataStatusCodeTexts.NORMAL);
            //    result = _Factory.SelectCount<SchoolRTypeEntity>(where, out count);

            //    #region 新增日誌資料
            //    if (dbLogger != null)
            //    {
            //        string notation = null;
            //        if (result.IsSuccess)
            //        {
            //            notation = String.Format("[{0}] {1}商家代號是否存在成功 ({2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, (count > 0 ? "存在" : "不存在"));
            //        }
            //        else
            //        {
            //            notation = String.Format("[{0}] {1}商家代號是否存在失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
            //        }
            //        dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
            //    }
            //    #endregion

            //    if (result.IsSuccess && count != receiveTypes.Length)
            //    {
            //        result = new Result(false, "所屬商家代號參數包含無效的值", CoreStatusCode.INVALID_PARAMETER, null);
            //    }
            //    if (!result.IsSuccess)
            //    {
            //        if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
            //        {
            //            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
            //        }
            //        else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
            //        {
            //            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
            //        }

            //        string logErrmsg = this.ReleaseDBLogger(true);
            //        if (dbLogger != null)
            //        {
            //            dbLogger.Dispose();
            //            dbLogger = null;
            //        }
            //        return result;
            //    }
            //}
            #endregion

            #region 檢查使用者帳號是否存在
            {
                Expression where = new Expression(UsersEntity.Field.UBank, bankId)
                    .And(UsersEntity.Field.UId, userId)
                    .And(UsersEntity.Field.UGrp, groupId)
                    .And(UsersEntity.Field.URt, new string[] { receiveType, receiveType.Trim(',', ' ') });  //因為部分資料比較早轉置，沒有前後補逗號
                UsersEntity user = null;
                result = _Factory.SelectFirst<UsersEntity>(where, null, out user);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}使用者帳號是否存在成功 ({2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, (user != null ? "存在" : "不存在"));
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}使用者帳號是否存在失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                }
                #endregion

                if (result.IsSuccess && user == null)
                {
                    result = new Result(false, "使用者帳號不存在", ErrorCode.D_DATA_EXISTS, null);
                }
                if (!result.IsSuccess)
                {
                    if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
                    }
                    else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
                    }

                    string logErrmsg = this.ReleaseDBLogger(true);
                    if (dbLogger != null)
                    {
                        dbLogger.Dispose();
                        dbLogger = null;
                    }
                    return result;
                }
                receiveType = user.URt; //取得實際上的 URt 欄位值

                #region [MDY:20160921] 使用者密碼加密
                #region [MDY:20220530] Checkmarx 調整
                if (!user.IsBank() && !String.IsNullOrEmpty(userPXX))
                {
                    userPXX = DataFormat.GetUserPXXEncode(userPXX);
                    if (String.IsNullOrEmpty(userPXX))
                    {
                        return new Result(false, "登入密碼加解密處理失敗", CoreStatusCode.UNKNOWN_ERROR, null);
                    }
                }
                #endregion
                #endregion
            }
            #endregion

            #region 取得 commandAsker 的使用者資料
            //UsersEntity asker = null;
            //{
            //    result = this.GetUserByCommandAsker(dbLogger, commandAsker, out asker);
            //    if (!result.IsSuccess)
            //    {
            //        if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
            //        {
            //            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
            //        }
            //        else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
            //        {
            //            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
            //        }

            //        string logErrmsg = this.ReleaseDBLogger(true);
            //        if (dbLogger != null)
            //        {
            //            dbLogger.Dispose();
            //            dbLogger = null;
            //        }
            //        return result;
            //    }
            //}
            #endregion

            #region 更新資料 (使用交易)
            {
                DateTime now = DateTime.Now;
                result = new Result(true);

                EntityFactory tsFactory = _Factory.CloneForTransaction();
                try
                {
                    #region 更新使用者
                    if (result.IsSuccess)
                    {
                        KeyValueList parameters = new KeyValueList();

                        #region [MDY:20210311] 密碼欄位 (更換變數名稱避免原碼掃描)
                        #region [MDY:20210401] 原碼修正
                        #region [MDY:20220530] Checkmarx 調整
                        string sqlSetPXX = null;
                        if (String.IsNullOrEmpty(userPXX)) //不更新密碼欄位
                        {
                            sqlSetPXX = String.Empty;
                        }
                        else
                        {
                            sqlSetPXX = String.Format(", [{0}] = [{1}], [{1}] = @NewPXX, [{2}] = @PXXChangeDate", UsersEntity.Field.UPXX1, UsersEntity.Field.UPXX, UsersEntity.Field.PXXChangeDate);

                            parameters.Add(new KeyValue("@NewPXX", userPXX));
                            parameters.Add(new KeyValue("@PXXChangeDate", Common.GetTWDate7(now)));
                        }
                        #endregion
                        #endregion
                        #endregion

                        #region [MDY:20220530] Checkmarx 調整
                        string sql = String.Format(@"UPDATE [{0}] 
SET [{1}] = @ReceiveType, [{2}] = @UserName, [{3}] = @Tel, [{4}] = @Title, [{5}] = @Email, [{6}] = @LockFlag 
{7} 
, [{12}] = '0', [{13}] = '0', [{14}] = 0 
WHERE [{8}] = @OrgUserId AND [{9}] = @OrgGroupId AND [{10}] = @OrgReceiveType AND [{11}] = @OrgBankId"
                                        , UsersEntity.TABLE_NAME            //0 (TABLE NAME)
                                        , UsersEntity.Field.URt     //1 (SET)
                                        , UsersEntity.Field.UName
                                        , UsersEntity.Field.Tel
                                        , UsersEntity.Field.Title
                                        , UsersEntity.Field.Email
                                        , UsersEntity.Field.ULock        //6
                                        , sqlSetPXX      //7
                                        , UsersEntity.Field.UId      //8 (WHERE)
                                        , UsersEntity.Field.UGrp
                                        , UsersEntity.Field.URt
                                        , UsersEntity.Field.UBank      //11
                                        , UsersEntity.Field.ProcessStatus   //12    舊學雜費寫法，不知道為什麽
                                        , UsersEntity.Field.DataStatus      //13    舊學雜費寫法，不知道為什麽
                                        , UsersEntity.Field.UNum);          //14    舊學雜費寫法，不知道為什麽
                        parameters.Add("@ReceiveType", newReceiveType);
                        parameters.Add("@UserName", userName);
                        parameters.Add("@Tel", tel);
                        parameters.Add("@Title", title);
                        parameters.Add("@Email", email);
                        parameters.Add("@LockFlag", locked);
                        parameters.Add("@OrgUserId", userId);
                        parameters.Add("@OrgGroupId", groupId);
                        parameters.Add("@OrgReceiveType", receiveType);
                        parameters.Add("@OrgBankId", bankId);
                        #endregion

                        int count = 0;
                        result = tsFactory.ExecuteNonQuery(sql, parameters, out count);

                        if (result.IsSuccess && count == 0)
                        {
                            result = new Result(false, "無使用者資料被更新", CoreStatusCode.D_NOT_DATA_UPDATE, null);
                        }

                        #region 新增日誌資料
                        if (dbLogger != null)
                        {
                            string notation = null;
                            if (result.IsSuccess)
                            {
                                notation = String.Format("[{0}] {1}使用者資料成功 (userId={2}, groupId={3}, receiveType={4}, bankId={5})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, userId, groupId, receiveType, bankId);
                            }
                            else
                            {
                                notation = String.Format("[{0}] {1}使用者資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, result.Message);
                            }
                            dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.UPDATE, commandAsker.UserId, notation);
                        }
                        #endregion
                    }
                    #endregion

                    #region [Old] 土銀不使用使用者權限
//                    #region 更新使用者權限
//                    if (result.IsSuccess && group.RoleType == RoleTypeCodeTexts.USER)
//                    {
//                        #region 先刪除舊資料
//                        {
//                            string sql = String.Format("DELETE [{0}] WHERE [{1}] = @UserId AND [{2}] = @GroupId AND [{3}] = @ReceiveType AND [{4}] = @BankId"
//                                            , UsersRightEntity.TABLE_NAME       //0 (TABLE NAME)
//                                            , UsersRightEntity.Field.UId     //1 (WHERE)
//                                            , UsersRightEntity.Field.UGrp
//                                            , UsersRightEntity.Field.URt
//                                            , UsersRightEntity.Field.UBank);
//                            KeyValue[] parameters = new KeyValue[4];
//                            parameters[0] = new KeyValue("@UserId", userId);
//                            parameters[1] = new KeyValue("@GroupId", groupId);
//                            parameters[2] = new KeyValue("@ReceiveType", receiveType);
//                            parameters[3] = new KeyValue("@BankId", bankId);

//                            int count = 0;
//                            result = tsFactory.ExecuteNonQuery(sql, parameters, out count);

//                            #region 新增日誌資料
//                            if (dbLogger != null)
//                            {
//                                string notation = null;
//                                if (result.IsSuccess)
//                                {
//                                    notation = String.Format("[{0}] {1}舊的使用者權限資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
//                                }
//                                else
//                                {
//                                    notation = String.Format("[{0}] {1}舊的使用者權限資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
//                                }
//                                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
//                            }
//                            #endregion
//                        }
//                        #endregion

//                        #region 新增新資料
//                        if (result.IsSuccess && userRights != null && userRights.Count > 0)
//                        {
//                            foreach (KeyValue<string> userRight in userRights)
//                            {
//                                #region [Old]
////                                string sql = String.Format(@"INSERT INTO [{0}]
////([{1}], [{2}], [{3}], [{4}], [{5}], [{6}], [{7}], [{8}], [{9}]) 
////VALUES (@{1}, @{2}, @{3}, @{4}, @{5}, @{6}, @{7}, @{8}, @{9})"
////                                                , UsersRightEntity.TABLE_NAME       //0 (TABLE NAME)
////                                                , UsersRightEntity.Field.UserId     //1 (FIELD)
////                                                , UsersRightEntity.Field.GroupId
////                                                , UsersRightEntity.Field.ReceiveType
////                                                , UsersRightEntity.Field.BankId
////                                                , UsersRightEntity.Field.FuncId
////                                                , UsersRightEntity.Field.RightCode
////                                                , UsersRightEntity.Field.Status
////                                                , UsersRightEntity.Field.CrtDate
////                                                , UsersRightEntity.Field.CrtUser);   //9
////                                KeyValue[] parameters = new KeyValue[9];
////                                parameters[0] = new KeyValue(String.Format("@{0}", UsersRightEntity.Field.UserId), userId);
////                                parameters[1] = new KeyValue(String.Format("@{0}", UsersRightEntity.Field.GroupId), groupId);
////                                parameters[2] = new KeyValue(String.Format("@{0}", UsersRightEntity.Field.ReceiveType), receiveType);
////                                parameters[3] = new KeyValue(String.Format("@{0}", UsersRightEntity.Field.BankId), bankId);
////                                parameters[4] = new KeyValue(String.Format("@{0}", UsersRightEntity.Field.FuncId), userRight.Key);
////                                parameters[5] = new KeyValue(String.Format("@{0}", UsersRightEntity.Field.RightCode), userRight.Value);
////                                parameters[6] = new KeyValue(String.Format("@{0}", UsersRightEntity.Field.Status), DataStatusCodeTexts.NORMAL);
////                                parameters[7] = new KeyValue(String.Format("@{0}", UsersRightEntity.Field.CrtDate), now);
////                                parameters[8] = new KeyValue(String.Format("@{0}", UsersRightEntity.Field.CrtUser), commandAsker.UserId);
//                                #endregion

//                                #region [New]
//                                string sql = String.Format(@"INSERT INTO [{0}] 
//([{1}], [{2}], [{3}], [{4}], [{5}], [{6}], [{7}], [{8}], [{9}])
//SELECT @UserId, @GroupId, @ReceiveType, @BankId, @FuncId, @RightCode, @Status, @CrtDate, @CrtUser
//  FROM [{10}]
// WHERE [{11}] = @GroupId AND [{12}] = @FuncId
//   AND ([{13}] = '1' Or [{13}] = @RightCode)"
//                                                , UsersRightEntity.TABLE_NAME       //0 (INSERT TABLE NAME)
//                                                , UsersRightEntity.Field.UId     //1 (FIELD)
//                                                , UsersRightEntity.Field.UGrp
//                                                , UsersRightEntity.Field.URt
//                                                , UsersRightEntity.Field.UBank
//                                                , UsersRightEntity.Field.FuncId
//                                                , UsersRightEntity.Field.RightCode
//                                                , UsersRightEntity.Field.Status
//                                                , UsersRightEntity.Field.CrtDate
//                                                , UsersRightEntity.Field.CrtUser    //9
//                                                , GroupRightEntity.TABLE_NAME       //10 (FROM TABLE NAME)
//                                                , GroupRightEntity.Field.GroupId    //11 (WHERE)
//                                                , GroupRightEntity.Field.FuncId
//                                                , GroupRightEntity.Field.RightCode);    //13
//                                KeyValue[] parameters = new KeyValue[9];
//                                parameters[0] = new KeyValue("@UserId", userId);
//                                parameters[1] = new KeyValue("@GroupId", groupId);
//                                parameters[2] = new KeyValue("@ReceiveType", newReceiveType);
//                                parameters[3] = new KeyValue("@BankId", bankId);
//                                parameters[4] = new KeyValue("@FuncId", userRight.Key);
//                                parameters[5] = new KeyValue("@RightCode", userRight.Value);
//                                parameters[6] = new KeyValue("@Status", DataStatusCodeTexts.NORMAL);
//                                parameters[7] = new KeyValue("@CrtDate", now);
//                                parameters[8] = new KeyValue("@CrtUser", commandAsker.UserId);
//                                #endregion

//                                int count = 0;
//                                result = tsFactory.ExecuteNonQuery(sql, parameters, out count);

//                                #region 新增日誌資料
//                                if (dbLogger != null)
//                                {
//                                    string notation = null;
//                                    if (result.IsSuccess)
//                                    {
//                                        notation = String.Format("[{0}] {1}使用者權限資料成功 (FuncId={2}, RightCode={3})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, userRight.Key, userRight.Value);
//                                    }
//                                    else
//                                    {
//                                        notation = String.Format("[{0}] {1}使用者權限資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
//                                    }
//                                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
//                                }
//                                #endregion

//                                if (!result.IsSuccess)
//                                {
//                                    break;
//                                }
//                            }
//                        }
//                        #endregion
//                    }
//                    #endregion
                    #endregion
                }
                catch (Exception ex)
                {
                    string notation = String.Format("[{0}] {1}資料發生例外 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, ex.Message);
                    result = new Result(false, notation, CoreStatusCode.UNKNOWN_EXCEPTION, ex);

                    #region 新增日誌資料
                    if (dbLogger != null)
                    {
                        dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.UPDATE, commandAsker.UserId, notation);
                    }
                    #endregion
                }
                finally
                {
                    if (tsFactory != null)
                    {
                        if (result.IsSuccess)
                        {
                            tsFactory.Commit();
                        }
                        else
                        {
                            tsFactory.Rollback();
                        }
                        tsFactory.Dispose();
                        tsFactory = null;
                    }

                    #region Release DBLogger
                    if (!result.IsSuccess)
                    {
                        if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                        {
                            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_UPDATE_DATA_EXCEPTION, result.Exception);
                        }
                        else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                        {
                            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_UPDATE_DATA_EXCEPTION, result.Exception);
                        }
                    }
                    string logErrmsg = this.ReleaseDBLogger(true);
                    if (dbLogger != null)
                    {
                        dbLogger.Dispose();
                        dbLogger = null;
                    }
                    #endregion
                }

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 刪除 S530001 (使用者管理) 頁面用的刪除資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <returns></returns>
        public Result S530001DeleteData(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments)
        {
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string userId = null;
            string groupId = null;
            string receiveType = null;
            string bankId = null;

            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "USERID":
                        userId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "GROUPID":
                        groupId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "BANKID":
                        bankId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(userId)        //必要參數且不可為空字串
                || String.IsNullOrEmpty(groupId)    //必要參數且不可為空字串
                || String.IsNullOrEmpty(bankId)     //必要參數且不可為空字串
                || receiveType == null)             //必要參數
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 處理商家代號代碼
            if (!String.IsNullOrEmpty(receiveType) && receiveType != "*")
            {
                string[] receiveTypes = receiveType.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
                for (int idx = 0; idx < receiveTypes.Length; idx++)
                {
                    receiveTypes[idx] = receiveTypes[idx].Trim();
                }
                receiveType = "," + String.Join(",", receiveTypes) + ",";
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            Result result = null;

            #region 刪除資料 (使用交易)
            {
                DateTime now = DateTime.Now;
                result = new Result(true);

                EntityFactory tsFactory = _Factory.CloneForTransaction();
                try
                {
                    #region 刪除使用者
                    if (result.IsSuccess)
                    {
                        KeyValueList parameters = new KeyValueList();

                        string sql = String.Format(@"DELETE [{0}] WHERE [{1}] = @UserId AND [{2}] = @GroupId AND [{3}] = @ReceiveType AND [{4}] = @BankId"
                                        , UsersEntity.TABLE_NAME        //0 (TABLE NAME)
                                        , UsersEntity.Field.UId      //1 (WHERE)
                                        , UsersEntity.Field.UGrp
                                        , UsersEntity.Field.URt
                                        , UsersEntity.Field.UBank);
                        parameters.Add("@UserId", userId);
                        parameters.Add("@GroupId", groupId);
                        parameters.Add("@ReceiveType", receiveType);
                        parameters.Add("@BankId", bankId);

                        int count = 0;
                        result = tsFactory.ExecuteNonQuery(sql, parameters, out count);

                        if (result.IsSuccess && count == 0)
                        {
                            result = new Result(false, "無使用者資料被刪除", CoreStatusCode.D_NOT_DATA_UPDATE, null);
                        }

                        #region 新增日誌資料
                        if (dbLogger != null)
                        {
                            string notation = null;
                            if (result.IsSuccess)
                            {
                                notation = String.Format("[{0}] {1}使用者資料成功 (userId={2}, groupId={3}, receiveType={4}, bankId={5})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, userId, groupId, receiveType, bankId);
                            }
                            else
                            {
                                notation = String.Format("[{0}] {1}使用者資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                            }
                            dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                        }
                        #endregion
                    }
                    #endregion

                    #region [Old] 土銀不使用使用者權限
                    //#region 刪除使用者權限
                    //if (result.IsSuccess)
                    //{
                    //    string sql = String.Format("DELETE [{0}] WHERE [{1}] = @UserId AND [{2}] = @GroupId AND [{3}] = @ReceiveType AND [{4}] = @BankId"
                    //                    , UsersRightEntity.TABLE_NAME       //0 (TABLE NAME)
                    //                    , UsersRightEntity.Field.UId     //1 (WHERE)
                    //                    , UsersRightEntity.Field.UGrp
                    //                    , UsersRightEntity.Field.URt
                    //                    , UsersRightEntity.Field.UBank);
                    //    KeyValue[] parameters = new KeyValue[4];
                    //    parameters[0] = new KeyValue("@UserId", userId);
                    //    parameters[1] = new KeyValue("@GroupId", groupId);
                    //    parameters[2] = new KeyValue("@ReceiveType", receiveType);
                    //    parameters[3] = new KeyValue("@BankId", bankId);

                    //    int count = 0;
                    //    result = tsFactory.ExecuteNonQuery(sql, parameters, out count);

                    //    #region 新增日誌資料
                    //    if (dbLogger != null)
                    //    {
                    //        string notation = null;
                    //        if (result.IsSuccess)
                    //        {
                    //            notation = String.Format("[{0}] {1}舊的使用者權限資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                    //        }
                    //        else
                    //        {
                    //            notation = String.Format("[{0}] {1}舊的使用者權限資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                    //        }
                    //        dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                    //    }
                    //    #endregion
                    //}
                    //#endregion
                    #endregion
                }
                catch (Exception ex)
                {
                    string notation = String.Format("[{0}] {1}刪除資料發生例外 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, ex.Message);
                    result = new Result(false, notation, CoreStatusCode.UNKNOWN_EXCEPTION, ex);

                    #region 新增日誌資料
                    if (dbLogger != null)
                    {
                        dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                    }
                    #endregion
                }
                finally
                {
                    if (tsFactory != null)
                    {
                        if (result.IsSuccess)
                        {
                            tsFactory.Commit();
                        }
                        else
                        {
                            tsFactory.Rollback();
                        }
                        tsFactory.Dispose();
                        tsFactory = null;
                    }

                    #region Release DBLogger
                    if (!result.IsSuccess)
                    {
                        if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                        {
                            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_DELETE_DATA_EXCEPTION, result.Exception);
                        }
                        else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                        {
                            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_DELETE_DATA_FAILURE, result.Exception);
                        }
                    }
                    string logErrmsg = this.ReleaseDBLogger(true);
                    if (dbLogger != null)
                    {
                        dbLogger.Dispose();
                        dbLogger = null;
                    }
                    #endregion
                }

                return result;
            }
            #endregion
        }

        #region [Old] 取消放行
//        /// <summary>
//        /// 核可 S530001 (使用者管理) 頁面用的核可資料
//        /// </summary>
//        /// <param name="commandAsker"></param>
//        /// <param name="arguments"></param>
//        /// <returns></returns>
//        public Result S530001ApproveData(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
//        {
//            data = null;
//            if (arguments == null || arguments.Count == 0)
//            {
//                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
//            }

//            #region 取得執行參數
//            string userId = null;
//            string groupId = null;
//            string receiveType = null;
//            string bankId = null;
//            string approverId = null;

//            foreach (KeyValue<string> argument in arguments)
//            {
//                string argName = argument.Key.ToUpper();
//                switch (argName)
//                {
//                    case "USERID":
//                        userId = argument.Value == null ? String.Empty : argument.Value.Trim();
//                        break;
//                    case "GROUPID":
//                        groupId = argument.Value == null ? String.Empty : argument.Value.Trim();
//                        break;
//                    case "RECEIVETYPE":
//                        receiveType = argument.Value == String.Empty ? null : argument.Value.Trim();
//                        break;
//                    case "BANKID":
//                        bankId = argument.Value == null ? String.Empty : argument.Value.Trim();
//                        break;
//                    case "APPROVERID":
//                        approverId = argument.Value == null ? String.Empty : argument.Value.Trim();
//                        break;
//                }
//            }
//            if (String.IsNullOrEmpty(userId)        //必要參數且不可為空字串
//                || String.IsNullOrEmpty(groupId)    //必要參數且不可為空字串
//                || receiveType == null              //必要參數
//                || bankId == null                   //必要參數
//                || (String.IsNullOrEmpty(receiveType) && String.IsNullOrEmpty(bankId))  //不可同時為空字串
//                || String.IsNullOrEmpty(approverId)) //必要參數
//            {
//                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
//            }
//            #endregion

//            #region 取得初始化的資料庫日誌記錄器
//            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
//            #endregion

//            Result result = null;

//            #region 取得被核可者的資料
//            string password = null;
//            string roleType = null;
//            {
//                string sql = String.Format(@"
//SELECT ISNULL(u.[{1}], '') AS [PASSWORD] 
//     , ISNULL((SELECT [{8}] FROM [{7}] g WHERE g.[{9}] = u.[{10}]), '') AS [ROLE_TYPE] 
//  FROM [{0}] u 
// WHERE u.[{2}] = @UserId AND u.[{3}] = @GroupId AND u.[{4}] = @ReceiveType AND u.[{5}] = @BankId 
//   AND (u.[{6}] IS NULL OR u.[{6}] = '')"
//                    , UsersEntity.TABLE_NAME        //0 (MAIN TABLE)
//                    , UsersEntity.Field.Password    //1
//                    , UsersEntity.Field.UserId      //2 (WHERE)
//                    , UsersEntity.Field.GroupId
//                    , UsersEntity.Field.ReceiveType
//                    , UsersEntity.Field.BankId      //5
//                    , UsersEntity.Field.Approver    //6
//                    , GroupListEntity.TABLE_NAME    //7 (SUB TABLE)
//                    , GroupListEntity.Field.RoleType//8
//                    , GroupListEntity.Field.GroupId //9 (SUB WHERE)
//                    , UsersEntity.Field.GroupId);

//                KeyValueList parameters = new KeyValueList();
//                parameters.Add("@UserId", userId);
//                parameters.Add("@GroupId", groupId);
//                parameters.Add("@ReceiveType", receiveType);
//                parameters.Add("@BankId", bankId);

//                DataTable dt = null;
//                result = _Factory.GetDataTable(sql, parameters, 0, 1, out dt);

//                #region 新增日誌資料
//                if (dbLogger != null)
//                {
//                    string notation = null;
//                    if (result.IsSuccess)
//                    {
//                        notation = String.Format("[{0}] {1}被核可使用者資料成功 (userId={2}, groupId={3}, receiveType={4}, bankId={5})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, userId, groupId, receiveType, bankId);
//                    }
//                    else
//                    {
//                        notation = String.Format("[{0}] {1}被核可使用者資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
//                    }
//                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
//                }
//                #endregion

//                if (result.IsSuccess)
//                {
//                    if (dt == null || dt.Rows.Count == 0)
//                    {
//                        result = new Result(false, "無法取得被核可者的資料", ErrorCode.D_DATA_NOT_FOUND, null);
//                    }
//                    else
//                    {
//                        DataRow row = dt.Rows[0];
//                        password = row["PASSWORD"].ToString();
//                        roleType = row["ROLE_TYPE"].ToString();
//                    }
//                }

//                if (!result.IsSuccess)
//                {
//                    if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
//                    {
//                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
//                    }
//                    else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
//                    {
//                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
//                    }

//                    string logErrmsg = this.ReleaseDBLogger(true);
//                    if (dbLogger != null)
//                    {
//                        dbLogger.Dispose();
//                        dbLogger = null;
//                    }
//                    return result;
//                }
//            }
//            #endregion

//            #region 更新資料 (只有一筆資料無須交易)
//            {
//                DateTime now = DateTime.Now;
//                result = new Result(true);

//                try
//                {
//                    #region 更新使用者
//                    if (result.IsSuccess)
//                    {
//                        KeyValueList parameters = new KeyValueList();

//                        string sql = String.Format(@"
//UPDATE [{0}] SET [{1}] = @Approver, [{2}] = @ApproveDate 
// WHERE [{3}] = @UserId AND [{4}] = @GroupId AND [{5}] = @ReceiveType AND [{6}] = @BankId 
//   AND ([{1}] IS NULL OR [{1}] = '')"
//                                        , UsersEntity.TABLE_NAME        //0 (TABLE NAME)
//                                        , UsersEntity.Field.Approver    //1 (SET)
//                                        , UsersEntity.Field.ApproveDate //2
//                                        , UsersEntity.Field.UserId      //3 (WHERE)
//                                        , UsersEntity.Field.GroupId
//                                        , UsersEntity.Field.ReceiveType
//                                        , UsersEntity.Field.BankId);
//                        parameters.Add("@Approver", approverId);
//                        parameters.Add("@ApproveDate", now.ToString("yyyyMMdd"));
//                        parameters.Add("@UserId", userId);
//                        parameters.Add("@GroupId", groupId);
//                        parameters.Add("@ReceiveType", receiveType);
//                        parameters.Add("@BankId", bankId);

//                        int count = 0;
//                        result = _Factory.ExecuteNonQuery(sql, parameters, out count);

//                        if (result.IsSuccess && count == 0)
//                        {
//                            result = new Result(false, "無使用者資料被核可", CoreStatusCode.D_NOT_DATA_UPDATE, null);
//                        }

//                        #region 新增日誌資料
//                        if (dbLogger != null)
//                        {
//                            string notation = null;
//                            if (result.IsSuccess)
//                            {
//                                notation = String.Format("[{0}] {1}使用者核可資料成功 (userId={2}, groupId={3}, receiveType={4}, bankId={5}, approverId={6})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, userId, groupId, receiveType, bankId, approverId);
//                            }
//                            else
//                            {
//                                notation = String.Format("[{0}] {1}使用者核可資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, result.Message);
//                            }
//                            dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.UPDATE, commandAsker.UserId, notation);
//                        }
//                        #endregion
//                    }
//                    #endregion
//                }
//                catch (Exception ex)
//                {
//                    string notation = String.Format("[{0}] {1}核可資料發生例外 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, ex.Message);
//                    result = new Result(false, notation, CoreStatusCode.UNKNOWN_EXCEPTION, ex);

//                    #region 新增日誌資料
//                    if (dbLogger != null)
//                    {
//                        dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.UPDATE, commandAsker.UserId, notation);
//                    }
//                    #endregion
//                }
//                finally
//                {
//                    #region Release DBLogger
//                    if (!result.IsSuccess)
//                    {
//                        if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
//                        {
//                            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_UPDATE_DATA_EXCEPTION, result.Exception);
//                        }
//                        else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
//                        {
//                            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_UPDATE_DATA_FAILURE, result.Exception);
//                        }
//                    }
//                    string logErrmsg = this.ReleaseDBLogger(true);
//                    if (dbLogger != null)
//                    {
//                        dbLogger.Dispose();
//                        dbLogger = null;
//                    }
//                    #endregion
//                }

//                if (result.IsSuccess)
//                {
//                    data = new CodeText[] { new CodeText("PASSWORD", password), new CodeText("ROLETYLE", roleType) };
//                }

//                return result;
//            }
//            #endregion
//        }
        #endregion


        /// <summary>
        /// 取得授權的商家代號 CodeText 清單
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result GetMyReceiveTypeCodeTexts(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (commandAsker == null || !commandAsker.IsReady)
            {
                return new Result(false, "缺少或無效命令請求者的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            string receiveKind = null;
            if (arguments != null && arguments.Count > 0)
            {
                foreach (KeyValue<string> arg in arguments)
                {
                    string key = arg.Key == null ? String.Empty  : arg.Key.Trim().ToUpper();
                    switch (key)
                    {
                        case "RECEIVEKIND":
                            receiveKind = arg.Value == null ? null : arg.Value.Trim();
                            break;
                    }
                }
            }

            #region 處理查詢參數
            KeyValueList parameters = new KeyValueList(3);
            string sql = null;
            switch (commandAsker.UserQual)
            {
                case UserQualCodeTexts.BANK:
                    #region 銀行使用者
                    {
                        if (commandAsker.IsBankManager)
                        {
                            //銀行的管理者單位可查全部的商家代號
                            if (ReceiveKindCodeTexts.IsDefine(receiveKind))
                            {
                                sql = String.Format("SELECT [{1}], [{2}] FROM [{0}] WHERE [{3}] = @NormalStatus AND [{4}] = @ReceiveKind ORDER BY [{1}]"
                                        , SchoolRTypeEntity.TABLE_NAME
                                        , SchoolRTypeEntity.Field.ReceiveType
                                        , SchoolRTypeEntity.Field.SchName
                                        , SchoolRTypeEntity.Field.Status
                                        , SchoolRTypeEntity.Field.ReceiveKind);
                                parameters.Add("@NormalStatus", DataStatusCodeTexts.NORMAL);
                                parameters.Add("@ReceiveKind", receiveKind);
                            }
                            else
                            {
                                sql = String.Format("SELECT [{1}], [{2}] FROM [{0}] WHERE [{3}] = @NormalStatus ORDER BY [{1}]"
                                        , SchoolRTypeEntity.TABLE_NAME
                                        , SchoolRTypeEntity.Field.ReceiveType
                                        , SchoolRTypeEntity.Field.SchName
                                        , SchoolRTypeEntity.Field.Status);
                                parameters.Add("@NormalStatus", DataStatusCodeTexts.NORMAL);
                            }
                        }
                        else
                        {
                            //銀行的使用者單位可查所屬分行的商家代號
                            if (ReceiveKindCodeTexts.IsDefine(receiveKind))
                            {
                                sql = String.Format("SELECT [{1}], [{2}] FROM [{0}] WHERE [{3}] = @NormalStatus AND [{4}] = @BankId AND [{5}] = @ReceiveKind ORDER BY [{1}]"
                                        , SchoolRTypeEntity.TABLE_NAME
                                        , SchoolRTypeEntity.Field.ReceiveType
                                        , SchoolRTypeEntity.Field.SchName
                                        , SchoolRTypeEntity.Field.Status
                                        , SchoolRTypeEntity.Field.BankId
                                        , SchoolRTypeEntity.Field.ReceiveKind);
                                parameters.Add("@NormalStatus", DataStatusCodeTexts.NORMAL);
                                parameters.Add("@BankId", commandAsker.UnitId);
                                parameters.Add("@ReceiveKind", receiveKind);
                            }
                            else
                            {
                                sql = String.Format("SELECT [{1}], [{2}] FROM [{0}] WHERE [{3}] = @NormalStatus AND [{4}] = @BankId ORDER BY [{1}]"
                                        , SchoolRTypeEntity.TABLE_NAME
                                        , SchoolRTypeEntity.Field.ReceiveType
                                        , SchoolRTypeEntity.Field.SchName
                                        , SchoolRTypeEntity.Field.Status
                                        , SchoolRTypeEntity.Field.BankId);
                                parameters.Add("@NormalStatus", DataStatusCodeTexts.NORMAL);
                                parameters.Add("@BankId", commandAsker.UnitId);
                            }
                        }
                    }
                    #endregion
                    break;
                case UserQualCodeTexts.SCHOOL:
                    #region 學校使用者
                    {
                        UsersEntity asker = null;
                        Result result2 = this.GetUserByCommandAsker(null, commandAsker, out asker);
                        if (!result2.IsSuccess)
                        {
                            return new Result(false, "無法取得命令請求者的使用者資料", CoreStatusCode.INVALID_PARAMETER, null);
                        }
                        if (asker == null)
                        {
                            return new Result(false, "無效的命令請求者", CoreStatusCode.INVALID_PARAMETER, null);
                        }
                        //無授權商家代號法
                        if (String.IsNullOrEmpty(asker.URt))
                        {
                            data = new CodeText[0];
                            return new Result(true);
                        }
                        if (asker.URt != "*")
                        {
                            string[] inValues = asker.URt.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
                            string[] inKeys = new string[inValues.Length];
                            for (int idx = 0; idx < inKeys.Length; idx++)
                            {
                                inKeys[idx] = String.Format("@RT{0}", idx);
                                parameters.Add(inKeys[idx], inValues[idx]);
                            }

                            //學校使用者只能查自己的商家代號
                            if (ReceiveKindCodeTexts.IsDefine(receiveKind))
                            {
                                sql = String.Format("SELECT [{1}], [{2}] FROM [{0}] WHERE [{3}] = @NormalStatus AND [{4}] = @SchIdenty AND [{1}] IN ({5}) AND [{6}] = @ReceiveKind"
                                        , SchoolRTypeEntity.TABLE_NAME
                                        , SchoolRTypeEntity.Field.ReceiveType
                                        , SchoolRTypeEntity.Field.SchName
                                        , SchoolRTypeEntity.Field.Status
                                        , SchoolRTypeEntity.Field.SchIdenty
                                        , String.Join(", ", inKeys)
                                        , SchoolRTypeEntity.Field.ReceiveKind);
                                parameters.Add("NormalStatus", DataStatusCodeTexts.NORMAL);
                                parameters.Add("SchIdenty", asker.UBank);
                                parameters.Add("@ReceiveKind", receiveKind);
                            }
                            else
                            {
                                sql = String.Format("SELECT [{1}], [{2}] FROM [{0}] WHERE [{3}] = @NormalStatus AND [{4}] = @SchIdenty AND [{1}] IN ({5})"
                                        , SchoolRTypeEntity.TABLE_NAME
                                        , SchoolRTypeEntity.Field.ReceiveType
                                        , SchoolRTypeEntity.Field.SchName
                                        , SchoolRTypeEntity.Field.Status
                                        , SchoolRTypeEntity.Field.SchIdenty
                                        , String.Join(", ", inKeys));
                                parameters.Add("NormalStatus", DataStatusCodeTexts.NORMAL);
                                parameters.Add("SchIdenty", asker.UBank);
                            }
                        }
                        else
                        {
                            if (ReceiveKindCodeTexts.IsDefine(receiveKind))
                            {
                                sql = String.Format("SELECT [{1}], [{2}] FROM [{0}] WHERE [{3}] = @NormalStatus AND [{4}] = @SchIdenty AND [{5}] = @ReceiveKind"
                                        , SchoolRTypeEntity.TABLE_NAME
                                        , SchoolRTypeEntity.Field.ReceiveType
                                        , SchoolRTypeEntity.Field.SchName
                                        , SchoolRTypeEntity.Field.Status
                                        , SchoolRTypeEntity.Field.SchIdenty
                                        , SchoolRTypeEntity.Field.ReceiveKind);
                                parameters.Add("NormalStatus", DataStatusCodeTexts.NORMAL);
                                parameters.Add("SchIdenty", asker.UBank);
                                parameters.Add("@ReceiveKind", receiveKind);
                            }
                            else
                            {
                                sql = String.Format("SELECT [{1}], [{2}] FROM [{0}] WHERE [{3}] = @NormalStatus AND [{4}] = @SchIdenty"
                                        , SchoolRTypeEntity.TABLE_NAME
                                        , SchoolRTypeEntity.Field.ReceiveType
                                        , SchoolRTypeEntity.Field.SchName
                                        , SchoolRTypeEntity.Field.Status
                                        , SchoolRTypeEntity.Field.SchIdenty);
                                parameters.Add("NormalStatus", DataStatusCodeTexts.NORMAL);
                                parameters.Add("SchIdenty", asker.UBank);
                            }
                        }
                    }
                    #endregion
                    break;
                case UserQualCodeTexts.STUDENT:
                    #region 學生使用者
                    {
                        //學生使用者只能查自己的商家代號
                        if (ReceiveKindCodeTexts.IsDefine(receiveKind))
                        {
                            sql = String.Format("SELECT [{1}], [{2}] FROM [{0}] WHERE [{3}] = @NormalStatus AND [{1}] = @Receive_Type AND [{4}] = @ReceiveKind"
                                    , SchoolRTypeEntity.TABLE_NAME
                                    , SchoolRTypeEntity.Field.ReceiveType
                                    , SchoolRTypeEntity.Field.SchName
                                    , SchoolRTypeEntity.Field.Status
                                    , SchoolRTypeEntity.Field.ReceiveKind);
                            parameters.Add("NormalStatus", DataStatusCodeTexts.NORMAL);
                            parameters.Add("@Receive_Type", commandAsker.UnitId);
                            parameters.Add("@ReceiveKind", receiveKind);
                        }
                        else
                        {
                            sql = String.Format("SELECT [{1}], [{2}] FROM [{0}] WHERE [{3}] = @NormalStatus AND [{1}] = @Receive_Type"
                                    , SchoolRTypeEntity.TABLE_NAME
                                    , SchoolRTypeEntity.Field.ReceiveType
                                    , SchoolRTypeEntity.Field.SchName
                                    , SchoolRTypeEntity.Field.Status);
                            parameters.Add("NormalStatus", DataStatusCodeTexts.NORMAL);
                            parameters.Add("@Receive_Type", commandAsker.UnitId);
                        }
                    }
                    #endregion
                    break;
                default:
                    return new Result(false, "缺少或無效命令請求者的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 取得資料
            CodeText[] items = null;
            DataTable dt = null;
            Result result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
            if (result.IsSuccess)
            {
                if (dt != null && dt.Rows.Count > 0)
                {
                    #region 逐筆處理
                    items = new CodeText[dt.Rows.Count];
                    int idx = 0;
                    foreach (DataRow dRow in dt.Rows)
                    {
                        string code = dRow.IsNull(SchoolRTypeEntity.Field.ReceiveType) ? String.Empty : dRow[SchoolRTypeEntity.Field.ReceiveType].ToString();
                        string text = dRow.IsNull(SchoolRTypeEntity.Field.SchName) ? String.Empty : dRow[SchoolRTypeEntity.Field.SchName].ToString();
                        items[idx++] = new CodeText(code, text);
                    }
                    #endregion
                }
                else
                {
                    items = new CodeText[0];
                }
            }
            else
            {
                data = null;

                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
                }
            }
            #endregion

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}授權商家代號資料成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                }
                else
                {
                    notation = String.Format("[{0}] {1}授權商家代號資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
            }
            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            data = items;
            return result;

        }

        /// <summary>
        /// 整批刪除課程收費標準 Class_Standard
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result DeleteAllClassStandard(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearID = null;
            string termID = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearID = argument.Value == null ? null : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termID = argument.Value == null ? null : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearID)
                || String.IsNullOrEmpty(termID))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            int count = 0;
            StringBuilder deleteSql = new StringBuilder();
            deleteSql
                .AppendFormat("DELETE {0} WHERE ", ClassStandardEntity.TABLE_NAME).AppendLine()
                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Year_Id=@YEAR_ID and Term_Id=@TERM_ID ").AppendLine();

            KeyValueList delParameters = new KeyValueList(4);
            delParameters.Add("@RECEIVE_TYPE", receiveType);
            delParameters.Add("@YEAR_ID", yearID);
            delParameters.Add("@TERM_ID", termID);
            Result result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}資料成功 (共{2}筆)", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            if (!result.IsSuccess)
            {
                count = 0;
                if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                }
                else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                }
                return result;
            }
            return result;
        }

        #region [MDY:20220530] Checkmarx 調整
        /// <summary>
        /// 變更使用者密碼
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <returns></returns>
        public Result ChangeUserPXX(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments)
        {
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string unitId = null;
            string userId = null;
            string groupId = null;
            string oldPXX = null;
            string newPXX = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "UNITID":
                        unitId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "USERID":
                        userId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "GROUPID":
                        groupId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "OLDPXX":
                        oldPXX = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "NEWPXX":
                        newPXX = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(unitId)        //必要參數且不可為空字串
                || String.IsNullOrEmpty(userId)     //必要參數且不可為空字串
                || String.IsNullOrEmpty(groupId)    //必要參數且不可為空字串
                || oldPXX == null                   //必要參數且不可為空字串
                || newPXX == null                   //必要參數且不可為空字串
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            LogonHelper helper = new LogonHelper(_Factory);
            Result result = helper.ChangeUserPXX(unitId, userId, groupId, oldPXX, newPXX);

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}資料成功 (UnitID：{2} ; UserID：{3})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, unitId, userId);
                }
                else
                {
                    notation = String.Format("[{0}] {1}資料失敗 (UnitID：{2} ; UserID：{3} ; 錯誤訊息：{4})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, unitId, userId, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;
        }
        #endregion

        /// <summary>
        /// 新增批次處理佇列 For D15 類
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result InsertJobCubeForD15(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            BankpmEntity fileData = null;
            JobcubeEntity jobCube = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "FILEDATAXML":
                        {
                            string fileDataXml = argument.Value == null ? String.Empty : argument.Value.Trim();
                            if (!Common.TryDeXmlExplicitly<BankpmEntity>(fileDataXml, out fileData))
                            {
                                fileData = null;
                            }
                        }
                        break;
                    case "JOBCUBEXML":
                        {
                            string jobCubeXml = argument.Value == null ? String.Empty : argument.Value.Trim();
                            if (!Common.TryDeXmlExplicitly<JobcubeEntity>(jobCubeXml, out jobCube))
                            {
                                jobCube = null;
                            }
                        }
                        break;
                }
            }
            if (fileData == null        //必要參數
                || jobCube == null)     //必要參數
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            Result result = null;

            #region 使用交易新增資料
            int count = 0;
            int fileDataSNo = 0;
            int jobCubeSNo = 0;
            EntityFactory tsFactory = _Factory.CloneForTransaction();
            try
            {
                #region 新增檔案資料
                {
                    result = tsFactory.Insert(fileData, out count);
                    if (result.IsSuccess)
                    {
                        if (count == 0)
                        {
                            result = new Result(false, "無檔案資料被新增", ErrorCode.D_DATA_EXISTS, null);
                        }
                        else
                        {
                            //取序號
                            object value = null;
                            string sql = String.Format("SELECT IDENT_CURRENT ('{0}') AS Current_Identity;", BankpmEntity.TABLE_NAME);
                            result = tsFactory.ExecuteScalar(sql, new KeyValue[0], out value);
                            if (result.IsSuccess)
                            {
                                if (Int32.TryParse(value.ToString(), out fileDataSNo))
                                {
                                    fileData.Cancel = fileDataSNo;
                                }
                                else
                                {
                                    result = new Result(false, "無法取得新增檔案資料的序號", CoreStatusCode.S_SELECT_DATA_FAILURE, null);
                                }
                            }
                        }
                    }

                    #region 新增日誌資料
                    if (dbLogger != null)
                    {
                        string notation = null;
                        if (result.IsSuccess)
                        {
                            notation = String.Format("[{0}] {1}檔案資料成功 (cancel={2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, fileDataSNo);
                        }
                        else
                        {
                            notation = String.Format("[{0}] {1}檔案資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                        }
                        dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                    }
                    #endregion
                }
                #endregion

                #region 新增批次處理佇列資料
                if (result.IsSuccess)
                {
                    string sql = String.Format("SELECT MAX(CAST({1} AS int)) FROM [{0}]  WHERE [{2}] = @JRID AND [{3}] = @JYEAR AND [{4}] = @JTERM AND [{5}] = @JDEP AND [{6}] = @JRECID AND [{7}] = @JTYPEID"
                        , JobcubeEntity.TABLE_NAME      //0
                        , JobcubeEntity.Field.SeriorNo  //1
                        , JobcubeEntity.Field.Jrid
                        , JobcubeEntity.Field.Jyear
                        , JobcubeEntity.Field.Jterm
                        , JobcubeEntity.Field.Jdep
                        , JobcubeEntity.Field.Jrecid
                        , JobcubeEntity.Field.Jtypeid);
                    KeyValue[] parameters = new  KeyValue[6];
                    parameters[0] = new KeyValue("@JRID", jobCube.Jrid);
                    parameters[1] = new KeyValue("@JYEAR", jobCube.Jyear);
                    parameters[2] = new KeyValue("@JTERM", jobCube.Jterm);
                    parameters[3] = new KeyValue("@JDEP", jobCube.Jdep);
                    parameters[4] = new KeyValue("@JRECID", jobCube.Jrecid);
                    parameters[5] = new KeyValue("@JTYPEID", jobCube.Jtypeid);

                    object value = null;
                    result = tsFactory.ExecuteScalar(sql, parameters, out value);
                    if (result.IsSuccess)
                    {
                        if (value == null || Convert.IsDBNull(value))
                        {
                            jobCubeSNo = 1;
                        }
                        else if (!Int32.TryParse(value.ToString(), out jobCubeSNo))
                        {
                            result = new Result(false, "無法取得新的批次處理佇列資料的批號", CoreStatusCode.S_SELECT_DATA_FAILURE, null);
                        }
                        else
                        {
                            jobCubeSNo++;
                            if (jobCubeSNo > 9999)
                            {
                                result = new Result(false, "批次處理佇列資料的批號操過上限 9999", CoreStatusCode.S_SELECT_DATA_FAILURE, null);
                            }
                        }
                    }

                    if (result.IsSuccess)
                    {
                        jobCube.SeriorNo = jobCubeSNo.ToString();
                        jobCube.Chancel = fileData.Cancel.ToString();
                        jobCube.Jparam = jobCube.Jparam.Replace("[@Job.SeriorNo]", jobCube.SeriorNo).Replace("[@Data.Cancel]", jobCube.Chancel);
                        result = tsFactory.Insert(jobCube, out count);
                        if (result.IsSuccess && count == 0)
                        {
                            result = new Result(false, "無批次處理佇列資料被新增", ErrorCode.D_DATA_EXISTS, null);
                        }
                    }

                    #region 新增日誌資料
                    if (dbLogger != null)
                    {
                        string notation = null;
                        if (result.IsSuccess)
                        {
                            notation = String.Format("[{0}] {1}批次處理佇列資料成功 (Serior_No={2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, jobCubeSNo);
                        }
                        else
                        {
                            notation = String.Format("[{0}] {1}批次處理佇列資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                        }
                        dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                    }
                    #endregion
                }
                #endregion
            }
            catch (Exception ex)
            {
                string notation = String.Format("[{0}] {1}新增資料發生例外 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, ex.Message);
                result = new Result(false, notation, CoreStatusCode.UNKNOWN_EXCEPTION, ex);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion
            }
            finally
            {
                if (tsFactory != null)
                {
                    if (result.IsSuccess)
                    {
                        tsFactory.Commit();
                    }
                    else
                    {
                        tsFactory.Rollback();
                    }
                    tsFactory.Dispose();
                    tsFactory = null;
                }

                #region Release DBLogger
                if (!result.IsSuccess)
                {
                    if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                    }
                    else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                    }
                }
                string logErrmsg = this.ReleaseDBLogger(true);
                if (dbLogger != null)
                {
                    dbLogger.Dispose();
                    dbLogger = null;
                }
                #endregion
            }
            #endregion

            if (result.IsSuccess)
            {
                data = new CodeText[] { new CodeText("fileSNo", fileData.Cancel.ToString()), new CodeText("JobSNo", jobCube.SeriorNo) };
            }
            return result;
        }

        /// <summary>
        /// 新增批次處理佇列 For PDF 類
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result InsertJobCubeForPDF(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            JobcubeEntity jobCube = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "JOBCUBEXML":
                        {
                            string jobCubeXml = argument.Value == null ? String.Empty : argument.Value.Trim();
                            if (!Common.TryDeXmlExplicitly<JobcubeEntity>(jobCubeXml, out jobCube))
                            {
                                jobCube = null;
                            }
                        }
                        break;
                }
            }
            if (jobCube == null)     //必要參數
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            Result result = null;
            Result genResult = null;

            #region 使用交易新增資料
            //byte[] pdfContent = null;
            EntityFactory tsFactory = _Factory.CloneForTransaction();
            try
            {
                int totalCount = 0;
                string pdfFile = null;
                jobCube.Jstd = DateTime.Now;
                using (JobCubeHelper helper = new JobCubeHelper())
                {
                    genResult = helper.ProcessPDFxJob(jobCube, this.TempPath, out totalCount, out pdfFile);
                }
                jobCube.Jetd = DateTime.Now;
                if (genResult.IsSuccess)
                {
                    jobCube.Jstatusid = JobCubeStatusCodeTexts.FINISH;
                    jobCube.Jresultid = JobCubeResultCodeTexts.SUCCESS;
                    jobCube.Memo = JobCubeResultCodeTexts.SUCCESS_TEXT;
                    jobCube.Jlog = String.Format("共有 {0} 筆繳費資料", totalCount);

                    data = System.IO.File.ReadAllBytes(pdfFile);
                }
                else
                {
                    jobCube.Jstatusid = JobCubeStatusCodeTexts.FINISH;
                    jobCube.Jresultid = JobCubeResultCodeTexts.FAILURE;
                    jobCube.Memo = JobCubeResultCodeTexts.SUCCESS_TEXT;
                    jobCube.Jlog = String.Format("錯誤訊息：{0}", genResult.Message);
                }

                #region 新增批次處理佇列資料
                int count = 0;
                string jobCubeNo = null;
                result = _Factory.Insert(jobCube, out count);
                if (result.IsSuccess)
                {
                    if (count == 0)
                    {
                        result = new Result(false, "無批次處理佇列資料被新增", ErrorCode.D_DATA_EXISTS, null);
                    }
                    else
                    {
                        //取序號
                        object value = null;
                        string sql = String.Format("SELECT IDENT_CURRENT ('{0}') AS Current_Identity;", JobcubeEntity.TABLE_NAME);
                        result = tsFactory.ExecuteScalar(sql, new KeyValue[0], out value);
                        if (result.IsSuccess)
                        {
                            jobCubeNo = value == null ? String.Empty : value.ToString();
                        }
                    }
                }

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}批次處理佇列資料成功 (JNO={2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, jobCubeNo);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}批次處理佇列資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion
                #endregion
            }
            catch (Exception ex)
            {
                string notation = String.Format("[{0}] {1}新增資料發生例外 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, ex.Message);
                result = new Result(false, notation, CoreStatusCode.UNKNOWN_EXCEPTION, ex);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion
            }
            finally
            {
                if (tsFactory != null)
                {
                    if (result.IsSuccess)
                    {
                        tsFactory.Commit();
                    }
                    else
                    {
                        tsFactory.Rollback();
                    }
                    tsFactory.Dispose();
                    tsFactory = null;
                }

                #region Release DBLogger
                string logErrmsg = this.ReleaseDBLogger(true);
                if (dbLogger != null)
                {
                    dbLogger.Dispose();
                    dbLogger = null;
                }
                #endregion
            }
            #endregion

            if (!genResult.IsSuccess)
            {
                if (genResult.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                {
                    genResult = new Result(genResult.IsSuccess, genResult.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, genResult.Exception);
                }
                else if (genResult.Code == CoreStatusCode.UNKNOWN_ERROR)
                {
                    genResult = new Result(genResult.IsSuccess, genResult.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, genResult.Exception);
                }
            }
            return genResult;
        }

        /// <summary>
        /// 新增批次處理佇列 For PDF 類 By 非同步
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result InsertJobCubeForPDFByAsync(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            JobcubeEntity jobCube = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "JOBCUBEXML":
                        {
                            string jobCubeXml = argument.Value == null ? String.Empty : argument.Value.Trim();
                            if (!Common.TryDeXmlExplicitly<JobcubeEntity>(jobCubeXml, out jobCube))
                            {
                                jobCube = null;
                            }
                        }
                        break;
                }
            }
            if (jobCube == null)     //必要參數
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            Result result = null;
            //Result genResult = null;

            #region 使用交易新增資料
            EntityFactory tsFactory = null;
            try
            {
                tsFactory = _Factory.CloneForTransaction();

                #region 新增批次處理佇列資料
                jobCube.Jstatusid = JobCubeStatusCodeTexts.WAIT;
                jobCube.Jresultid = JobCubeResultCodeTexts.WAIT;
                jobCube.Memo = String.Empty;
                jobCube.Jlog = JobCubeResultCodeTexts.WAIT_TEXT;

                int count = 0;
                string jobCubeNo = null;
                result = _Factory.Insert(jobCube, out count);
                if (result.IsSuccess)
                {
                    if (count == 0)
                    {
                        result = new Result(false, "無批次處理佇列資料被新增", ErrorCode.D_DATA_EXISTS, null);
                    }
                    else
                    {
                        //取序號
                        object value = null;
                        string sql = String.Format("SELECT IDENT_CURRENT ('{0}') AS Current_Identity;", JobcubeEntity.TABLE_NAME);
                        result = tsFactory.ExecuteScalar(sql, new KeyValue[0], out value);
                        if (result.IsSuccess)
                        {
                            jobCubeNo = value == null ? String.Empty : value.ToString();
                        }
                    }
                }

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}批次處理佇列資料成功 (JNO={2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, jobCubeNo);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}批次處理佇列資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion
                #endregion

                if (result.IsSuccess)
                {
                    JobCubeHelper helper = new JobCubeHelper();
                    string stamp = Common.GetGUID();
                    IAsyncResult asyncResult = helper.ProcessPDFxJobByAsync(jobCubeNo, stamp, this.TempPath, null);
                    data = new string[] { jobCubeNo, stamp };
                    result = new Result(true);
                }
            }
            catch (Exception ex)
            {
                string notation = String.Format("[{0}] {1}新增資料發生例外 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, ex.Message);
                result = new Result(false, notation, CoreStatusCode.UNKNOWN_EXCEPTION, ex);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion
            }
            finally
            {
                if (tsFactory != null)
                {
                    if (result.IsSuccess)
                    {
                        tsFactory.Commit();
                    }
                    else
                    {
                        tsFactory.Rollback();
                    }
                    tsFactory.Dispose();
                    tsFactory = null;
                }

                #region Release DBLogger
                string logErrmsg = this.ReleaseDBLogger(true);
                if (dbLogger != null)
                {
                    dbLogger.Dispose();
                    dbLogger = null;
                }
                #endregion
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 新增批次處理佇列 For D38 類
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result InsertJobCubeForD38(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            JobcubeEntity jobCube = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "JOBCUBEXML":
                        {
                            string jobCubeXml = argument.Value == null ? String.Empty : argument.Value.Trim();
                            if (!Common.TryDeXmlExplicitly<JobcubeEntity>(jobCubeXml, out jobCube))
                            {
                                jobCube = null;
                            }
                        }
                        break;
                }
            }
            if (jobCube == null)     //必要參數
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            Result result = null;

            #region 使用交易新增資料
            EntityFactory tsFactory = null;
            try
            {
                tsFactory = _Factory.CloneForTransaction();

                #region 新增批次處理佇列資料
                jobCube.Jstatusid = JobCubeStatusCodeTexts.WAIT;
                jobCube.Jresultid = JobCubeResultCodeTexts.WAIT;
                jobCube.Memo = String.Empty;
                jobCube.Jlog = JobCubeResultCodeTexts.WAIT_TEXT;

                int count = 0;
                string jobCubeNo = null;
                result = _Factory.Insert(jobCube, out count);
                if (result.IsSuccess)
                {
                    if (count == 0)
                    {
                        result = new Result(false, "無批次處理佇列資料被新增", ErrorCode.D_DATA_EXISTS, null);
                    }
                    else
                    {
                        //取序號
                        object value = null;
                        string sql = String.Format("SELECT IDENT_CURRENT ('{0}') AS Current_Identity;", JobcubeEntity.TABLE_NAME);
                        result = tsFactory.ExecuteScalar(sql, new KeyValue[0], out value);
                        if (result.IsSuccess)
                        {
                            jobCubeNo = value == null ? String.Empty : value.ToString();
                        }
                    }
                }

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}批次處理佇列資料成功 (JNO={2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, jobCubeNo);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}批次處理佇列資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion
                #endregion

                if (result.IsSuccess)
                {
                    data = jobCubeNo;
                    //result = new Result(true);
                }
            }
            catch (Exception ex)
            {
                string notation = String.Format("[{0}] {1}新增資料發生例外 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, ex.Message);
                result = new Result(false, notation, CoreStatusCode.UNKNOWN_EXCEPTION, ex);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion
            }
            finally
            {
                if (tsFactory != null)
                {
                    if (result.IsSuccess)
                    {
                        tsFactory.Commit();
                    }
                    else
                    {
                        tsFactory.Rollback();
                    }
                    tsFactory.Dispose();
                    tsFactory = null;
                }

                #region Release DBLogger
                string logErrmsg = this.ReleaseDBLogger(true);
                if (dbLogger != null)
                {
                    dbLogger.Dispose();
                    dbLogger = null;
                }
                #endregion
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 執行 B2100002 特殊需求 (計算金額、產生PDF繳費單、產生PDF繳費收據)
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result ExecB2100002Request(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            #region [MDY:202203XX] 2022擴充案 增加英文介面參數
            string command = null;
            string receiveType = null;
            string yearId = null;
            string termId = null;
            string depId = null;
            string receiveId = null;
            string stuId = null;
            int oldSeq = -1;
            bool fgMark = false;
            bool isEngUI = false;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "COMMAND":
                        command = argument.Value == null ? String.Empty : argument.Value.Trim().ToUpper();
                        break;
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "DEPID":
                        depId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVEID":
                        receiveId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "STUID":
                        stuId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "OLDSEQ":
                        {
                            string arg = argument.Value == null ? String.Empty : argument.Value.Trim();
                            if (!Int32.TryParse(arg, out oldSeq))
                            {
                                oldSeq = -1;
                            }
                        }
                        break;
                    case "FGMARK":
                        fgMark = argument.Value == "Y";
                        break;
                    case "ISENGUI":
                        isEngUI = argument.Value == "Y";
                        break;
                }
            }
            #endregion

            #region [Old] 土銀不使用部別，部別固定為空字串
            //if ((command != "GENAMOUNT" && command != "GENBILL" && command != "GENRECEIPT")
            //    || String.IsNullOrEmpty(receiveType)    //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(yearId)         //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(termId)         //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(depId)          //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(receiveId)      //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(studentId)      //必要參數且不可為空字串
            //    )
            //{
            //    return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            //}
            #endregion

            if ((command != "GENAMOUNT" && command != "GENBILL" && command != "GENRECEIPT")
                || String.IsNullOrEmpty(receiveType)    //必要參數且不可為空字串
                || String.IsNullOrEmpty(yearId)         //必要參數且不可為空字串
                || String.IsNullOrEmpty(termId)         //必要參數且不可為空字串
                || depId == null                        //必要參數且不可為 null 因為土銀不使用部別，部別固定為空字串
                || String.IsNullOrEmpty(receiveId)      //必要參數且不可為空字串
                || String.IsNullOrEmpty(stuId)          //必要參數且不可為空字串
                || oldSeq < 0                           //必要參數且不可小於 0
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region StudentMasterEntity
            StudentMasterEntity student = null;
            {
                Expression where = new Expression(StudentMasterEntity.Field.ReceiveType, receiveType)
                    .And(StudentMasterEntity.Field.DepId, depId)
                    .And(StudentMasterEntity.Field.Id, stuId);
                Result result = _Factory.SelectFirst<StudentMasterEntity>(where, null, out student);
                if (result.IsSuccess && student == null)
                {
                    result = new Result(false, "查無該學生基本繳費資料", ErrorCode.D_DATA_NOT_FOUND, null);
                }

                #region [MDY:202203XX] 2022擴充案 修正 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}學生基本資料成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}學生基本資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                }
                #endregion

                if (!result.IsSuccess)
                {
                    #region [MDY:202203XX] 2022擴充案 修正 儲存日誌資料並釋放資料庫日誌記錄器
                    if (dbLogger != null)
                    {
                        string logErrmsg = this.ReleaseDBLogger(true);
                        dbLogger.Dispose();
                        dbLogger = null;
                    }
                    #endregion

                    return result;
                }
            }
            StudentMasterEntity[] students = new StudentMasterEntity[] { student };
            #endregion

            #region ReceiveChannelEntity
            ReceiveChannelEntity[] receiveChannels = null;
            ReceiveChannelEntity atmReceiveChannel = null;
            ReceiveChannelEntity[] smReceiveChannels = null;
            {
                Expression where = new Expression(ReceiveChannelEntity.Field.ReceiveType, receiveType);
                KeyValueList<OrderByEnum> orderbys = new KeyValueList<OrderByEnum>();
                orderbys.Add(ReceiveChannelEntity.Field.ChannelId, OrderByEnum.Asc);
                orderbys.Add(ReceiveChannelEntity.Field.BarcodeId, OrderByEnum.Asc);
                Result result = _Factory.SelectAll<ReceiveChannelEntity>(where, orderbys, out receiveChannels);

                #region [Old] 李小姐說無管道資料不用攔
                //if (result.IsSuccess && (receiveChannels == null || receiveChannels.Length == 0))
                //{
                //    result = new Result(false, "查無該商家代號的代收管道手續費資料資料", ErrorCode.D_DATA_NOT_FOUND, null);
                //}
                #endregion

                if (receiveChannels == null)
                {
                    receiveChannels = new ReceiveChannelEntity[0];
                }

                #region [MDY:202203XX] 2022擴充案 修正 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}代收管道手續費資料成功 ({2} 筆)", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, receiveChannels.Length);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}代收管道手續費資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                }
                #endregion

                if (!result.IsSuccess)
                {
                    #region [MDY:202203XX] 2022擴充案 修正 儲存日誌資料並釋放資料庫日誌記錄器
                    if (dbLogger != null)
                    {
                        string logErrmsg = this.ReleaseDBLogger(true);
                        dbLogger.Dispose();
                        dbLogger = null;
                    }
                    #endregion

                    return result;
                }

                if (receiveChannels.Length == 0)
                {
                    atmReceiveChannel = null;
                    smReceiveChannels = new ReceiveChannelEntity[0];
                }
                else
                {
                    List<ReceiveChannelEntity> smList = new List<ReceiveChannelEntity>(receiveChannels.Length);
                    foreach (ReceiveChannelEntity receiveChannel in receiveChannels)
                    {
                        if (ChannelHelper.IsCashChannel(receiveChannel.ChannelId))
                        {
                            atmReceiveChannel = receiveChannel;
                        }
                        else if (ChannelHelper.IsDefaultSMChannel(receiveChannel.ChannelId))
                        {
                            smList.Add(receiveChannel);
                        }
                    }
                    smReceiveChannels = smList.ToArray();
                }
            }
            #endregion

            #region SchoolRTypeEntity
            SchoolRTypeEntity schoolRType = null;
            {
                Expression where = new Expression(SchoolRTypeEntity.Field.ReceiveType, receiveType);
                Result result = _Factory.SelectFirst<SchoolRTypeEntity>(where, null, out schoolRType);
                if (result.IsSuccess && schoolRType == null)
                {
                    result = new Result(false, "查無該商家代號資料", ErrorCode.D_DATA_NOT_FOUND, null);
                }

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}商家代號資料成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}商家代號資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                }
                #endregion

                if (!result.IsSuccess)
                {
                    #region 儲存日誌資料並釋放資料庫日誌記錄器
                    if (dbLogger != null)
                    {
                        string logErrmsg = this.ReleaseDBLogger(true);
                        dbLogger.Dispose();
                        dbLogger = null;
                    }
                    #endregion

                    return result;
                }
            }
            #endregion

            switch (command)
            {
                case "GENAMOUNT":
                    #region 計算金額
                    {
                        Expression whereStudentReceive = new Expression(StudentReceiveEntity.Field.ReceiveType, receiveType)
                            .And(StudentReceiveEntity.Field.YearId, yearId)
                            .And(StudentReceiveEntity.Field.TermId, termId)
                            .And(StudentReceiveEntity.Field.DepId, depId)
                            .And(StudentReceiveEntity.Field.ReceiveId, receiveId)
                            .And(StudentReceiveEntity.Field.StuId, stuId)
                            .And(StudentReceiveEntity.Field.OldSeq, oldSeq);

                        #region StudentReceiveEntity
                        StudentReceiveEntity studentReceive = null;
                        {
                            Result result = _Factory.SelectFirst<StudentReceiveEntity>(whereStudentReceive, null, out studentReceive);
                            if (result.IsSuccess && studentReceive == null)
                            {
                                result = new Result(false, "查無該學生繳費資料", ErrorCode.D_DATA_NOT_FOUND, null);
                            }
                            if (!String.IsNullOrWhiteSpace(studentReceive.ReceiveDate) || !String.IsNullOrWhiteSpace(studentReceive.ReceiveWay) || !String.IsNullOrWhiteSpace(studentReceive.CancelFlag))
                            {
                                result = new Result(false, "該學生繳費資料已繳款無法重新計算金額", CoreStatusCode.UNKNOWN_ERROR, null);
                            }

                            #region 新增日誌資料
                            if (dbLogger != null)
                            {
                                string notation = null;
                                if (result.IsSuccess)
                                {
                                    notation = String.Format("[{0}] {1}學生繳費資料成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                                }
                                else
                                {
                                    notation = String.Format("[{0}] {1}學生繳費資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                                }
                                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                            }
                            #endregion

                            if (!result.IsSuccess)
                            {
                                #region 儲存日誌資料並釋放資料庫日誌記錄器
                                string logErrmsg = this.ReleaseDBLogger(true);
                                dbLogger.Dispose();
                                dbLogger = null;
                                #endregion

                                return result;
                            }
                        }
                        Decimal? orgReceiveAmount = studentReceive.ReceiveAmount;
                        string orgCancelNo = studentReceive.CancelNo;
                        #endregion

                        #region SchoolRidEntity
                        SchoolRidEntity schoolRid = null;
                        {
                            Expression where = new Expression(SchoolRidEntity.Field.ReceiveType, receiveType)
                                .And(SchoolRidEntity.Field.YearId, yearId)
                                .And(SchoolRidEntity.Field.TermId, termId)
                                .And(SchoolRidEntity.Field.DepId, depId)
                                .And(SchoolRidEntity.Field.ReceiveId, receiveId);
                            Result result = _Factory.SelectFirst<SchoolRidEntity>(where, null, out schoolRid);
                            if (result.IsSuccess && schoolRid == null)
                            {
                                result = new Result(false, "查無該代收費用別設定資料", ErrorCode.D_DATA_NOT_FOUND, null);
                            }

                            #region 新增日誌資料
                            if (dbLogger != null)
                            {
                                string notation = null;
                                if (result.IsSuccess)
                                {
                                    notation = String.Format("[{0}] {1}代收費用別設定資料成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                                }
                                else
                                {
                                    notation = String.Format("[{0}] {1}代收費用別設定資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                                }
                                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                            }
                            #endregion

                            if (!result.IsSuccess)
                            {
                                #region 儲存日誌資料並釋放資料庫日誌記錄器
                                string logErrmsg = this.ReleaseDBLogger(true);
                                dbLogger.Dispose();
                                dbLogger = null;
                                #endregion

                                return result;
                            }
                        }
                        #endregion

                        BillAmountHelper helper = new BillAmountHelper();
                        BillAmountHelper.CalculateType type = studentReceive.BillingType == BillingTypeCodeTexts.BY_STANDARD ? BillAmountHelper.CalculateType.byStandard : BillAmountHelper.CalculateType.byAmount;
                        if (helper.CalcBillAmount(ref studentReceive, type))
                        {
                            KeyValueList fieldValues = new KeyValueList();
                            #region 收入科目金額也要儲存
                            fieldValues.Add(StudentReceiveEntity.Field.Receive01, studentReceive.Receive01);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive02, studentReceive.Receive02);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive03, studentReceive.Receive03);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive04, studentReceive.Receive04);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive05, studentReceive.Receive05);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive06, studentReceive.Receive06);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive07, studentReceive.Receive07);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive08, studentReceive.Receive08);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive09, studentReceive.Receive09);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive10, studentReceive.Receive10);

                            fieldValues.Add(StudentReceiveEntity.Field.Receive11, studentReceive.Receive11);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive12, studentReceive.Receive12);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive13, studentReceive.Receive13);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive14, studentReceive.Receive14);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive15, studentReceive.Receive15);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive16, studentReceive.Receive16);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive17, studentReceive.Receive17);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive18, studentReceive.Receive18);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive19, studentReceive.Receive19);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive20, studentReceive.Receive20);

                            fieldValues.Add(StudentReceiveEntity.Field.Receive21, studentReceive.Receive21);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive22, studentReceive.Receive22);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive23, studentReceive.Receive23);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive24, studentReceive.Receive24);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive25, studentReceive.Receive25);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive26, studentReceive.Receive26);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive27, studentReceive.Receive27);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive28, studentReceive.Receive28);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive29, studentReceive.Receive29);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive30, studentReceive.Receive30);

                            fieldValues.Add(StudentReceiveEntity.Field.Receive31, studentReceive.Receive31);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive32, studentReceive.Receive32);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive33, studentReceive.Receive33);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive34, studentReceive.Receive34);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive35, studentReceive.Receive35);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive36, studentReceive.Receive36);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive37, studentReceive.Receive37);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive38, studentReceive.Receive38);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive39, studentReceive.Receive39);
                            fieldValues.Add(StudentReceiveEntity.Field.Receive40, studentReceive.Receive40);
                            #endregion

                            fieldValues.Add(StudentReceiveEntity.Field.ReceiveAmount, studentReceive.ReceiveAmount);
                            fieldValues.Add(StudentReceiveEntity.Field.ReceiveAtmamount, studentReceive.ReceiveAtmamount);
                            fieldValues.Add(StudentReceiveEntity.Field.ReceiveSmamount, studentReceive.ReceiveSmamount);

                            CancelNoHelper helper2 = new CancelNoHelper();
                            CancelNoHelper.Module module = helper2.GetModuleByReceiveType(studentReceive.ReceiveType);
                            if (module == null)
                            {
                                return new Result(false, "產生虛擬帳號失敗，錯誤訊息：無法取得虛擬帳號模組", CoreStatusCode.UNKNOWN_ERROR, null);
                            }

                            string cancelNo = null;
                            string custtomNo = null;
                            string checksum = null;
                            string errmsg = null;

                            if (module.IsD38Kind && !String.IsNullOrWhiteSpace(studentReceive.CancelNo))
                            {
                                #region 特別處理 module.IsD38Kind 類，直接使用 CanceNo
                                cancelNo = studentReceive.CancelNo.Trim();

                                #region 臨櫃虛擬帳號
                                if (studentReceive.ReceiveAtmamount != null && studentReceive.ReceiveAtmamount.Value > 0)
                                {
                                    studentReceive.CancelAtmno = cancelNo;
                                }
                                else
                                {
                                    studentReceive.CancelAtmno = String.Empty;
                                }
                                fieldValues.Add(StudentReceiveEntity.Field.CancelAtmno, studentReceive.CancelAtmno);
                                #endregion

                                #region 超商虛擬帳號
                                if (studentReceive.ReceiveSmamount != null && studentReceive.ReceiveSmamount.Value > 0)
                                {
                                    studentReceive.CancelSmno = cancelNo;
                                }
                                else
                                {
                                    studentReceive.CancelSmno = String.Empty;
                                }
                                fieldValues.Add(StudentReceiveEntity.Field.CancelSmno, studentReceive.CancelSmno);
                                #endregion
                                #endregion
                            }
                            else
                            {
                                bool isBigReceiveId = schoolRType.IsBigReceiveId();
                                if (studentReceive.ReceiveAmount > 0)
                                {
                                    //金額大於 0 才要產生虛擬帳號
                                    #region 處理一般虛擬帳號模組
                                    #region 檢查是否有流水號，如果沒有則產生流水號，並加入要更新的欄位
                                    if (module.SeriorNoSize > 0 && String.IsNullOrWhiteSpace(studentReceive.SeriorNo))
                                    {
                                        #region 有虛擬帳號，則流水號取自銷編
                                        if (!String.IsNullOrWhiteSpace(studentReceive.CancelNo))
                                        {
                                            cancelNo = studentReceive.CancelNo.Trim();
                                            string myReceiveType = null;
                                            string myCusttomNo = null;
                                            string myChecksum = null;
                                            string myYearId = null;
                                            string myTermId = null;
                                            string myReceiveId = null;
                                            string mySeriorNo = null;
                                            if (module.TryParseCancelNo(cancelNo, isBigReceiveId, out myReceiveType, out myCusttomNo, out myChecksum, out myYearId, out myTermId, out myReceiveId, out mySeriorNo))
                                            {
                                                studentReceive.SeriorNo = mySeriorNo;
                                                fieldValues.Add(StudentReceiveEntity.Field.SeriorNo, studentReceive.SeriorNo);
                                            }
                                            else
                                            {
                                                cancelNo = null;
                                                studentReceive.CancelNo = null;
                                            }
                                        }
                                        #endregion

                                        #region 仍然無流水號，則取號
                                        if (String.IsNullOrWhiteSpace(studentReceive.SeriorNo))
                                        {
                                            string seriorNo = null;
                                            if (helper2.GenStudentReceiveSeriorNo(_Factory, module, studentReceive.ReceiveType, studentReceive.YearId, studentReceive.TermId, studentReceive.DepId, studentReceive.ReceiveId, isBigReceiveId, out seriorNo))
                                            {
                                                studentReceive.SeriorNo = seriorNo;
                                                fieldValues.Add(StudentReceiveEntity.Field.SeriorNo, studentReceive.SeriorNo);
                                            }
                                            else
                                            {
                                                return new Result(false, "產生虛擬帳號失敗，錯誤訊息：無法取得虛擬帳號模組", CoreStatusCode.UNKNOWN_ERROR, null);
                                            }
                                        }
                                        #endregion
                                    }
                                    #endregion

                                    #region 虛擬帳號
                                    errmsg = helper2.TryGenCancelNo(module, studentReceive.ReceiveType, studentReceive.YearId, studentReceive.TermId, studentReceive.ReceiveId, studentReceive.SeriorNo, isBigReceiveId, studentReceive.ReceiveAmount.Value
                                        , out cancelNo, out custtomNo, out checksum);
                                    if (String.IsNullOrEmpty(errmsg))
                                    {
                                        if (studentReceive.HasUploadCancelNo())
                                        {
                                            if (studentReceive.CancelNo != null || studentReceive.CancelNo.Trim() != cancelNo)
                                            {
                                                return new Result(false, "上傳的虛擬帳號與系統產生的虛擬帳號不同", CoreStatusCode.UNKNOWN_ERROR, null);
                                            }
                                        }
                                        else
                                        {
                                            studentReceive.CancelNo = cancelNo;
                                            fieldValues.Add(StudentReceiveEntity.Field.CancelNo, studentReceive.CancelNo);
                                        }
                                    }
                                    else
                                    {
                                        return new Result(false, "產生虛擬帳號失敗，錯誤訊息：" + errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
                                    }
                                    #endregion

                                    #region 臨櫃虛擬帳號
                                    if (studentReceive.ReceiveAtmamount != null && studentReceive.ReceiveAtmamount.Value > 0)
                                    {
                                        errmsg = helper2.TryGenCancelNo(module, studentReceive.ReceiveType, studentReceive.YearId, studentReceive.TermId, studentReceive.ReceiveId, studentReceive.SeriorNo, isBigReceiveId, studentReceive.ReceiveAtmamount.Value
                                            , out cancelNo, out custtomNo, out checksum);
                                        if (String.IsNullOrEmpty(errmsg))
                                        {
                                            studentReceive.CancelAtmno = cancelNo;
                                        }
                                        else
                                        {
                                            return new Result(false, "產生臨櫃虛擬帳號失敗，錯誤訊息：" + errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
                                        }
                                    }
                                    else
                                    {
                                        studentReceive.CancelAtmno = String.Empty;
                                    }
                                    fieldValues.Add(StudentReceiveEntity.Field.CancelAtmno, studentReceive.CancelAtmno);
                                    #endregion

                                    #region 超商虛擬帳號
                                    if (studentReceive.ReceiveSmamount != null && studentReceive.ReceiveSmamount.Value > 0)
                                    {
                                        errmsg = helper2.TryGenCancelNo(module, studentReceive.ReceiveType, studentReceive.YearId, studentReceive.TermId, studentReceive.ReceiveId, studentReceive.SeriorNo, isBigReceiveId, studentReceive.ReceiveSmamount.Value
                                            , out cancelNo, out custtomNo, out checksum);
                                        if (String.IsNullOrEmpty(errmsg))
                                        {
                                            studentReceive.CancelSmno = cancelNo;
                                        }
                                        else
                                        {
                                            return new Result(false, "產生超商虛擬帳號失敗，錯誤訊息：" + errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
                                        }
                                    }
                                    else
                                    {
                                        studentReceive.CancelSmno = String.Empty;
                                    }
                                    fieldValues.Add(StudentReceiveEntity.Field.CancelSmno, studentReceive.CancelSmno);
                                    #endregion
                                    #endregion
                                }
                                else
                                {
                                    //否則清除虛擬帳號 (但不清除流水號)
                                    #region 虛擬帳號
                                    studentReceive.CancelNo = String.Empty;
                                    fieldValues.Add(StudentReceiveEntity.Field.CancelNo, studentReceive.CancelNo);
                                    #endregion

                                    #region 臨櫃虛擬帳號
                                    studentReceive.CancelAtmno = String.Empty;
                                    fieldValues.Add(StudentReceiveEntity.Field.CancelAtmno, studentReceive.CancelAtmno);
                                    #endregion

                                    #region 超商虛擬帳號
                                    studentReceive.CancelSmno = String.Empty;
                                    fieldValues.Add(StudentReceiveEntity.Field.CancelSmno, studentReceive.CancelSmno);
                                    #endregion
                                }
                            }

                            #region 中信資料發送旗標清為 0
                            if (studentReceive.ReceiveAmount != orgReceiveAmount || studentReceive.CancelNo != orgCancelNo)
                            {
                                fieldValues.Add(StudentReceiveEntity.Field.CFlag, "0");
                            }
                            #endregion

                            #region 清除上傳資料註記
                            fieldValues.Add(StudentReceiveEntity.Field.Uploadflag, "");
                            #endregion

                            int count = 0;
                            Result result = _Factory.UpdateFields<StudentReceiveEntity>(fieldValues, whereStudentReceive, out count);
                            if (result.IsSuccess && count == 0)
                            {
                                result = new Result(false, "更新金額與虛擬帳號失敗，無資料被更新", CoreStatusCode.D_NOT_DATA_UPDATE, null);
                            }

                            return result;
                        }
                        else
                        {
                            return new Result(false, "產生金額失敗，錯誤訊息：" + helper.err_mgs, CoreStatusCode.UNKNOWN_ERROR, null);
                        }
                    }
                    #endregion
                case "GENBILL":
                case "GENRECEIPT":
                    #region 產生 PDF
                    {
                        #region StudentReceiveView
                        StudentReceiveView studentReceive = null;
                        {
                            #region [MDY:202203XX] 2022擴充案 改用 GetStudentReceiveView()
                            #region [OLD]
                            //Expression where = new Expression(StudentReceiveView.Field.ReceiveType, receiveType)
                            //    .And(StudentReceiveView.Field.YearId, yearId)
                            //    .And(StudentReceiveView.Field.TermId, termId)
                            //    .And(StudentReceiveView.Field.DepId, depId)
                            //    .And(StudentReceiveView.Field.ReceiveId, receiveId)
                            //    .And(StudentReceiveView.Field.StuId, stuId)
                            //    .And(StudentReceiveView.Field.OldSeq, oldSeq);

                            //Result result = _Factory.SelectFirst<StudentReceiveView>(where, null, out studentReceive);
                            #endregion

                            Result result = this.GetStudentReceiveView(receiveType, yearId, termId, depId, receiveId, stuId, oldSeq, isEngUI, out studentReceive);
                            #endregion

                            if (result.IsSuccess && studentReceive == null)
                            {
                                result = new Result(false, "查無該學生繳費資料", ErrorCode.D_DATA_NOT_FOUND, null);
                            }

                            #region 新增日誌資料
                            if (dbLogger != null)
                            {
                                string notation = null;
                                if (result.IsSuccess)
                                {
                                    notation = String.Format("[{0}] {1}學生繳費資料成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                                }
                                else
                                {
                                    notation = String.Format("[{0}] {1}學生繳費資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                                }
                                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                            }
                            #endregion

                            if (!result.IsSuccess)
                            {
                                #region 儲存日誌資料並釋放資料庫日誌記錄器
                                if (dbLogger != null)
                                {
                                    string logErrmsg = this.ReleaseDBLogger(true);
                                    dbLogger.Dispose();
                                    dbLogger = null;
                                }
                                #endregion

                                return result;
                            }
                        }

                        StudentReceiveView[] studentReceives = new StudentReceiveView[] { studentReceive };
                        #endregion

                        #region [Old]
                        //#region SchoolRTypeEntity
                        //SchoolRTypeEntity schoolRType = null;
                        //{
                        //    Expression where = new Expression(SchoolRTypeEntity.Field.ReceiveType, receiveType);
                        //    Result result = _Factory.SelectFirst<SchoolRTypeEntity>(where, null, out schoolRType);
                        //    if (result.IsSuccess && schoolRType == null)
                        //    {
                        //        result = new Result(false, "查無該商家代號資料", ErrorCode.D_DATA_NOT_FOUND, null);
                        //    }

                        //    #region 新增日誌資料
                        //    if (dbLogger != null)
                        //    {
                        //        string notation = null;
                        //        if (result.IsSuccess)
                        //        {
                        //            notation = String.Format("[{0}] {1}商家代號資料成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                        //        }
                        //        else
                        //        {
                        //            notation = String.Format("[{0}] {1}商家代號資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                        //        }
                        //        dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                        //    }
                        //    #endregion

                        //    if (!result.IsSuccess)
                        //    {
                        //        #region 儲存日誌資料並釋放資料庫日誌記錄器
                        //        string logErrmsg = this.ReleaseDBLogger(true);
                        //        dbLogger.Dispose();
                        //        dbLogger = null;
                        //        #endregion

                        //        return result;
                        //    }
                        //}
                        //#endregion
                        #endregion

                        #region [MDY:202203XX] 2022擴充案 取消 SchoolRidView2 改用 SchoolRidEntity 就夠
                        SchoolRidEntity schoolRid = null;
                        {
                            Expression where = new Expression(SchoolRidEntity.Field.ReceiveType, receiveType)
                                .And(SchoolRidEntity.Field.YearId, yearId)
                                .And(SchoolRidEntity.Field.TermId, termId)
                                .And(SchoolRidEntity.Field.DepId, depId)
                                .And(SchoolRidEntity.Field.ReceiveId, receiveId);
                            Result result = _Factory.SelectFirst<SchoolRidEntity>(where, null, out schoolRid);
                            if (result.IsSuccess && schoolRid == null)
                            {
                                result = new Result(false, "查無該代收費用別設定資料", ErrorCode.D_DATA_NOT_FOUND, null);
                            }

                            #region 新增日誌資料
                            if (dbLogger != null)
                            {
                                string notation = null;
                                if (result.IsSuccess)
                                {
                                    notation = String.Format("[{0}] {1}代收費用別設定資料成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                                }
                                else
                                {
                                    notation = String.Format("[{0}] {1}代收費用別設定資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                                }
                                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                            }
                            #endregion

                            if (!result.IsSuccess)
                            {
                                #region 儲存日誌資料並釋放資料庫日誌記錄器
                                if (dbLogger != null)
                                {
                                    string logErrmsg = this.ReleaseDBLogger(true);
                                    dbLogger.Dispose();
                                    dbLogger = null;
                                }
                                #endregion

                                return result;
                            }
                        }
                        #endregion

                        #region BankEntity
                        BankEntity bank = null;
                        {
                            Expression where = null;
                            string bankId = schoolRType.BankId == null ? String.Empty : schoolRType.BankId.Trim();
                            if (bankId.Length == 7)
                            {
                                where = new Expression(BankEntity.Field.FullCode, bankId);
                            }
                            else if (bankId.Length == 6)
                            {
                                where = new Expression(BankEntity.Field.BankNo, bankId);
                            }
                            else if (bankId.Length == 3)
                            {
                                where = new Expression(BankEntity.Field.BankNo, DataFormat.MyBankID + bankId);
                            }
                            else
                            {
                                where = new Expression(BankEntity.Field.BankNo, RelationEnum.Like, DataFormat.MyBankID + bankId + "%");
                            }

                            Result result = _Factory.SelectFirst<BankEntity>(where, null, out bank);
                            if (result.IsSuccess && bank == null)
                            {
                                result = new Result(false, String.Format("查無 {0} 主辦行資料", bankId), ErrorCode.D_DATA_NOT_FOUND, null);
                            }

                            #region 新增日誌資料
                            if (dbLogger != null)
                            {
                                string notation = null;
                                if (result.IsSuccess)
                                {
                                    notation = String.Format("[{0}] {1}主辦行資料成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                                }
                                else
                                {
                                    notation = String.Format("[{0}] {1}主辦行資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                                }
                                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                            }
                            #endregion

                            if (!result.IsSuccess)
                            {
                                #region 儲存日誌資料並釋放資料庫日誌記錄器
                                if (dbLogger != null)
                                {
                                    string logErrmsg = this.ReleaseDBLogger(true);
                                    dbLogger.Dispose();
                                    dbLogger = null;
                                }
                                #endregion

                                return result;
                            }
                        }
                        #endregion

                        #region [NEW:20151229] 合計項目 ReceiveSumEntity
                        ReceiveSumEntity[] receiveSums = null;
                        {
                            Expression where = new Expression(ReceiveSumEntity.Field.ReceiveType, schoolRid.ReceiveType)
                                .And(ReceiveSumEntity.Field.YearId, schoolRid.YearId)
                                .And(ReceiveSumEntity.Field.TermId, schoolRid.TermId)
                                .And(ReceiveSumEntity.Field.DepId, schoolRid.DepId)
                                .And(ReceiveSumEntity.Field.ReceiveId, schoolRid.ReceiveId)
                                .And(ReceiveSumEntity.Field.Status, DataStatusCodeTexts.NORMAL);
                            KeyValueList<OrderByEnum> orderbys = new KeyValueList<OrderByEnum>(1);
                            orderbys.Add(ReceiveSumEntity.Field.SumId, OrderByEnum.Asc);

                            Result result = _Factory.SelectAll<ReceiveSumEntity>(where, orderbys, out receiveSums);

                            #region 新增日誌資料
                            if (dbLogger != null)
                            {
                                string notation = null;
                                if (result.IsSuccess)
                                {
                                    notation = String.Format("[{0}] {1}合計項目設定資料成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                                }
                                else
                                {
                                    notation = String.Format("[{0}] {1}合計項目設定資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                                }
                                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                            }
                            #endregion

                            if (!result.IsSuccess)
                            {
                                #region 儲存日誌資料並釋放資料庫日誌記錄器
                                if (dbLogger != null)
                                {
                                    string logErrmsg = this.ReleaseDBLogger(true);
                                    dbLogger.Dispose();
                                    dbLogger = null;
                                }
                                #endregion

                                return result;
                            }
                        }
                        #endregion

                        #region templetContent
                        byte[] templetContent = null;
                        GenPDFHelper.PDFType pdfType = GenPDFHelper.PDFType.None;
                        {
                            #region [MDY:202203XX] 2022擴充案 中英文模板
                            bool useEngDataUI = isEngUI && schoolRType.IsEngEnabled();

                            BillFormEntity billForm = null;
                            Expression where = null;    // new Expression(BillFormEntity.Field.ReceiveType, receiveType);
                            if (command == "GENBILL")
                            {
                                int value = 0;
                                if (useEngDataUI)
                                {
                                    if (!Common.IsInt32(schoolRid.BillFormEId.Trim(), out value) || value < 1)
                                    {
                                        return new Result(false, "該代收費用別未設定繳費單模版或繳費單模版設定不正確", ErrorCode.D_DATA_NOT_FOUND, null);
                                    }
                                }
                                else
                                {
                                    if (!Common.IsInt32(schoolRid.BillformId.Trim(), out value) || value < 1)
                                    {
                                        return new Result(false, "該代收費用別未設定繳費單模版或繳費單模版設定不正確", ErrorCode.D_DATA_NOT_FOUND, null);
                                    }
                                }

                                pdfType = GenPDFHelper.PDFType.Bill;
                                where = new Expression(BillFormEntity.Field.BillFormId, value);
                            }
                            else
                            {
                                int value = 0;
                                if (useEngDataUI)
                                {
                                    if (!Common.IsInt32(schoolRid.InvoiceFormEId.Trim(), out value) || value < 1)
                                    {
                                        return new Result(false, "該代收費用別未設定收據模版或收據模版設定不正確", ErrorCode.D_DATA_NOT_FOUND, null);
                                    }
                                }
                                else
                                {
                                    if (!Common.IsInt32(schoolRid.InvoiceformId.Trim(), out value) || value < 1)
                                    {
                                        return new Result(false, "該代收費用別未設定收據模版或收據模版設定不正確", ErrorCode.D_DATA_NOT_FOUND, null);
                                    }
                                }

                                pdfType = GenPDFHelper.PDFType.Receipt;
                                where = new Expression(BillFormEntity.Field.BillFormId, value);
                            }
                            #endregion

                            Result result = _Factory.SelectFirst<BillFormEntity>(where, null, out billForm);
                            if (billForm != null)
                            {
                                templetContent = billForm.BillFormImage;
                            }
                            if (result.IsSuccess && templetContent == null || templetContent.Length == 0)
                            {
                                result = new Result(false, "查無該代收費用別的模板資料", ErrorCode.D_DATA_NOT_FOUND, null);
                            }

                            #region 新增日誌資料
                            if (dbLogger != null)
                            {
                                string notation = null;
                                if (result.IsSuccess)
                                {
                                    notation = String.Format("[{0}] {1}模板資料成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                                }
                                else
                                {
                                    notation = String.Format("[{0}] {1}模板資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                                }
                                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                            }
                            #endregion

                            if (!result.IsSuccess)
                            {
                                #region 儲存日誌資料並釋放資料庫日誌記錄器
                                if (dbLogger != null)
                                {
                                    string logErrmsg = this.ReleaseDBLogger(true);
                                    dbLogger.Dispose();
                                    dbLogger = null;
                                }
                                #endregion

                                return result;
                            }
                        }
                        #endregion

                        #region [MDY:20171127] 取財金 QRCode 支付參數設定 (20170831_01)
                        FiscQRCodeConfig qrcodeConfig = null;
                        {
                            ConfigEntity configData = null;
                            Expression where = new Expression(ConfigEntity.Field.ConfigKey, FiscQRCodeConfig.ConfigKey);
                            Result result = _Factory.SelectFirst<ConfigEntity>(where, null, out configData);
                            if (!result.IsSuccess)
                            {
                                return new Result(false, "讀取財金 QRCode 支付參數失敗，錯誤訊息：" + result.Message, result.Code, result.Exception);
                            }
                            //無資料或參數設定錯誤 (無法解析) 都不要中斷處理，避免使用無 QRCode 的模板也無法產生 PDF
                            if (configData != null)
                            {
                                qrcodeConfig = FiscQRCodeConfig.Parse(configData.ConfigValue);
                            }
                        }
                        #endregion

                        #region 產生 PDF
                        {
                            DateTime startTime;
                            DateTime endTime;
                            string pdfFile = null;
                            GenPDFHelper helper = new GenPDFHelper();

                            #region [MDY:20171127] 財金 QRCode 支付 (20170831_01)
                            #region [Old]
                            //Result result = helper.GenPDFFiles(schoolRType, schoolRid
                            //    , receiveChannels, studentReceives, students, bank, receiveSums, fgMark
                            //    , pdfType, templetContent, this.TempPath, commandAsker.UserId
                            //    , out startTime, out endTime, out pdfFile);
                            #endregion

                            #region [MDY:202203XX] 2022擴充案 是否英文介面
                            Result result = helper.GenPDFFiles(schoolRType, schoolRid
                                , receiveChannels, studentReceives, students, bank, receiveSums, qrcodeConfig, fgMark, isEngUI
                                , pdfType, templetContent, this.TempPath, commandAsker.UserId
                                , out startTime, out endTime, out pdfFile);
                            #endregion
                            #endregion

                            if (result.IsSuccess)
                            {
                                try
                                {
                                    byte[] pdfContent = System.IO.File.ReadAllBytes(pdfFile);
                                    if (pdfContent == null || pdfContent.Length == 0)
                                    {
                                        result = new Result(false, "無法讀取產生的 PDF 檔，檔案無內容", CoreStatusCode.UNKNOWN_ERROR, null);
                                    }
                                    else
                                    {
                                        data = pdfContent;
                                    }
                                }
                                catch (Exception ex)
                                {
                                    result = new Result(false, "讀取產生的 PDF 檔失敗，錯誤訊息：" + ex.Message, CoreStatusCode.UNKNOWN_EXCEPTION, ex);
                                }
                            }
                            return result;
                        }
                        #endregion
                    }
                    #endregion
                default:
                    return new Result(false, "支援的要求命令", CoreStatusCode.UNKNOWN_ERROR, null);
            }
        }

        /// <summary>
        /// 取得 B2100002 (維護學生繳費資料) 合計資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result GetB2100002Summary(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            Expression where = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "WHEREXML":
                        {
                            object objData = null;
                            string whereXml = argument.Value == null ? String.Empty : argument.Value.Trim();
                            if (Common.TryDeXmlExplicitly2(whereXml, typeof(Expression), out objData))
                            {
                                where = objData as Expression;
                            }
                            else
                            {
                                return new Result(false, "方法參數無法被反序列化", ErrorCode.S_DESERIALIZED_FAILURE, null);
                            }
                        }
                        break;
                }
            }

            if (where == null   //必要參數
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 將 Where 物件轉成 where sql 語法與 KeyValue 參數
            string whereSql = null;
            KeyValueList parameters = null;
            IDataParameter[] whereParameters = null;
            if (!_Factory.GenWhereCommandTextParameters(where, out whereSql, out whereParameters))
            {
                return new Result(false, "無效的查詢條件參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            if (whereParameters != null &&　whereParameters.Length > 0)
            {
                parameters = new KeyValueList(whereParameters.Length);
                foreach(IDataParameter whereParameter in whereParameters)
                {
                    parameters.Add(whereParameter.ParameterName, whereParameter.Value);
                }
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 查詢資料 (StudentView)
            {
                //請注意，組 SQL 參考的 Entity 需與 B2100002 頁面相同，否則查詢結過可能會失敗或不正確
                string sql = @"SELECT COUNT(1) AS DataCount, ISNULL(SUM(Receive_Amount), 0) AS SumAmount
  FROM (" +
StudentView.VIEWSQL +
@") T " + @"
 WHERE " + whereSql;

                int dataCount = 0;
                decimal sumAmount = 0M;
                DataTable dt = null;
                Result result = _Factory.GetDataTable(sql, parameters, 0, 1, out dt);
                if (result.IsSuccess)
                {
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        DataRow row = dt.Rows[0];
                        dataCount = Convert.ToInt32(row["DataCount"]);
                        if (!row.IsNull("SumAmount"))
                        {
                            sumAmount = Convert.ToDecimal(row["SumAmount"]);
                        }
                    }

                    data = new KeyValue<Decimal>[2] {
                        new KeyValue<Decimal>("DataCount", dataCount),
                        new KeyValue<Decimal>("SumAmount", sumAmount)
                    };
                }

                #region 新增日誌資料，儲存日誌資料並釋放資料庫日誌記錄器
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}合計資料成功 (DataCount={2}; SumAmount={3})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, dataCount, sumAmount);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}合計資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);

                    string logErrmsg = this.ReleaseDBLogger(true);
                    dbLogger.Dispose();
                    dbLogger = null;
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 取得 C3700006 (中心入帳資料查詢) 合計資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result GetC3700006Summary(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            Expression where = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "WHEREXML":
                        {
                            object objData = null;
                            string whereXml = argument.Value == null ? String.Empty : argument.Value.Trim();
                            if (Common.TryDeXmlExplicitly2(whereXml, typeof(Expression), out objData))
                            {
                                where = objData as Expression;
                            }
                            else
                            {
                                return new Result(false, "方法參數無法被反序列化", ErrorCode.S_DESERIALIZED_FAILURE, null);
                            }
                        }
                        break;
                }
            }

            if (where == null   //必要參數
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 將 Where 物件轉成 where sql 語法與 KeyValue 參數
            string whereSql = null;
            KeyValueList parameters = null;
            IDataParameter[] whereParameters = null;
            if (!_Factory.GenWhereCommandTextParameters(where, out whereSql, out whereParameters))
            {
                return new Result(false, "無效的查詢條件參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            if (whereParameters != null && whereParameters.Length > 0)
            {
                parameters = new KeyValueList(whereParameters.Length);
                foreach (IDataParameter whereParameter in whereParameters)
                {
                    parameters.Add(whereParameter.ParameterName, whereParameter.Value);
                }
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 查詢資料 (StudentView)
            {
                //請注意，組 SQL 參考的 Entity 需與 C3700006 頁面相同，否則查詢結過可能會失敗或不正確
                string sql = @"SELECT COUNT(1) AS DataCount, ISNULL(SUM(Receive_Amount), 0) AS SumAmount
  FROM (" +
CancelDebtsView.VIEWSQL +
@") T " + @"
 WHERE " + whereSql;

                int dataCount = 0;
                decimal sumAmount = 0M;
                DataTable dt = null;
                Result result = _Factory.GetDataTable(sql, parameters, 0, 1, out dt);
                if (result.IsSuccess)
                {
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        DataRow row = dt.Rows[0];
                        dataCount = Convert.ToInt32(row["DataCount"]);
                        if (!row.IsNull("SumAmount"))
                        {
                            sumAmount = Convert.ToDecimal(row["SumAmount"]);
                        }
                    }

                    data = new KeyValue<Decimal>[2] {
                        new KeyValue<Decimal>("DataCount", dataCount),
                        new KeyValue<Decimal>("SumAmount", sumAmount)
                    };
                }

                #region 新增日誌資料，儲存日誌資料並釋放資料庫日誌記錄器
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}合計資料成功 (DataCount={2}; SumAmount={3})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, dataCount, sumAmount);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}合計資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);

                    string logErrmsg = this.ReleaseDBLogger(true);
                    dbLogger.Dispose();
                    dbLogger = null;
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 新增 B2300003 資料 (產生Email繳費通知)
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <returns></returns>
        public Result InsertB2300003Data(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments)
        {
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            string depId = null;
            string receiveId = null;
            string rangeType = null;
            string startSNo = null;
            string endSNo = null;
            string upNo = null;
            string studentId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "DEPID":
                        depId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVEID":
                        receiveId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RANGETYPE":
                        rangeType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "STARTSNO":
                        startSNo = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "ENDSNO":
                        endSNo = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "UPNO":
                        upNo = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "STUDENTID":
                        studentId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)        //必要參數且不可為空字串
                || String.IsNullOrEmpty(yearId)         //必要參數且不可為空字串
                || String.IsNullOrEmpty(termId)         //必要參數且不可為空字串
                //|| String.IsNullOrEmpty(depId)          //必要參數且不可為空字串
                || String.IsNullOrEmpty(receiveId)      //必要參數且不可為空字串
                || String.IsNullOrEmpty(rangeType)      //必要參數且不可為空字串
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            string andWhereSql = null;
            KeyValue[] andWhereParams = null;;
            switch (rangeType)
            {
                case "ByAll":
                    {
                        andWhereSql = String.Empty;
                    }
                    break;
                case "BySeriorNo":
                    {
                        Int64 value = 0;
                        if (String.IsNullOrEmpty(startSNo) || String.IsNullOrEmpty(endSNo)
                            || !Int64.TryParse(startSNo, out value) || value < 1
                            || !Int64.TryParse(endSNo, out value) || value < 1)
                        {
                            return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                        }
                        andWhereSql = "    AND a.serior_no >= @StartSNo AND a.serior_no <= @EndSNo ";
                        andWhereParams = new KeyValue[] { new KeyValue("@StartSNo", startSNo), new KeyValue("@EndSNo", endSNo) };
                    }
                    break;
                case "ByUpNo":
                    {
                        int value = 0;
                        if (String.IsNullOrEmpty(upNo) || !Int32.TryParse(upNo, out value) || value < 1)
                        {
                            return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                        }
                        andWhereSql = "    AND a.up_no = @UpNo ";
                        andWhereParams = new KeyValue[] { new KeyValue("@UpNo", upNo) };
                    }
                    break;
                case "ByStudentId":
                    {
                        if (String.IsNullOrEmpty(studentId))
                        {
                            return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                        }
                        andWhereSql = "    AND a.stu_id = @StudentId ";
                        andWhereParams = new KeyValue[] { new KeyValue("@StudentId", studentId) };
                    }
                    break;
                default:
                    return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            Result result = null;

            #region 檢查繳費期限
            {
                SchoolRidEntity school = null;
                Expression where = new Expression(SchoolRidEntity.Field.ReceiveType, receiveType)
                    .And(SchoolRidEntity.Field.YearId, yearId)
                    .And(SchoolRidEntity.Field.TermId, termId)
                    .And(SchoolRidEntity.Field.DepId, depId)
                    .And(SchoolRidEntity.Field.ReceiveId, receiveId);
                result = _Factory.SelectFirst<SchoolRidEntity>(where, null, out school);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}代收費用設定資料成功 (ReceiveType={2}, YearId={3}, TermId={4}, DepId={5}, ReceiveId={6})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, receiveType, yearId, termId, depId, receiveId);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}代收費用設定資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                }
                #endregion

                if (result.IsSuccess)
                {
                    DateTime payDueDate;
                    if (school == null)
                    {
                        result = new Result(false, "查詢無代收費用設定資料", ErrorCode.D_DATA_NOT_FOUND, null);
                    }
                    else if (String.IsNullOrEmpty(school.PayDate) || !Common.TryConvertTWDate7(school.PayDate, out  payDueDate))
                    {
                        result = new Result(false, "該代收費用別未設定繳款期限", ErrorCode.D_DATA_NOT_FOUND, null);
                    }
                    else if (payDueDate < DateTime.Today)
                    {
                        result = new Result(false, "該代收費用別的繳款期限已過期", ErrorCode.D_DATA_NOT_FOUND, null);
                    }
                }
                else
                {
                    result = new Result(false, "查詢代收費用設定資料失敗", result.Code, result.Exception);
                }
            }
            #endregion

            #region 使用交易新增資料
            if (result.IsSuccess)
            {
                EntityFactory tsFactory = _Factory.CloneForTransaction();
                try
                {
                    #region 先刪除舊資料
                    {
                        //[TODO] 待確認是否寄送過得也要刪
                        string sql = @"
DELETE FROM email_data
 WHERE cancel_no IN (
    SELECT a.cancel_no AS cancel_no
      FROM student_receive a, student_master b, school_rid c
     WHERE 1 = 1
       AND (b.stu_id = a.stu_id AND b.receive_type = a.receive_type AND b.dep_id = a.dep_id)
       AND (c.receive_type = a.receive_type AND c.year_id = a.year_id  AND c.term_id = a.term_id  AND c.dep_id = a.dep_id  AND c.receive_id = a.receive_id)
       AND (b.stu_email <> '' AND b.stu_email IS NOT NULL)
       AND (a.receive_amount IS NOT NULL AND a.receive_amount > 0)
       AND (a.receive_way = '' OR a.receive_way IS NULL)
       AND (a.cancel_flag = '' OR a.cancel_flag IS NULL)
       AND (a.cancel_no <> '' AND a.cancel_no IS NOT NULL)
       AND a.receive_type = @ReceiveType
       AND a.year_id = @YearId
       AND a.term_id = @TermId
       AND a.dep_id = @DepId
       AND a.receive_id = @ReceiveId 
" + andWhereSql + @"
);";
                        KeyValueList parameters = new KeyValueList(10);
                        parameters.Add("@ReceiveType", receiveType);
                        parameters.Add("@YearId", yearId);
                        parameters.Add("@TermId", termId);
                        parameters.Add("@DepId", depId);
                        parameters.Add("@ReceiveId", receiveId);
                        if (andWhereParams != null && andWhereParams.Length > 0)
                        {
                            parameters.AddRange(andWhereParams);
                        }
                        int count = 0;
                        result = tsFactory.ExecuteNonQuery(sql, parameters, out count);

                        #region 新增日誌資料
                        if (dbLogger != null)
                        {
                            string notation = null;
                            if (result.IsSuccess)
                            {
                                notation = String.Format("[{0}] {1}重複的通知信資料成功 (count={2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, count);
                            }
                            else
                            {
                                notation = String.Format("[{0}] {1}重複的通知信資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                            }
                            dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                        }
                        #endregion

                        if (!result.IsSuccess)
                        {
                            result = new Result(false, "刪除重複的通知信資料失敗", result.Code, result.Exception);
                        }
                    }
                    #endregion

                    if (result.IsSuccess)
                    {
                        string sql = @"
INSERT INTO email_data 
(cancel_no, stu_email, personid, stu_id, stu_name, due_date, amount, email_date, receive_type, year_id, term_id, dep_id, receive_id) 
SELECT a.cancel_no, b.stu_email, ISNULL(b.id_number,'') AS personid, a.stu_id, b.stu_name, ISNULL(c.pay_date,'') AS due_date, a.receive_amount AS amount
     , CONVERT(varchar,GETDATE(),112) AS email_date
     , a.receive_type, a.year_id, a.term_id, a.dep_id, a.receive_id 
  FROM student_receive a, student_master b, school_rid c 
 WHERE 1 = 1 
   AND (b.stu_id = a.stu_id AND b.receive_type = a.receive_type AND b.dep_id = a.dep_id) 
   AND (c.receive_type = a.receive_type AND c.year_id = a.year_id AND c.term_id = a.term_id AND c.dep_id = a.dep_id AND c.receive_id = a.receive_id) 
   AND (b.stu_email <> '' AND b.stu_email IS NOT NULL) 
   AND (a.receive_amount IS NOT NULL AND a.receive_amount > 0) 
   AND (a.receive_way = '' OR a.receive_way IS NULL) 
   AND (a.cancel_flag = '' OR a.cancel_flag IS NULL) 
   AND (a.cancel_no <> '' AND a.cancel_no IS NOT NULL) 
   AND a.receive_type = @ReceiveType
   AND a.year_id = @YearId 
   AND a.term_id = @TermId
   AND a.dep_id = @DepId
   AND a.receive_id = @ReceiveId
" + andWhereSql + ";";
                        KeyValueList parameters = new KeyValueList(10);
                        parameters.Add("@ReceiveType", receiveType);
                        parameters.Add("@YearId", yearId);
                        parameters.Add("@TermId", termId);
                        parameters.Add("@DepId", depId);
                        parameters.Add("@ReceiveId", receiveId);
                        if (andWhereParams != null && andWhereParams.Length > 0)
                        {
                            parameters.AddRange(andWhereParams);
                        }
                        int count = 0;
                        result = tsFactory.ExecuteNonQuery(sql, parameters, out count);

                        #region 新增日誌資料
                        if (dbLogger != null)
                        {
                            string notation = null;
                            if (result.IsSuccess)
                            {
                                notation = String.Format("[{0}] {1}通知信資料成功 (count={2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, count);
                            }
                            else
                            {
                                notation = String.Format("[{0}] {1}通知信資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                            }
                            dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                        }
                        #endregion

                        if (!result.IsSuccess)
                        {
                            result = new Result(false, "新增通知信資料失敗", result.Code, result.Exception);
                        }
                    }
                }
                catch (Exception ex)
                {
                    string notation = String.Format("[{0}] {1}新增資料發生例外 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, ex.Message);
                    result = new Result(false, notation, CoreStatusCode.UNKNOWN_EXCEPTION, ex);

                    #region 新增日誌資料
                    if (dbLogger != null)
                    {
                        dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                    }
                    #endregion
                }
                finally
                {
                    if (tsFactory != null)
                    {
                        if (result.IsSuccess)
                        {
                            tsFactory.Commit();
                        }
                        else
                        {
                            tsFactory.Rollback();
                        }
                        tsFactory.Dispose();
                        tsFactory = null;
                    }

                    #region Release DBLogger
                    if (!result.IsSuccess)
                    {
                        if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                        {
                            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                        }
                        else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                        {
                            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                        }
                    }
                    string logErrmsg = this.ReleaseDBLogger(true);
                    if (dbLogger != null)
                    {
                        dbLogger.Dispose();
                        dbLogger = null;
                    }
                    #endregion
                }
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 取得 C3400001 查詢結果 (每日銷帳結果查詢)
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result GetC3400001Result(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式 (合併前端的純查詢、匯出 XLS、匯出 ODS)
            string receiveType = null;
            string yearId = null;
            string termId = null;
            string depId = null;
            string receiveId = null;
            DateTime? sAccountDate = null;
            DateTime? eAccountDate = null;
            string fileType = null;  //匯出檔類別 XLS、ODS，如果無值表示純查詢則傳回原 CancelResultEntity
            DateTime date;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "DEPID":
                        depId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVEID":
                        receiveId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "SACCOUNTDATE":
                        if (!String.IsNullOrEmpty(argument.Value) && DateTime.TryParse(argument.Value.Trim(), out date))
                        {
                            sAccountDate = date;
                        }
                        break;
                    case "EACCOUNTDATE":
                        if (!String.IsNullOrEmpty(argument.Value) && DateTime.TryParse(argument.Value.Trim(), out date))
                        {
                            eAccountDate = date;
                        }
                        break;

                    case "FILETYPE":
                        fileType = argument.Value == null ? String.Empty : argument.Value.Trim().ToUpper();
                        break;
                }
            }

            if (String.IsNullOrEmpty(receiveType)       //必要參數且不可為空字串
                || sAccountDate == null                 //必要參數
                || eAccountDate == null                 //必要參數
                || (!String.IsNullOrEmpty(fileType) && fileType != "XLS" && fileType != "ODS")
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            Result result = null;

            #region 查詢
            KeyValueList parameters = new KeyValueList(7);
            List<string> sqlWheres = new List<string>(4);
            if (!String.IsNullOrEmpty(yearId))
            {
                sqlWheres.Add(" AND Year_Id = @YearId");
                parameters.Add("@YearId", yearId);
            }
            if (!String.IsNullOrEmpty(termId))
            {
                sqlWheres.Add(" AND Term_Id = @TermId");
                parameters.Add("@TermId", termId);
            }
            if (!String.IsNullOrEmpty(depId))
            {
                sqlWheres.Add(" AND Dep_Id = @DepId");
                parameters.Add("@DepId", depId);
            }
            if (!String.IsNullOrEmpty(receiveId))
            {
                sqlWheres.Add(" AND Receive_Id = @ReceiveId");
                parameters.Add("@ReceiveId", receiveId);
            }

            #region [MDY:20191214] (2019擴充案) 國際信用卡 - 增加國際信用卡 (NC)
            #region [OLD]
//            #region [MDY:20171127] 增加全國繳費網 (C08)、台灣Pay (C10) (20170831_01)
//            #region [Old]
//            //            #region [MDY:20170506] 增加支付寶
////            #region [Old]
////            //            string sql = @"SELECT [Account_Date]
//////     , [Receive_Type]
//////     , [Year_Id], [Year_Name]
//////     , [Term_Id], [Term_Name]
//////     , [Dep_Id], [Dep_Name]
//////     , [Receive_Id], [Receive_Name]
//////     , SUM([SO_Count])     AS [SO_Count],     SUM([SO_Amount])    AS [SO_Amount]
//////     , SUM([Y_Count])      AS [Y_Count],      SUM([Y_Amount])     AS [Y_Amount]
//////     , SUM([P_Count])      AS [P_Count],      SUM([P_Amount])     AS [P_Amount]
//////     , SUM([G_Count])      AS [G_Count],      SUM([G_Amount])     AS [G_Amount]
//////     , SUM([D_Count])      AS [D_Count],      SUM([D_Amount])     AS [D_Amount]
//////     , SUM([N_Count])      AS [N_Count],      SUM([N_Amount])     AS [N_Amount]
//////     , SUM([J_Count])      AS [J_Count],      SUM([J_Amount])     AS [J_Amount]
//////     , SUM([B_Count])      AS [B_Count],      SUM([B_Amount])     AS [B_Amount]
//////     , SUM([K_Count])      AS [K_Count],      SUM([K_Amount])     AS [K_Amount]
//////     , SUM([W_Count])      AS [W_Count],      SUM([W_Amount])     AS [W_Amount]
//////     , SUM([A_Count])      AS [A_Count],      SUM([A_Amount])     AS [A_Amount]
//////     , SUM([I_Count])      AS [I_Count],      SUM([I_Amount])     AS [I_Amount]
//////     , SUM([CMF_Count])    AS [CMF_Count],    SUM([CMF_Amount])   AS [CMF_Amount]
//////     , SUM([H_Count])      AS [H_Count],      SUM([H_Amount])     AS [H_Amount]
//////     , SUM([Market_Count]) AS [Market_Count], SUM([Market_Fee])   AS [Market_Fee]
//////     , SUM([Sub_Count])    AS [Sub_Count],    SUM([Sub_Amount])   AS [Sub_Amount]
//////     , SUM([Total_Count])  AS [Total_Count],  SUM([Total_Amount]) AS [Total_Amount]
//////     , GETDATE() AS [Create_Date]
//////     , SUM([Post_Fee]) AS [Post_Fee]
//////  FROM [Cancel_Result]
////// WHERE Receive_Type = @ReceiveType AND Account_Date >= @SAccountDate AND Account_Date <= @EAccountDate
//////  " + String.Join("", sqlWheres.ToArray()) + @"
////// GROUP BY [Account_Date],[Receive_Type]
//////     , [Year_Id], [Year_Name], [Term_Id], [Term_Name]
//////     , [Dep_Id], [Dep_Name], [Receive_Id], [Receive_Name]";
////            #endregion

////            string sql = @"SELECT [Account_Date]
////     , [Receive_Type]
////     , [Year_Id], [Year_Name]
////     , [Term_Id], [Term_Name]
////     , [Dep_Id], [Dep_Name]
////     , [Receive_Id], [Receive_Name]
////     , SUM([SO_Count])     AS [SO_Count],     SUM([SO_Amount])    AS [SO_Amount]
////     , SUM([Y_Count])      AS [Y_Count],      SUM([Y_Amount])     AS [Y_Amount]
////     , SUM([P_Count])      AS [P_Count],      SUM([P_Amount])     AS [P_Amount]
////     , SUM([G_Count])      AS [G_Count],      SUM([G_Amount])     AS [G_Amount]
////     , SUM([D_Count])      AS [D_Count],      SUM([D_Amount])     AS [D_Amount]
////     , SUM([N_Count])      AS [N_Count],      SUM([N_Amount])     AS [N_Amount]
////     , SUM([J_Count])      AS [J_Count],      SUM([J_Amount])     AS [J_Amount]
////     , SUM([B_Count])      AS [B_Count],      SUM([B_Amount])     AS [B_Amount]
////     , SUM([K_Count])      AS [K_Count],      SUM([K_Amount])     AS [K_Amount]
////     , SUM([W_Count])      AS [W_Count],      SUM([W_Amount])     AS [W_Amount]
////     , SUM([A_Count])      AS [A_Count],      SUM([A_Amount])     AS [A_Amount]
////     , SUM([I_Count])      AS [I_Count],      SUM([I_Amount])     AS [I_Amount]
////     , SUM([CMF_Count])    AS [CMF_Count],    SUM([CMF_Amount])   AS [CMF_Amount]
////     , SUM([H_Count])      AS [H_Count],      SUM([H_Amount])     AS [H_Amount]
////     , SUM([C09_Count])    AS [C09_Count],    SUM([C09_Amount])   AS [C09_Amount]
////     , SUM([Market_Count]) AS [Market_Count], SUM([Market_Fee])   AS [Market_Fee]
////     , SUM([Sub_Count])    AS [Sub_Count],    SUM([Sub_Amount])   AS [Sub_Amount]
////     , SUM([Total_Count])  AS [Total_Count],  SUM([Total_Amount]) AS [Total_Amount]
////     , GETDATE() AS [Create_Date]
////     , SUM([Post_Fee]) AS [Post_Fee]
////  FROM [Cancel_Result]
//// WHERE Receive_Type = @ReceiveType AND Account_Date >= @SAccountDate AND Account_Date <= @EAccountDate
////  " + String.Join("", sqlWheres.ToArray()) + @"
//// GROUP BY [Account_Date], [Receive_Type]
////     , [Year_Id], [Year_Name], [Term_Id], [Term_Name]
////     , [Dep_Id], [Dep_Name], [Receive_Id], [Receive_Name]";
////            #endregion
//            #endregion

//            string sql = @"SELECT [Account_Date]
//     , [Receive_Type]
//     , [Year_Id], [Year_Name]
//     , [Term_Id], [Term_Name]
//     , [Dep_Id], [Dep_Name]
//     , [Receive_Id], [Receive_Name]
//     , SUM([SO_Count])     AS [SO_Count],     SUM([SO_Amount])    AS [SO_Amount]
//     , SUM([Y_Count])      AS [Y_Count],      SUM([Y_Amount])     AS [Y_Amount]
//     , SUM([P_Count])      AS [P_Count],      SUM([P_Amount])     AS [P_Amount]
//     , SUM([G_Count])      AS [G_Count],      SUM([G_Amount])     AS [G_Amount]
//     , SUM([D_Count])      AS [D_Count],      SUM([D_Amount])     AS [D_Amount]
//     , SUM([N_Count])      AS [N_Count],      SUM([N_Amount])     AS [N_Amount]
//     , SUM([J_Count])      AS [J_Count],      SUM([J_Amount])     AS [J_Amount]
//     , SUM([B_Count])      AS [B_Count],      SUM([B_Amount])     AS [B_Amount]
//     , SUM([K_Count])      AS [K_Count],      SUM([K_Amount])     AS [K_Amount]
//     , SUM([W_Count])      AS [W_Count],      SUM([W_Amount])     AS [W_Amount]
//     , SUM([A_Count])      AS [A_Count],      SUM([A_Amount])     AS [A_Amount]
//     , SUM([I_Count])      AS [I_Count],      SUM([I_Amount])     AS [I_Amount]
//     , SUM([CMF_Count])    AS [CMF_Count],    SUM([CMF_Amount])   AS [CMF_Amount]
//     , SUM([H_Count])      AS [H_Count],      SUM([H_Amount])     AS [H_Amount]
//     , SUM([C09_Count])    AS [C09_Count],    SUM([C09_Amount])   AS [C09_Amount]
//     , SUM([C08_Count])    AS [C08_Count],    SUM([C08_Amount])   AS [C08_Amount]
//     , SUM([C10_Count])    AS [C10_Count],    SUM([C10_Amount])   AS [C10_Amount]
//     , SUM([Market_Count]) AS [Market_Count], SUM([Market_Fee])   AS [Market_Fee]
//     , SUM([Sub_Count])    AS [Sub_Count],    SUM([Sub_Amount])   AS [Sub_Amount]
//     , SUM([Total_Count])  AS [Total_Count],  SUM([Total_Amount]) AS [Total_Amount]
//     , GETDATE() AS [Create_Date]
//     , SUM([Post_Fee]) AS [Post_Fee]
//  FROM [Cancel_Result]
// WHERE Receive_Type = @ReceiveType AND Account_Date >= @SAccountDate AND Account_Date <= @EAccountDate
//  " + String.Join("", sqlWheres.ToArray()) + @"
// GROUP BY [Account_Date], [Receive_Type]
//     , [Year_Id], [Year_Name], [Term_Id], [Term_Name]
//     , [Dep_Id], [Dep_Name], [Receive_Id], [Receive_Name]";
//            #endregion
            #endregion

            string sql = @"SELECT [Account_Date]
     , [Receive_Type]
     , [Year_Id], [Year_Name]
     , [Term_Id], [Term_Name]
     , [Dep_Id], [Dep_Name]
     , [Receive_Id], [Receive_Name]
     , SUM([SO_Count])     AS [SO_Count],     SUM([SO_Amount])    AS [SO_Amount]
     , SUM([Y_Count])      AS [Y_Count],      SUM([Y_Amount])     AS [Y_Amount]
     , SUM([P_Count])      AS [P_Count],      SUM([P_Amount])     AS [P_Amount]
     , SUM([G_Count])      AS [G_Count],      SUM([G_Amount])     AS [G_Amount]
     , SUM([D_Count])      AS [D_Count],      SUM([D_Amount])     AS [D_Amount]
     , SUM([N_Count])      AS [N_Count],      SUM([N_Amount])     AS [N_Amount]
     , SUM([J_Count])      AS [J_Count],      SUM([J_Amount])     AS [J_Amount]
     , SUM([B_Count])      AS [B_Count],      SUM([B_Amount])     AS [B_Amount]
     , SUM([K_Count])      AS [K_Count],      SUM([K_Amount])     AS [K_Amount]
     , SUM([W_Count])      AS [W_Count],      SUM([W_Amount])     AS [W_Amount]
     , SUM([A_Count])      AS [A_Count],      SUM([A_Amount])     AS [A_Amount]
     , SUM([I_Count])      AS [I_Count],      SUM([I_Amount])     AS [I_Amount]
     , SUM([CMF_Count])    AS [CMF_Count],    SUM([CMF_Amount])   AS [CMF_Amount]
     , SUM([H_Count])      AS [H_Count],      SUM([H_Amount])     AS [H_Amount]
     , SUM([C09_Count])    AS [C09_Count],    SUM([C09_Amount])   AS [C09_Amount]
     , SUM([C08_Count])    AS [C08_Count],    SUM([C08_Amount])   AS [C08_Amount]
     , SUM([C10_Count])    AS [C10_Count],    SUM([C10_Amount])   AS [C10_Amount]
     , SUM([NC_Count])     AS [NC_Count],     SUM([NC_Amount])    AS [NC_Amount]
     , SUM([Market_Count]) AS [Market_Count], SUM([Market_Fee])   AS [Market_Fee]
     , SUM([Sub_Count])    AS [Sub_Count],    SUM([Sub_Amount])   AS [Sub_Amount]
     , SUM([Total_Count])  AS [Total_Count],  SUM([Total_Amount]) AS [Total_Amount]
     , GETDATE() AS [Create_Date]
     , SUM([Post_Fee]) AS [Post_Fee]
  FROM [Cancel_Result]
 WHERE Receive_Type = @ReceiveType AND Account_Date >= @SAccountDate AND Account_Date <= @EAccountDate
  " + String.Join("", sqlWheres.ToArray()) + @"
 GROUP BY [Account_Date], [Receive_Type]
     , [Year_Id], [Year_Name], [Term_Id], [Term_Name]
     , [Dep_Id], [Dep_Name], [Receive_Id], [Receive_Name]";
            #endregion

            parameters.Add("@ReceiveType", receiveType);
            parameters.Add("@SAccountDate", Common.GetTWDate7(sAccountDate.Value));
            parameters.Add("@EAccountDate", Common.GetTWDate7(eAccountDate.Value));

            DataTable dt = null;
            using(EntityFactory factory = new EntityFactory())
            {
                result = factory.GetDataTable(sql, parameters, 0, 0, out dt);
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}每日銷帳結果資料成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                }
                else
                {
                    notation = String.Format("[{0}] {1}每日銷帳結果資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);

                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            if (result.IsSuccess && dt != null && dt.Rows.Count > 0)
            {
                CancelResultEntity[] instances = null;
                result = EntityUtility.Convert<CancelResultEntity>(dt, 0, 0, out instances);
                if (result.IsSuccess)
                {
                    #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式 (合併前端的純查詢、匯出 XLS、匯出 ODS)
                    if (String.IsNullOrEmpty(fileType))
                    {
                        data = instances;
                    }
                    else
                    {
                        byte[] fileContent = null;
                        if (instances != null && instances.Length > 0)
                        {
                            using (ExportFileHelper helper = new ExportFileHelper())
                            {
                                string sheetName = String.Format("{0:yyyyMMdd}~{1:yyyyMMdd}_銷帳結果.XLS", sAccountDate, eAccountDate);
                                string errmsg = helper.ExportC3400001ResutFile(instances, sheetName, fileType, out fileContent);
                                if (!String.IsNullOrEmpty(errmsg))
                                {
                                    result = new Result(false, errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
                                }
                            }
                        }
                        data = fileContent;
                    }
                    #endregion
                }
            }
            return result;
            #endregion
        }

        /// <summary>
        /// 匯出 B2100005 的委扣檔案
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result ExportB2100005File(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string command = null;
            string receiveType = null;
            List<BillKey> keys = null;
            DateTime? deductDate = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "COMMAND":
                        command = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "KEYSTEXT":
                        string keysText = argument.Value == null ? String.Empty : argument.Value.Trim();
                        if (!String.IsNullOrEmpty(keysText))
                        {
                            string[] keyTexts = keysText.Split(new char[] {';'},  StringSplitOptions.RemoveEmptyEntries);
                            if (keyTexts.Length > 0)
                            {
                                keys = new List<BillKey>(keyTexts.Length);
                                foreach (string keyText in keyTexts)
                                {
                                    BillKey key = BillKey.ParseKeyText(keyText);
                                    if (key == null)
                                    {
                                        return new Result(false, "匯出資料選取參數包含無效的資料", CoreStatusCode.INVALID_PARAMETER, null);
                                    }
                                    keys.Add(key);
                                }
                            }
                        }
                        break;
                    case "DEDUCTDATE":
                        DateTime date;
                        if (!String.IsNullOrEmpty(argument.Value) && DateTime.TryParse(argument.Value.Trim(), out date))
                        {
                            deductDate = date;
                        }
                        break;
                }
            }
            if (String.IsNullOrEmpty(command)           //必要參數且不可為空字串
                || String.IsNullOrEmpty(receiveType)    //必要參數且不可為空字串
                || keys == null || keys.Count == 0      //必要參數
                || deductDate == null                   //必要參數
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            string outFile = null;
            string dataLog = null;
            string errmsg = null;
            using(ExportFileHelper helper = new  ExportFileHelper(null, this.TempPath))
            {
                switch(command)
                {
                    case "ExportBANK":
                        errmsg = helper.ExportBANKDeduction(receiveType, keys, deductDate.Value, null, out outFile, out dataLog);
                        break;

                    #region [Old] 土銀只有自行委扣
                    //case "ExportCNB":
                    //    errmsg = helper.ExportCNBDeduction(keys, deductDate.Value, null, out outFile, out dataLog);
                    //    break;
                    //case "ExportACH":
                    //    errmsg = helper.ExportACHDeduction(keys, deductDate.Value, null, out outFile, out dataLog);
                    //    break;
                    #endregion

                    default:
                        return new Result(false, "無效的方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
                }
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (String.IsNullOrEmpty(errmsg))
                {
                    notation = String.Format("[{0}] {1}委扣資料成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                }
                else
                {
                    notation = String.Format("[{0}] {1}委扣資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, errmsg);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);

                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            if (String.IsNullOrEmpty(errmsg))
            {
                try
                {
                    data = System.IO.File.ReadAllBytes(outFile);
                    return new Result(true, dataLog, ErrorCode.NORMAL_STATUS, null);
                }
                catch (Exception ex)
                {
                    return new Result(false, "讀取匯出資料的檔案失敗，錯誤訊息：" + ex.Message, CoreStatusCode.UNKNOWN_EXCEPTION, ex);
                }
            }
            else
            {
                return new Result(false, errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
            }
        }

        /// <summary>
        /// 匯入 B2100007 的委扣回復檔案
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result ImportB2100007File(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            string depId = null;
            string receiveId = null;
            string fileContent = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "DEPID":
                        depId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVEID":
                        receiveId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "FILECONTENT":
                        fileContent = argument.Value == null ? String.Empty : argument.Value;
                        break;
                }
            }

            #region [Old] 土銀不使用 depId 部別代碼
            //if (String.IsNullOrEmpty(receiveType)       //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(yearId)         //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(termId)         //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(depId)          //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(receiveId)      //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(fileContent)    //必要參數且不可為空字串
            //    )
            //{
            //    return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            //}
            #endregion

            if (String.IsNullOrEmpty(receiveType)       //必要參數且不可為空字串
                || String.IsNullOrEmpty(yearId)         //必要參數且不可為空字串
                || String.IsNullOrEmpty(termId)         //必要參數且不可為空字串
                || depId == null                        //必要參數
                || String.IsNullOrEmpty(receiveId)      //必要參數且不可為空字串
                || String.IsNullOrEmpty(fileContent)    //必要參數且不可為空字串
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            string resultText = null;
            CancelHelper helper = new CancelHelper();
            string errmsg = helper.CancelByBankDeductionResult(dbLogger, receiveType, yearId, termId, depId, receiveId, fileContent, out resultText);
            data = resultText;

            #region Release DBLogger
            string logErrmsg = this.ReleaseDBLogger(true);
            if (dbLogger != null)
            {
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            if (String.IsNullOrEmpty(errmsg))
            {
                return new Result(true);
            }
            else
            {
                return new Result(false, errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
            }
        }

        /// <summary>
        /// 匯出 B2100003 學生繳費資料媒體檔 (下載銷帳資料也使用此方法)
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result ExportB2100003File(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
            string receiveType = null;
            string yearId = null;
            string termId = null;
            string depId = null;
            string receiveId = null;

            int? qUpNo = null;
            string qCancelStatus = null;
            string qReceiveWay = null;
            DateTime? qSReceivDate = null;
            DateTime? qEReceivDate = null;
            DateTime? qSAccountDate = null;
            DateTime? qEAccountDate = null;
            string qFieldName = null;
            string qFieldValue = null;
            bool isUseODS = false;

            string[] outFields = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "DEPID":
                        depId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVEID":
                        receiveId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;

                    case "QUPNO":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            int value = 0;
                            if (Int32.TryParse(argument.Value.Trim(), out value) && value > -1)
                            {
                                qUpNo = value;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "QCANCELSTATUS":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            qCancelStatus = argument.Value.Trim();
                            if (CancelStatusCodeTexts.GetCodeText(qCancelStatus) == null)
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "QRECEIVEWAY":
                        qReceiveWay = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "QSRECEIVDATE":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            DateTime date;
                            if (DateTime.TryParse(argument.Value.Trim(), out date) && date.Year >= 1911)
                            {
                                qSReceivDate = date;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "QERECEIVDATE":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            DateTime date;
                            if (DateTime.TryParse(argument.Value.Trim(), out date) && date.Year >= 1911)
                            {
                                qEReceivDate = date;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "QSACCOUNTDATE":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            DateTime date;
                            if (DateTime.TryParse(argument.Value.Trim(), out date) && date.Year >= 1911)
                            {
                                qSAccountDate = date;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "QEACCOUNTDATE":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            DateTime date;
                            if (DateTime.TryParse(argument.Value.Trim(), out date) && date.Year >= 1911)
                            {
                                qEAccountDate = date;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "QFIELDNAME":
                        qFieldName = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "QFIELDVALUE":
                        qFieldValue = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;

                    case "OUTFIELDS":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            outFields = argument.Value.Trim().Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
                        }
                        break;

                    case "USEODS":
                        if ("Y".Equals(argument.Value))
                        {
                            isUseODS = true;
                        }
                        break;
                }
            }
            #endregion

            #region #region [Old] 土銀不使用原有部別 DepList，改用專用部別 DeptList
            //if (String.IsNullOrEmpty(receiveType)                 //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(yearId)                   //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(termId)                   //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(depId)                    //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(receiveId)                //必要參數且不可為空字串
            //    || (outFields == null || outFields.Length == 0)   //必要參數
            //    )
            //{
            //    return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            //}
            #endregion

            if (String.IsNullOrEmpty(receiveType)           //必要參數且不可為空字串
                || String.IsNullOrEmpty(yearId)             //必要參數且不可為空字串
                || String.IsNullOrEmpty(termId)             //必要參數且不可為空字串
                || depId == null                            //必要參數
                || String.IsNullOrEmpty(receiveId)          //必要參數且不可為空字串
                || (outFields == null || outFields.Length == 0) //必要參數且不可為空陣列
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            byte[] outFileContent = null;
            string errmsg = null;
            using (ExportFileHelper helper = new ExportFileHelper(null, this.TempPath))
            {
                #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
                errmsg = helper.ExportStudentReceiveView4(receiveType, yearId, termId, depId, receiveId
                    , qUpNo, qCancelStatus, qReceiveWay, qSReceivDate, qEReceivDate, qSAccountDate, qEAccountDate
                    , qFieldName, qFieldValue, outFields, out outFileContent, isUseODS);
                #endregion
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (String.IsNullOrEmpty(errmsg))
                {
                    notation = String.Format("[{0}] {1}學生繳費媒體資料成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                }
                else
                {
                    notation = String.Format("[{0}] {1}學生繳費媒體資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, errmsg);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);

                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            if (String.IsNullOrEmpty(errmsg))
            {
                data = outFileContent;
                return new Result(true, String.Empty, ErrorCode.NORMAL_STATUS, null);
                //try
                //{
                //    data = System.IO.File.ReadAllBytes(outFile);
                //    return new Result(true, String.Empty, ErrorCode.NORMAL_STATUS, null);
                //}
                //catch (Exception ex)
                //{
                //    return new Result(false, "讀取匯出資料的檔案失敗，錯誤訊息：" + ex.Message, CoreStatusCode.UNKNOWN_EXCEPTION, ex);
                //}
            }
            else
            {
                return new Result(false, errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
            }
        }

        /// <summary>
        /// 匯出 C3700007 銷帳資料 (固定格式)
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result ExportC3700007File(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
            string receiveType = null;
            string yearId = null;
            string termId = null;
            string depId = null;
            string receiveId = null;

            int? qUpNo = null;
            string qCancelStatus = null;
            string qReceiveWay = null;
            DateTime? qSReceivDate = null;
            DateTime? qEReceivDate = null;
            DateTime? qSAccountDate = null;
            DateTime? qEAccountDate = null;
            string qFieldName = null;
            string qFieldValue = null;
            bool isUseODS = false;

            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "DEPID":
                        depId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVEID":
                        receiveId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;

                    case "QUPNO":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            int value = 0;
                            if (Int32.TryParse(argument.Value.Trim(), out value) && value > -1)
                            {
                                qUpNo = value;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "QCANCELSTATUS":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            qCancelStatus = argument.Value.Trim();
                            if (CancelStatusCodeTexts.GetCodeText(qCancelStatus) == null)
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "QRECEIVEWAY":
                        qReceiveWay = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "QSRECEIVDATE":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            DateTime date;
                            if (DateTime.TryParse(argument.Value.Trim(), out date) && date.Year >= 1911)
                            {
                                qSReceivDate = date;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "QERECEIVDATE":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            DateTime date;
                            if (DateTime.TryParse(argument.Value.Trim(), out date) && date.Year >= 1911)
                            {
                                qEReceivDate = date;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "QSACCOUNTDATE":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            DateTime date;
                            if (DateTime.TryParse(argument.Value.Trim(), out date) && date.Year >= 1911)
                            {
                                qSAccountDate = date;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "QEACCOUNTDATE":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            DateTime date;
                            if (DateTime.TryParse(argument.Value.Trim(), out date) && date.Year >= 1911)
                            {
                                qEAccountDate = date;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "QFIELDNAME":
                        qFieldName = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "QFIELDVALUE":
                        qFieldValue = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;

                    case "USEODS":
                        if ("Y".Equals(argument.Value))
                        {
                            isUseODS = true;
                        }
                        break;
                }
            }
            #endregion

            #region #region [Old] 土銀不使用原有部別 DepList，改用專用部別 DeptList
            //if (String.IsNullOrEmpty(receiveType)                 //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(yearId)                   //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(termId)                   //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(depId)                    //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(receiveId)                //必要參數且不可為空字串
            //    || (outFields == null || outFields.Length == 0)   //必要參數
            //    )
            //{
            //    return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            //}
            #endregion

            if (String.IsNullOrEmpty(receiveType)           //必要參數且不可為空字串
                || String.IsNullOrEmpty(yearId)             //必要參數且不可為空字串
                || String.IsNullOrEmpty(termId)             //必要參數且不可為空字串
                || depId == null                            //必要參數
                || String.IsNullOrEmpty(receiveId)          //必要參數且不可為空字串
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            byte[] outFileContent = null;
            string errmsg = null;
            using (ExportFileHelper helper = new ExportFileHelper(null, this.TempPath))
            {
                #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
                errmsg = helper.ExportC3700007File(receiveType, yearId, termId, depId, receiveId
                    , qUpNo, qCancelStatus, qReceiveWay, qSReceivDate, qEReceivDate, qSAccountDate, qEAccountDate
                    , qFieldName, qFieldValue, out outFileContent, isUseODS);
                #endregion
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (String.IsNullOrEmpty(errmsg))
                {
                    notation = String.Format("[{0}] {1}銷帳資料(固定格式)成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                }
                else
                {
                    notation = String.Format("[{0}] {1}銷帳資料(固定格式)失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, errmsg);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);

                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            if (String.IsNullOrEmpty(errmsg))
            {
                data = outFileContent;
                return new Result(true, String.Empty, ErrorCode.NORMAL_STATUS, null);
                //try
                //{
                //    data = System.IO.File.ReadAllBytes(outFile);
                //    return new Result(true, String.Empty, ErrorCode.NORMAL_STATUS, null);
                //}
                //catch (Exception ex)
                //{
                //    return new Result(false, "讀取匯出資料的檔案失敗，錯誤訊息：" + ex.Message, CoreStatusCode.UNKNOWN_EXCEPTION, ex);
                //}
            }
            else
            {
                return new Result(false, errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
            }
        }


        /// <summary>
        /// 產生匯出資料檔
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result GenExportFileData(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
            string receiveType = null;
            string kind = null;
            string explain = null;

            string qYearId = null;
            string qTermId = null;
            string qDepId = String.Empty;   //土銀這個參數固定為空字串
            string qReceiveId = null;

            int? qUpNo = null;
            string qCancelStatus = null;
            string qReceiveWay = null;
            DateTime? qSReceivDate = null;
            DateTime? qEReceivDate = null;
            DateTime? qSAccountDate = null;
            DateTime? qEAccountDate = null;
            string qFieldName = null;
            string qFieldValue = null;
            bool isUseODS = false;

            string[] outFields = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "KIND":
                        kind = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "EXPLAIN":
                        explain = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;

                    case "QYEARID":
                        qYearId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "QTERMID":
                        qTermId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "QRECEIVEID":
                        qReceiveId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;

                    case "QUPNO":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            int value = 0;
                            if (Int32.TryParse(argument.Value.Trim(), out value) && value > -1)
                            {
                                qUpNo = value;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "QCANCELSTATUS":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            qCancelStatus = argument.Value.Trim();
                            if (CancelStatusCodeTexts.GetCodeText(qCancelStatus) == null)
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "QRECEIVEWAY":
                        qReceiveWay = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "QSRECEIVDATE":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            DateTime date;
                            if (DateTime.TryParse(argument.Value.Trim(), out date) && date.Year >= 1911)
                            {
                                qSReceivDate = date;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "QERECEIVDATE":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            DateTime date;
                            if (DateTime.TryParse(argument.Value.Trim(), out date) && date.Year >= 1911)
                            {
                                qEReceivDate = date;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "QSACCOUNTDATE":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            DateTime date;
                            if (DateTime.TryParse(argument.Value.Trim(), out date) && date.Year >= 1911)
                            {
                                qSAccountDate = date;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "QEACCOUNTDATE":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            DateTime date;
                            if (DateTime.TryParse(argument.Value.Trim(), out date) && date.Year >= 1911)
                            {
                                qEAccountDate = date;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "QFIELDNAME":
                        qFieldName = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "QFIELDVALUE":
                        qFieldValue = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;

                    case "OUTFIELDS":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            outFields = argument.Value.Trim().Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
                        }
                        break;

                    case "USEODS":
                        if ("Y".Equals(argument.Value))
                        {
                            isUseODS = true;
                        }
                        break;
                }
            }
            #endregion

            if (String.IsNullOrEmpty(receiveType)               //必要參數且不可為空字串
                || !ExportFileKindCodeTexts.IsDefine(kind)      //必要參數且符合定義值
                || (outFields == null || outFields.Length == 0) //必要參數且不可為空陣列
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            Result result = null;
            try
            {
                #region 新增待處理的匯出資料檔資料
                ExportFileEntity exportData = new ExportFileEntity();
                using (EntityFactory tsFactory = _Factory.CloneForTransaction())
                {
                    exportData.ReceiveType = receiveType;
                    exportData.Kind = kind;
                    exportData.FileName = String.Empty;
                    exportData.ExtName = String.Empty;
                    if (String.IsNullOrEmpty(explain))
                    {
                        exportData.Explain = String.Format("條件：學年={0}; 學期={1}; 費用別={2} 批號={3}; 繳款方式={4}; 資料項目={5}項", receiveType, qYearId, qTermId, qReceiveId, qReceiveWay, outFields.Length);
                    }
                    else
                    {
                        exportData.Explain = explain;
                    }
                    exportData.JobNo = 0;
                    exportData.FileContent = null;
                    exportData.Status = ExportFileStatusCodeTexts.WAIT;
                    exportData.CrtDate = DateTime.Now;
                    exportData.CrtUser = commandAsker.UserId;
                    exportData.MdyDate = null;
                    exportData.MdyUser = null;

                    int count = 0;
                    result = _Factory.Insert(exportData, out count);
                    if (result.IsSuccess)
                    {
                        if (count == 0)
                        {
                            result = new Result(false, "無待處理的匯出資料檔被新增", ErrorCode.D_DATA_EXISTS, null);
                        }
                        else
                        {
                            //取序號
                            object value = null;
                            string sql = String.Format("SELECT IDENT_CURRENT ('{0}') AS Current_Identity;", ExportFileEntity.TABLE_NAME);
                            result = tsFactory.ExecuteScalar(sql, new KeyValue[0], out value);
                            if (result.IsSuccess)
                            {
                                int sn = 0;
                                if (value != null && Int32.TryParse(value.ToString(), out sn))
                                {
                                    exportData.SN = sn;
                                }
                                else
                                {
                                    result = new Result(false, "無法取得待處理的匯出資料檔的序號", ErrorCode.D_DATA_EXISTS, null);
                                }
                            }
                        }
                    }

                    if (result.IsSuccess)
                    {
                        tsFactory.Commit();
                    }
                    else
                    {
                        tsFactory.Rollback();
                    }
                }

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}待處理的匯出資料檔資料成功 (SN={2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, exportData.SN);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}待處理的匯出資料檔資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion
                #endregion

                using (ExportFileHelper helper = new ExportFileHelper(null, this.TempPath))
                {
                    #region 執行非同步的產生匯出資料檔
                    //{
                    //    IAsyncResult asyncResult = helper.GenExportFileDataAsync(exportData.SN, receiveType, kind
                    //        , qYearId, qTermId, qReceiveId
                    //        , qUpNo, qCancelStatus, qReceiveWay, qSReceivDate, qEReceivDate, qSAccountDate, qEAccountDate
                    //        , qFieldName, qFieldValue, outFields, null);
                    //}
                    #endregion

                    #region 執行同步的產生匯出資料檔
                    {
                        #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
                        result = helper.GenExportFileData(exportData.SN, receiveType, kind
                            , qYearId, qTermId, qReceiveId
                            , qUpNo, qCancelStatus, qReceiveWay, qSReceivDate, qEReceivDate, qSAccountDate, qEAccountDate
                            , qFieldName, qFieldValue, outFields, isUseODS);
                        #endregion
                    }
                    #endregion
                }

                result = new Result(true);
            }
            catch (Exception ex)
            {
                string notation = String.Format("[{0}] {1}匯出資料檔發生例外 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.EXECUTE_TEXT, ex.Message);
                result = new Result(false, notation, CoreStatusCode.UNKNOWN_EXCEPTION, ex);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.EXECUTE, commandAsker.UserId, notation);
                }
                #endregion
            }
            finally
            {
                #region Release DBLogger
                string logErrmsg = this.ReleaseDBLogger(true);
                if (dbLogger != null)
                {
                    dbLogger.Dispose();
                    dbLogger = null;
                }
                #endregion
            }

            return result;
        }


        /// <summary>
        /// 匯出繳費失敗總表(遲繳)
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result ExportReportA(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
            string receiveType = null;
            string yearId = null;
            string termId = null;
            string depId = null;
            string receiveId = null;

            int? upNo = null;
            string receiveStatus = null;
            string reportKind = null;
            string reportName = null;
            bool isUseODS = false;

            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "DEPID":
                        depId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVEID":
                        receiveId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;

                    case "UPNO":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            int value = 0;
                            if (Int32.TryParse(argument.Value.Trim(), out value) && value > -1)
                            {
                                upNo = value;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "RECEIVESTATUS":
                        receiveStatus = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "REPORTKIND":
                        reportKind = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "REPORTNAME":
                        reportName = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "USEODS":
                        if ("Y".Equals(argument.Value))
                        {
                            isUseODS = true;
                        }
                        break;
                }
            }
            #endregion

            #region #region [Old] 土銀不使用原有部別 DepList，改用專用部別 DeptList
            //if (String.IsNullOrEmpty(receiveType)                 //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(yearId)                   //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(termId)                   //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(depId)                    //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(receiveId)                //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(reportName)               //必要參數且不可為空字串
            //    )
            //{
            //    return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            //}
            #endregion

            if (String.IsNullOrEmpty(receiveType)           //必要參數且不可為空字串
                || String.IsNullOrEmpty(yearId)             //必要參數且不可為空字串
                || String.IsNullOrEmpty(termId)             //必要參數且不可為空字串
                || depId == null                            //必要參數
                || String.IsNullOrEmpty(receiveId)          //必要參數且不可為空字串
                || String.IsNullOrEmpty(reportName)         //必要參數且不可為空字串
                || (!String.IsNullOrEmpty(receiveStatus) && receiveStatus != "0" && receiveStatus != "1")
                || (reportKind != "1" && reportKind != "2")
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            byte[] outFileContent = null;
            string errmsg = null;
            using (ExportFileHelper helper = new ExportFileHelper(null, this.TempPath))
            {
                #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
                errmsg = helper.ExportReportA(receiveType, yearId, termId, depId, receiveId
                    , upNo, receiveStatus, reportKind, reportName
                    , out outFileContent, isUseODS);
                #endregion
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (String.IsNullOrEmpty(errmsg))
                {
                    notation = String.Format("[{0}] {1}繳費銷帳總表成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                }
                else
                {
                    notation = String.Format("[{0}] {1}繳費銷帳總表失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, errmsg);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);

                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            if (String.IsNullOrEmpty(errmsg))
            {
                data = outFileContent;
                return new Result(true, String.Empty, ErrorCode.NORMAL_STATUS, null);
                //try
                //{
                //    data = System.IO.File.ReadAllBytes(outFile);
                //    return new Result(true, String.Empty, ErrorCode.NORMAL_STATUS, null);
                //}
                //catch (Exception ex)
                //{
                //    return new Result(false, "讀取匯出資料的檔案失敗，錯誤訊息：" + ex.Message, CoreStatusCode.UNKNOWN_EXCEPTION, ex);
                //}
            }
            else
            {
                return new Result(false, errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
            }
        }

        /// <summary>
        /// 匯出繳費銷帳總表
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result ExportReportA2(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
            string receiveType = null;
            string yearId = null;
            string termId = null;
            string depId = null;
            string receiveId = null;

            int? upNo = null;
            string receiveStatus = null;
            string reportKind = null;
            string reportName = null;
            bool isUseODS = false;

            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "DEPID":
                        depId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVEID":
                        receiveId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;

                    case "UPNO":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            int value = 0;
                            if (Int32.TryParse(argument.Value.Trim(), out value) && value > -1)
                            {
                                upNo = value;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "RECEIVESTATUS":
                        receiveStatus = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "REPORTKIND":
                        reportKind = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "REPORTNAME":
                        reportName = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "USEODS":
                        if ("Y".Equals(argument.Value))
                        {
                            isUseODS = true;
                        }
                        break;
                }
            }
            #endregion

            #region #region [Old] 土銀不使用原有部別 DepList，改用專用部別 DeptList
            //if (String.IsNullOrEmpty(receiveType)                 //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(yearId)                   //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(termId)                   //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(depId)                    //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(receiveId)                //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(reportName)               //必要參數且不可為空字串
            //    )
            //{
            //    return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            //}
            #endregion

            if (String.IsNullOrEmpty(receiveType)           //必要參數且不可為空字串
                || String.IsNullOrEmpty(yearId)             //必要參數且不可為空字串
                || String.IsNullOrEmpty(termId)             //必要參數且不可為空字串
                || depId == null                            //必要參數
                || String.IsNullOrEmpty(receiveId)          //必要參數且不可為空字串
                || String.IsNullOrEmpty(reportName)         //必要參數且不可為空字串
                || (!String.IsNullOrEmpty(receiveStatus) && receiveStatus != "0" && receiveStatus != "1")
                || (reportKind != "1" && reportKind != "2")
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            byte[] outFileContent = null;
            string errmsg = null;
            using (ExportFileHelper helper = new ExportFileHelper(null, this.TempPath))
            {
                #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
                errmsg = helper.ExportReportA2(receiveType, yearId, termId, depId, receiveId
                    , upNo, receiveStatus, reportKind, reportName
                    , out outFileContent, isUseODS);
                #endregion
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (String.IsNullOrEmpty(errmsg))
                {
                    notation = String.Format("[{0}] {1}繳費銷帳總表成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                }
                else
                {
                    notation = String.Format("[{0}] {1}繳費銷帳總表失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, errmsg);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);

                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            if (String.IsNullOrEmpty(errmsg))
            {
                data = outFileContent;
                return new Result(true, String.Empty, ErrorCode.NORMAL_STATUS, null);
                //try
                //{
                //    data = System.IO.File.ReadAllBytes(outFile);
                //    return new Result(true, String.Empty, ErrorCode.NORMAL_STATUS, null);
                //}
                //catch (Exception ex)
                //{
                //    return new Result(false, "讀取匯出資料的檔案失敗，錯誤訊息：" + ex.Message, CoreStatusCode.UNKNOWN_EXCEPTION, ex);
                //}
            }
            else
            {
                return new Result(false, errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
            }
        }

        /// <summary>
        /// 匯出繳費銷帳明細表 (正常、遲繳)
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result ExportReportB(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
            string receiveType = null;
            string yearId = null;
            string termId = null;
            string depId = null;
            string receiveId = null;

            int? upNo = null;
            string receiveStatus = null;
            string reportKind = null;
            string reportName = null;
            bool isUseODS = false;

            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "DEPID":
                        depId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVEID":
                        receiveId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;

                    case "UPNO":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            int value = 0;
                            if (Int32.TryParse(argument.Value.Trim(), out value) && value > -1)
                            {
                                upNo = value;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "RECEIVESTATUS":
                        receiveStatus = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "REPORTKIND":
                        reportKind = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "REPORTNAME":
                        reportName = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "USEODS":
                        if ("Y".Equals(argument.Value))
                        {
                            isUseODS = true;
                        }
                        break;
                }
            }
            #endregion

            #region #region [Old] 土銀不使用原有部別 DepList，改用專用部別 DeptList
            //if (String.IsNullOrEmpty(receiveType)                 //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(yearId)                   //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(termId)                   //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(depId)                    //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(receiveId)                //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(reportName)               //必要參數且不可為空字串
            //    )
            //{
            //    return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            //}
            #endregion

            if (String.IsNullOrEmpty(receiveType)           //必要參數且不可為空字串
                || String.IsNullOrEmpty(yearId)             //必要參數且不可為空字串
                || String.IsNullOrEmpty(termId)             //必要參數且不可為空字串
                || depId == null                            //必要參數
                || String.IsNullOrEmpty(receiveId)          //必要參數且不可為空字串
                || String.IsNullOrEmpty(reportName)         //必要參數且不可為空字串
                || (!String.IsNullOrEmpty(receiveStatus) && receiveStatus != "0" && receiveStatus != "1")
                || (reportKind != "1" && reportKind != "2")
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            byte[] outFileContent = null;
            string errmsg = null;
            using (ExportFileHelper helper = new ExportFileHelper(null, this.TempPath))
            {
                #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
                errmsg = helper.ExportReportB(receiveType, yearId, termId, depId, receiveId
                    , upNo, receiveStatus, reportKind, reportName
                    , out outFileContent, isUseODS);
                #endregion
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (String.IsNullOrEmpty(errmsg))
                {
                    notation = String.Format("[{0}] {1}繳費銷帳總表成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                }
                else
                {
                    notation = String.Format("[{0}] {1}繳費銷帳總表失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, errmsg);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);

                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            if (String.IsNullOrEmpty(errmsg))
            {
                data = outFileContent;
                return new Result(true, String.Empty, ErrorCode.NORMAL_STATUS, null);
                //try
                //{
                //    data = System.IO.File.ReadAllBytes(outFile);
                //    return new Result(true, String.Empty, ErrorCode.NORMAL_STATUS, null);
                //}
                //catch (Exception ex)
                //{
                //    return new Result(false, "讀取匯出資料的檔案失敗，錯誤訊息：" + ex.Message, CoreStatusCode.UNKNOWN_EXCEPTION, ex);
                //}
            }
            else
            {
                return new Result(false, errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
            }
        }

        /// <summary>
        /// 匯出學生繳費名冊
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result ExportReportC(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
            string receiveType = null;
            string yearId = null;
            string termId = null;
            string depId = null;
            string receiveId = null;

            int? upNo = null;
            string receiveStatus = null;
            string groupKind = null;
            string[] otherItems = null;
            int receiveItemNo = -1;
            string reportName = null;
            bool isUseODS = false;

            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "DEPID":
                        depId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVEID":
                        receiveId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;

                    case "UPNO":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            int value = 0;
                            if (Int32.TryParse(argument.Value.Trim(), out value) && value > -1)
                            {
                                upNo = value;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "RECEIVESTATUS":
                        receiveStatus = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "GROUPKIND":
                        groupKind = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "OTHERITEMS":
                        string argOtherItems = argument.Value == null ? String.Empty : argument.Value.Trim();
                        if (!String.IsNullOrEmpty(argOtherItems))
                        {
                            otherItems = argOtherItems.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
                        }
                        break;
                    case "RECEIVEITEMNO":
                        int argReceiveItemNo = 0;
                        if (Int32.TryParse(argument.Value == null ? String.Empty : argument.Value.Trim(), out argReceiveItemNo))
                        {
                            receiveItemNo = argReceiveItemNo;
                        }
                        break;
                    case "REPORTNAME":
                        reportName = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "USEODS":
                        if ("Y".Equals(argument.Value))
                        {
                            isUseODS = true;
                        }
                        break;
                }
            }
            #endregion

            #region #region [Old] 土銀不使用原有部別 DepList，改用專用部別 DeptList
            //if (String.IsNullOrEmpty(receiveType)                 //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(yearId)                   //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(termId)                   //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(depId)                    //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(receiveId)                //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(reportName)               //必要參數且不可為空字串
            //    )
            //{
            //    return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            //}
            #endregion

            if (String.IsNullOrEmpty(receiveType)           //必要參數且不可為空字串
                || String.IsNullOrEmpty(yearId)             //必要參數且不可為空字串
                || String.IsNullOrEmpty(termId)             //必要參數且不可為空字串
                || depId == null                            //必要參數
                || String.IsNullOrEmpty(receiveId)          //必要參數且不可為空字串
                || String.IsNullOrEmpty(reportName)         //必要參數且不可為空字串
                || (!String.IsNullOrEmpty(receiveStatus) && receiveStatus != "0" && receiveStatus != "1")
                || (groupKind != "1" && groupKind != "2")
                || (receiveItemNo < 1 || receiveItemNo > 40)
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            byte[] outFileContent = null;
            string errmsg = null;
            using (ExportFileHelper helper = new ExportFileHelper(null, this.TempPath))
            {
                #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
                errmsg = helper.ExportReportC(receiveType, yearId, termId, depId, receiveId
                    , upNo, receiveStatus, groupKind, otherItems, receiveItemNo, reportName
                    , out outFileContent, isUseODS);
                #endregion
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (String.IsNullOrEmpty(errmsg))
                {
                    notation = String.Format("[{0}] {1}繳費銷帳總表成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                }
                else
                {
                    notation = String.Format("[{0}] {1}繳費銷帳總表失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, errmsg);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);

                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            if (String.IsNullOrEmpty(errmsg))
            {
                data = outFileContent;
                return new Result(true, String.Empty, ErrorCode.NORMAL_STATUS, null);
            }
            else
            {
                return new Result(false, errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
            }
        }

        /// <summary>
        /// 匯出手續費統計報表
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result ExportReportD(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
            string reportType = null;
            string bankId = null;
            string schIdenty = null;
            string receiveType = null;
            DateTime? acctSDate = null;
            DateTime? acctEDate = null;
            string receiveWay = null;
            bool isUseODS = false;

            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "REPORT_TYPE":
                        reportType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "BANK_ID":
                        bankId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "SCH_IDENTY":
                        schIdenty = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVE_TYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "ACCT_SDATE":
                        {
                            string txt = argument.Value;
                            if (!String.IsNullOrEmpty(txt))
                            {
                                DateTime date;
                                if (DateTime.TryParse(txt.Trim(), out date))
                                {
                                    acctSDate = date;
                                }
                                else
                                {
                                    return new Result(false, "無效的 ACCT_SDATE 參數", CoreStatusCode.INVALID_PARAMETER, null);
                                }
                            }
                        }
                        break;
                    case "ACCT_EDATE":
                        {
                            string txt = argument.Value;
                            if (!String.IsNullOrEmpty(txt))
                            {
                                DateTime date;
                                if (DateTime.TryParse(txt.Trim(), out date))
                                {
                                    acctEDate = date;
                                }
                                else
                                {
                                    return new Result(false, "無效的 ACCT_EDATE 參數", CoreStatusCode.INVALID_PARAMETER, null);
                                }
                            }
                        }
                        break;
                    case "RECEIVE_WAY":
                        receiveWay = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "USEODS":
                        if ("Y".Equals(argument.Value))
                        {
                            isUseODS = true;
                        }
                        break;
                }
            }
            #endregion

            if (String.IsNullOrEmpty(reportType) //必要參數且必須有值
                || (String.IsNullOrEmpty(bankId) && String.IsNullOrEmpty(schIdenty) && String.IsNullOrEmpty(receiveType))   //至少一項且不可為空字串
                || acctSDate == null             //必要參數且必須有值
                || acctEDate == null             //必要參數且必須有值
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            string reportName = null;
            switch (reportType)
            {
                case "1":
                    reportName = "手續費統計報表";
                    break;
                case "2":
                    reportName = "代收單位交易資訊統計表";
                    break;
                case "3":
                    reportName = "繳款通道交易資訊統計表";
                    break;
                default:
                    return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            byte[] outFileContent = null;
            string errmsg = null;
            using (ExportFileHelper helper = new ExportFileHelper(null, this.TempPath))
            {
                #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
                switch (reportType)
                {
                    case "1":
                        errmsg = helper.ExportReportD(bankId, schIdenty, receiveType, acctSDate, acctEDate, out outFileContent, isUseODS);
                        break;
                    case "2":
                        errmsg = helper.ExportReportD2(bankId, schIdenty, receiveType, acctSDate, acctEDate, out outFileContent, isUseODS);
                        break;
                    case "3":
                        errmsg = helper.ExportReportD3(bankId, schIdenty, receiveType, receiveWay, acctSDate, acctEDate, out outFileContent, isUseODS);
                        break;
                }
                #endregion
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (String.IsNullOrEmpty(errmsg))
                {
                    notation = String.Format("[{0}] {1} {2}成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, reportName);
                }
                else
                {
                    notation = String.Format("[{0}] {1} {2}失敗 (錯誤訊息：{3})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, reportName, errmsg);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);

                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            if (String.IsNullOrEmpty(errmsg))
            {
                data = outFileContent;
                return new Result(true, String.Empty, ErrorCode.NORMAL_STATUS, null);
            }
            else
            {
                return new Result(false, errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
            }
        }

        /// <summary>
        /// 匯出繳費收費項目 (明細分析表、分類統計表)
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result ExportReportE(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
            string receiveType = null;
            string yearId = null;
            string termId = null;
            string depId = null;
            string receiveId = null;

            int? upNo = null;
            string receiveStatus = null;
            string reportKind = null;
            string reportName = null;
            bool isUseODS = false;

            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "DEPID":
                        depId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVEID":
                        receiveId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;

                    case "UPNO":
                        if (!String.IsNullOrEmpty(argument.Value))
                        {
                            int value = 0;
                            if (Int32.TryParse(argument.Value.Trim(), out value) && value > -1)
                            {
                                upNo = value;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "RECEIVESTATUS":
                        receiveStatus = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "REPORTKIND":
                        reportKind = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "REPORTNAME":
                        reportName = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "USEODS":
                        if ("Y".Equals(argument.Value))
                        {
                            isUseODS = true;
                        }
                        break;
                }
            }
            #endregion

            #region #region [Old] 土銀不使用原有部別 DepList，改用專用部別 DeptList
            //if (String.IsNullOrEmpty(receiveType)                 //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(yearId)                   //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(termId)                   //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(depId)                    //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(receiveId)                //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(reportName)               //必要參數且不可為空字串
            //    )
            //{
            //    return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            //}
            #endregion

            if (String.IsNullOrEmpty(receiveType)           //必要參數且不可為空字串
                || String.IsNullOrEmpty(yearId)             //必要參數且不可為空字串
                || String.IsNullOrEmpty(termId)             //必要參數且不可為空字串
                || depId == null                            //必要參數
                || String.IsNullOrEmpty(receiveId)          //必要參數且不可為空字串
                || String.IsNullOrEmpty(reportName)         //必要參數且不可為空字串
                || (!String.IsNullOrEmpty(receiveStatus) && receiveStatus != "0" && receiveStatus != "1")
                || (reportKind != "1" && reportKind != "2")
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            byte[] outFileContent = null;
            string errmsg = null;
            using (ExportFileHelper helper = new ExportFileHelper(null, this.TempPath))
            {
                #region [MDY:20170702] 修正應呼叫 ExportReportE 方法
                #region [Old]
                //errmsg = helper.ExportReportB(receiveType, yearId, termId, depId, receiveId
                //    , upNo, receiveStatus, reportKind, reportName, out outFileContent);
                #endregion

                #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
                errmsg = helper.ExportReportE(receiveType, yearId, termId, depId, receiveId
                    , upNo, receiveStatus, reportKind, reportName
                    , out outFileContent, isUseODS);
                #endregion
                #endregion
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (String.IsNullOrEmpty(errmsg))
                {
                    notation = String.Format("[{0}] {1}繳費銷帳總表成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
                }
                else
                {
                    notation = String.Format("[{0}] {1}繳費銷帳總表失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, errmsg);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);

                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            if (String.IsNullOrEmpty(errmsg))
            {
                data = outFileContent;
                return new Result(true, String.Empty, ErrorCode.NORMAL_STATUS, null);
                //try
                //{
                //    data = System.IO.File.ReadAllBytes(outFile);
                //    return new Result(true, String.Empty, ErrorCode.NORMAL_STATUS, null);
                //}
                //catch (Exception ex)
                //{
                //    return new Result(false, "讀取匯出資料的檔案失敗，錯誤訊息：" + ex.Message, CoreStatusCode.UNKNOWN_EXCEPTION, ex);
                //}
            }
            else
            {
                return new Result(false, errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
            }
        }


        /// <summary>
        /// 匯出查詢結果的 Excel 檔 (C3600001:查詢問題檔、C3700006:中心入帳資料查詢、S5400003:排程作業查詢)
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result ExportQueryResult(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
            string funcId = null;
            Expression where = null;
            bool isUseODS = false;

            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "FUNCID":
                        funcId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "WHERE":
                        if (!String.IsNullOrWhiteSpace(argument.Value))
                        {
                            if (!Common.TryDeXmlExplicitly<Expression>(argument.Value.Trim(), out where))
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "USEODS":
                        if ("Y".Equals(argument.Value))
                        {
                            isUseODS = true;
                        }
                        break;
                }
            }
            #endregion

            if (String.IsNullOrEmpty(funcId)            //必要參數且不可為空字串
                || where == null || where.IsEmpty()     //必要參數且不可為空字串
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            byte[] outFileContent = null;
            string errmsg = null;
            string funcName = null;
            switch (funcId)
            {
                case "C3600001":
                    #region C3600001 (查詢問題檔)
                    {
                        funcName = "查詢問題檔查詢結果";
                        using (ExportFileHelper helper = new ExportFileHelper(null, this.TempPath))
                        {
                            #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
                            errmsg = helper.ExportC3600001QueryResult(where, out outFileContent, isUseODS);
                            #endregion
                        }
                    }
                    #endregion
                    break;
                case "C3700006":
                    #region C3700006 (中心入帳資料查詢)
                    {
                        funcName = "中心入帳資料查詢結果";
                        using (ExportFileHelper helper = new ExportFileHelper(null, this.TempPath))
                        {
                            #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
                            errmsg = helper.ExportC3700006QueryResult(where, out outFileContent, isUseODS);
                            #endregion
                        }
                    }
                    #endregion
                    break;
                case "S5400003":
                    #region S5400003 (排程作業查詢)
                    {
                        funcName = "排程作業查詢";
                        using (ExportFileHelper helper = new ExportFileHelper(null, this.TempPath))
                        {
                            #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
                            errmsg = helper.ExportS5400003QueryResult(where, out outFileContent, isUseODS);
                            #endregion
                        }
                    }
                    #endregion
                    break;
                case "C3700009":
                    #region C3700009 (查詢歷史(繳費)資料)
                    {
                        funcName = "查詢歷史(繳費)資料";
                        HistoryHelper helper = new HistoryHelper(null);

                        #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
                        Result result = helper.ExportC3700009QueryResult(where, out outFileContent, isUseODS);
                        #endregion

                        if (!result.IsSuccess)
                        {
                            errmsg = result.Message;
                        }
                    }
                    #endregion
                    break;
                default:
                    return new Result(false, "無效的 funcId 的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (String.IsNullOrEmpty(errmsg))
                {
                    notation = String.Format("[{0}] 匯出{1}成功", commandAsker.FuncName, funcName);
                }
                else
                {
                    notation = String.Format("[{0}] 匯出{1}失敗 (錯誤訊息：{2})", commandAsker.FuncName, funcName, errmsg);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);

                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            if (String.IsNullOrEmpty(errmsg))
            {
                data = outFileContent;
                return new Result(true, String.Empty, ErrorCode.NORMAL_STATUS, null);
            }
            else
            {
                return new Result(false, errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
            }
        }

        /// <summary>
        /// 取得 BankPM 的 TempFile
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="data"></param>
        /// <returns></returns>
        public Result GetBankPMTempFile(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object data)
        {
            data = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string fileName = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "FILENAME":
                        fileName = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(fileName))     //必要參數且不可為空字串
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            BankpmEntity bankpm = null;
            Expression where = new Expression(BankpmEntity.Field.Filename, fileName);
            KeyValueList<OrderByEnum> orderbys = new KeyValueList<OrderByEnum>();
            orderbys.Add(BankpmEntity.Field.Cancel, OrderByEnum.Desc);
            Result result = _Factory.SelectFirst<BankpmEntity>(where, orderbys, out bankpm);
            if (result.IsSuccess)
            {
                if (bankpm == null)
                {
                    result = new Result(false, "資料不存在", ErrorCode.D_DATA_NOT_FOUND, null);
                }
                else
                {
                    data = bankpm.Tempfile ?? new byte[0];
                }
            }
            return result;
        }

        #region [Old] 20150605 取消前擋後，改回後踢前
        ///// <summary>
        ///// 強迫登出指定帳號
        ///// </summary>
        ///// <param name="commandAsker"></param>
        ///// <param name="arguments"></param>
        ///// <returns></returns>
        //public Result ForcedLogoutUser(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments)
        //{
        //    if (arguments == null || arguments.Count == 0)
        //    {
        //        return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
        //    }

        //    #region 取得執行參數
        //    string logonUnit = null;
        //    string logonId = null;
        //    string logonQual = null;
        //    foreach (KeyValue<string> argument in arguments)
        //    {
        //        string argName = argument.Key.ToUpper();
        //        switch (argName)
        //        {
        //            case "LOGONUNIT":
        //                logonUnit = argument.Value == null ? String.Empty : argument.Value.Trim();
        //                break;
        //            case "LOGONID":
        //                logonId = argument.Value == null ? String.Empty : argument.Value.Trim();
        //                break;
        //            case "LOGONQUAL":
        //                logonQual = argument.Value == null ? String.Empty : argument.Value.Trim();
        //                if (!UserQualCodeTexts.IsDefine(logonQual))
        //                {
        //                    logonQual = null;
        //                }
        //                break;
        //        }
        //    }
        //    if (String.IsNullOrEmpty(logonUnit)         //必要參數且不可為空字串
        //        || String.IsNullOrEmpty(logonId)        //必要參數且不可為空字串
        //        || String.IsNullOrEmpty(logonQual)      //必要參數且不可為空字串
        //        )
        //    {
        //        return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
        //    }
        //    #endregion

        //    #region 取得初始化的資料庫日誌記錄器
        //    DBLogger dbLogger = this.InitialDBLogger(commandAsker);
        //    #endregion

        //    LogonHelper helper = new LogonHelper(_Factory);
        //    Result result = helper.UserForcedLogout(commandAsker, logonUnit, logonId, logonQual);

        //    #region 儲存日誌資料並釋放資料庫日誌記錄器
        //    if (dbLogger != null)
        //    {
        //        string notation = null;
        //        if (result.IsSuccess)
        //        {
        //            notation = String.Format("[{0}] 強迫登出使用者成功 (LogonUnit：{1}; LogonId：{2}; LogonQual：{3})", commandAsker.FuncName, logonUnit, logonId, logonQual);
        //        }
        //        else
        //        {
        //            notation = String.Format("[{0}] 強迫登出使用者資料失敗 (LogonUnit：{1}; LogonId：{2}; LogonQual：{3}) ; 錯誤訊息：{4}", commandAsker.FuncName, logonUnit, logonId, logonQual, result.Message);
        //        }
        //        dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
        //        string logErrmsg = this.ReleaseDBLogger(true);
        //        dbLogger.Dispose();
        //        dbLogger = null;
        //    }
        //    #endregion

        //    return result;
        //}
        #endregion

        #region [Old] 土銀沒有
        ///// <summary>
        ///// 呼叫 N162 查詢電文
        ///// </summary>
        ///// <param name="commandAsker"></param>
        ///// <param name="arguments"></param>
        ///// <returns></returns>
        //public Result CallN162Request(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments)
        //{
        //    if (arguments == null || arguments.Count == 0)
        //    {
        //        return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
        //    }

        //    #region 取得執行參數
        //    string cusidn = null;
        //    foreach (KeyValue<string> argument in arguments)
        //    {
        //        string argName = argument.Key.ToUpper();
        //        switch (argName)
        //        {
        //            case "CUSIDN":
        //                cusidn = argument.Value == null ? String.Empty : argument.Value.Trim();
        //                break;
        //        }
        //    }
        //    if (String.IsNullOrEmpty(cusidn))        //必要參數且不可為空字串
        //    {
        //        return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
        //    }
        //    #endregion

        //    #region 發送 N162 電文
        //    N162Response n162 = null;
        //    try
        //    {
        //        EAIRequest request = null;
        //        EAIResponse response = null;
        //        EAIHelper helper = new EAIHelper();
        //        int code = helper.SendN162(cusidn, out request, out response);

        //        this.WriteLog("SendN162", "RequestXml = {0}\r\nResponseXml = {1}", request.RequestXmlString, response == null ? "null" : response.ResponseXmlString);

        //        if (code == 0 && response is N162Response)
        //        {
        //            n162 = response as N162Response;
        //            if (!n162.IsLoadOK)
        //            {
        //                string errmsg = String.Format("解析 N162 回覆電文失敗，錯誤訊息：{0}", n162.GetLoadErrorMessage());
        //                this.WriteLog("SendN162", errmsg);
        //                return new Result(false, errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
        //            }
        //        }
        //        else if (response is EAIStatus)
        //        {
        //            EAIStatus status = response as EAIStatus;
        //            string errmsg = String.Format("發送 N162 失敗，錯誤代碼：{0}，錯誤訊息：{1}", status.StatusCode, status.StatusDesc);
        //            this.WriteLog("SendN162", errmsg);
        //            return new Result(false, errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
        //        }
        //        else
        //        {
        //            string errmsg = String.Format("發送 N162 失敗，傳回代碼：{0}", code);
        //            this.WriteLog("SendN162", errmsg);
        //            return new Result(false, errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
        //        }
        //    }
        //    catch (Exception ex)
        //    {
        //        string errmsg = String.Format("發送 N162 發生例外，錯誤訊息：{0}", ex.Message);
        //        this.WriteLog("SendN162", errmsg);
        //        return new Result(false, errmsg, CoreStatusCode.UNKNOWN_ERROR, ex);
        //    }
        //    #endregion

        //    #region Save Data
        //    {
        //        ImportEAIDataHelper helper = new ImportEAIDataHelper();
        //        Result result = null;

        //        #region Import N162 Data
        //        try
        //        {
        //            result = helper.ImportN162Data(n162, DateTime.Now);
        //        }
        //        catch (Exception ex)
        //        {
        //            string errmsg = String.Format("匯入 N162 回覆資料發生例外，錯誤訊息：{0}", ex.Message);
        //            this.WriteLog("SendN162", errmsg);
        //            result = new Result(false, errmsg, CoreStatusCode.UNKNOWN_ERROR, ex);
        //        }
        //        #endregion

        //        #region EAIData
        //        try
        //        {
        //            Result result2 = helper.SaveEDIData(n162, result.IsSuccess);
        //            if (!result2.IsSuccess)
        //            {
        //                string errmsg = String.Concat("N162 日誌寫入失敗，" + result2.Message);
        //                this.WriteLog("SendN162", errmsg);
        //            }
        //        }
        //        catch (Exception ex)
        //        {
        //            string errmsg = String.Concat("N162 日誌寫入發生例外，" + ex.Message);
        //            this.WriteLog("SendN162", errmsg);
        //        }
        //        #endregion

        //        return result;
        //    }
        //    #endregion
        //}
        #endregion

        /// <summary>
        /// 呼叫 D00I71 電文
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <returns></returns>
        public Result CallD00I71Request(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string appno = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "APPNO":
                        appno = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(appno))        //必要參數且不可為空字串
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region [Old]
            //#region 取得本日 EAI 的 Key
            //string eaiKey = null;
            //{
            //    ConfigEntity config = null;
            //    Expression where = new Expression(ConfigEntity.Field.ConfigKey, ConfigKeyCodeTexts.EDI_DAILY_KEY);
            //    Result result = _Factory.SelectFirst<ConfigEntity>(where, null, out config);
            //    if (!result.IsSuccess)
            //    {
            //        return new Result(false, "讀取本日 EAI Key 失敗，" + result.Message, result.Code, result.Exception);
            //    }

            //    if (config != null && !String.IsNullOrEmpty(config.ConfigValue))
            //    {
            //        string[] values = config.ConfigValue.Trim().Split(new char[] { '=' }, StringSplitOptions.None);
            //        if (values.Length == 2 && values[0].Trim() == DateTime.Now.ToString("yyyyMMdd"))
            //        {
            //            eaiKey = values[1].Trim();
            //        }
            //    }
            //    if (String.IsNullOrEmpty(eaiKey))
            //    {
            //        return new Result(false, "本日 EAI 尚未換 Key，請稍後再試", result.Code, result.Exception);
            //    }
            //}
            //#endregion
            #endregion

            #region 取得 EAIHelper
            #region [MDY:20181007] 使用新的 EAIHelper (一律取自專案組態的參數)
            #region [OLD]
            //EAIHelper helper = new EAIHelper(true);
            #endregion

            EAIHelper helper = new EAIHelper();
            #endregion

            {
                if (!helper.IsEAIArgsReady())
                {
                    return new Result(false, "EAI 的執行參數未設定好", CoreStatusCode.UNKNOWN_ERROR, null);
                }
                else
                {
                    if (!helper.IsEAIDailyKeyReady())
                    {
                        if (!helper.ChangeDailyKey())
                        {
                            return new Result(false, "換 Key 失敗，錯誤訊息：" + helper.ErrMsg, CoreStatusCode.UNKNOWN_ERROR, null);
                        }
                    }
                }
            }
            #endregion

            #region 發送 D00I71
            KeyValueList<string> datas = null;

            #region [Old]
            //EAIHelper helper = new EAIHelper(pwsd: eaiKey);
            #endregion

            if (helper.SendD00I71(appno, out datas))
            {
                rtnData = datas;
                return new Result(true);
            }
            else
            {
                return new Result(false, helper.ErrMsg, CoreStatusCode.UNKNOWN_ERROR, null);
            }
            #endregion
        }

        /// <summary>
        /// 更新多筆 StudentReturn
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <returns></returns>
        public Result UpdateStudentReturnDatas(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            string dataNOs = string.Empty;
            #region 參數處理
            //StudentReturnEntity data = new StudentReturnEntity();
            //List<StudentReturnEntity> datas = new List<StudentReturnEntity>();
            string srNo = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string[] args = argument.Value.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);

                long datano = 0;
                //long.TryParse(args[0], out datano);
                //data.DataNo = datano;
                //data.SrNo = args[1];
                //datas.Add(data);
                //dataNOs = string.Format("{0},", data.DataNo) + dataNOs;
                srNo = args[1]; //退費清單批號其實只需傳一筆，所以這裡取最後一筆
                if (long.TryParse(args[0], out datano))
                {
                    dataNOs = string.Format("{0},", datano) + dataNOs;
                }
                else
                {
                    return new Result(false, "參數錯誤", CoreStatusCode.INVALID_PARAMETER, null);
                }
            }
            #endregion
            if (dataNOs.Length > 0)
            {
                dataNOs = dataNOs.Substring(0, dataNOs.Length - 1);
            }
            else
            {
                return new Result(false, "參數錯誤", CoreStatusCode.INVALID_PARAMETER, null);
            }
            if (String.IsNullOrEmpty(srNo))
            {
                return new Result(false, "參數錯誤", CoreStatusCode.INVALID_PARAMETER, null);
            }

            Result result = new Result();
            int count = 0;

            StringBuilder updateSql = new StringBuilder();
            updateSql
                .AppendFormat("UPDATE {0} Set SR_No=@SR_NO WHERE ", StudentReturnEntity.TABLE_NAME).AppendLine()
                .AppendFormat(" Data_No in ({0}) ", dataNOs).AppendLine();

            KeyValueList updParameters = new KeyValueList(1);
            //updParameters.Add("@SR_NO", data.SrNo);
            updParameters.Add("@SR_NO", srNo);

            result = _Factory.ExecuteNonQuery(updateSql.ToString(), updParameters.ToArray(), out count);
            if (result.IsSuccess)
            {
                rtnData = ("更新成功");
            }
            else
            {
                rtnData = result.Message;
            }


            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}資料成功 (UnitID：{2} ; UserID：{3})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, commandAsker.UnitId, commandAsker.UserId);
                }
                else
                {
                    notation = String.Format("[{0}] {1}資料失敗 (UnitID：{2} ; UserID：{3} ; 錯誤訊息：{4})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, commandAsker.UnitId, commandAsker.UserId, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 自收銷帳 (多筆銷帳)
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <returns></returns>
        public Result UpdateCancelDatas(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string kind = null;
            string content = null;
            string receive_type = "";
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "KIND":
                        kind = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "CONTENT":
                        content = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVETYPE":
                        receive_type = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                }
            }
            if ((kind != "1" && kind != "2")
                || String.IsNullOrEmpty(content)    //必要參數且不可為空字串
                || (kind == "2" && string.IsNullOrEmpty(receive_type))      //必要參數且不可為空字串
            )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            using (EntityFactory factory = new EntityFactory())
            {
                #region 取得所屬商家代號
                bool isBankManager = false;
                List<string> receiveTypes = new List<string>();
                {
                    if (commandAsker.IsBankUser)
                    {
                        #region 行員
                        if (commandAsker.IsBankManager)
                        {
                            isBankManager = true;
                        }
                        else
                        {
                            string sql = "SELECT Receive_Type FROM School_Rtype WHERE Bank_Id = @BankId";
                            KeyValue[] parameters = new KeyValue[] { new KeyValue("@BankId", commandAsker.UnitId) };
                            DataTable dt = null;
                            Result result = factory.GetDataTable(sql, parameters, 0, 0, out dt);

                            #region 新增日誌資料
                            if (dbLogger != null)
                            {
                                string notation = null;
                                if (result.IsSuccess)
                                {
                                    notation = String.Format("[{0}] {1}所屬商家代號資料成功 (Bank_Id={2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, commandAsker.UnitId);
                                }
                                else
                                {
                                    notation = String.Format("[{0}] {1}所屬權商家代號資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                                }
                                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                            }
                            #endregion

                            if (result.IsSuccess)
                            {
                                if (dt != null && dt.Rows.Count > 0)
                                {
                                    foreach (DataRow row in dt.Rows)
                                    {
                                        receiveTypes.Add(row["Receive_Type"].ToString());
                                    }
                                }
                                dt.Dispose();
                                dt = null;
                            }
                            else
                            {
                                return result;
                            }
                        }
                        #endregion
                    }
                    else if (commandAsker.IsSchoolUser)
                    {
                        #region 學校
                        string sql = "SELECT Receive_Type FROM School_Rtype WHERE Sch_Identy = @SchIdenty";
                        KeyValue[] parameters = new KeyValue[] { new KeyValue("@SchIdenty", commandAsker.UnitId) };
                        DataTable dt = null;
                        Result result = factory.GetDataTable(sql, parameters, 0, 0, out dt);

                        #region 新增日誌資料
                        if (dbLogger != null)
                        {
                            string notation = null;
                            if (result.IsSuccess)
                            {
                                notation = String.Format("[{0}] {1}所屬商家代號資料成功 (Sch_Identy={2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, commandAsker.UnitId);
                            }
                            else
                            {
                                notation = String.Format("[{0}] {1}所屬商家代號資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
                            }
                            dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
                        }
                        #endregion

                        List<string> schReceiveTypes = new List<string>();
                        if (result.IsSuccess)
                        {
                            if (dt != null && dt.Rows.Count > 0)
                            {
                                foreach (DataRow row in dt.Rows)
                                {
                                    schReceiveTypes.Add(row["Receive_Type"].ToString());
                                }
                            }
                            dt.Dispose();
                            dt = null;
                        }
                        else
                        {
                            return result;
                        }

                        if (commandAsker.RoleType == RoleTypeCodeTexts.USER)
                        {
                            UsersEntity user = null;
                            this.GetUserByCommandAsker(dbLogger, commandAsker, out user);
                            string[] myReceiveTypes = user.URt.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
                            foreach (string myReceiveType in myReceiveTypes)
                            {
                                if (schReceiveTypes.Contains(myReceiveType))
                                {
                                    receiveTypes.Add(myReceiveType);
                                }
                            }
                        }
                        else
                        {
                            receiveTypes.AddRange(schReceiveTypes);
                        }
                        #endregion
                    }
                    else
                    {
                        return new Result(false, "無權限執行此功能", ErrorCode.S_NO_AUTHORIZE_FOR_FUNCTION, null);
                    }
                }
                #endregion

                List<string> logs = new List<string>();
                CancelHelper helper1 = new CancelHelper();
                CancelNoHelper helper2 = new CancelNoHelper();
                using (System.IO.StringReader reader = new System.IO.StringReader(content))
                {
                    int no = 0;
                    string line = null;
                    while ((line = reader.ReadLine()) != null)
                    {
                        no++;

                        #region 拆解資料行欄位
                        if (line.Length != 39)
                        {
                            if (kind == "1")
                            {
                                logs.Add("資料長度不正確");
                            }
                            else
                            {
                                logs.Add(String.Format("第 {0} 筆資料長度不正確", no));
                            }
                            continue;
                        }

                        string cancelNo = line.Substring(0, 16).Trim();
                        string amountText = line.Substring(16, 9).Trim();
                        DateTime? receiveDate = DataFormat.ConvertDateText(line.Substring(25, 7));
                        DateTime? accountDate = DataFormat.ConvertDateText(line.Substring(32, 7));

                        if (!Common.IsNumber(cancelNo, 14, 16))
                        {
                            if (kind == "1")
                            {
                                logs.Add("虛擬帳號不正確");
                            }
                            else
                            {
                                logs.Add(String.Format("第 {0} 筆資料的虛擬帳號 ({1}) 不正確", no, cancelNo));
                            }
                            continue;
                        }
                        string receiveType = cancelNo.Substring(0, 4);
                        CancelNoHelper.Module module = helper2.GetModuleByReceiveType(receiveType);
                        if (module == null)
                        {
                            if (kind == "1")
                            {
                                logs.Add("無對應商家代號");
                            }
                            else
                            {
                                logs.Add(String.Format("第 {0} 筆資料的虛擬帳號 ({1}) 不正確 (無對應商家代號)", no, cancelNo));
                            }
                            continue;
                        }

                        #region [MDY:20160507] 學校自收整批上傳 (kind=2) 時要檢查上傳的檔案只能是上傳時指定的 RECEIVETYPE
                        if (kind == "2" && receiveType != receive_type)
                        {
                            logs.Add(String.Format("第 {0} 筆資料的虛擬帳號 ({1}) 不屬於指定的商家代號 ({2})", no, cancelNo, receive_type));
                            continue;
                        }
                        #endregion

                        if (!isBankManager && !receiveTypes.Contains(receiveType))
                        {
                            if (kind == "1")
                            {
                                logs.Add("未授權該商家代號");
                            }
                            else
                            {
                                logs.Add(String.Format("第 {0} 筆資料的虛擬帳號 ({1}) 不正確 (未授權該商家代號)", no, cancelNo));
                            }
                            continue;
                        }

                        decimal amount = 0;
                        if (!Decimal.TryParse(amountText, out amount) || amount < 0)
                        {
                            if (kind == "1")
                            {
                                logs.Add("金額不正確");
                            }
                            else
                            {
                                logs.Add(String.Format("第 {0} 筆資料 (虛擬帳號 = {1}) 的金額不正確", no, cancelNo));
                            }
                            continue;
                        }
                        if (receiveDate == null)
                        {
                            if (kind == "1")
                            {
                                logs.Add("代收日不正確");
                            }
                            else
                            {
                                logs.Add(String.Format("第 {0} 筆資料 (虛擬帳號 = {1}) 的代收日不正確", no, cancelNo));
                            }
                            continue;
                        }
                        if (accountDate == null)
                        {
                            if (kind == "1")
                            {
                                logs.Add("入帳日不正確");
                            }
                            else
                            {
                                logs.Add(String.Format("第 {0} 筆資料 (虛擬帳號 = {1}) 的入帳日不正確", no, cancelNo));
                            }
                            continue;
                        }
                        #endregion

                        string errmsg = helper1.CancelDataByCANL(factory, cancelNo, amount, receiveDate.Value, accountDate.Value);

                        #region 新增日誌資料
                        if (dbLogger != null)
                        {
                            string notation = null;
                            if (String.IsNullOrEmpty(errmsg))
                            {
                                notation = String.Format("[{0}] {1}銷帳欄位資料成功 (Cancel_No={2}, Receive_Amount={3})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, cancelNo, amount);
                            }
                            else
                            {
                                notation = String.Format("[{0}] {1}銷帳欄位資料失敗 (Cancel_No={2}, Receive_Amount={3}，錯誤訊息：{4})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, cancelNo, amount, errmsg);
                            }

                            dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.UPDATE, commandAsker.UserId, notation);

                            #region [MDY:20160507] 額外以指定的商家代號紀錄，以便提供 by 商家代號查詢
                            if (!String.IsNullOrEmpty(receive_type))
                            {
                                //只有 kind=2 才會傳 receive_type 並限制一定是 receive_type 的資料
                                //如果 kind=1 也要記，就不用判斷 receive_type
                                //為了避免被其他紀錄查詢功能找到此筆紀錄，特別將 Function_Id 串上 "_LOG"
                                dbLogger.AppendLog(commandAsker.UserQual, receiveType, commandAsker.FuncId + "_LOG", LogTypeCodeTexts.UPDATE, commandAsker.UserId, notation);
                            }
                            #endregion
                        }
                        #endregion

                        if (String.IsNullOrEmpty(errmsg))
                        {
                            if (kind == "1")
                            {
                                logs.Add("銷帳成功");
                            }
                            else
                            {
                                logs.Add(String.Format("第 {0} 筆資料 (虛擬帳號 = {1}) 銷帳成功", no, cancelNo));
                            }
                        }
                        else
                        {
                            if (kind == "1")
                            {
                                logs.Add("銷帳失敗，" + errmsg);
                            }
                            else
                            {
                                logs.Add(String.Format("第 {0} 筆資料 (虛擬帳號 = {1}) 銷帳失敗，錯誤訊息：{2}", no, cancelNo, errmsg));
                            }
                        }
                    }
                }
                rtnData = logs.ToArray();
            }

            #region Release DBLogger
            if (dbLogger != null)
            {
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return new Result(true);
            #region [Old]
            //rtnData = null;
            //List<string> rtnMsg = new List<string>();

            //#region 檢查參數
            //if (arguments == null || arguments.Count == 0)
            //{
            //    return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            //}
            //#endregion

            //#region 取得初始化的資料庫日誌記錄器
            //DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            //#endregion

            //int iSuccess = 0;
            //int iFail = 0;
            //Result result = new Result();

            //#region 參數處理
            //List<StudentReceiveEntity> datas = new List<StudentReceiveEntity>();
            //foreach (KeyValue<string> argument in arguments)
            //{
            //    string[] args = argument.Value.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
            //    if (args.Length != 5)
            //    {
            //        iFail++;
            //        continue;
            //    }

            //    StudentReceiveEntity data = new StudentReceiveEntity();
            //    data.ReceiveType = args[0];
            //    data.CancelNo = args[1];
            //    data.ReceiveAmount = Convert.ToDecimal(args[2]);
            //    data.ReceiveDate = args[3];
            //    data.AccountDate = args[4];
            //    datas.Add(data);
            //}
            //#endregion

            ////依傳入的資料做銷帳
            //foreach (StudentReceiveEntity data in datas)
            //{
            //    //用代收類別+銷帳編號去查 student_receive
            //    Expression where = new Expression();
            //    where.And(StudentReceiveEntity.Field.ReceiveType, data.ReceiveType);
            //    where.And(StudentReceiveEntity.Field.CancelNo, data.CancelNo);

            //    #region 排序條件
            //    KeyValueList<OrderByEnum> orderbys = new KeyValueList<OrderByEnum>(1);
            //    orderbys.Add(StudentReceiveEntity.Field.ReceiveAmount, OrderByEnum.Asc);
            //    #endregion

            //    StudentReceiveEntity[] allCancelData = null;
            //    result = _Factory.SelectAll<StudentReceiveEntity>(where, orderbys, out allCancelData);
            //    if (!result.IsSuccess)
            //    {
            //        #region DB發生錯誤
            //        if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
            //        {
            //            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
            //        }
            //        else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
            //        {
            //            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
            //        }

            //        rtnMsg.Add(string.Format("銷帳編號: {0}, 結果: 失敗(DB發生錯誤)", data.CancelNo));
            //        iFail++;
            //        break;
            //        #endregion
            //    }

            //    #region 找不到要銷帳的資料 失敗筆數 + 1
            //    if (allCancelData == null || allCancelData.Length == 0)
            //    {
            //        rtnMsg.Add(string.Format("銷帳編號: {0}, 結果: 失敗(查無該銷帳編號)", data.CancelNo));
            //        iFail++;
            //        break;
            //    }
            //    #endregion

            //    //檢查receive_way是否為null或空值 及 比對金額
            //    foreach (StudentReceiveEntity cancelData in allCancelData)
            //    {
            //        #region 銷帳編號存在但金額不合則傳回金額不合
            //        if (cancelData.ReceiveAmount != data.ReceiveAmount)
            //        {
            //            rtnMsg.Add(string.Format("銷帳編號: {0}, 結果: 失敗(金額不合)", data.CancelNo));
            //            iFail++;
            //            break;
            //        }
            //        #endregion

            //        #region 銷編與金額都對但已有代收管道資料，則傳回已繳費
            //        if (!string.IsNullOrEmpty(cancelData.ReceiveWay))
            //        {
            //            rtnMsg.Add(string.Format("銷帳編號: {0}, 結果: 失敗(已繳費)", data.CancelNo));
            //            iFail++;
            //            break;
            //        }
            //        #endregion

            //        if (string.IsNullOrEmpty(cancelData.ReceiveWay)
            //            && cancelData.ReceiveAmount == data.ReceiveAmount)
            //        {
            //            #region 找到銷帳資料 成功筆數 + 1
            //            cancelData.CancelFlag = "9";
            //            cancelData.ReceiveDate = data.ReceiveDate;
            //            cancelData.AccountDate = data.AccountDate;
            //            cancelData.ReceiveTime = DateTime.Now.ToString("hhmmss");
            //            cancelData.CancelDate = DateTime.Today.ToString("yyyyMMdd");
            //            if (commandAsker.IsBankUser)
            //            {
            //                cancelData.ReceiveWay = "S";  //(如果登入者是行員就是S不然就是C)
            //                cancelData.ReceiveBankId = commandAsker.UnitId;
            //            }
            //            else
            //            {
            //                cancelData.ReceiveWay = "C";  //(如果登入者是行員就是S不然就是C)
            //                cancelData.ReceiveBankId = string.Empty;
            //            }

            //            int count = 0;
            //            result = _Factory.Update(cancelData, out count);
            //            if (result.IsSuccess)
            //            {
            //                if (count < 1)
            //                {
            //                    rtnMsg.Add(string.Format("銷帳編號: {0}, 結果: 失敗(資料更新失敗)", data.CancelNo));
            //                    iFail++;
            //                    break;
            //                }
            //                else
            //                {
            //                    rtnMsg.Add(string.Format("銷帳編號: {0}, 結果: 成功", data.CancelNo));
            //                    iSuccess++;
            //                    break;
            //                }
            //            }
            //            else
            //            {
            //                rtnMsg.Add(string.Format("銷帳編號: {0}, 結果: 失敗(執行資料更新失敗)", data.CancelNo));
            //                iFail++;
            //                break;
            //            }
            //            #endregion
            //        }
            //    }
            //}

            //string msg = string.Format("銷帳{0}筆。成功{1}筆，失敗{2}筆。", iSuccess + iFail, iSuccess, iFail);
            //rtnMsg.Add(msg);
            //rtnData = rtnMsg.ToArray();

            //#region 儲存日誌資料並釋放資料庫日誌記錄器
            //if (dbLogger != null)
            //{
            //    string notation = null;
            //    if (result.IsSuccess)
            //    {
            //        notation = String.Format("[{0}] {1}資料成功 (UnitID：{2} ; UserID：{3})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE, commandAsker.UnitId, commandAsker.UserId);
            //    }
            //    else
            //    {
            //        notation = String.Format("[{0}] {1}資料失敗 (UnitID：{2} ; UserID：{3} ; 錯誤訊息：{4})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE, commandAsker.UnitId, commandAsker.UserId, result.Message);
            //    }
            //    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
            //    string logErrmsg = this.ReleaseDBLogger(true);
            //    dbLogger.Dispose();
            //    dbLogger = null;
            //}
            //#endregion

            //return result;
            #endregion
        }

        #region [MDY:20160125] 整批刪除學生資料
        /// <summary>
        /// 整批刪除學生資料 (勾選的資料)
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <returns></returns>
        public Result DeleteStudentReceiveByPKeys(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數 (將參數轉成 pkeys，所有參數都對才繼續處理)
            List<StudentReceiveView2> dataPKeys = new List<StudentReceiveView2>(arguments.Count);   //借用 StudentReceiveView2 類別存放 PKey
            {
                char[] separator = new char[] { ',' };
                int no = 0;
                foreach (KeyValue<string> argument in arguments)
                {
                    no++;
                    string[] args = argument.Value.Split(separator);
                    Int32 oldSeq = 0;
                    if (args.Length != 7 || !Int32.TryParse(args[6], out oldSeq) || oldSeq < 0)
                    {
                        string errmsg = String.Format("第{0}筆資料參數不正確 ({1})", no, argument);
                        return new Result(false, errmsg, CoreStatusCode.INVALID_PARAMETER, null);
                    }

                    StudentReceiveView2 dataPKey = new StudentReceiveView2();
                    dataPKey.ReceiveType = args[0];
                    dataPKey.YearId = args[1];
                    dataPKey.TermId = args[2];
                    dataPKey.DepId = args[3];
                    dataPKey.ReceiveId = args[4];
                    dataPKey.StuId = args[5];
                    dataPKey.OldSeq = oldSeq;
                    if ((String.IsNullOrWhiteSpace(dataPKey.ReceiveType) || dataPKey.ReceiveType.Length != 4)
                        || (String.IsNullOrWhiteSpace(dataPKey.YearId) || dataPKey.YearId.Length != 3)
                        || (String.IsNullOrWhiteSpace(dataPKey.TermId) || dataPKey.TermId.Length != 1)
                        || (String.IsNullOrWhiteSpace(dataPKey.ReceiveId) || dataPKey.ReceiveId.Length > 2))
                    {
                        string errmsg = String.Format("第{0}筆資料參數不正確 ({1})", no, argument);
                        return new Result(false, errmsg, CoreStatusCode.INVALID_PARAMETER, null);
                    }
                    dataPKeys.Add(dataPKey);
                }
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除資料 (不使用交易，一律回傳交易成功，回傳資料為成功與失敗筆數訊息)
            {
                int okCount = 0;
                int failCount = 0;
                List<string> failStuIds = new List<string>();

                foreach (StudentReceiveView2 dataPKey in dataPKeys)
                {
                    int count = 0;

                    string sql = String.Format(@"DELETE [{0}]
 WHERE [Receive_Type] = @RECEIVE_TYPE AND [Year_Id] = @YEAR_ID AND [Term_Id] = @TERM_ID AND [Dep_Id] = @DEP_ID AND [Receive_Id] = @RECEIVE_ID
   AND [Stu_Id] = @STU_ID AND [Old_Seq] = @OLD_SEQ
   AND ([Receive_Date] IS NULL OR [Receive_Date] = '') AND ([Receive_Way] IS NULL OR [Receive_Way] = '')", StudentReceiveEntity.TABLE_NAME);

                    KeyValue[] parameters = new KeyValue[7] {
                        new KeyValue("@RECEIVE_TYPE", dataPKey.ReceiveType),
                        new KeyValue("@YEAR_ID", dataPKey.YearId),
                        new KeyValue("@TERM_ID", dataPKey.TermId),
                        new KeyValue("@DEP_ID", dataPKey.DepId),
                        new KeyValue("@RECEIVE_ID", dataPKey.ReceiveId),
                        new KeyValue("@STU_ID", dataPKey.StuId),
                        new KeyValue("@OLD_SEQ", dataPKey.OldSeq)
                    };

                    Result result = _Factory.ExecuteNonQuery(sql, parameters, out count);
                    if (result.IsSuccess)
                    {
                        if (count < 1)
                        {
                            failCount++;
                            failStuIds.Add(dataPKey.StuId);
                        }
                        else
                        {
                            okCount++;
                        }
                    }
                    else
                    {
                        failCount++;
                        failStuIds.Add(dataPKey.StuId);
                    }
                }

                StringBuilder msg = new StringBuilder();
                msg.AppendFormat("刪除{0}筆資料，成功{1}筆，失敗{2}筆。", dataPKeys.Count, okCount, failCount);
                if (failStuIds.Count > 0)
                {
                    msg.AppendLine().Append("失敗學號：").Append(String.Join(",", failStuIds.ToArray()));
                }

                rtnData = msg.ToString();

                #region 儲存日誌資料並釋放資料庫日誌記錄器
                if (dbLogger != null)
                {
                    string notation = String.Format("[{0}] {1}資料成功 (UnitID：{2}; UserID：{3}; rtnData：{4})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, commandAsker.UnitId, commandAsker.UserId, rtnData);
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);

                    string logErrmsg = this.ReleaseDBLogger(true);
                    dbLogger.Dispose();
                    dbLogger = null;
                }
                #endregion

                return new Result(true);
            }
            #endregion
        }

        /// <summary>
        /// 整批刪除學生資料 (條件的資料)
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <returns></returns>
        public Result DeleteStudentReceiveByWhere(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            string depId = null;
            string receiveId = null;
            string cancelNo = null;
            string stuId = null;
            int? upNo = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "DEPID":
                        depId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVEID":
                        receiveId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;

                    case "CANCELNO":
                        cancelNo = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "STUID":
                        stuId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "UPNO":
                        {
                            int value = 0;
                            if (!Int32.TryParse(argument.Value, out value) || value < 0)
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                            upNo = value;
                        }
                        break;
                }
            }

            #region #region [Old] 土銀不使用原有部別 DepList，改用專用部別 DeptList
            //if (String.IsNullOrEmpty(receiveType)                 //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(yearId)                   //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(termId)                   //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(depId)                    //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(receiveId)                //必要參數且不可為空字串
            //    || (String.IsNullOrEmpty(cancelNo) && String.IsNullOrEmpty(stuId) && upNo == null)  //至少要一個有值
            //    )
            //{
            //    return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            //}
            #endregion

            if (String.IsNullOrEmpty(receiveType)           //必要參數且不可為空字串
                || String.IsNullOrEmpty(yearId)             //必要參數且不可為空字串
                || String.IsNullOrEmpty(termId)             //必要參數且不可為空字串
                || depId == null                            //必要參數
                || String.IsNullOrEmpty(receiveId)          //必要參數且不可為空字串
                || (String.IsNullOrEmpty(cancelNo) && String.IsNullOrEmpty(stuId) && upNo == null)  //至少要一個有值
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 刪除資料
            {
                KeyValueList parameters = new KeyValueList(8);
                parameters.Add("@RECEIVE_TYPE", receiveType);
                parameters.Add("@YEAR_ID", yearId);
                parameters.Add("@TERM_ID", termId);
                parameters.Add("@DEP_ID", depId);
                parameters.Add("@RECEIVE_ID", receiveId);

                StringBuilder andSql = new StringBuilder();
                if (!String.IsNullOrEmpty(cancelNo))
                {
                    andSql.AppendFormat(" AND [Cancel_No] = @CANCEL_NO");
                    parameters.Add("@CANCEL_NO", cancelNo);
                }
                if (!String.IsNullOrEmpty(stuId))
                {
                    andSql.AppendFormat(" AND [Stu_Id] = @STU_ID");
                    parameters.Add("@STU_ID", stuId);
                }
                if (upNo != null)
                {
                    andSql.AppendFormat(" AND [Up_No] = @UP_NO");
                    parameters.Add("@UP_NO", upNo.Value);
                }
                if (andSql.Length == 0)
                {
                    //缺少條件，就讓他沒有資料可以刪除
                    andSql.Append(" AND 1 = 2");
                }

                string sql = String.Format(@"DELETE [{0}] 
 WHERE [Receive_Type] = @RECEIVE_TYPE AND [Year_Id] = @YEAR_ID AND [Term_Id] = @TERM_ID AND [Dep_Id] = @DEP_ID AND [Receive_Id] = @RECEIVE_ID
   AND ([Receive_Date] IS NULL OR [Receive_Date] = '') AND ([Receive_Way] IS NULL OR [Receive_Way] = '')
   {1}", StudentReceiveEntity.TABLE_NAME, andSql.ToString());

                int count = 0;
                Result result = _Factory.ExecuteNonQuery(sql, parameters, out count);
                if (result.IsSuccess && count < 1)
                {
                    result = new Result(false, "無資料被刪除", ErrorCode.D_DATA_NOT_FOUND, null);
                }

                rtnData = string.Format("整批刪除資料{0}，共刪除{1}筆資料 (刪除條件：商家代號={2}、學年={3}、學期={4}、代收費用別={5}、虛擬帳號={6}、學號={7}、批號={8})",
                    (result.IsSuccess ? "成功" : "失敗"), count,
                    receiveType, yearId, termId, receiveId, cancelNo, stuId, (upNo == null ? String.Empty : upNo.Value.ToString()));

                #region 儲存日誌資料並釋放資料庫日誌記錄器
                if (dbLogger != null)
                {
                    string whereKey = string.Format("ReceiveType={0}, YearId={1}, TermId={2}, DptId={3}, ReceiveId={4}, CancelNo={5}, StuId={6}, UpNo={7}",
                        receiveType, yearId, termId, depId, receiveId, cancelNo, stuId, (upNo == null ? String.Empty : upNo.Value.ToString()));
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        notation = String.Format("[{0}] {1}資料成功 (UnitID：{2}; UserID：{3}; 刪除條件：{4}; 刪除筆數：{5})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, commandAsker.UnitId, commandAsker.UserId, whereKey, count);
                    }
                    else
                    {
                        notation = String.Format("[{0}] {1}資料失敗 (UnitID：{2}; UserID：{3}; 刪除條件：{4}; 錯誤訊息：{5})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, commandAsker.UnitId, commandAsker.UserId, whereKey, result.Message);
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);

                    string logErrmsg = this.ReleaseDBLogger(true);
                    dbLogger.Dispose();
                    dbLogger = null;
                }
                #endregion

                return result;
            }
            #endregion
        }
        #endregion

        /// <summary>
        /// 整批刪除銷帳問題資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <returns></returns>
        public Result DeleteProblemListDatas(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region [Old]
            //int iSuccess = 0;
            //int iFail = 0;
            //string failMessage = string.Empty;

            //Result result = new Result();
            //List<ProblemListEntity> datas = new List<ProblemListEntity>();
            //foreach (KeyValue<string> argument in arguments)
            //{
            //    string[] args = argument.Value.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
            //    if (args.Length != 1)
            //    {
            //        iFail++;
            //        failMessage += "參數錯誤: ";
            //        for (int i = 0; i < args.Length; i++)
            //        {
            //            failMessage += args[i];
            //        }
            //        failMessage += ", ";
            //        continue;
            //    }

            //    ProblemListEntity data = new ProblemListEntity();
            //    int iId = 0;
            //    if(int.TryParse(args[0], out iId))
            //    {
            //        data.Id = iId;
            //        //data.ReceiveType = string.Empty;
            //        //data.CancelNo = string.Empty;
            //        datas.Add(data);
            //    }
            //}

            //foreach (ProblemListEntity data in datas)
            //{
            //    int count = 0;

            //    StringBuilder deleteSql = new StringBuilder();
            //    deleteSql
            //        .AppendFormat("DELETE {0} WHERE ", ProblemListEntity.TABLE_NAME).AppendLine()
            //        .AppendFormat(" Id=@ID ").AppendLine();

            //    KeyValueList delParameters = new KeyValueList();
            //    delParameters.Add("@ID", data.Id);

            //    result = _Factory.ExecuteNonQuery(deleteSql.ToString(), delParameters.ToArray(), out count);
            //    if (result.IsSuccess)
            //    {
            //        if (count < 1)
            //        {
            //            iFail++;
            //            failMessage += string.Format("問題檔編號: {0}, ", data.Id);
            //        }
            //        else
            //        {
            //            iSuccess++;
            //        }
            //    }
            //    else
            //    {
            //        iFail++;
            //        failMessage += string.Format("問題檔編號: {0}, ", data.Id);
            //    }
            //}
            #endregion

            #region 處理參數值
            List<int> pkeys = new List<int>(arguments.Count);
            List<string> cancelNos = new List<string>(arguments.Count);
            foreach (KeyValue<string> argument in arguments)
            {
                int pkey = 0;
                string cancelNo = null;
                string[] args = argument.Value == null ? null : argument.Value.Trim().Split(',');
                if (args != null && args.Length == 2 && Int32.TryParse(args[0].Trim(), out pkey) && pkey > 0 && (cancelNo = args[1].Trim()).Length > 0)
                {
                    pkeys.Add(pkey);
                    cancelNos.Add(cancelNo);
                }
                else
                {
                    return new Result(false, String.Format("參數錯誤，{0} 不是合法的參數值", argument), CoreStatusCode.INVALID_PARAMETER, null);
                }
            }
            #endregion

            //因為是多筆資料刪除，只要參數正確了，一律算成功
            Result result = new Result(true);
            StringBuilder log = new StringBuilder();
            int okCount = 0;

            string sql = String.Format("DELETE {0} WHERE Id=@ID", ProblemListEntity.TABLE_NAME);
            for (int idx = 0; idx < pkeys.Count; idx++)
            {
                int pkey = pkeys[idx];
                KeyValue[] parameters = new KeyValue[] { new KeyValue("@ID", pkey) };

                int count = 0;
                Result result2 = _Factory.ExecuteNonQuery(sql, parameters, out count);
                if (result2.IsSuccess)
                {
                    if (count < 1)
                    {
                        log.AppendFormat("虛擬帳號：{0} (問題檔編號：{1}) 資料不存在", cancelNos[idx], pkey).AppendLine();
                    }
                    else
                    {
                        okCount++;
                        log.AppendFormat("虛擬帳號：{0} 刪除成功", cancelNos[idx], pkey).AppendLine();
                    }
                }
                else
                {
                    log.AppendFormat("虛擬帳號：{0} (問題檔編號：{1}) 刪除失敗，{2}", cancelNos[idx], pkey, result2.Message).AppendLine();
                }
            }

            string summary = string.Format("刪除{0}筆資料，成功{1}筆。", pkeys.Count, okCount);
            rtnData = summary + "\r\n" + log.ToString();

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}資料完成 ({2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, rtnData);
                }
                else
                {
                    notation = String.Format("[{0}] {1}資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.DELETE_TEXT, result.Message);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 新增學期資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <returns></returns>
        public Result InsertTermListDatas(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string type = null;  //1: 由 學年新增 第一學期、第二學期，2: 由 代收類別新增 第一學期、第二學期
            string insertKey = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "TYPE":
                        type = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "INSERTKEY":
                        insertKey = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(type) || String.IsNullOrEmpty(insertKey)) //必要參數且不可為空字串
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            Result result = null;
            int count = 0;
            
            EntityFactory tsFactory = _Factory.CloneForTransaction();
            try
            {
                switch (type)
                {
                    case "1":
                        #region 由 學年新增 第一學期、第二學期
                        {
                            //step 1. delete 原本的 Term_List 資料
                            StringBuilder delSql = new StringBuilder();
                            delSql
                                .AppendFormat("DELETE {0} WHERE ", TermListEntity.TABLE_NAME).AppendLine()
                                .AppendFormat("Year_Id=@YEAR_ID and Term_Id in ('1','2') ").AppendLine();

                            KeyValueList delParameters = new KeyValueList(1);
                            delParameters.Add("@YEAR_ID", insertKey);
                            result = _Factory.ExecuteNonQuery(delSql.ToString(), delParameters.ToArray(), out count);

                            if (result.IsSuccess)
                            {
                                //step 2. insert Term_List 此學年所有代收類別 第一學期、第二學期
                                #region [MDY:202203XX] 2022擴充案 英文資料啟用、學期英文名稱 欄位
                                #region [OLD]
                                //StringBuilder insSql = new StringBuilder();
                                //insSql
                                //    .AppendFormat("insert into {0} ", TermListEntity.TABLE_NAME).AppendLine()
                                //    .AppendFormat("(Receive_Type, Year_Id, Term_Id, Term_Name, status, crt_date, crt_user) ").AppendLine()
                                //    .AppendFormat("select Receive_Type, @YEAR_ID, '1', '第一學期', '0', @CRTDATE, @CRTUSER from School_Rtype ").AppendLine()
                                //    .AppendFormat("insert into {0} ", TermListEntity.TABLE_NAME).AppendLine()
                                //    .AppendFormat("(Receive_Type, Year_Id, Term_Id, Term_Name, status, crt_date, crt_user) ").AppendLine()
                                //    .AppendFormat("select Receive_Type, @YEAR_ID, '2', '第二學期', '0', @CRTDATE, @CRTUSER from School_Rtype ").AppendLine();

                                //KeyValueList insParameters = new KeyValueList(3);
                                //insParameters.Add("@YEAR_ID", insertKey);
                                //insParameters.Add("@CRTDATE", DateTime.Now);
                                //insParameters.Add("@CRTUSER", commandAsker.UserId);
                                //result = _Factory.ExecuteNonQuery(insSql.ToString(), insParameters.ToArray(), out count);
                                #endregion

                                string insSql = $@"
INSERT INTO {TermListEntity.TABLE_NAME}
( {TermListEntity.Field.ReceiveType}, {TermListEntity.Field.YearId}, {TermListEntity.Field.TermId}
, {TermListEntity.Field.TermName}, {TermListEntity.Field.Status}, {TermListEntity.Field.CrtDate}, {TermListEntity.Field.CrtUser}
, {TermListEntity.Field.TermEName})
SELECT {SchoolRTypeEntity.Field.ReceiveType}, @YEAR_ID, '1' AS {TermListEntity.Field.TermId}
, '第一學期', '0', @CRTDATE, @CRTUSER
, (CASE WHEN {SchoolRTypeEntity.Field.EngEnabled} = 'Y' THEN 'First Semester' ELSE NULL END)
  FROM  {SchoolRTypeEntity.TABLE_NAME}
UNION
SELECT {SchoolRTypeEntity.Field.ReceiveType}, @YEAR_ID, '2' AS {TermListEntity.Field.TermId}
, '第二學期', '0', @CRTDATE, @CRTUSER
, (CASE WHEN {SchoolRTypeEntity.Field.EngEnabled} = 'Y' THEN 'Second Semester' ELSE NULL END)
  FROM  {SchoolRTypeEntity.TABLE_NAME}
 ORDER BY {TermListEntity.Field.ReceiveType}, {TermListEntity.Field.TermId}
".Trim();
                                KeyValueList insParameters = new KeyValueList(3);
                                insParameters.Add("@YEAR_ID", insertKey);
                                insParameters.Add("@CRTDATE", DateTime.Now);
                                insParameters.Add("@CRTUSER", commandAsker.UserId);
                                result = _Factory.ExecuteNonQuery(insSql, insParameters, out count);
                                #endregion
                            }
                        }
                        #endregion
                        break;
                    case "2":
                        #region 由 代收類別新增 第一學期、第二學期
                        {
                            //step 1. delete 原本的 Term_List 資料
                            StringBuilder delSql = new StringBuilder();
                            delSql
                                .AppendFormat("DELETE {0} WHERE ", TermListEntity.TABLE_NAME).AppendLine()
                                .AppendFormat("Receive_Type=@RECEIVE_TYPE and Term_Id in ('1','2') ").AppendLine();

                            KeyValueList delParameters = new KeyValueList(1);
                            delParameters.Add("@RECEIVE_TYPE", insertKey);
                            result = _Factory.ExecuteNonQuery(delSql.ToString(), delParameters.ToArray(), out count);

                            if (result.IsSuccess)
                            {
                                //step 2. insert Term_List 此代收類別所有學年 第一學期、第二學期
                                #region [MDY:202203XX] 2022擴充案 英文資料啟用、學期英文名稱 欄位
                                #region [OLD]
                                //StringBuilder insSql = new StringBuilder();
                                //insSql
                                //    .AppendFormat("insert into {0} ", TermListEntity.TABLE_NAME).AppendLine()
                                //    .AppendFormat("(Receive_Type, Year_Id, Term_Id, Term_Name, status, crt_date, crt_user) ").AppendLine()
                                //    .AppendFormat("select @RECEIVE_TYPE, Year_Id, '1', '第一學期', '0', @CRTDATE, @CRTUSER from Year_List ").AppendLine()
                                //    .AppendFormat("insert into {0} ", TermListEntity.TABLE_NAME).AppendLine()
                                //    .AppendFormat("(Receive_Type, Year_Id, Term_Id, Term_Name, status, crt_date, crt_user) ").AppendLine()
                                //    .AppendFormat("select @RECEIVE_TYPE, Year_Id, '2', '第二學期', '0', @CRTDATE, @CRTUSER from Year_List ").AppendLine();

                                //KeyValueList insParameters = new KeyValueList(3);
                                //insParameters.Add("@RECEIVE_TYPE", insertKey);
                                //insParameters.Add("@CRTDATE", DateTime.Now);
                                //insParameters.Add("@CRTUSER", commandAsker.UserId);
                                //result = _Factory.ExecuteNonQuery(insSql.ToString(), insParameters.ToArray(), out count);
                                #endregion

                                string insSql = $@"
INSERT INTO {TermListEntity.TABLE_NAME}
( {TermListEntity.Field.ReceiveType}, {TermListEntity.Field.YearId}, {TermListEntity.Field.TermId}
, {TermListEntity.Field.TermName}, {TermListEntity.Field.Status}, {TermListEntity.Field.CrtDate}, {TermListEntity.Field.CrtUser}
, {TermListEntity.Field.TermEName})
SELECT @RECEIVE_TYPE, {YearListEntity.Field.YearId}, '1' AS {TermListEntity.Field.TermId}
, '第一學期', '0', @CRTDATE, @CRTUSER
, (SELECT (CASE WHEN {SchoolRTypeEntity.Field.EngEnabled} = 'Y' THEN 'First Semester' ELSE NULL END) FROM {SchoolRTypeEntity.TABLE_NAME} WHERE {SchoolRTypeEntity.Field.ReceiveType} = @RECEIVE_TYPE)
  FROM  {YearListEntity.TABLE_NAME}
UNION
SELECT @RECEIVE_TYPE, {YearListEntity.Field.YearId}, '2' AS {TermListEntity.Field.TermId}
, '第二學期', '0', @CRTDATE, @CRTUSER
, (SELECT (CASE WHEN {SchoolRTypeEntity.Field.EngEnabled} = 'Y' THEN 'Second Semester' ELSE NULL END) FROM {SchoolRTypeEntity.TABLE_NAME} WHERE {SchoolRTypeEntity.Field.ReceiveType} = @RECEIVE_TYPE)
  FROM  {YearListEntity.TABLE_NAME}
 ORDER BY {YearListEntity.Field.YearId}, {TermListEntity.Field.TermId}
".Trim();
                                KeyValueList insParameters = new KeyValueList(3);
                                insParameters.Add("@RECEIVE_TYPE", insertKey);
                                insParameters.Add("@CRTDATE", DateTime.Now);
                                insParameters.Add("@CRTUSER", commandAsker.UserId);
                                result = _Factory.ExecuteNonQuery(insSql, insParameters, out count);
                                #endregion
                            }
                        }
                        #endregion
                        break;
                }
            }
            catch (Exception ex)
            {
                string notation = String.Format("[{0}] {1}新增資料發生例外 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, ex.Message);
                result = new Result(false, notation, CoreStatusCode.UNKNOWN_EXCEPTION, ex);

                #region 新增日誌資料
                if (dbLogger != null)
                {
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                }
                #endregion
            }
            finally
            {
                if (tsFactory != null)
                {
                    if (result.IsSuccess)
                    {
                        tsFactory.Commit();
                    }
                    else
                    {
                        tsFactory.Rollback();
                    }
                    tsFactory.Dispose();
                    tsFactory = null;
                }

                #region Release DBLogger
                if (!result.IsSuccess)
                {
                    if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_INSERT_DATA_EXCEPTION, result.Exception);
                    }
                    else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
                    {
                        result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_INSERT_DATA_FAILURE, result.Exception);
                    }
                }
                string logErrmsg = this.ReleaseDBLogger(true);
                if (dbLogger != null)
                {
                    dbLogger.Dispose();
                    dbLogger = null;
                }
                #endregion
            }

            return result;
        }

        /// <summary>
        /// 清除虛擬帳號
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <returns></returns>
        public Result ClearCancelNo(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            string depId = null;
            string receiveId = null;

            string byKind = null;
            string byValue = null;

            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "DEPID":
                        depId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVEID":
                        receiveId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;

                    case "BYKIND":
                        byKind = argument.Value == null ? null : argument.Value.Trim().ToUpper();
                        switch (byKind)
                        {
                            case "BYUPNO":
                            case "BYSTUID":
                            case "BYCANCELNO":
                                break;
                            default:
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                        }
                        break;
                    case "BYVALUE":
                        byValue = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                }
            }

            #region #region [Old] 土銀不使用原有部別 DepList，改用專用部別 DeptList
            //if (String.IsNullOrEmpty(receiveType)                 //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(yearId)                   //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(termId)                   //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(depId)                    //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(receiveId)                //必要參數且不可為空字串
            //    || String.IsNullOrEmpty(reportName)               //必要參數且不可為空字串
            //    )
            //{
            //    return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            //}
            #endregion

            if (String.IsNullOrEmpty(receiveType)           //必要參數且不可為空字串
                || String.IsNullOrEmpty(yearId)             //必要參數且不可為空字串
                || String.IsNullOrEmpty(termId)             //必要參數且不可為空字串
                || depId == null                            //必要參數
                || String.IsNullOrEmpty(receiveId)          //必要參數且不可為空字串
                || String.IsNullOrEmpty(byKind)             //必要參數且不可為空字串
                || String.IsNullOrEmpty(byValue)            //必要參數且不可為空字串
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            int count = 0;
            string sqlLog = null;
            CancelNoHelper helper = new CancelNoHelper();
            Result result = helper.ClearCancelNo(_Factory, receiveType, yearId, termId, depId, receiveId, byKind, byValue, out count, out sqlLog);

            if (result.IsSuccess)
            {
                rtnData = string.Format("清除虛擬帳號成功，共{0}筆。", count);
            }
            else
            {
                rtnData = string.Format("清除虛擬帳號失敗，錯誤訊息：{0}", result.Message);
            }

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}資料成功 (ReceiveType：{2} ; YearId：{3} ; TermId：{4} ; DepId：{5} ; ReceiveId：{6} ; ByKind：{7} ; ByValue：{8} ; 筆數：{9})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, receiveType, yearId, termId, depId, receiveId, byKind, byValue, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}資料失敗 (ReceiveType：{2} ; YearId：{3} ; TermId：{4} ; DepId：{5} ; ReceiveId：{6} ; ByKind：{7} ; ByValue：{8} ; 錯誤訊息：{9})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, receiveType, yearId, termId, depId, receiveId, byKind, byValue, result.Message);
                }
                notation += "\r\n" + sqlLog;
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.UPDATE, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;
        }


        /// <summary>
        /// 上傳中國信託繳費單資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="rtnData"></param>
        /// <returns></returns>
        public Result ImportQueueCTCBFile(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
            string receiveType = null;
            DateTime? payDueDate = null;
            byte[] fileContent = null;
            string fileType = null;

            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "PAYDUEDATE":
                        {
                            DateTime date;
                            string txt = argument.Value == null ? String.Empty : argument.Value.Trim();
                            if (DateTime.TryParse(txt, out date))
                            {
                                payDueDate = date;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "FILECONTENT":
                        {
                            string txt = argument.Value == null ? String.Empty : argument.Value.Trim();
                            if (!Fuju.Common.TryDeXmlExplicitly<byte[]>(txt, out fileContent))
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "FILETYPE":
                        fileType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                }
            }

            if (String.IsNullOrEmpty(receiveType)                   //必要參數且不可為空字串
                || payDueDate == null                               //必要參數且不可為空字串
                || fileContent == null || fileContent.Length == 0   //必要參數且不可為空陣列
                || fileType == null                                 //必要參數且不可為空字串
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            int count = 0;
            string dataInfo = null;
            Result result = null;
            using (ImportFileHelper helper = new ImportFileHelper())
            {
                result = helper.ImportQueueCTCBFile(receiveType, payDueDate.Value, fileContent, commandAsker.UserId, out dataInfo, fileType);
            }

            rtnData = dataInfo;

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}資料成功 (ReceiveType：{2} ; PayDueDate：{3:yyyy/MM/dd})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, receiveType, payDueDate.Value, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}資料失敗 (ReceiveType：{2} ; PayDueDate：{3:yyyy/MM/dd} ; 錯誤訊息：{4})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, receiveType, payDueDate.Value, result.Message);
                }
                notation += "\r\n" + dataInfo;
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;
        }

        #region [MDY:20210301] 上傳中國信託繳費單資料 For Debug
        /// <summary>
        /// 上傳中國信託繳費單資料 For Debug
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="rtnData"></param>
        /// <returns></returns>
        public Result ImportQueueCTCBFileForDebug(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            #region [MDY:20190906] (2019擴充案) 匯出檔增加 ODS 格式
            string receiveType = null;
            DateTime? payDueDate = null;
            byte[] fileContent = null;
            string fileType = null;
            string clientTaskId = null;

            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "PAYDUEDATE":
                        {
                            DateTime date;
                            string txt = argument.Value == null ? String.Empty : argument.Value.Trim();
                            if (DateTime.TryParse(txt, out date))
                            {
                                payDueDate = date;
                            }
                            else
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "FILECONTENT":
                        {
                            string txt = argument.Value == null ? String.Empty : argument.Value.Trim();
                            if (!Fuju.Common.TryDeXmlExplicitly<byte[]>(txt, out fileContent))
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "FILETYPE":
                        fileType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "CLIENTTASKID":
                        clientTaskId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                }
            }

            if (String.IsNullOrEmpty(receiveType)                   //必要參數且不可為空字串
                || payDueDate == null                               //必要參數且不可為空字串
                || fileContent == null || fileContent.Length == 0   //必要參數且不可為空陣列
                || fileType == null                                 //必要參數且不可為空字串
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 除錯日誌紀錄器
            DebugLogger debugger = DebugLogger.Create(commandAsker, clientTaskId);
            debugger.AppendFormat("[{0:yyyy/MM/dd HH:mm:ss}] 開始執行 {1}-{2}", DateTime.Now, commandAsker.FuncId, commandAsker.FuncName).AppendLine(false);
            #endregion

            System.Diagnostics.Stopwatch watchA = new System.Diagnostics.Stopwatch();
            watchA.Start();

            int count = 0;
            string dataInfo = null;
            Result result = null;

            debugger.AppendFormat("[{0:yyyy/MM/dd HH:mm:ss}] 開始執行 ImportQueueCTCBFile() ", DateTime.Now);
            System.Diagnostics.Stopwatch watchB = new System.Diagnostics.Stopwatch();
            watchB.Start();
            using (ImportFileHelper helper = new ImportFileHelper())
            {
                result = helper.ImportQueueCTCBFile(receiveType, payDueDate.Value, fileContent, commandAsker.UserId, out dataInfo, fileType);
            }
            watchB.Stop();
            debugger.AppendFormat("[{0:yyyy/MM/dd HH:mm:ss}] 結束執行 ImportQueueCTCBFile() ，共耗時 {1} 秒", DateTime.Now, (watchB.ElapsedMilliseconds / 1000M));

            rtnData = dataInfo;

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (result.IsSuccess)
                {
                    notation = String.Format("[{0}] {1}資料成功 (ReceiveType：{2} ; PayDueDate：{3:yyyy/MM/dd})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, receiveType, payDueDate.Value, count);
                }
                else
                {
                    notation = String.Format("[{0}] {1}資料失敗 (ReceiveType：{2} ; PayDueDate：{3:yyyy/MM/dd} ; 錯誤訊息：{4})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, receiveType, payDueDate.Value, result.Message);
                }
                notation += "\r\n" + dataInfo;
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            watchA.Stop();
            debugger.AppendFormat("[{0:yyyy/MM/dd HH:mm:ss}] 結束執行 {1}-{2} ，共耗時 {2} 秒", DateTime.Now, commandAsker.FuncId, commandAsker.FuncName, (watchA.ElapsedMilliseconds / 1000M)).AppendLine(false).Flush();
            debugger.Dispose();
            debugger = null;

            return result;
        }
        #endregion

        public Result ImportD00I70File(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            #region 檢查參數
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得執行參數
            string receiveType = null;
            //DateTime? payDueDate = null;
            byte[] fileContent = null;

            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "FILECONTENT":
                        {
                            string txt = argument.Value == null ? String.Empty : argument.Value.Trim();
                            if (!Fuju.Common.TryDeXmlExplicitly<byte[]>(txt, out fileContent))
                            {
                                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                }
            }

            if (String.IsNullOrEmpty(receiveType)                   //必要參數且不可為空字串
                || fileContent == null || fileContent.Length == 0   //必要參數且不可為空陣列
                )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            int dataCount = 0;
            string dataInfo = null;
            D00I70 helper = new D00I70();
            bool rc = helper.ImportD00I70File(receiveType, fileContent, out dataCount, out dataInfo);

            rtnData = dataInfo;

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string notation = null;
                if (rc)
                {
                    notation = String.Format("[{0}] {1}資料成功 (ReceiveType：{2} ; 資料筆數：{3})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, receiveType, dataCount);
                }
                else
                {
                    notation = String.Format("[{0}] {1}資料失敗 (ReceiveType：{2} ; 錯誤訊息：{3})", commandAsker.FuncName, LogTypeCodeTexts.INSERT_TEXT, receiveType, dataInfo);
                }

                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.INSERT, commandAsker.UserId, notation);
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            //為了傳回 rtnData，處理完資料一律傳回 new Result(true)
            return new Result(true);
        }

        /// <summary>
        /// 處理流程資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <returns></returns>
        public Result ProcessFlowData(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments)
        {
            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string guid = null;
            string processKind = null;
            string processMemo = null;
            string processUserQual = null;
            string processUnitId = null;
            string processUserId = null;
            string processUserName = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "GUID":
                        guid = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "PROCESSKIND":
                        processKind = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "PROCESSMEMO":
                        processMemo = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "PROCESSUSERQUAL":
                        processUserQual = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "PROCESSUNITID":
                        processUnitId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "PROCESSUSERID":
                        processUserId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "PROCESSUSERNAME":
                        processUserName = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(guid)        //必要參數且不可為空字串
                || ProcessKindCodeTexts.GetCodeText(processKind) == null    //必要參數且必須符合 ProcessKindCodeTexts 定義
                || UserQualCodeTexts.GetCodeText(processUserQual) == null   //必要參數且必須符合 UserQualCodeTexts 定義
                || String.IsNullOrEmpty(processUnitId)   //必要參數且不可為空字串
                || String.IsNullOrEmpty(processUserId)   //必要參數且不可為空字串
            )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 處理流程資料
            FlowDataHelper helper = new FlowDataHelper();
            Result result = helper.ProcessFlowData(dbLogger, guid, processKind, processMemo, processUserQual, processUnitId, processUserId, processUserName);
            #endregion

            #region 儲存日誌資料並釋放資料庫日誌記錄器
            if (dbLogger != null)
            {
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;
        }

        /// <summary>
        /// 取得 C3700009 所有選項陣列
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="rtnData"></param>
        /// <returns></returns>
        public Result GetC3700009AllOptions(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            string depId = null;
            string receiveId = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "YEARID":
                        yearId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "TERMID":
                        termId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "DEPID":
                        depId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                    case "RECEIVEID":
                        receiveId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        break;
                }
            }
            if (String.IsNullOrEmpty(receiveType)   //必要參數且不可為空字串
                || yearId == null     //必要參數
                || termId == null     //必要參數
                || depId == null      //必要參數
                || receiveId == null  //必要參數
            )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            if (String.IsNullOrEmpty(yearId) || String.IsNullOrEmpty(termId) || String.IsNullOrEmpty(receiveId))
            {
                rtnData = new KeyValue<string>[] {
                    new KeyValue<string>("DEPT", null),
                    new KeyValue<string>("COLLEGE", null),
                    new KeyValue<string>("MAJOR", null),
                    new KeyValue<string>("CLASS", null),
                    new KeyValue<string>("UPNO", null)
                };
                return new Result(true);
            }
            #endregion

            #region [Old] 取得初始化的資料庫日誌記錄器 (暫時不要記錄這類查詢 Log)
            //string queryKey = String.Format("ReceiveType={0}; YearId={1}; TermId={2}; DepId={3}; ReceiveId={4}", receiveType, yearId, termId, depId, receiveId);
            //DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 取得 Where Sql
            string whereSql = null;
            KeyValueList parameters = null;
            {
                Expression where = new Expression(HistoryEntity.Field.ReceiveType, receiveType)
                    .And(HistoryEntity.Field.YearId, yearId)
                    .And(HistoryEntity.Field.TermId, termId)
                    .And(HistoryEntity.Field.DepId, depId)
                    .And(HistoryEntity.Field.ReceiveId, receiveId);
                IDataParameter[] whereParameters = null;
                if (! _Factory.GenWhereCommandTextParameters(where, out whereSql, out whereParameters))
                {
                    return new Result(false, "無法產生查詢條件 SQL 指令", CoreStatusCode.UNKNOWN_ERROR, null);
                }
                parameters = new KeyValueList(whereParameters.Length);
                foreach(IDataParameter whereParameter in whereParameters)
                {
                    parameters.Add(whereParameter.ParameterName, whereParameter.Value);
                }
            }
            #endregion

            Result result = new Result(true);

            #region 部別
            string deptXml = null;
            if (result.IsSuccess)
            {
                DataTable dt = null;
                string sql = String.Format("SELECT DISTINCT [{0}], ISNULL([{1}], '') AS [{1}] FROM [{2}] WHERE [{0}] IS NOT NULL AND [{0}] <> '' AND {3}", HistoryEntity.Field.DeptId, HistoryEntity.Field.DeptName, HistoryEntity.TABLE_NAME, whereSql);
                result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
                if (result.IsSuccess)
                {
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        CodeTextList datas = new CodeTextList(dt.Rows.Count);
                        foreach (DataRow row in dt.Rows)
                        {
                            datas.Add(row[0].ToString(), row[1].ToString());
                        }
                        if (!Common.TryToXmlExplicitly<CodeText[]>(datas.ToArray(), out deptXml))
                        {
                            result = new Result(false, "部別選項資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                    }
                }

                #region [Old] 新增日誌資料 (暫時不要記錄這類查詢 Log)
                //if (dbLogger != null)
                //{
                //    string notation = null;
                //    if (result.IsSuccess)
                //    {
                //        notation = String.Format("[{0}] {1}部別選項資料成功 ({2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, queryKey);
                //    }
                //    else
                //    {
                //        notation = String.Format("[{0}] {1}部別選項資料失敗 ({2} ; 錯誤訊息：{3})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, queryKey, result.Message);
                //    }
                //    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //}
                #endregion
            }
            #endregion

            #region 院別
            string collegeXml = null;
            if (result.IsSuccess)
            {
                DataTable dt = null;
                string sql = String.Format("SELECT DISTINCT [{0}], ISNULL([{1}], '') AS [{1}] FROM [{2}] WHERE [{0}] IS NOT NULL AND [{0}] <> '' AND {3}", HistoryEntity.Field.CollegeId, HistoryEntity.Field.CollegeName, HistoryEntity.TABLE_NAME, whereSql);
                result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
                if (result.IsSuccess)
                {
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        CodeTextList datas = new CodeTextList(dt.Rows.Count);
                        foreach (DataRow row in dt.Rows)
                        {
                            datas.Add(row[0].ToString(), row[1].ToString());
                        }
                        if (!Common.TryToXmlExplicitly<CodeText[]>(datas.ToArray(), out collegeXml))
                        {
                            result = new Result(false, "院別選項資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                    }
                }

                #region [Old] 新增日誌資料 (暫時不要記錄這類查詢 Log)
                //if (dbLogger != null)
                //{
                //    string notation = null;
                //    if (result.IsSuccess)
                //    {
                //        notation = String.Format("[{0}] {1}院別選項資料成功 ({2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, queryKey);
                //    }
                //    else
                //    {
                //        notation = String.Format("[{0}] {1}院別選項資料失敗 ({2} 錯誤訊息：{3})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, queryKey, result.Message);
                //    }
                //    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //}
                #endregion
            }
            #endregion

            #region 科系
            string majorXml = null;
            if (result.IsSuccess)
            {
                DataTable dt = null;
                string sql = String.Format("SELECT DISTINCT [{0}], ISNULL([{1}], '') AS [{1}] FROM [{2}] WHERE [{0}] IS NOT NULL AND [{0}] <> '' AND {3}", HistoryEntity.Field.MajorId, HistoryEntity.Field.MajorName, HistoryEntity.TABLE_NAME, whereSql);
                result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
                if (result.IsSuccess)
                {
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        CodeTextList datas = new CodeTextList(dt.Rows.Count);
                        foreach (DataRow row in dt.Rows)
                        {
                            datas.Add(row[0].ToString(), row[1].ToString());
                        }
                        if (!Common.TryToXmlExplicitly<CodeText[]>(datas.ToArray(), out majorXml))
                        {
                            result = new Result(false, "科系選項資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                    }
                }

                #region [Old] 新增日誌資料 (暫時不要記錄這類查詢 Log)
                //if (dbLogger != null)
                //{
                //    string notation = null;
                //    if (result.IsSuccess)
                //    {
                //        notation = String.Format("[{0}] {1}科系選項資料成功 ({2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, queryKey);
                //    }
                //    else
                //    {
                //        notation = String.Format("[{0}] {1}科系選項資料失敗 ({2} ; 錯誤訊息：{3})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, queryKey, result.Message);
                //    }
                //    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //}
                #endregion
            }
            #endregion

            #region 班別
            string classXml = null;
            if (result.IsSuccess)
            {
                DataTable dt = null;
                string sql = String.Format("SELECT DISTINCT [{0}], ISNULL([{1}], '') AS [{1}] FROM [{2}] WHERE [{0}] IS NOT NULL AND [{0}] <> '' AND {3}", HistoryEntity.Field.ClassId, HistoryEntity.Field.ClassName, HistoryEntity.TABLE_NAME, whereSql);
                result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
                if (result.IsSuccess)
                {
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        CodeTextList datas = new CodeTextList(dt.Rows.Count);
                        foreach (DataRow row in dt.Rows)
                        {
                            datas.Add(row[0].ToString(), row[1].ToString());
                        }
                        if (!Common.TryToXmlExplicitly<CodeText[]>(datas.ToArray(), out classXml))
                        {
                            result = new Result(false, "班別選項資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                    }
                }

                #region [Old] 新增日誌資料 (暫時不要記錄這類查詢 Log)
                //if (dbLogger != null)
                //{
                //    string notation = null;
                //    if (result.IsSuccess)
                //    {
                //        notation = String.Format("[{0}] {1}班別選項資料成功 ({2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, queryKey);
                //    }
                //    else
                //    {
                //        notation = String.Format("[{0}] {1}班別選項資料失敗 ({2} ; 錯誤訊息：{3})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, queryKey, result.Message);
                //    }
                //    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //}
                #endregion
            }
            #endregion

            #region 批號
            string upNoXml = null;
            if (result.IsSuccess)
            {
                DataTable dt = null;
                string sql = String.Format("SELECT DISTINCT [{0}] FROM [{1}] WHERE [{0}] IS NOT NULL AND [{0}] <> '' AND {2}", HistoryEntity.Field.UpNo, HistoryEntity.TABLE_NAME, whereSql);
                result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
                if (result.IsSuccess)
                {
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        CodeTextList datas = new CodeTextList(dt.Rows.Count);
                        foreach (DataRow row in dt.Rows)
                        {
                            datas.Add(row[0].ToString(), row[0].ToString());
                        }
                        if (!Common.TryToXmlExplicitly<CodeText[]>(datas.ToArray(), out upNoXml))
                        {
                            result = new Result(false, "批號選項資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                    }
                }

                #region [Old] 新增日誌資料 (暫時不要記錄這類查詢 Log)
                //if (dbLogger != null)
                //{
                //    string notation = null;
                //    if (result.IsSuccess)
                //    {
                //        notation = String.Format("[{0}] {1}批號選項資料成功 ({2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, queryKey);
                //    }
                //    else
                //    {
                //        notation = String.Format("[{0}] {1}批號選項資料失敗 ({2} ; 錯誤訊息：{3})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, queryKey, result.Message);
                //    }
                //    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);
                //}
                #endregion
            }
            #endregion

            #region [Old] 儲存日誌資料並釋放資料庫日誌記錄器 (暫時不要記錄這類查詢 Log)
            //if (dbLogger != null)
            //{
            //    string logErrmsg = this.ReleaseDBLogger(true);
            //    dbLogger.Dispose();
            //    dbLogger = null;
            //}
            #endregion

            rtnData = new KeyValue<string>[] {
                new KeyValue<string>("DEPT", deptXml),
                new KeyValue<string>("COLLEGE", collegeXml),
                new KeyValue<string>("MAJOR", majorXml),
                new KeyValue<string>("CLASS", classXml),
                new KeyValue<string>("UPNO", upNoXml)
            };
            return result;
        }

        #region [MDY:20160321] 維護就貸資料
        /// <summary>
        /// 維護就貸資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="rtnData"></param>
        /// <returns></returns>
        public Result EditStudentLoanData(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string action = null;
            StudentLoanEntity data = null;
            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "ACTION":
                        {
                            action = argument.Value == null ? String.Empty : argument.Value.Trim().ToUpper();
                            if (action != "A" && action != "M" && action != "D")
                            {
                                return new Result(false, "缺少或無效的處理參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                    case "DATAXML":
                        {
                            string dataXml = argument.Value == null ? String.Empty : argument.Value.Trim();
                            if (!String.IsNullOrEmpty(dataXml) && !Common.TryDeXmlExplicitly<StudentLoanEntity>(dataXml, out data))
                            {
                                data = null;
                                return new Result(false, "無法反序列化就貸資料參數", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                        }
                        break;
                }
            }
            if (String.IsNullOrEmpty(action)   //必要參數且不可為空字串
                || data == null || String.IsNullOrEmpty(data.ReceiveType) || String.IsNullOrEmpty(data.YearId) || String.IsNullOrEmpty(data.TermId)
                || data.DepId == null || String.IsNullOrEmpty(data.ReceiveId) || String.IsNullOrEmpty(data.StuId) || data.OldSeq < 0
            )
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region [TMP] 取得初始化的資料庫日誌記錄器 (暫時不要記錄這類查詢 Log)
            //string queryKey = String.Format("ReceiveType={0}; YearId={1}; TermId={2}; DepId={3}; ReceiveId={4}; StuId={5}; OldSeq={6}", data.ReceiveType, data.YearId, data.TermId, data.DepId, data.ReceiveId, data.StuId, data.OldSeq);
            //DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 處理資料
            switch (action)
            {
                case "A":   //新增
                case "M":   //修改
                    #region 新增 || 修改
                    {
                        if (String.IsNullOrEmpty(data.LoanId))
                        {
                            return new Result(false, "就貸資料缺少就貸代號", CoreStatusCode.INVALID_PARAMETER, null);
                        }
                        if (data.LoanFixamount == null || data.LoanFixamount.Value == 0)
                        {
                            return new Result(false, "就貸資料缺少就貸總金額", CoreStatusCode.INVALID_PARAMETER, null);
                        }
                        if ((data.LoanAmount == null || data.LoanAmount.Value == 0) && (data.LoanFixamount == null || data.LoanFixamount.Value == 0))
                        {
                            return new Result(false, "就貸資料缺少就貸金額", CoreStatusCode.INVALID_PARAMETER, null);
                        }
                        if (data.LoanAmount != null && data.LoanFixamount != null && data.LoanAmount.Value > 0 && data.LoanAmount.Value != data.LoanFixamount)
                        {
                            return new Result(false, "就貸資料的就貸總金額與就貸明細合計金額不合", CoreStatusCode.INVALID_PARAMETER, null);
                        }

                        using (EntityFactory factory = new EntityFactory(true))
                        {
                            Result result = new Result(true);

                            #region 刪除舊的 StudentLoanEntity
                            if (result.IsSuccess)
                            {
                                //因為同一張繳單只會有一筆貸款
                                string sql = String.Format("DELETE {0} WHERE [{1}] = @ReceiveType AND [{2}] = @YearId AND [{3}] = @TermId AND [{4}] = @DepId AND [{5}] = @ReceiveId AND [{6}] = @StuId AND [{7}] = @OldSeq"
                                    , StudentLoanEntity.TABLE_NAME
                                    , StudentLoanEntity.Field.ReceiveType
                                    , StudentLoanEntity.Field.YearId
                                    , StudentLoanEntity.Field.TermId
                                    , StudentLoanEntity.Field.DepId
                                    , StudentLoanEntity.Field.ReceiveId
                                    , StudentLoanEntity.Field.StuId
                                    , StudentLoanEntity.Field.OldSeq);
                                KeyValue[] parameters = new KeyValue[] {
                                    new KeyValue("@ReceiveType", data.ReceiveType),
                                    new KeyValue("@YearId", data.YearId),
                                    new KeyValue("@TermId", data.TermId),
                                    new KeyValue("@DepId", data.DepId),
                                    new KeyValue("@ReceiveId", data.ReceiveId),
                                    new KeyValue("@StuId", data.StuId),
                                    new KeyValue("@OldSeq", data.OldSeq)
                                };

                                int count = 0;
                                result = factory.ExecuteNonQuery(sql, parameters, out count);
                            }
                            #endregion

                            #region 新增 StudentLoanEntity
                            if (result.IsSuccess)
                            {
                                int count = 0;
                                if (data.LoanFixamount == null)
                                {
                                    data.LoanFixamount = 0;
                                }
                                if (data.LoanAmount == null)
                                {
                                    data.LoanAmount = 0;
                                }
                                result =  factory.Insert(data, out count);
                            }
                            #endregion

                            #region 更新 StudentReceiveEntity 的 LoanId、Loan、RealLoan
                            if (result.IsSuccess)
                            {
                                Expression where = new Expression(StudentReceiveEntity.Field.ReceiveType, data.ReceiveType)
                                    .And(StudentReceiveEntity.Field.YearId, data.YearId)
                                    .And(StudentReceiveEntity.Field.TermId, data.TermId)
                                    .And(StudentReceiveEntity.Field.DepId, data.DepId)
                                    .And(StudentReceiveEntity.Field.ReceiveId, data.ReceiveId)
                                    .And(StudentReceiveEntity.Field.StuId, data.StuId)
                                    .And(StudentReceiveEntity.Field.OldSeq, data.OldSeq)
                                    .And(new Expression(StudentReceiveEntity.Field.ReceiveWay, null).Or(StudentReceiveEntity.Field.ReceiveWay, String.Empty))
                                    .And(new Expression(StudentReceiveEntity.Field.ReceiveDate, null).Or(StudentReceiveEntity.Field.ReceiveDate, String.Empty))
                                    .And(new Expression(StudentReceiveEntity.Field.AccountDate, null).Or(StudentReceiveEntity.Field.AccountDate, String.Empty));

                                KeyValueList fieldValues = new KeyValueList();
                                fieldValues.Add(StudentReceiveEntity.Field.LoanId, data.LoanId);
                                fieldValues.Add(StudentReceiveEntity.Field.Loan, data.LoanFixamount.Value);
                                if (data.LoanFixamount.Value > 0)
                                {
                                    fieldValues.Add(StudentReceiveEntity.Field.RealLoan, data.LoanFixamount.Value);
                                }
                                else if (data.LoanAmount.Value > 0)
                                {
                                    fieldValues.Add(StudentReceiveEntity.Field.RealLoan, data.LoanAmount.Value);
                                }
                                else
                                {
                                    fieldValues.Add(StudentReceiveEntity.Field.RealLoan, 0);
                                }

                                int count = 0;
                                result = factory.UpdateFields<StudentReceiveEntity>(fieldValues, where, out count);
                            }
                            #endregion

                            if (result.IsSuccess)
                            {
                                factory.Commit();
                            }
                            else
                            {
                                factory.Rollback();
                            }
                            return result;
                        }
                    }
                    #endregion
                    //break;
                case "D":   //刪除
                    #region 刪除
                    {
                        using (EntityFactory factory = new EntityFactory(true))
                        {
                            Result result = new Result(true);

                            #region 刪除 StudentLoanEntity
                            if (result.IsSuccess)
                            {
                                //因為同一張繳單只會有一筆貸款
                                string sql = String.Format("DELETE {0} WHERE [{1}] = @ReceiveType AND [{2}] = @YearId AND [{3}] = @TermId AND [{4}] = @DepId AND [{5}] = @ReceiveId AND [{6}] = @StuId AND [{7}] = @OldSeq"
                                    , StudentLoanEntity.TABLE_NAME
                                    , StudentLoanEntity.Field.ReceiveType
                                    , StudentLoanEntity.Field.YearId
                                    , StudentLoanEntity.Field.TermId
                                    , StudentLoanEntity.Field.DepId
                                    , StudentLoanEntity.Field.ReceiveId
                                    , StudentLoanEntity.Field.StuId
                                    , StudentLoanEntity.Field.OldSeq);
                                KeyValue[] parameters = new KeyValue[] {
                                    new KeyValue("@ReceiveType", data.ReceiveType),
                                    new KeyValue("@YearId", data.YearId),
                                    new KeyValue("@TermId", data.TermId),
                                    new KeyValue("@DepId", data.DepId),
                                    new KeyValue("@ReceiveId", data.ReceiveId),
                                    new KeyValue("@StuId", data.StuId),
                                    new KeyValue("@OldSeq", data.OldSeq)
                                };

                                int count = 0;
                                result = factory.ExecuteNonQuery(sql, parameters, out count);
                            }
                            #endregion

                            #region 清空 StudentReceiveEntity 的 LoanId、Loan、RealLoan
                            if (result.IsSuccess)
                            {
                                Expression where = new Expression(StudentReceiveEntity.Field.ReceiveType, data.ReceiveType)
                                    .And(StudentReceiveEntity.Field.YearId, data.YearId)
                                    .And(StudentReceiveEntity.Field.TermId, data.TermId)
                                    .And(StudentReceiveEntity.Field.DepId, data.DepId)
                                    .And(StudentReceiveEntity.Field.ReceiveId, data.ReceiveId)
                                    .And(StudentReceiveEntity.Field.StuId, data.StuId)
                                    .And(StudentReceiveEntity.Field.OldSeq, data.OldSeq)
                                    .And(new Expression(StudentReceiveEntity.Field.ReceiveWay, null).Or(StudentReceiveEntity.Field.ReceiveWay, String.Empty))
                                    .And(new Expression(StudentReceiveEntity.Field.ReceiveDate, null).Or(StudentReceiveEntity.Field.ReceiveDate, String.Empty))
                                    .And(new Expression(StudentReceiveEntity.Field.AccountDate, null).Or(StudentReceiveEntity.Field.AccountDate, String.Empty));

                                KeyValueList fieldValues = new KeyValueList();
                                fieldValues.Add(StudentReceiveEntity.Field.LoanId, String.Empty);
                                fieldValues.Add(StudentReceiveEntity.Field.Loan, 0);
                                fieldValues.Add(StudentReceiveEntity.Field.RealLoan, 0);

                                int count = 0;
                                result = factory.UpdateFields<StudentReceiveEntity>(fieldValues, where, out count);
                            }
                            #endregion

                            if (result.IsSuccess)
                            {
                                factory.Commit();
                            }
                            else
                            {
                                factory.Rollback();
                            }
                            return result;
                        }
                    }
                    #endregion
                    //break;
                default:
                    return new Result(false, "不正確的操作參數", CoreStatusCode.UNKNOWN_ERROR, null);
            }
            #endregion
        }
        #endregion


        #region [MDY:2018xxxx] 取得指定代碼資料表的資料選項陣列
        /// <summary>
        /// 取得指定代碼資料表的資料選項陣列
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="rtnData"></param>
        /// <returns></returns>
        public Result GetCodeTableAllOptions(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region [MDY:202203XX] 2022擴充案 英文名稱相關欄位
            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            string depId = null;
            string codeTables = null;
            List<string> tableNames = null;
            bool useEngDataUI = false;
            {
                foreach (KeyValue<string> argument in arguments)
                {
                    string argName = argument.Key.ToUpper();
                    switch (argName)
                    {
                        case "RECEIVETYPE":
                            receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                            break;
                        case "YEARID":
                            yearId = argument.Value == null ? String.Empty : argument.Value.Trim();
                            break;
                        case "TERMID":
                            termId = argument.Value == null ? String.Empty : argument.Value.Trim();
                            break;
                        case "DEPID":
                            depId = argument.Value == null ? String.Empty : argument.Value.Trim();
                            break;
                        case "CODETABLES":
                            codeTables = argument.Value == null ? String.Empty : argument.Value.Trim();
                            if (!String.IsNullOrEmpty(codeTables))
                            {
                                string[] values = codeTables.Split(new string[] { "," }, StringSplitOptions.RemoveEmptyEntries);
                                tableNames = new List<string>(values.Length);
                                string[] tableNameList = new string[] {
                                    DeptListEntity.TABLE_NAME, CollegeListEntity.TABLE_NAME, MajorListEntity.TABLE_NAME, ClassListEntity.TABLE_NAME,
                                    DormListEntity.TABLE_NAME, ReduceListEntity.TABLE_NAME, LoanListEntity.TABLE_NAME,
                                    IdentifyList1Entity.TABLE_NAME, IdentifyList2Entity.TABLE_NAME, IdentifyList3Entity.TABLE_NAME,
                                    IdentifyList4Entity.TABLE_NAME, IdentifyList5Entity.TABLE_NAME, IdentifyList6Entity.TABLE_NAME
                                };
                                for (int idx = 0; idx < values.Length; idx++)
                                {
                                    string value = values[idx].Trim();
                                    if (!tableNameList.Contains(value))
                                    {
                                        return new Result(false, "codeTables 參數不合法", CoreStatusCode.INVALID_PARAMETER, null);
                                    }
                                    else if (tableNames.Contains(value))
                                    {
                                        return new Result(false, "codeTables 參數值重複", CoreStatusCode.INVALID_PARAMETER, null);
                                    }
                                    else
                                    {
                                        tableNames.Add(value);
                                    }
                                }
                            }
                            break;
                        case "USEENGDATAUI":
                            useEngDataUI = "Y".Equals(argument?.Value);
                            break;
                    }
                }
                if (String.IsNullOrWhiteSpace(receiveType)   //必要參數且不可為空字串
                    || String.IsNullOrWhiteSpace(yearId)     //必要參數且不可為空字串
                    || String.IsNullOrWhiteSpace(termId)     //必要參數且不可為空字串
                    || depId == null                         //必要參數且不可為空字串
                    || tableNames == null || tableNames.Count == 0  //必要參數
                )
                {
                    return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                }
            }
            #endregion

            #region [TMP] 取得初始化的資料庫日誌記錄器 (暫時不要記錄這類查詢 Log)
            //string queryKey = String.Format("ReceiveType={0}; YearId={1}; TermId={2}; DepId={3}; codeTables={4}", receiveType, yearId, termId, depId, codeTables);
            //DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            Result result = new Result(true);
            KeyValueList<string> returnDatas = new KeyValueList<string>(tableNames.Count);

            #region 部別
            if (result.IsSuccess && tableNames.Contains(DeptListEntity.TABLE_NAME))
            {
                DataTable dt = null;
                string sql = null;
                if (useEngDataUI)
                {
                    sql = $@"
SELECT [{DeptListEntity.Field.DeptId}] AS [CODE], [{DeptListEntity.Field.DeptEName}] AS [TEXT]
  FROM [{DeptListEntity.TABLE_NAME}]
 WHERE [{DeptListEntity.Field.ReceiveType}] = @ReceiveType AND [{DeptListEntity.Field.YearId}] = @YearId
   AND [{DeptListEntity.Field.TermId}] = @TermId
 ORDER BY [{DeptListEntity.Field.DeptId}]
".Trim();
                }
                else
                {
                    sql = $@"
SELECT [{DeptListEntity.Field.DeptId}] AS [CODE], [{DeptListEntity.Field.DeptName}] AS [TEXT]
  FROM [{DeptListEntity.TABLE_NAME}]
 WHERE [{DeptListEntity.Field.ReceiveType}] = @ReceiveType AND [{DeptListEntity.Field.YearId}] = @YearId
   AND [{DeptListEntity.Field.TermId}] = @TermId
 ORDER BY [{DeptListEntity.Field.DeptId}]
".Trim();
                }
                KeyValue[]  parameters = new KeyValue[3] {
                    new KeyValue("@ReceiveType", receiveType), new KeyValue("@YearId", yearId), new KeyValue("@TermId", termId)
                };
                result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
                if (result.IsSuccess)
                {
                    string xml = null;
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        CodeTextList datas = new CodeTextList(dt.Rows.Count);
                        foreach (DataRow row in dt.Rows)
                        {
                            datas.Add(row[0].ToString(), row[1].ToString());
                        }
                        if (!Common.TryToXmlExplicitly<CodeText[]>(datas.ToArray(), out xml))
                        {
                            result = new Result(false, "部別選項資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                    }
                    returnDatas.Add(DeptListEntity.TABLE_NAME, xml);
                }
            }
            #endregion

            #region 院別
            if (result.IsSuccess && tableNames.Contains(CollegeListEntity.TABLE_NAME))
            {
                DataTable dt = null;
                string sql = null;
                if (useEngDataUI)
                {
                    sql = $@"
SELECT [{CollegeListEntity.Field.CollegeId}] AS [CODE], [{CollegeListEntity.Field.CollegeEName}] AS [TEXT]
  FROM [{CollegeListEntity.TABLE_NAME}] 
 WHERE [{CollegeListEntity.Field.ReceiveType}] = @ReceiveType AND [{CollegeListEntity.Field.YearId}] = @YearId
   AND [{CollegeListEntity.Field.TermId}] = @TermId AND [{CollegeListEntity.Field.DepId}] = @DepId
 ORDER BY [{CollegeListEntity.Field.CollegeId}]
".Trim();
                }
                else
                {
                    sql = $@"
SELECT [{CollegeListEntity.Field.CollegeId}] AS [CODE], [{CollegeListEntity.Field.CollegeName}] AS [TEXT]
  FROM [{CollegeListEntity.TABLE_NAME}] 
 WHERE [{CollegeListEntity.Field.ReceiveType}] = @ReceiveType AND [{CollegeListEntity.Field.YearId}] = @YearId
   AND [{CollegeListEntity.Field.TermId}] = @TermId AND [{CollegeListEntity.Field.DepId}] = @DepId
 ORDER BY [{CollegeListEntity.Field.CollegeId}]
".Trim();
                }
                KeyValue[] parameters = new KeyValue[4] {
                    new KeyValue("@ReceiveType", receiveType), new KeyValue("@YearId", yearId), new KeyValue("@TermId", termId), new KeyValue("@DepId", depId)
                };
                result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
                if (result.IsSuccess)
                {
                    string xml = null;
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        CodeTextList datas = new CodeTextList(dt.Rows.Count);
                        foreach (DataRow row in dt.Rows)
                        {
                            datas.Add(row[0].ToString(), row[1].ToString());
                        }
                        if (!Common.TryToXmlExplicitly<CodeText[]>(datas.ToArray(), out xml))
                        {
                            result = new Result(false, "院別選項資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                    }
                    returnDatas.Add(CollegeListEntity.TABLE_NAME, xml);
                }
            }
            #endregion

            #region 科系
            if (result.IsSuccess && tableNames.Contains(MajorListEntity.TABLE_NAME))
            {
                DataTable dt = null;
                string sql = null;
                if (useEngDataUI)
                {
                    sql = $@"
SELECT [{MajorListEntity.Field.MajorId}] AS [CODE], [{MajorListEntity.Field.MajorEName}] AS [TEXT]
  FROM [{MajorListEntity.TABLE_NAME}]
 WHERE [{MajorListEntity.Field.ReceiveType}] = @ReceiveType AND [{MajorListEntity.Field.YearId}] = @YearId
   AND [{MajorListEntity.Field.TermId}] = @TermId AND [{MajorListEntity.Field.DepId}] = @DepId
 ORDER BY [{MajorListEntity.Field.MajorId}]
".Trim();
                }
                else
                {
                    sql = $@"
SELECT [{MajorListEntity.Field.MajorId}] AS [CODE], [{MajorListEntity.Field.MajorName}] AS [TEXT]
  FROM [{MajorListEntity.TABLE_NAME}]
 WHERE [{MajorListEntity.Field.ReceiveType}] = @ReceiveType AND [{MajorListEntity.Field.YearId}] = @YearId
   AND [{MajorListEntity.Field.TermId}] = @TermId AND [{MajorListEntity.Field.DepId}] = @DepId
 ORDER BY [{MajorListEntity.Field.MajorId}]
".Trim();
                }
                KeyValue[] parameters = new KeyValue[4] {
                    new KeyValue("@ReceiveType", receiveType), new KeyValue("@YearId", yearId), new KeyValue("@TermId", termId), new KeyValue("@DepId", depId)
                };
                result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
                if (result.IsSuccess)
                {
                    string xml = null;
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        CodeTextList datas = new CodeTextList(dt.Rows.Count);
                        foreach (DataRow row in dt.Rows)
                        {
                            datas.Add(row[0].ToString(), row[1].ToString());
                        }
                        if (!Common.TryToXmlExplicitly<CodeText[]>(datas.ToArray(), out xml))
                        {
                            result = new Result(false, "科系選項資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                    }
                    returnDatas.Add(MajorListEntity.TABLE_NAME, xml);
                }
            }
            #endregion

            #region 班別
            if (result.IsSuccess && tableNames.Contains(ClassListEntity.TABLE_NAME))
            {
                DataTable dt = null;
                string sql = null;
                if (useEngDataUI)
                {
                    sql = $@"
SELECT [{ClassListEntity.Field.ClassId}] AS [CODE], [{ClassListEntity.Field.ClassEName}] AS [TEXT]
  FROM [{ClassListEntity.TABLE_NAME}]
 WHERE [{ClassListEntity.Field.ReceiveType}] = @ReceiveType AND [{ClassListEntity.Field.YearId}] = @YearId
   AND [{ClassListEntity.Field.TermId}] = @TermId AND [{ClassListEntity.Field.DepId}] = @DepId
 ORDER BY [{ClassListEntity.Field.ClassId}]
".Trim();
                }
                else
                {
                    sql = $@"
SELECT [{ClassListEntity.Field.ClassId}] AS [CODE], [{ClassListEntity.Field.ClassName}] AS [TEXT]
  FROM [{ClassListEntity.TABLE_NAME}]
 WHERE [{ClassListEntity.Field.ReceiveType}] = @ReceiveType AND [{ClassListEntity.Field.YearId}] = @YearId
   AND [{ClassListEntity.Field.TermId}] = @TermId AND [{ClassListEntity.Field.DepId}] = @DepId
 ORDER BY [{ClassListEntity.Field.ClassId}]
".Trim();
                }
                KeyValue[] parameters = new KeyValue[4] {
                    new KeyValue("@ReceiveType", receiveType), new KeyValue("@YearId", yearId), new KeyValue("@TermId", termId), new KeyValue("@DepId", depId)
                };
                result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
                if (result.IsSuccess)
                {
                    string xml = null;
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        CodeTextList datas = new CodeTextList(dt.Rows.Count);
                        foreach (DataRow row in dt.Rows)
                        {
                            datas.Add(row[0].ToString(), row[1].ToString());
                        }
                        if (!Common.TryToXmlExplicitly<CodeText[]>(datas.ToArray(), out xml))
                        {
                            result = new Result(false, "班別選項資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                    }
                    returnDatas.Add(ClassListEntity.TABLE_NAME, xml);
                }
            }
            #endregion

            #region 住宿
            if (result.IsSuccess && tableNames.Contains(DormListEntity.TABLE_NAME))
            {
                DataTable dt = null;
                string sql = null;
                if (useEngDataUI)
                {
                    sql = $@"
SELECT [{DormListEntity.Field.DormId}] AS [CODE], [{DormListEntity.Field.DormEName}] AS [TEXT]
  FROM [{DormListEntity.TABLE_NAME}] 
 WHERE [{DormListEntity.Field.ReceiveType}] = @ReceiveType AND [{DormListEntity.Field.YearId}] = @YearId
   AND [{DormListEntity.Field.TermId}] = @TermId AND [{DormListEntity.Field.DepId}] = @DepId
 ORDER BY [{DormListEntity.Field.DormId}]
".Trim();
                }
                else
                {
                    sql = $@"
SELECT [{DormListEntity.Field.DormId}] AS [CODE], [{DormListEntity.Field.DormName}] AS [TEXT]
  FROM [{DormListEntity.TABLE_NAME}] 
 WHERE [{DormListEntity.Field.ReceiveType}] = @ReceiveType AND [{DormListEntity.Field.YearId}] = @YearId
   AND [{DormListEntity.Field.TermId}] = @TermId AND [{DormListEntity.Field.DepId}] = @DepId
 ORDER BY [{DormListEntity.Field.DormId}]
".Trim();
                }
                KeyValue[] parameters = new KeyValue[4] {
                    new KeyValue("@ReceiveType", receiveType), new KeyValue("@YearId", yearId), new KeyValue("@TermId", termId), new KeyValue("@DepId", depId)
                };
                result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
                if (result.IsSuccess)
                {
                    string xml = null;
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        CodeTextList datas = new CodeTextList(dt.Rows.Count);
                        foreach (DataRow row in dt.Rows)
                        {
                            datas.Add(row[0].ToString(), row[1].ToString());
                        }
                        if (!Common.TryToXmlExplicitly<CodeText[]>(datas.ToArray(), out xml))
                        {
                            result = new Result(false, "住宿選項資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                    }
                    returnDatas.Add(DormListEntity.TABLE_NAME, xml);
                }
            }
            #endregion

            #region 減免
            if (result.IsSuccess && tableNames.Contains(ReduceListEntity.TABLE_NAME))
            {
                DataTable dt = null;
                string sql = null;
                if (useEngDataUI)
                {
                    sql = $@"
SELECT [{ReduceListEntity.Field.ReduceId}] AS [CODE], [{ReduceListEntity.Field.ReduceEName}] AS [TEXT]
  FROM [{ReduceListEntity.TABLE_NAME}]
 WHERE [{ReduceListEntity.Field.ReceiveType}] = @ReceiveType AND [{ReduceListEntity.Field.YearId}] = @YearId
   AND [{ReduceListEntity.Field.TermId}] = @TermId AND [{ReduceListEntity.Field.DepId}] = @DepId
 ORDER BY [{ReduceListEntity.Field.ReduceId}]
".Trim();
                }
                else
                {
                    sql = $@"
SELECT [{ReduceListEntity.Field.ReduceId}] AS [CODE], [{ReduceListEntity.Field.ReduceName}] AS [TEXT]
  FROM [{ReduceListEntity.TABLE_NAME}]
 WHERE [{ReduceListEntity.Field.ReceiveType}] = @ReceiveType AND [{ReduceListEntity.Field.YearId}] = @YearId
   AND [{ReduceListEntity.Field.TermId}] = @TermId AND [{ReduceListEntity.Field.DepId}] = @DepId
 ORDER BY [{ReduceListEntity.Field.ReduceId}]
".Trim();
                }
                KeyValue[] parameters = new KeyValue[4] {
                    new KeyValue("@ReceiveType", receiveType), new KeyValue("@YearId", yearId), new KeyValue("@TermId", termId), new KeyValue("@DepId", depId)
                };
                result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
                if (result.IsSuccess)
                {
                    string xml = null;
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        CodeTextList datas = new CodeTextList(dt.Rows.Count);
                        foreach (DataRow row in dt.Rows)
                        {
                            datas.Add(row[0].ToString(), row[1].ToString());
                        }
                        if (!Common.TryToXmlExplicitly<CodeText[]>(datas.ToArray(), out xml))
                        {
                            result = new Result(false, "減免選項資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                    }
                    returnDatas.Add(ReduceListEntity.TABLE_NAME, xml);
                }
            }
            #endregion

            #region 就貸
            if (result.IsSuccess && tableNames.Contains(LoanListEntity.TABLE_NAME))
            {
                DataTable dt = null;
                string sql = null;
                if (useEngDataUI)
                {
                    sql = $@"
SELECT [{LoanListEntity.Field.LoanId}] AS [CODE], [{LoanListEntity.Field.LoanEName}] AS [TEXT]
  FROM [{LoanListEntity.TABLE_NAME}]
 WHERE [{LoanListEntity.Field.ReceiveType}] = @ReceiveType AND [{LoanListEntity.Field.YearId}] = @YearId
   AND [{LoanListEntity.Field.TermId}] = @TermId AND [{LoanListEntity.Field.DepId}] = @DepId
 ORDER BY [{LoanListEntity.Field.LoanId}]
".Trim();
                }
                else
                {
                    sql = $@"
SELECT [{LoanListEntity.Field.LoanId}] AS [CODE], [{LoanListEntity.Field.LoanName}] AS [TEXT]
  FROM [{LoanListEntity.TABLE_NAME}]
 WHERE [{LoanListEntity.Field.ReceiveType}] = @ReceiveType AND [{LoanListEntity.Field.YearId}] = @YearId
   AND [{LoanListEntity.Field.TermId}] = @TermId AND [{LoanListEntity.Field.DepId}] = @DepId
 ORDER BY [{LoanListEntity.Field.LoanId}]
".Trim();
                }
                KeyValue[] parameters = new KeyValue[4] {
                    new KeyValue("@ReceiveType", receiveType), new KeyValue("@YearId", yearId), new KeyValue("@TermId", termId), new KeyValue("@DepId", depId)
                };
                result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
                if (result.IsSuccess)
                {
                    string xml = null;
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        CodeTextList datas = new CodeTextList(dt.Rows.Count);
                        foreach (DataRow row in dt.Rows)
                        {
                            datas.Add(row[0].ToString(), row[1].ToString());
                        }
                        if (!Common.TryToXmlExplicitly<CodeText[]>(datas.ToArray(), out xml))
                        {
                            result = new Result(false, "就貸選項資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                    }
                    returnDatas.Add(LoanListEntity.TABLE_NAME, xml);
                }
            }
            #endregion

            #region 身份註記一
            if (result.IsSuccess && tableNames.Contains(IdentifyList1Entity.TABLE_NAME))
            {
                DataTable dt = null;
                string sql = null;
                if (useEngDataUI)
                {
                    sql = $@"
SELECT [{IdentifyList1Entity.Field.IdentifyId}] AS [CODE], [{IdentifyList1Entity.Field.IdentifyEName}] AS [TEXT]
  FROM [{IdentifyList1Entity.TABLE_NAME}]
 WHERE [{IdentifyList1Entity.Field.ReceiveType}] = @ReceiveType AND [{IdentifyList1Entity.Field.YearId}] = @YearId
   AND [{IdentifyList1Entity.Field.TermId}] = @TermId AND [{IdentifyList1Entity.Field.DepId}] = @DepId
 ORDER BY [{IdentifyList1Entity.Field.IdentifyId}]
".Trim();
                }
                else
                {
                    sql = $@"
SELECT [{IdentifyList1Entity.Field.IdentifyId}] AS [CODE], [{IdentifyList1Entity.Field.IdentifyName}] AS [TEXT]
  FROM [{IdentifyList1Entity.TABLE_NAME}]
 WHERE [{IdentifyList1Entity.Field.ReceiveType}] = @ReceiveType AND [{IdentifyList1Entity.Field.YearId}] = @YearId
   AND [{IdentifyList1Entity.Field.TermId}] = @TermId AND [{IdentifyList1Entity.Field.DepId}] = @DepId
 ORDER BY [{IdentifyList1Entity.Field.IdentifyId}]
".Trim();
                }
                KeyValue[] parameters = new KeyValue[4] {
                    new KeyValue("@ReceiveType", receiveType), new KeyValue("@YearId", yearId), new KeyValue("@TermId", termId), new KeyValue("@DepId", depId)
                };
                result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
                if (result.IsSuccess)
                {
                    string xml = null;
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        CodeTextList datas = new CodeTextList(dt.Rows.Count);
                        foreach (DataRow row in dt.Rows)
                        {
                            datas.Add(row[0].ToString(), row[1].ToString());
                        }
                        if (!Common.TryToXmlExplicitly<CodeText[]>(datas.ToArray(), out xml))
                        {
                            result = new Result(false, "身份註記一選項資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                    }
                    returnDatas.Add(IdentifyList1Entity.TABLE_NAME, xml);
                }
            }
            #endregion

            #region 身份註記二
            if (result.IsSuccess && tableNames.Contains(IdentifyList2Entity.TABLE_NAME))
            {
                DataTable dt = null;
                string sql = null;
                if (useEngDataUI)
                {
                    sql = $@"
SELECT [{IdentifyList2Entity.Field.IdentifyId}] AS [CODE], [{IdentifyList2Entity.Field.IdentifyEName}] AS [TEXT]
  FROM [{IdentifyList2Entity.TABLE_NAME}]
 WHERE [{IdentifyList2Entity.Field.ReceiveType}] = @ReceiveType AND [{IdentifyList2Entity.Field.YearId}] = @YearId
   AND [{IdentifyList2Entity.Field.TermId}] = @TermId AND [{IdentifyList2Entity.Field.DepId}] = @DepId
 ORDER BY [{IdentifyList2Entity.Field.IdentifyId}]
".Trim();
                }
                else
                {
                    sql = $@"
SELECT [{IdentifyList2Entity.Field.IdentifyId}] AS [CODE], [{IdentifyList2Entity.Field.IdentifyName}] AS [TEXT]
  FROM [{IdentifyList2Entity.TABLE_NAME}]
 WHERE [{IdentifyList2Entity.Field.ReceiveType}] = @ReceiveType AND [{IdentifyList2Entity.Field.YearId}] = @YearId
   AND [{IdentifyList2Entity.Field.TermId}] = @TermId AND [{IdentifyList2Entity.Field.DepId}] = @DepId
 ORDER BY [{IdentifyList2Entity.Field.IdentifyId}]
".Trim();
                }
                KeyValue[] parameters = new KeyValue[4] {
                    new KeyValue("@ReceiveType", receiveType), new KeyValue("@YearId", yearId), new KeyValue("@TermId", termId), new KeyValue("@DepId", depId)
                };
                result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
                if (result.IsSuccess)
                {
                    string xml = null;
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        CodeTextList datas = new CodeTextList(dt.Rows.Count);
                        foreach (DataRow row in dt.Rows)
                        {
                            datas.Add(row[0].ToString(), row[1].ToString());
                        }
                        if (!Common.TryToXmlExplicitly<CodeText[]>(datas.ToArray(), out xml))
                        {
                            result = new Result(false, "身份註記二選項資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                    }
                    returnDatas.Add(IdentifyList2Entity.TABLE_NAME, xml);
                }
            }
            #endregion

            #region 身份註記三
            if (result.IsSuccess && tableNames.Contains(IdentifyList3Entity.TABLE_NAME))
            {
                DataTable dt = null;
                string sql = null;
                if (useEngDataUI)
                {
                    sql = $@"
SELECT [{IdentifyList3Entity.Field.IdentifyId}] AS [CODE], [{IdentifyList3Entity.Field.IdentifyEName}] AS [TEXT]
  FROM [{IdentifyList3Entity.TABLE_NAME}]
 WHERE [{IdentifyList3Entity.Field.ReceiveType}] = @ReceiveType AND [{IdentifyList3Entity.Field.YearId}] = @YearId
   AND [{IdentifyList3Entity.Field.TermId}] = @TermId AND [{IdentifyList3Entity.Field.DepId}] = @DepId
 ORDER BY [{IdentifyList3Entity.Field.IdentifyId}]
".Trim();
                }
                else
                {
                    sql = $@"
SELECT [{IdentifyList3Entity.Field.IdentifyId}] AS [CODE], [{IdentifyList3Entity.Field.IdentifyName}] AS [TEXT]
  FROM [{IdentifyList3Entity.TABLE_NAME}]
 WHERE [{IdentifyList3Entity.Field.ReceiveType}] = @ReceiveType AND [{IdentifyList3Entity.Field.YearId}] = @YearId
   AND [{IdentifyList3Entity.Field.TermId}] = @TermId AND [{IdentifyList3Entity.Field.DepId}] = @DepId
 ORDER BY [{IdentifyList3Entity.Field.IdentifyId}]
".Trim();
                }
                KeyValue[] parameters = new KeyValue[4] {
                    new KeyValue("@ReceiveType", receiveType), new KeyValue("@YearId", yearId), new KeyValue("@TermId", termId), new KeyValue("@DepId", depId)
                };
                result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
                if (result.IsSuccess)
                {
                    string xml = null;
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        CodeTextList datas = new CodeTextList(dt.Rows.Count);
                        foreach (DataRow row in dt.Rows)
                        {
                            datas.Add(row[0].ToString(), row[1].ToString());
                        }
                        if (!Common.TryToXmlExplicitly<CodeText[]>(datas.ToArray(), out xml))
                        {
                            result = new Result(false, "身份註記三選項資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                    }
                    returnDatas.Add(IdentifyList3Entity.TABLE_NAME, xml);
                }
            }
            #endregion

            #region 身份註記四
            if (result.IsSuccess && tableNames.Contains(IdentifyList4Entity.TABLE_NAME))
            {
                DataTable dt = null;
                string sql = null;
                if (useEngDataUI)
                {
                    sql = $@"
SELECT [{IdentifyList4Entity.Field.IdentifyId}] AS [CODE], [{IdentifyList4Entity.Field.IdentifyEName}] AS [TEXT]
  FROM [{IdentifyList4Entity.TABLE_NAME}]
 WHERE [{IdentifyList4Entity.Field.ReceiveType}] = @ReceiveType AND [{IdentifyList4Entity.Field.YearId}] = @YearId
   AND [{IdentifyList4Entity.Field.TermId}] = @TermId AND [{IdentifyList4Entity.Field.DepId}] = @DepId
 ORDER BY [{IdentifyList4Entity.Field.IdentifyId}]
".Trim();
                }
                else
                {
                    sql = $@"
SELECT [{IdentifyList4Entity.Field.IdentifyId}] AS [CODE], [{IdentifyList4Entity.Field.IdentifyName}] AS [TEXT]
  FROM [{IdentifyList4Entity.TABLE_NAME}]
 WHERE [{IdentifyList4Entity.Field.ReceiveType}] = @ReceiveType AND [{IdentifyList4Entity.Field.YearId}] = @YearId
   AND [{IdentifyList4Entity.Field.TermId}] = @TermId AND [{IdentifyList4Entity.Field.DepId}] = @DepId
 ORDER BY [{IdentifyList4Entity.Field.IdentifyId}]
".Trim();
                }
                KeyValue[] parameters = new KeyValue[4] {
                    new KeyValue("@ReceiveType", receiveType), new KeyValue("@YearId", yearId), new KeyValue("@TermId", termId), new KeyValue("@DepId", depId)
                };
                result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
                if (result.IsSuccess)
                {
                    string xml = null;
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        CodeTextList datas = new CodeTextList(dt.Rows.Count);
                        foreach (DataRow row in dt.Rows)
                        {
                            datas.Add(row[0].ToString(), row[1].ToString());
                        }
                        if (!Common.TryToXmlExplicitly<CodeText[]>(datas.ToArray(), out xml))
                        {
                            result = new Result(false, "身份註記四選項資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                    }
                    returnDatas.Add(IdentifyList4Entity.TABLE_NAME, xml);
                }
            }
            #endregion

            #region 身份註記五
            if (result.IsSuccess && tableNames.Contains(IdentifyList5Entity.TABLE_NAME))
            {
                DataTable dt = null;
                string sql = null;
                if (useEngDataUI)
                {
                    sql = $@"
SELECT [{IdentifyList5Entity.Field.IdentifyId}] AS [CODE], [{IdentifyList5Entity.Field.IdentifyEName}] AS [TEXT]
  FROM [{IdentifyList5Entity.TABLE_NAME}]
 WHERE [{IdentifyList5Entity.Field.ReceiveType}] = @ReceiveType AND [{IdentifyList5Entity.Field.YearId}] = @YearId
   AND [{IdentifyList5Entity.Field.TermId}] = @TermId AND [{IdentifyList5Entity.Field.DepId}] = @DepId
 ORDER BY [{IdentifyList5Entity.Field.IdentifyId}]
".Trim();
                }
                else
                {
                    sql = $@"
SELECT [{IdentifyList5Entity.Field.IdentifyId}] AS [CODE], [{IdentifyList5Entity.Field.IdentifyName}] AS [TEXT]
  FROM [{IdentifyList5Entity.TABLE_NAME}]
 WHERE [{IdentifyList5Entity.Field.ReceiveType}] = @ReceiveType AND [{IdentifyList5Entity.Field.YearId}] = @YearId
   AND [{IdentifyList5Entity.Field.TermId}] = @TermId AND [{IdentifyList5Entity.Field.DepId}] = @DepId
 ORDER BY [{IdentifyList5Entity.Field.IdentifyId}]
".Trim();
                }
                KeyValue[] parameters = new KeyValue[4] {
                    new KeyValue("@ReceiveType", receiveType), new KeyValue("@YearId", yearId), new KeyValue("@TermId", termId), new KeyValue("@DepId", depId)
                };
                result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
                if (result.IsSuccess)
                {
                    string xml = null;
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        CodeTextList datas = new CodeTextList(dt.Rows.Count);
                        foreach (DataRow row in dt.Rows)
                        {
                            datas.Add(row[0].ToString(), row[1].ToString());
                        }
                        if (!Common.TryToXmlExplicitly<CodeText[]>(datas.ToArray(), out xml))
                        {
                            result = new Result(false, "身份註記五選項資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                    }
                    returnDatas.Add(IdentifyList5Entity.TABLE_NAME, xml);
                }
            }
            #endregion

            #region 身份註記六
            if (result.IsSuccess && tableNames.Contains(IdentifyList6Entity.TABLE_NAME))
            {
                DataTable dt = null;
                string sql = null;
                if (useEngDataUI)
                {
                    sql = $@"
SELECT [{IdentifyList6Entity.Field.IdentifyId}] AS [CODE], [{IdentifyList6Entity.Field.IdentifyEName}] AS [TEXT]
  FROM [{IdentifyList6Entity.TABLE_NAME}]
 WHERE [{IdentifyList6Entity.Field.ReceiveType}] = @ReceiveType AND [{IdentifyList6Entity.Field.YearId}] = @YearId
   AND [{IdentifyList6Entity.Field.TermId}] = @TermId AND [{IdentifyList6Entity.Field.DepId}] = @DepId
 ORDER BY [{IdentifyList6Entity.Field.IdentifyId}]
".Trim();
                }
                else
                {
                    sql = $@"
SELECT [{IdentifyList6Entity.Field.IdentifyId}] AS [CODE], [{IdentifyList6Entity.Field.IdentifyName}] AS [TEXT]
  FROM [{IdentifyList6Entity.TABLE_NAME}]
 WHERE [{IdentifyList6Entity.Field.ReceiveType}] = @ReceiveType AND [{IdentifyList6Entity.Field.YearId}] = @YearId
   AND [{IdentifyList6Entity.Field.TermId}] = @TermId AND [{IdentifyList6Entity.Field.DepId}] = @DepId
 ORDER BY [{IdentifyList6Entity.Field.IdentifyId}]
".Trim();
                }
                KeyValue[] parameters = new KeyValue[4] {
                    new KeyValue("@ReceiveType", receiveType), new KeyValue("@YearId", yearId), new KeyValue("@TermId", termId), new KeyValue("@DepId", depId)
                };
                result = _Factory.GetDataTable(sql, parameters, 0, 0, out dt);
                if (result.IsSuccess)
                {
                    string xml = null;
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        CodeTextList datas = new CodeTextList(dt.Rows.Count);
                        foreach (DataRow row in dt.Rows)
                        {
                            datas.Add(row[0].ToString(), row[1].ToString());
                        }
                        if (!Common.TryToXmlExplicitly<CodeText[]>(datas.ToArray(), out xml))
                        {
                            result = new Result(false, "身份註記六選項資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                    }
                    returnDatas.Add(IdentifyList6Entity.TABLE_NAME, xml);
                }
            }
            #endregion

            if (result.IsSuccess)
            {
                rtnData = returnDatas.ToArray();
            }
            return result;
            #endregion
        }
        #endregion

        #region [MDY:2018xxxx] 取得指定代收費用檔、學生基本資料、學生繳費單、合計項目設定、學生就貸的資料
        public Result GetStudentBillDatas(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string receiveType = null;
            string yearId = null;
            string termId = null;
            string depId = null;
            string receiveId = null;
            string stuId = null;
            int? oldSeq = null;
            string dataKinds = null;
            List<string> tableNames = null;
            {
                foreach (KeyValue<string> argument in arguments)
                {
                    string argName = argument.Key.ToUpper();
                    switch (argName)
                    {
                        case "RECEIVETYPE":
                            receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                            break;
                        case "YEARID":
                            yearId = argument.Value == null ? String.Empty : argument.Value.Trim();
                            break;
                        case "TERMID":
                            termId = argument.Value == null ? String.Empty : argument.Value.Trim();
                            break;
                        case "DEPID":
                            depId = argument.Value == null ? String.Empty : argument.Value.Trim();
                            break;
                        case "RECEIVEID":
                            receiveId = argument.Value == null ? String.Empty : argument.Value.Trim();
                            break;
                        case "STUID":
                            stuId = argument.Value == null ? String.Empty : argument.Value.Trim();
                            break;
                        case "OLDSEQ":
                            if (!String.IsNullOrWhiteSpace(argument.Value))
                            {
                                int value = 0;
                                if (!Int32.TryParse(argument.Value.Trim(), out value) || value < 0)
                                {
                                    return new Result(false, "oldSeq 參數不合法", CoreStatusCode.INVALID_PARAMETER, null);
                                }
                                oldSeq = value;
                            }
                            break;
                        case "DATAKINDS":
                            dataKinds = argument.Value == null ? String.Empty : argument.Value.Trim();
                            break;
                    }
                }
                if (String.IsNullOrWhiteSpace(receiveType)    //必要參數且不可為空字串
                    || depId == null                          //必要參數
                    || (oldSeq.HasValue && oldSeq .Value < 0) //非要參數但不可小於 0
                    || String.IsNullOrWhiteSpace(dataKinds)   //必要參數
                )
                {
                    return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                }

                #region 檢查各資料類別的必要參數
                {
                    string[] tableNameList = new string[] {
                        SchoolRidEntity.TABLE_NAME, StudentMasterEntity.TABLE_NAME, StudentReceiveEntity.TABLE_NAME,
                        ReceiveSumEntity.TABLE_NAME, StudentLoanEntity.TABLE_NAME,
                        "LAST_STUDENTRECEIVE"
                    };
                    string[] values = dataKinds.Split(new string[] { "," }, StringSplitOptions.RemoveEmptyEntries);
                    tableNames = new List<string>(values.Length);
                    for (int idx = 0; idx < values.Length; idx++)
                    {
                        string value = values[idx].Trim();
                        if (!tableNameList.Contains(value))
                        {
                            return new Result(false, "dataKinds 參數不合法", CoreStatusCode.INVALID_PARAMETER, null);
                        }
                        else if (tableNames.Contains(value))
                        {
                            return new Result(false, "dataKinds 參數值重複", CoreStatusCode.INVALID_PARAMETER, null);
                        }
                        else
                        {
                            switch (value)
                            {
                                case SchoolRidEntity.TABLE_NAME:
                                    #region 代收費用檔
                                    if (String.IsNullOrWhiteSpace(yearId) || String.IsNullOrWhiteSpace(termId) || String.IsNullOrWhiteSpace(receiveId))
                                    {
                                        return new Result(false, "缺少查詢代收費用檔的必要參數或參數無效", CoreStatusCode.INVALID_PARAMETER, null);
                                    }
                                    break;
                                    #endregion

                                case StudentMasterEntity.TABLE_NAME:
                                    #region 學生基本資料
                                    if (String.IsNullOrWhiteSpace(stuId))
                                    {
                                        return new Result(false, "缺少查詢學生基本資料的必要參數或參數無效", CoreStatusCode.INVALID_PARAMETER, null);
                                    }
                                    break;
                                    #endregion

                                case StudentReceiveEntity.TABLE_NAME:
                                    #region 學生繳費單
                                    if (String.IsNullOrEmpty(yearId) || String.IsNullOrEmpty(termId) || String.IsNullOrEmpty(receiveId) || String.IsNullOrEmpty(stuId) || !oldSeq.HasValue || oldSeq.Value < 0)
                                    {
                                        return new Result(false, "缺少查詢學生繳費單的必要參數或參數無效", CoreStatusCode.INVALID_PARAMETER, null);
                                    }
                                    break;
                                    #endregion

                                case ReceiveSumEntity.TABLE_NAME:
                                    #region 合計項目設定
                                    if (String.IsNullOrWhiteSpace(yearId) || String.IsNullOrWhiteSpace(termId) || String.IsNullOrWhiteSpace(receiveId))
                                    {
                                        return new Result(false, "缺少查詢合計項目設定的必要參數或參數無效", CoreStatusCode.INVALID_PARAMETER, null);
                                    }
                                    break;
                                    #endregion

                                case StudentLoanEntity.TABLE_NAME:
                                    #region 學生就貸
                                    if (String.IsNullOrEmpty(yearId) || String.IsNullOrEmpty(termId) || String.IsNullOrEmpty(receiveId) || String.IsNullOrEmpty(stuId) || !oldSeq.HasValue || oldSeq.Value < 0)
                                    {
                                        return new Result(false, "缺少查詢學生就貸的必要參數或參數無效", CoreStatusCode.INVALID_PARAMETER, null);
                                    }
                                    break;
                                    #endregion

                                case "LAST_STUDENTRECEIVE":
                                    #region 最近一筆學生繳費單
                                    if (String.IsNullOrEmpty(yearId) || String.IsNullOrEmpty(termId) || String.IsNullOrEmpty(stuId))
                                    {
                                        return new Result(false, "缺少查詢最近一筆學生繳費單的必要參數或參數無效", CoreStatusCode.INVALID_PARAMETER, null);
                                    }
                                    break;
                                    #endregion
                            }
                            tableNames.Add(value);
                        }
                    }
                }
                #endregion
            }
            #endregion

            #region [TMP] 取得初始化的資料庫日誌記錄器 (暫時不要記錄這類查詢 Log)
            //string queryKey = String.Format("ReceiveType={0}; YearId={1}; TermId={2}; DepId={3}; ReceiveId={4}; StuId={5}; OldSeq={6}; DataKinds={7}", receiveType, yearId, termId, depId, receiveId, stuId, oldSeq, dataKinds);
            //DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            Result result = new Result(true);
            KeyValueList<string> returnDatas = new KeyValueList<string>(tableNames.Count);

            #region 代收費用檔
            if (result.IsSuccess && tableNames.Contains(SchoolRidEntity.TABLE_NAME))
            {
                SchoolRidEntity schoolRid = null;
                Expression where = new Expression(SchoolRidEntity.Field.ReceiveType, receiveType)
                    .And(SchoolRidEntity.Field.YearId, yearId)
                    .And(SchoolRidEntity.Field.TermId, termId)
                    .And(SchoolRidEntity.Field.DepId, depId)
                    .And(SchoolRidEntity.Field.ReceiveId, receiveId);
                result = _Factory.SelectFirst<SchoolRidEntity>(where, null, out schoolRid);
                if (result.IsSuccess)
                {
                    string xml = null;
                    if (!Common.TryToXmlExplicitly<SchoolRidEntity>(schoolRid, out xml))
                    {
                        result = new Result(false, "代收費用檔資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                    }
                    returnDatas.Add(SchoolRidEntity.TABLE_NAME, xml);
                }
            }
            #endregion

            #region 學生基本資料
            if (result.IsSuccess && tableNames.Contains(StudentMasterEntity.TABLE_NAME))
            {
                StudentMasterEntity studentMaster = null;
                Expression where = new Expression(StudentMasterEntity.Field.ReceiveType, receiveType)
                    .And(StudentMasterEntity.Field.DepId, depId)
                    .And(StudentMasterEntity.Field.Id, stuId);
                result = _Factory.SelectFirst<StudentMasterEntity>(where, null, out studentMaster);
                if (result.IsSuccess)
                {
                    string xml = null;
                    if (!Common.TryToXmlExplicitly<StudentMasterEntity>(studentMaster, out xml))
                    {
                        result = new Result(false, "學生基本資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                    }
                    returnDatas.Add(StudentMasterEntity.TABLE_NAME, xml);
                }
            }
            #endregion

            #region 學生繳費單
            StudentReceiveEntity studentReceive = null;
            if (result.IsSuccess && (tableNames.Contains(StudentReceiveEntity.TABLE_NAME) || tableNames.Contains(StudentLoanEntity.TABLE_NAME)))
            {
                Expression where = new Expression(StudentReceiveEntity.Field.ReceiveType, receiveType)
                        .And(StudentReceiveEntity.Field.YearId, yearId)
                        .And(StudentReceiveEntity.Field.TermId, termId)
                        .And(StudentReceiveEntity.Field.DepId, depId)
                        .And(StudentReceiveEntity.Field.ReceiveId, receiveId)
                        .And(StudentReceiveEntity.Field.StuId, stuId)
                        .And(StudentReceiveEntity.Field.OldSeq, oldSeq.Value);
                result = _Factory.SelectFirst<StudentReceiveEntity>(where, null, out studentReceive);
                if (result.IsSuccess && tableNames.Contains(StudentReceiveEntity.TABLE_NAME))
                {
                    string xml = null;
                    if (!Common.TryToXmlExplicitly<StudentReceiveEntity>(studentReceive, out xml))
                    {
                        result = new Result(false, "學生繳費單資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                    }
                    returnDatas.Add(StudentReceiveEntity.TABLE_NAME, xml);
                }
            }
            #endregion

            #region 合計項目設定
            if (result.IsSuccess && tableNames.Contains(ReceiveSumEntity.TABLE_NAME))
            {
                ReceiveSumEntity[] receiveSums = null;
                Expression where = new Expression(ReceiveSumEntity.Field.ReceiveType, receiveType)
                    .And(ReceiveSumEntity.Field.YearId, yearId)
                    .And(ReceiveSumEntity.Field.TermId, termId)
                    .And(ReceiveSumEntity.Field.DepId, depId)
                    .And(ReceiveSumEntity.Field.ReceiveId, receiveId)
                    .And(ReceiveSumEntity.Field.Status, DataStatusCodeTexts.NORMAL);
                KeyValueList<OrderByEnum> orderbys = new KeyValueList<OrderByEnum>(1);
                orderbys.Add(ReceiveSumEntity.Field.SumId, OrderByEnum.Asc);
                result = _Factory.SelectAll<ReceiveSumEntity>(where, orderbys, out receiveSums);
                if (result.IsSuccess)
                {
                    string xml = null;
                    if (!Common.TryToXmlExplicitly<ReceiveSumEntity[]>(receiveSums, out xml))
                    {
                        result = new Result(false, "合計項目設定資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                    }
                    returnDatas.Add(ReceiveSumEntity.TABLE_NAME, xml);
                }
            }
            #endregion

            #region 學生就貸
            if (result.IsSuccess && studentReceive != null && tableNames.Contains(StudentLoanEntity.TABLE_NAME))
            {
                StudentLoanEntity studentLoan = null;
                Expression where = new Expression(StudentLoanEntity.Field.ReceiveType, studentReceive.ReceiveType)
                        .And(StudentLoanEntity.Field.YearId, studentReceive.YearId)
                        .And(StudentLoanEntity.Field.TermId, studentReceive.TermId)
                        .And(StudentLoanEntity.Field.DepId, studentReceive.DepId)
                        .And(StudentLoanEntity.Field.ReceiveId, studentReceive.ReceiveId)
                        .And(StudentLoanEntity.Field.StuId, studentReceive.StuId)
                        .And(StudentLoanEntity.Field.OldSeq, studentReceive.OldSeq)
                        .And(StudentLoanEntity.Field.LoanId, studentReceive.LoanId);

                #region LoanId 無值且 LoanAmount <= 0 就視為空資料，不用取
                where
                    .And(StudentLoanEntity.Field.LoanId, RelationEnum.NotEqual, String.Empty)
                    .And(StudentLoanEntity.Field.LoanAmount, RelationEnum.Greater, 0);
                #endregion

                result = _Factory.SelectFirst<StudentLoanEntity>(where, null, out studentLoan);
                if (result.IsSuccess)
                {
                    string xml = null;
                    if (!Common.TryToXmlExplicitly<StudentLoanEntity>(studentLoan, out xml))
                    {
                        result = new Result(false, "學生就貸資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                    }
                    returnDatas.Add(StudentLoanEntity.TABLE_NAME, xml);
                }
            }
            #endregion

            #region 最近一筆學生繳費單
            //這個是針對單筆新增學生繳費資料 (B2100001.aspx) 提供的資料，有學生繳費單資料就不用取
            if (result.IsSuccess && tableNames.Contains("LAST_STUDENTRECEIVE"))
            {
                if ((tableNames.Contains(StudentReceiveEntity.TABLE_NAME) && studentReceive == null) || !tableNames.Contains(StudentReceiveEntity.TABLE_NAME))
                {
                    Expression where = new Expression(StudentReceiveEntity.Field.ReceiveType, receiveType)
                            .And(StudentReceiveEntity.Field.YearId, yearId)
                            .And(StudentReceiveEntity.Field.TermId, termId)
                            .And(StudentReceiveEntity.Field.DepId, depId)
                            .And(StudentReceiveEntity.Field.StuId, stuId);
                    KeyValueList<OrderByEnum> orderbys = new KeyValueList<OrderByEnum>(1);
                    orderbys.Add(StudentReceiveEntity.Field.CreateDate, OrderByEnum.Desc);
                    StudentReceiveEntity lastStudentReceive = null;
                    result = _Factory.SelectFirst<StudentReceiveEntity>(where, orderbys, out lastStudentReceive);
                    if (result.IsSuccess)
                    {
                        string xml = null;
                        if (!Common.TryToXmlExplicitly<StudentReceiveEntity>(lastStudentReceive, out xml))
                        {
                            result = new Result(false, "最近一筆學生繳費單資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                        returnDatas.Add("LAST_STUDENTRECEIVE", xml);
                    }
                }
                else
                {
                    returnDatas.Add("LAST_STUDENTRECEIVE", String.Empty);
                }
            }
            #endregion

            if (result.IsSuccess)
            {
                rtnData = returnDatas.ToArray();
            }
            return result;
        }
        #endregion

        #region [MDY:2018xxxx] 更新學生基本資料、學生繳費單的資料
        public Result UpdateStudentBillDatas(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            StudentMasterEntity studentMaster = null;
            StudentReceiveEntity studentReceive = null;
            bool? toGenCancelNo = null;
            bool? toReturnDatas = null;
            {
                foreach (KeyValue<string> argument in arguments)
                {
                    string argName = argument.Key.ToUpper();
                    switch (argName)
                    {
                        case "STUDENTMASTER":
                            if (!String.IsNullOrWhiteSpace(argument.Value) && !Common.TryDeXmlExplicitly<StudentMasterEntity>(argument.Value, out studentMaster))
                            {
                                return new Result(false, "StudentMaster 參數無法反序列化", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                            break;
                        case "STUDENTRECEIVE":
                            if (!String.IsNullOrWhiteSpace(argument.Value) && !Common.TryDeXmlExplicitly<StudentReceiveEntity>(argument.Value, out studentReceive))
                            {
                                return new Result(false, "StudentReceive 參數無法反序列化", CoreStatusCode.INVALID_PARAMETER, null);
                            }
                            break;
                        case "TOGENCANCELNO":
                            if (!String.IsNullOrWhiteSpace(argument.Value))
                            {
                                switch (argument.Value.ToUpper())
                                {
                                    case "Y":
                                        toGenCancelNo = true;
                                        break;
                                    case "N":
                                        toGenCancelNo = false;
                                        break;
                                    default:
                                        return new Result(false, "ToGenCancelNo 參數不正確", CoreStatusCode.INVALID_PARAMETER, null);
                                }
                            }
                            break;
                        case "TORETURNDATAS":
                            if (!String.IsNullOrWhiteSpace(argument.Value))
                            {
                                switch (argument.Value.ToUpper())
                                {
                                    case "Y":
                                        toReturnDatas = true;
                                        break;
                                    case "N":
                                        toReturnDatas = false;
                                        break;
                                    default:
                                        return new Result(false, "ToReturnDatas 參數不正確", CoreStatusCode.INVALID_PARAMETER, null);
                                }
                            }
                            break;
                    }
                }
                if (studentMaster == null       //必要參數且不可為空字串
                    || studentReceive == null   //必要參數
                    || !toGenCancelNo.HasValue  //非要參數但不可小於 0
                    || !toReturnDatas.HasValue  //必要參數
                )
                {
                    return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
                }

                #region 土銀不使用原有的 DepId 欄位，所以 null 轉成空字串
                if (studentReceive.DepId == null)
                {
                    studentReceive.DepId = "";
                }
                if (studentReceive.DepId == null)
                {
                    studentReceive.DepId = "";
                }
                #endregion

                #region 檢查資料
                if (studentMaster.ReceiveType != studentReceive.ReceiveType || studentMaster.DepId != studentReceive.DepId || studentMaster.Id != studentReceive.StuId)
                {
                    return new Result(false, "studentMaster 與 studentReceive 參數資料不一致", CoreStatusCode.INVALID_PARAMETER, null);
                }
                if (String.IsNullOrEmpty(studentReceive.ReceiveType) || String.IsNullOrEmpty(studentReceive.YearId) || String.IsNullOrEmpty(studentReceive.TermId)
                    || String.IsNullOrEmpty(studentReceive.ReceiveId) || String.IsNullOrEmpty(studentReceive.StuId) || studentReceive.OldSeq < 0)
                {
                    return new Result(false, "studentMaster 參數資料不正確", CoreStatusCode.INVALID_PARAMETER, null);
                }
                #endregion
            }
            #endregion

            #region [TMP] 取得初始化的資料庫日誌記錄器 (暫時不要記錄這類查詢 Log)
            string studentMasterKey = String.Format("ReceiveType={0}; DepId={1}; Id={2}", studentMaster.ReceiveType, studentMaster.DepId, studentMaster.Id);
            string studentReceiveKey = String.Format("ReceiveType={0}; YearId={1}; TermId={2}; DepId={3}; ReceiveId={4}; StuId={5}; OldSeq={6};", studentReceive.ReceiveType, studentReceive.YearId, studentReceive.TermId, studentReceive.DepId, studentReceive.ReceiveId, studentReceive.StuId, studentReceive.OldSeq);
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 取得舊的學生基本資料
            StudentMasterEntity oldStudentMaster = null;
            {
                Expression where = new Expression(StudentMasterEntity.Field.ReceiveType, studentMaster.ReceiveType)
                    .And(StudentMasterEntity.Field.DepId, studentMaster.DepId)
                    .And(StudentMasterEntity.Field.Id, studentMaster.Id);
                Result result2 = _Factory.SelectFirst<StudentMasterEntity>(where, null, out oldStudentMaster);
                if (!result2.IsSuccess)
                {
                    return new Result(false, "讀取該學生基本資料失敗，" + result2.Message, result2.Code, result2.Exception);
                }
                if (oldStudentMaster == null)
                {
                    return new Result(false, "查無該學生基本資料", ErrorCode.D_DATA_NOT_FOUND, null);
                }
            }
            #endregion

            #region 取得舊的學生繳費單資料
            StudentReceiveEntity oldStudentReceive = null;
            bool hasUploadCancelNo = false;
            bool isPayed = false;
            {
                Expression where = new Expression(StudentReceiveEntity.Field.ReceiveType, studentReceive.ReceiveType)
                    .And(StudentReceiveEntity.Field.YearId, studentReceive.YearId)
                    .And(StudentReceiveEntity.Field.TermId, studentReceive.TermId)
                    .And(StudentReceiveEntity.Field.DepId, studentReceive.DepId)
                    .And(StudentReceiveEntity.Field.ReceiveId, studentReceive.ReceiveId)
                    .And(StudentReceiveEntity.Field.StuId, studentReceive.StuId)
                    .And(StudentReceiveEntity.Field.OldSeq, studentReceive.OldSeq);
                Result result2 = _Factory.SelectFirst<StudentReceiveEntity>(where, null, out oldStudentReceive);
                if (!result2.IsSuccess)
                {
                    return new Result(false, "讀取該學生繳費單資料失敗，" + result2.Message, result2.Code, result2.Exception);
                }
                if (oldStudentMaster == null)
                {
                    return new Result(false, "查無該學生繳費單資料", ErrorCode.D_DATA_NOT_FOUND, null);
                }

                hasUploadCancelNo = oldStudentReceive.HasUploadCancelNo();  //有上傳虛擬帳號，一定要處理金額與虛擬帳號
                if (hasUploadCancelNo)
                {
                    if (String.IsNullOrEmpty(studentReceive.CancelNo))
                    {
                        return new Result(false, "上傳資料包含虛擬帳號時，修改資料也必須指定虛擬帳號", CoreStatusCode.INVALID_PARAMETER, null);
                    }
                    else if (studentReceive.BillingType != BillingTypeCodeTexts.BY_AMOUNT)
                    {
                        return new Result(false, "指定虛擬帳號時，計算方式必須為「依金額計算」", CoreStatusCode.INVALID_PARAMETER, null);
                    }
                }

                isPayed = !String.IsNullOrEmpty(oldStudentReceive.ReceiveDate) || !String.IsNullOrEmpty(oldStudentReceive.AccountDate) || !String.IsNullOrEmpty(oldStudentReceive.ReceiveWay);

                #region 複製其他不能修改但有連帶關係的欄位資料
                #region 批號、批次資料序號
                studentReceive.UpNo = oldStudentReceive.UpNo;
                studentReceive.UpOrder = oldStudentReceive.UpOrder;
                #endregion

                #region 銷帳相關欄位
                studentReceive.CancelFlag = oldStudentReceive.CancelFlag;
                studentReceive.ReceivebankId = oldStudentReceive.ReceivebankId;
                studentReceive.ReceiveDate = oldStudentReceive.ReceiveDate;
                studentReceive.ReceiveTime = oldStudentReceive.ReceiveTime;
                studentReceive.AccountDate = oldStudentReceive.AccountDate;
                studentReceive.ReceiveWay = oldStudentReceive.ReceiveWay;
                //studentReceive.CancelDate = oldStudentReceive.CancelDate;
                #endregion

                #region 土銀沒用到的欄位
                //studentReceive.ProcessFee = oldStudentReceive.ProcessFee;
                //studentReceive.RealReceive = oldStudentReceive.RealReceive;
                //studentReceive.CancelReceive = oldStudentReceive.CancelReceive;
                //studentReceive.FeeReceivable = oldStudentReceive.FeeReceivable;
                //studentReceive.FeePayable = oldStudentReceive.FeePayable;
                //studentReceive.Postseq = oldStudentReceive.Postseq;
                //studentReceive.AtmMeno = oldStudentReceive.AtmMeno;
                //studentReceive.EFlag = oldStudentReceive.EFlag;
                //studentReceive.PrintcreateDate = oldStudentReceive.PrintcreateDate;
                //studentReceive.PrintDate = oldStudentReceive.PrintDate;
                //studentReceive.InvcreateDate = oldStudentReceive.InvcreateDate;
                //studentReceive.InvDate = oldStudentReceive.InvDate;
                //studentReceive.MappingType = oldStudentReceive.MappingType;
                //studentReceive.MappingId = oldStudentReceive.MappingId;
                //studentReceive.Remark = oldStudentReceive.Remark;
                #endregion

                #region [MDY:20190906] (2019擴充案) 新增減免金額
                studentReceive.FeePayable = oldStudentReceive.FeePayable;
                #endregion

                #region [MDY:20190906] (2019擴充案) 補上傳就學貸款金額
                studentReceive.Loan = oldStudentReceive.Loan;
                #endregion

                studentReceive.CFlag = oldStudentReceive.CFlag;
                studentReceive.CreateDate = oldStudentReceive.CreateDate;
                studentReceive.RealLoan = oldStudentReceive.RealLoan;
                studentReceive.Exportreceivedata = oldStudentReceive.Exportreceivedata;

                studentReceive.SeriorNo = oldStudentReceive.SeriorNo;
                studentReceive.Uploadflag = oldStudentReceive.Uploadflag;
                studentReceive.CancelFlagFields = oldStudentReceive.CancelFlagFields;

                #region 連動製單服務
                //studentReceive.ServiceSeqNo = oldStudentReceive.ServiceSeqNo;
                //studentReceive.ServiceSchUser = oldStudentReceive.ServiceSchUser;
                //studentReceive.ServiceSchMDate = oldStudentReceive.ServiceSchMDate;
                //studentReceive.ServiceSchMTime = oldStudentReceive.ServiceSchMTime;
                #endregion
                #endregion
            }
            #endregion

            #region 檢查是否可以計算金額、產生銷帳編號
            if (isPayed && toGenCancelNo.Value)
            {
                return new Result(false, "此學生繳費單已繳費，不允許計算金額或產生虛擬帳號", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得代收費用檔資料
            SchoolRidEntity schoolRid = null;
            if (toGenCancelNo.Value || toReturnDatas.Value || hasUploadCancelNo)  //有上傳虛擬帳號，一定要處理金額與虛擬帳號
            {
                Expression where = new Expression(SchoolRidEntity.Field.ReceiveType, studentReceive.ReceiveType)
                    .And(SchoolRidEntity.Field.YearId, studentReceive.YearId)
                    .And(SchoolRidEntity.Field.TermId, studentReceive.TermId)
                    .And(SchoolRidEntity.Field.DepId, studentReceive.DepId)
                    .And(SchoolRidEntity.Field.ReceiveId, studentReceive.ReceiveId);
                Result result2 = _Factory.SelectFirst<SchoolRidEntity>(where, null, out schoolRid);
                if (!result2.IsSuccess)
                {
                    return new Result(false, "讀取該代收費用檔資料失敗，" + result2.Message, result2.Code, result2.Exception);
                }
                if (schoolRid == null)
                {
                    return new Result(false, "查無該代收費用檔資料", ErrorCode.D_DATA_NOT_FOUND, null);
                }
            }
            #endregion

            #region 取得合計項目設定
            ReceiveSumEntity[] receiveSums = null;
            if (toReturnDatas.Value)
            {
                Expression where = new Expression(ReceiveSumEntity.Field.ReceiveType, studentReceive.ReceiveType)
                    .And(ReceiveSumEntity.Field.YearId, studentReceive.YearId)
                    .And(ReceiveSumEntity.Field.TermId, studentReceive.TermId)
                    .And(ReceiveSumEntity.Field.DepId, studentReceive.DepId)
                    .And(ReceiveSumEntity.Field.ReceiveId, studentReceive.ReceiveId)
                    .And(ReceiveSumEntity.Field.Status, DataStatusCodeTexts.NORMAL);
                KeyValueList<OrderByEnum> orderbys = new KeyValueList<OrderByEnum>(1);
                orderbys.Add(ReceiveSumEntity.Field.SumId, OrderByEnum.Asc);
                Result result2 = _Factory.SelectAll<ReceiveSumEntity>(where, orderbys, out receiveSums);
                if (!result2.IsSuccess)
                {
                    return new Result(false, "讀取該合計項目設定資料失敗，" + result2.Message, result2.Code, result2.Exception);
                }
            }
            #endregion

            #region 取得學生就貸資料
            StudentLoanEntity studentLoan = null;
            if (toReturnDatas.Value)
            {
                Expression where = new Expression(StudentLoanEntity.Field.ReceiveType, studentReceive.ReceiveType)
                    .And(StudentLoanEntity.Field.YearId, studentReceive.YearId)
                    .And(StudentLoanEntity.Field.TermId, studentReceive.TermId)
                    .And(StudentLoanEntity.Field.DepId, studentReceive.DepId)
                    .And(StudentLoanEntity.Field.ReceiveId, studentReceive.ReceiveId)
                    .And(StudentLoanEntity.Field.StuId, studentReceive.StuId)
                    .And(StudentLoanEntity.Field.OldSeq, studentReceive.OldSeq)
                    .And(StudentLoanEntity.Field.LoanId, studentReceive.LoanId);

                #region LoanId 無值且 LoanAmount <= 0 就視為空資料，不用取
                where
                    .And(StudentLoanEntity.Field.LoanId, RelationEnum.NotEqual, String.Empty)
                    .And(StudentLoanEntity.Field.LoanAmount, RelationEnum.Greater, 0);
                #endregion

                Result result2 = _Factory.SelectFirst<StudentLoanEntity>(where, null, out studentLoan);
                if (!result2.IsSuccess)
                {
                    return new Result(false, "讀取該學生就貸資料失敗，" + result2.Message, result2.Code, result2.Exception);
                }
            }
            #endregion

            #region 取得商家代號的代收管道設定
            bool hasSMChannel = false;
            bool hasTabsChannel = false;
            if (toGenCancelNo.Value || hasUploadCancelNo)  //有上傳虛擬帳號，一定要處理金額與虛擬帳號
            {
                ReceiveChannelEntity[] channels = null;
                Expression where = new Expression(ReceiveChannelEntity.Field.ReceiveType, studentReceive.ReceiveType)
                    .And(ReceiveChannelEntity.Field.ChannelId, new string[] { ChannelHelper.TABS, ChannelHelper.SM_DEFAULT });  //土銀學雜費沒有郵局代收
                Result result2 = _Factory.SelectAll<ReceiveChannelEntity>(where, null, out channels);
                if (result2.IsSuccess)
                {
                    foreach (ReceiveChannelEntity channel in channels)
                    {
                        switch (channel.ChannelId)
                        {
                            case ChannelHelper.TABS:
                                hasTabsChannel = true;
                                break;
                            case ChannelHelper.SM_DEFAULT:
                                hasSMChannel = true;
                                break;
                        }
                        if (hasTabsChannel && hasSMChannel)
                        {
                            break;
                        }
                    }
                }
                else
                {
                    return new Result(false, "查詢代收管道資料失敗，" + result2.Message, result2.Code, result2.Exception);
                }
            }
            #endregion

            #region 取得商家代號與檢碼規則資料
            SchoolRTypeEntity schoolRType = null;
            CancelNoHelper.Module cancelNoModule = null;
            if (toGenCancelNo.Value || hasUploadCancelNo)  //有上傳虛擬帳號，一定要處理金額與虛擬帳號
            {
                Expression where = new Expression(SchoolRTypeEntity.Field.ReceiveType, studentReceive.ReceiveType);
                Result result2 = _Factory.SelectFirst<SchoolRTypeEntity>(where, null, out schoolRType);
                if (!result2.IsSuccess)
                {
                    return new Result(false, "讀取該商家代號資料失敗，" + result2.Message, result2.Code, result2.Exception);
                }
                if (schoolRType == null)
                {
                    return new Result(false, "查無該商家代號資料", ErrorCode.D_DATA_NOT_FOUND, null);
                }
                cancelNoModule = CancelNoHelper.Module.GetById(schoolRType.CancelNoRule);
                if (cancelNoModule == null)
                {
                    return new Result(false, "查無此商家代號的檢碼規則資料", ErrorCode.D_DATA_NOT_FOUND, null);
                }
            }
            #endregion

            if (toGenCancelNo.Value || hasUploadCancelNo)  //有上傳虛擬帳號，一定要處理金額與虛擬帳號
            {
                #region 計算金額
                {
                    BillAmountHelper helper = new BillAmountHelper();
                    BillAmountHelper.CalculateType calculateType = studentReceive.BillingType == BillingTypeCodeTexts.BY_STANDARD ? BillAmountHelper.CalculateType.byStandard : BillAmountHelper.CalculateType.byAmount;
                    if (!helper.CalcBillAmount(ref studentReceive, calculateType, schoolRid, hasTabsChannel, hasSMChannel))
                    {
                        return new Result(false, "計算金額失敗，" + helper.err_mgs, CoreStatusCode.UNKNOWN_ERROR, null);
                    }
                }
                #endregion

                #region 處理虛擬帳號
                {
                    CancelNoHelper helper = new CancelNoHelper();

                    #region [MDY:20190218] 改用 IsNoRuleModuleId() 判斷是否為組成無規則無檢碼，是則要特別處理
                    bool isUnrulyModule = CancelNoHelper.IsUnrulyModule(cancelNoModule);
                    #endregion

                    #region [MDY:20190218] 比照上傳學生繳費資料處理邏輯，只要自訂虛擬帳號一律要執行 CheckCustomCancelNo()
                    #region [OLD]
                    ////D38 沒有檢碼也沒有組成邏輯，所以 D38 時要檢核輸入的虛擬帳號
                    //if (hasUploadCancelNo && !cancelNoModule.IsD38Kind)
                    //{
                    //    string errmsg = helper.CheckCustomCancelNo(studentReceive.CancelNo, cancelNoModule, oldStudentReceive.CancelNo, studentReceive.ReceiveAmount.Value);
                    //    if (!String.IsNullOrEmpty(errmsg))
                    //    {
                    //        return new Result(false, errmsg, CoreStatusCode.INVALID_PARAMETER, null);
                    //    }

                    //    #region 有上傳虛擬帳號且檢核通過，就直接用上傳虛擬帳號，不用再產生虛擬帳號
                    //    #region 土銀的的收續費，內含就是企業負擔，外加就是繳款人負擔，所以各管道的金額都一樣，所以各管道的銷帳編號也都一樣，只要判斷是否有超商與臨櫃管道
                    //    #region 超商虛擬帳號
                    //    if (studentReceive.ReceiveSmamount.HasValue && studentReceive.ReceiveSmamount.Value > 0)
                    //    {
                    //        studentReceive.CancelSmno = studentReceive.CancelNo;
                    //    }
                    //    else
                    //    {
                    //        studentReceive.CancelSmno = String.Empty;
                    //    }
                    //    #endregion

                    //    #region 臨櫃虛擬帳號
                    //    if (studentReceive.ReceiveAtmamount.HasValue && studentReceive.ReceiveAtmamount.Value > 0)
                    //    {
                    //        studentReceive.CancelAtmno = studentReceive.CancelNo;
                    //    }
                    //    else
                    //    {
                    //        studentReceive.CancelAtmno = String.Empty;
                    //    }
                    //    #endregion
                    //    #endregion
                    //    #endregion
                    //}
                    #endregion

                    if (hasUploadCancelNo)
                    {
                        string errmsg = helper.CheckCustomCancelNo(studentReceive.CancelNo, cancelNoModule, oldStudentReceive.CancelNo, studentReceive.ReceiveAmount.Value);
                        if (!String.IsNullOrEmpty(errmsg))
                        {
                            return new Result(false, errmsg, CoreStatusCode.INVALID_PARAMETER, null);
                        }

                        #region 有上傳虛擬帳號且檢核通過，就直接用上傳虛擬帳號，不用再產生虛擬帳號
                        #region 土銀的的收續費，內含就是企業負擔，外加就是繳款人負擔，所以各管道的金額都一樣，所以各管道的銷帳編號也都一樣，只要判斷是否有超商與臨櫃管道
                        #region 超商虛擬帳號
                        if (studentReceive.ReceiveSmamount.HasValue && studentReceive.ReceiveSmamount.Value > 0)
                        {
                            studentReceive.CancelSmno = studentReceive.CancelNo;
                        }
                        else
                        {
                            studentReceive.CancelSmno = String.Empty;
                        }
                        #endregion

                        #region 臨櫃虛擬帳號
                        if (studentReceive.ReceiveAtmamount.HasValue && studentReceive.ReceiveAtmamount.Value > 0)
                        {
                            studentReceive.CancelAtmno = studentReceive.CancelNo;
                        }
                        else
                        {
                            studentReceive.CancelAtmno = String.Empty;
                        }
                        #endregion
                        #endregion
                        #endregion
                    }
                    #endregion

                    #region 產生虛擬帳號
                    #region [MDY:20190218] 改用 IsNoRuleModuleId() 判斷是否為組成無規則無檢碼，是則直接使用 CanceNo
                    #region [OLD]
                    //if (cancelNoModule.IsD38Kind && !String.IsNullOrWhiteSpace(studentReceive.CancelNo))
                    //{
                    //    #region 特別處理 module.IsD38Kind 類，直接使用 CanceNo
                    //    //D38 沒有檢碼也沒有組成邏輯，所以直接用 CancelNo
                    //    string cancelNo = studentReceive.CancelNo.Trim();

                    //    #region 土銀的的收續費，內含就是企業負擔，外加就是繳款人負擔，所以各管道的金額都一樣，所以各管道的銷帳編號也都一樣，只要判斷是否有超商與臨櫃管道
                    //    #region 臨櫃虛擬帳號
                    //    if (studentReceive.ReceiveAtmamount.HasValue && studentReceive.ReceiveAtmamount.Value > 0)
                    //    {
                    //        studentReceive.CancelAtmno = cancelNo;
                    //    }
                    //    else
                    //    {
                    //        studentReceive.CancelAtmno = String.Empty;
                    //    }
                    //    #endregion

                    //    #region 超商虛擬帳號
                    //    if (studentReceive.ReceiveSmamount.HasValue && studentReceive.ReceiveSmamount.Value > 0)
                    //    {
                    //        studentReceive.CancelSmno = cancelNo;
                    //    }
                    //    else
                    //    {
                    //        studentReceive.CancelSmno = String.Empty;
                    //    }
                    //    #endregion
                    //    #endregion

                    //    #region 介面沒有流水號，D38 也無法處理流水號，所以沿用原流水號
                    //    studentReceive.SeriorNo = oldStudentReceive.SeriorNo;
                    //    #endregion
                    //    #endregion
                    //}
                    //else
                    //{
                    //    string cancelNo = null;
                    //    string custtomNo = null;
                    //    string checksum = null;
                    //    string errmsg = null;
                    //    bool isBigReceiveId = schoolRType.IsBigReceiveId();
                    //    if (studentReceive.ReceiveAmount > 0)
                    //    {
                    //        //金額大於 0 才要產生虛擬帳號
                    //        #region 處理一般虛擬帳號模組
                    //        #region 檢查是否有流水號，如果沒有則產生流水號，並加入要更新的欄位
                    //        if (cancelNoModule.SeriorNoSize > 0 && String.IsNullOrWhiteSpace(studentReceive.SeriorNo))
                    //        {
                    //            #region 有虛擬帳號，則流水號取自銷編
                    //            if (!String.IsNullOrWhiteSpace(studentReceive.CancelNo))
                    //            {
                    //                string myReceiveType = null;
                    //                string myCusttomNo = null;
                    //                string myChecksum = null;
                    //                string myYearId = null;
                    //                string myTermId = null;
                    //                string myReceiveId = null;
                    //                string mySeriorNo = null;
                    //                if (cancelNoModule.TryParseCancelNo(studentReceive.CancelNo, isBigReceiveId, out myReceiveType, out myCusttomNo, out myChecksum, out myYearId, out myTermId, out myReceiveId, out mySeriorNo))
                    //                {
                    //                    studentReceive.SeriorNo = mySeriorNo;
                    //                }
                    //                else
                    //                {
                    //                    //只裡是頁面修改，有值又無法拆解，視為錯誤
                    //                    return new Result(false, "指定虛擬帳號不合法", CoreStatusCode.UNKNOWN_ERROR, null);
                    //                }
                    //            }
                    //            #endregion

                    //            #region 仍然無流水號，則取號
                    //            if (String.IsNullOrWhiteSpace(studentReceive.SeriorNo))
                    //            {
                    //                string seriorNo = null;
                    //                if (helper.GenStudentReceiveSeriorNo(_Factory, cancelNoModule, studentReceive.ReceiveType, studentReceive.YearId, studentReceive.TermId, studentReceive.DepId, studentReceive.ReceiveId, isBigReceiveId, out seriorNo))
                    //                {
                    //                    studentReceive.SeriorNo = seriorNo;
                    //                }
                    //                else
                    //                {
                    //                    return new Result(false, "產生虛擬帳號失敗，錯誤訊息：無法取得流水號", CoreStatusCode.UNKNOWN_ERROR, null);
                    //                }
                    //            }
                    //            #endregion
                    //        }
                    //        #endregion

                    //        #region 虛擬帳號
                    //        errmsg = helper.TryGenCancelNo(cancelNoModule, studentReceive.ReceiveType, studentReceive.YearId, studentReceive.TermId, studentReceive.ReceiveId, studentReceive.SeriorNo, isBigReceiveId, studentReceive.ReceiveAmount.Value
                    //            , out cancelNo, out custtomNo, out checksum);
                    //        if (String.IsNullOrEmpty(errmsg))
                    //        {
                    //            if (hasUploadCancelNo)
                    //            {
                    //                if (String.IsNullOrWhiteSpace(studentReceive.CancelNo) || studentReceive.CancelNo != cancelNo)
                    //                {
                    //                    return new Result(false, "上傳的虛擬帳號與系統產生的虛擬帳號不同", CoreStatusCode.UNKNOWN_ERROR, null);
                    //                }
                    //            }
                    //            else
                    //            {
                    //                studentReceive.CancelNo = cancelNo;
                    //            }
                    //        }
                    //        else
                    //        {
                    //            return new Result(false, "產生虛擬帳號失敗，錯誤訊息：" + errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
                    //        }
                    //        #endregion

                    //        #region 臨櫃虛擬帳號
                    //        if (studentReceive.ReceiveAtmamount != null && studentReceive.ReceiveAtmamount.Value > 0)
                    //        {
                    //            errmsg = helper.TryGenCancelNo(cancelNoModule, studentReceive.ReceiveType, studentReceive.YearId, studentReceive.TermId, studentReceive.ReceiveId, studentReceive.SeriorNo, isBigReceiveId, studentReceive.ReceiveAtmamount.Value
                    //                , out cancelNo, out custtomNo, out checksum);
                    //            if (String.IsNullOrEmpty(errmsg))
                    //            {
                    //                studentReceive.CancelAtmno = cancelNo;
                    //            }
                    //            else
                    //            {
                    //                return new Result(false, "產生臨櫃虛擬帳號失敗，錯誤訊息：" + errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
                    //            }
                    //        }
                    //        else
                    //        {
                    //            studentReceive.CancelAtmno = String.Empty;
                    //        }
                    //        #endregion

                    //        #region 超商虛擬帳號
                    //        if (studentReceive.ReceiveSmamount != null && studentReceive.ReceiveSmamount.Value > 0)
                    //        {
                    //            errmsg = helper.TryGenCancelNo(cancelNoModule, studentReceive.ReceiveType, studentReceive.YearId, studentReceive.TermId, studentReceive.ReceiveId, studentReceive.SeriorNo, isBigReceiveId, studentReceive.ReceiveSmamount.Value
                    //                , out cancelNo, out custtomNo, out checksum);
                    //            if (String.IsNullOrEmpty(errmsg))
                    //            {
                    //                studentReceive.CancelSmno = cancelNo;
                    //            }
                    //            else
                    //            {
                    //                return new Result(false, "產生超商虛擬帳號失敗，錯誤訊息：" + errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
                    //            }
                    //        }
                    //        else
                    //        {
                    //            studentReceive.CancelSmno = String.Empty;
                    //        }
                    //        #endregion
                    //        #endregion
                    //    }
                    //    else
                    //    {
                    //        //否則清除虛擬帳號 (但不清除流水號)
                    //        #region 虛擬帳號
                    //        studentReceive.CancelNo = String.Empty;
                    //        #endregion

                    //        #region 臨櫃虛擬帳號
                    //        studentReceive.CancelAtmno = String.Empty;
                    //        #endregion

                    //        #region 超商虛擬帳號
                    //        studentReceive.CancelSmno = String.Empty;
                    //        #endregion
                    //    }
                    //}
                    #endregion

                    if (isUnrulyModule && !String.IsNullOrWhiteSpace(studentReceive.CancelNo))
                    {
                        #region 特別處理無規則無檢碼類的撿碼規則模組，直接使用 CanceNo
                        string cancelNo = studentReceive.CancelNo.Trim();

                        #region 土銀的的收續費，內含就是企業負擔，外加就是繳款人負擔，所以各管道的金額都一樣，所以各管道的銷帳編號也都一樣，只要判斷是否有超商與臨櫃管道
                        #region 臨櫃虛擬帳號
                        if (studentReceive.ReceiveAtmamount.HasValue && studentReceive.ReceiveAtmamount.Value > 0)
                        {
                            studentReceive.CancelAtmno = cancelNo;
                        }
                        else
                        {
                            studentReceive.CancelAtmno = String.Empty;
                        }
                        #endregion

                        #region 超商虛擬帳號
                        if (studentReceive.ReceiveSmamount.HasValue && studentReceive.ReceiveSmamount.Value > 0)
                        {
                            studentReceive.CancelSmno = cancelNo;
                        }
                        else
                        {
                            studentReceive.CancelSmno = String.Empty;
                        }
                        #endregion
                        #endregion

                        #region 介面沒有流水號，無規則無檢碼類的撿碼規則模組也無法處理流水號，所以沿用原流水號
                        studentReceive.SeriorNo = oldStudentReceive.SeriorNo;
                        #endregion
                        #endregion
                    }
                    else
                    {
                        string cancelNo = null;
                        string custtomNo = null;
                        string checksum = null;
                        string errmsg = null;
                        bool isBigReceiveId = schoolRType.IsBigReceiveId();
                        if (studentReceive.ReceiveAmount > 0)
                        {
                            //金額大於 0 才要產生虛擬帳號
                            #region 處理一般虛擬帳號模組
                            #region 檢查是否有流水號，如果沒有則產生流水號，加入要更新的欄位
                            if (cancelNoModule.SeriorNoSize > 0 && String.IsNullOrWhiteSpace(studentReceive.SeriorNo))
                            {
                                #region 有虛擬帳號，則流水號取自銷編
                                if (!String.IsNullOrWhiteSpace(studentReceive.CancelNo))
                                {
                                    string myReceiveType = null;
                                    string myCusttomNo = null;
                                    string myChecksum = null;
                                    string myYearId = null;
                                    string myTermId = null;
                                    string myReceiveId = null;
                                    string mySeriorNo = null;
                                    if (cancelNoModule.TryParseCancelNo(studentReceive.CancelNo, isBigReceiveId, out myReceiveType, out myCusttomNo, out myChecksum, out myYearId, out myTermId, out myReceiveId, out mySeriorNo))
                                    {
                                        studentReceive.SeriorNo = mySeriorNo;
                                    }
                                    else
                                    {
                                        //只裡是頁面修改，有值又無法拆解，視為錯誤
                                        return new Result(false, "指定虛擬帳號不合法", CoreStatusCode.UNKNOWN_ERROR, null);
                                    }
                                }
                                #endregion

                                #region 仍然無流水號，則取號
                                if (String.IsNullOrWhiteSpace(studentReceive.SeriorNo))
                                {
                                    string seriorNo = null;
                                    if (helper.GenStudentReceiveSeriorNo(_Factory, cancelNoModule, studentReceive.ReceiveType, studentReceive.YearId, studentReceive.TermId, studentReceive.DepId, studentReceive.ReceiveId, isBigReceiveId, out seriorNo))
                                    {
                                        studentReceive.SeriorNo = seriorNo;
                                    }
                                    else
                                    {
                                        return new Result(false, "產生虛擬帳號失敗，錯誤訊息：無法取得流水號", CoreStatusCode.UNKNOWN_ERROR, null);
                                    }
                                }
                                #endregion
                            }
                            #endregion

                            #region 虛擬帳號
                            errmsg = helper.TryGenCancelNo(cancelNoModule, studentReceive.ReceiveType, studentReceive.YearId, studentReceive.TermId, studentReceive.ReceiveId, studentReceive.SeriorNo, isBigReceiveId, studentReceive.ReceiveAmount.Value
                                , out cancelNo, out custtomNo, out checksum);
                            if (String.IsNullOrEmpty(errmsg))
                            {
                                if (hasUploadCancelNo)
                                {
                                    if (String.IsNullOrWhiteSpace(studentReceive.CancelNo) || studentReceive.CancelNo != cancelNo)
                                    {
                                        return new Result(false, "上傳的虛擬帳號與系統產生的虛擬帳號不同", CoreStatusCode.UNKNOWN_ERROR, null);
                                    }
                                }
                                else
                                {
                                    studentReceive.CancelNo = cancelNo;
                                }
                            }
                            else
                            {
                                return new Result(false, "產生虛擬帳號失敗，錯誤訊息：" + errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
                            }
                            #endregion

                            #region 臨櫃虛擬帳號
                            if (studentReceive.ReceiveAtmamount != null && studentReceive.ReceiveAtmamount.Value > 0)
                            {
                                errmsg = helper.TryGenCancelNo(cancelNoModule, studentReceive.ReceiveType, studentReceive.YearId, studentReceive.TermId, studentReceive.ReceiveId, studentReceive.SeriorNo, isBigReceiveId, studentReceive.ReceiveAtmamount.Value
                                    , out cancelNo, out custtomNo, out checksum);
                                if (String.IsNullOrEmpty(errmsg))
                                {
                                    studentReceive.CancelAtmno = cancelNo;
                                }
                                else
                                {
                                    return new Result(false, "產生臨櫃虛擬帳號失敗，錯誤訊息：" + errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
                                }
                            }
                            else
                            {
                                studentReceive.CancelAtmno = String.Empty;
                            }
                            #endregion

                            #region 超商虛擬帳號
                            if (studentReceive.ReceiveSmamount != null && studentReceive.ReceiveSmamount.Value > 0)
                            {
                                errmsg = helper.TryGenCancelNo(cancelNoModule, studentReceive.ReceiveType, studentReceive.YearId, studentReceive.TermId, studentReceive.ReceiveId, studentReceive.SeriorNo, isBigReceiveId, studentReceive.ReceiveSmamount.Value
                                    , out cancelNo, out custtomNo, out checksum);
                                if (String.IsNullOrEmpty(errmsg))
                                {
                                    studentReceive.CancelSmno = cancelNo;
                                }
                                else
                                {
                                    return new Result(false, "產生超商虛擬帳號失敗，錯誤訊息：" + errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
                                }
                            }
                            else
                            {
                                studentReceive.CancelSmno = String.Empty;
                            }
                            #endregion
                            #endregion
                        }
                        else
                        {
                            //否則清除虛擬帳號 (但不清除流水號)
                            #region 虛擬帳號
                            studentReceive.CancelNo = String.Empty;
                            #endregion

                            #region 臨櫃虛擬帳號
                            studentReceive.CancelAtmno = String.Empty;
                            #endregion

                            #region 超商虛擬帳號
                            studentReceive.CancelSmno = String.Empty;
                            #endregion
                        }
                    }
                    #endregion

                    #region 處理上傳資料註記
                    //[MEMO] 舊資料有上傳虛擬帳號，頁面修改就需要指定虛擬帳號，所以應該保留有上傳虛擬帳號的註記 （舊程式是一律清除）
                    studentReceive.Uploadflag = hasUploadCancelNo ? StudentReceiveEntity.UploadCancelNoFlag.ToString() : "";
                    #endregion
                    #endregion
                }
                #endregion

                #region 中信資料發送旗標清為 0
                if (studentReceive.ReceiveAmount != oldStudentReceive.ReceiveAmount 
                    || studentReceive.CancelNo != oldStudentReceive.CancelNo
                    || studentReceive.PayDueDate != oldStudentReceive.PayDueDate)
                {
                    studentReceive.CFlag = "0";
                }
                #endregion
            }

            Result result = new Result(true);

            int updateCount = 0;

            #region 更新學生基本資料
            if (result.IsSuccess)
            {
                Expression where = new Expression(StudentMasterEntity.Field.ReceiveType, studentMaster.ReceiveType)
                    .And(StudentMasterEntity.Field.DepId, studentMaster.DepId)
                    .And(StudentMasterEntity.Field.Id, studentMaster.Id);

                KeyValueList fieldValues = new KeyValueList(9);
                if (oldStudentMaster.Name != studentMaster.Name)
                {
                    fieldValues.Add(StudentMasterEntity.Field.Name, studentMaster.Name);
                }
                if (oldStudentMaster.Birthday != studentMaster.Birthday)
                {
                    fieldValues.Add(StudentMasterEntity.Field.Birthday, studentMaster.Birthday);
                }
                if (oldStudentMaster.IdNumber != studentMaster.IdNumber)
                {
                    fieldValues.Add(StudentMasterEntity.Field.IdNumber, studentMaster.IdNumber);
                }
                if (oldStudentMaster.Tel != studentMaster.Tel)
                {
                    fieldValues.Add(StudentMasterEntity.Field.Tel, studentMaster.Tel);
                }
                if (oldStudentMaster.ZipCode != studentMaster.ZipCode)
                {
                    fieldValues.Add(StudentMasterEntity.Field.ZipCode, studentMaster.ZipCode);
                }
                if (oldStudentMaster.Address != studentMaster.Address)
                {
                    fieldValues.Add(StudentMasterEntity.Field.Address, studentMaster.Address);
                }
                if (oldStudentMaster.Email != studentMaster.Email)
                {
                    fieldValues.Add(StudentMasterEntity.Field.Email, studentMaster.Email);
                }
                if (oldStudentMaster.StuParent != studentMaster.StuParent)
                {
                    fieldValues.Add(StudentMasterEntity.Field.StuParent, studentMaster.StuParent);
                }

                if (fieldValues.Count > 0)
                {
                    fieldValues.Add(StudentMasterEntity.Field.MdyDate, DateTime.Now);

                    int count = 0;
                    result = _Factory.UpdateFields<StudentMasterEntity>(fieldValues, where, out count);
                    if (result.IsSuccess)
                    {
                        if (count < 1)
                        {
                            result = new Result(false, "更新學生基本資料失敗，資料不存在", ErrorCode.D_DATA_NOT_FOUND, null);
                        }
                        else
                        {
                            updateCount++;
                        }
                    }

                    #region 新增日誌資料
                    if (dbLogger != null)
                    {
                        string notation = null;
                        if (result.IsSuccess)
                        {
                            notation = String.Format("[{0}] {1}學生基本資料成功 ({2})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, studentMasterKey);
                        }
                        else
                        {
                            notation = String.Format("[{0}] {1}學生基本資料失敗 ({2}，錯誤訊息：{3})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, studentMasterKey, result.Message);
                        }
                        dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.UPDATE, commandAsker.UserId, notation);
                    }
                    #endregion
                }
            }
            #endregion

            #region 更新學生繳費單資料
            if (result.IsSuccess)
            {
                Expression where = new Expression(StudentReceiveEntity.Field.ReceiveType, studentReceive.ReceiveType)
                    .And(StudentReceiveEntity.Field.YearId, studentReceive.YearId)
                    .And(StudentReceiveEntity.Field.TermId, studentReceive.TermId)
                    .And(StudentReceiveEntity.Field.DepId, studentReceive.DepId)
                    .And(StudentReceiveEntity.Field.ReceiveId, studentReceive.ReceiveId)
                    .And(StudentReceiveEntity.Field.StuId, studentReceive.StuId)
                    .And(StudentReceiveEntity.Field.OldSeq, studentReceive.OldSeq);

                #region [MDY:20190906] (2019擴充案) 取消，因為非金額相關欄位要可更新
                //#region 加強更新條件，避免更新到已繳或已銷的資料
                //where.And(new Expression(StudentReceiveEntity.Field.ReceiveDate, null).Or(StudentReceiveEntity.Field.ReceiveDate, String.Empty));
                //where.And(new Expression(StudentReceiveEntity.Field.AccountDate, null).Or(StudentReceiveEntity.Field.AccountDate, String.Empty));
                //where.And(new Expression(StudentReceiveEntity.Field.ReceiveWay, null).Or(StudentReceiveEntity.Field.ReceiveWay, String.Empty));
                //#endregion
                #endregion

                KeyValueList fieldValues = new KeyValueList();

                #region [MDY:20191214] (2019擴充案) 國際信用卡 - 是否啟用國際信用卡繳費旗標
                if (oldStudentReceive.NCCardFlag != studentReceive.NCCardFlag)
                {
                    fieldValues.Add(StudentReceiveEntity.Field.NCCardFlag, studentReceive.NCCardFlag);
                }
                #endregion

                #region 部別、院別、科系、年級、班別、座號
                if (oldStudentReceive.DeptId != studentReceive.DeptId)
                {
                    fieldValues.Add(StudentReceiveEntity.Field.DeptId, studentReceive.DeptId);
                }
                if (oldStudentReceive.CollegeId != studentReceive.CollegeId)
                {
                    fieldValues.Add(StudentReceiveEntity.Field.CollegeId, studentReceive.CollegeId);
                }
                if (oldStudentReceive.MajorId != studentReceive.MajorId)
                {
                    fieldValues.Add(StudentReceiveEntity.Field.MajorId, studentReceive.MajorId);
                }
                if (oldStudentReceive.StuGrade != studentReceive.StuGrade)
                {
                    fieldValues.Add(StudentReceiveEntity.Field.StuGrade, studentReceive.StuGrade);
                }
                if (oldStudentReceive.ClassId != studentReceive.ClassId)
                {
                    fieldValues.Add(StudentReceiveEntity.Field.ClassId, studentReceive.ClassId);
                }
                if (oldStudentReceive.StuHid != studentReceive.StuHid)
                {
                    fieldValues.Add(StudentReceiveEntity.Field.StuHid, studentReceive.StuHid);
                }
                #endregion

                if (!isPayed)
                {
                    #region [MDY:20150201] 新增繳款期限
                    if (oldStudentReceive.PayDueDate != studentReceive.PayDueDate)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.PayDueDate, studentReceive.PayDueDate);
                    }
                    #endregion

                    #region 住宿、減免、就貸、身份註記 1 ~ 6
                    if (oldStudentReceive.DormId != studentReceive.DormId)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.DormId, studentReceive.DormId);
                    }
                    if (oldStudentReceive.ReduceId != studentReceive.ReduceId)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.ReduceId, studentReceive.ReduceId);
                    }
                    if (oldStudentReceive.LoanId != studentReceive.LoanId)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.LoanId, studentReceive.LoanId);
                    }
                    if (oldStudentReceive.IdentifyId01 != studentReceive.IdentifyId01)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.IdentifyId01, studentReceive.IdentifyId01);
                    }
                    if (oldStudentReceive.IdentifyId02 != studentReceive.IdentifyId02)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.IdentifyId02, studentReceive.IdentifyId02);
                    }
                    if (oldStudentReceive.IdentifyId03 != studentReceive.IdentifyId03)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.IdentifyId03, studentReceive.IdentifyId03);
                    }
                    if (oldStudentReceive.IdentifyId04 != studentReceive.IdentifyId04)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.IdentifyId04, studentReceive.IdentifyId04);
                    }
                    if (oldStudentReceive.IdentifyId05 != studentReceive.IdentifyId05)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.IdentifyId05, studentReceive.IdentifyId05);
                    }
                    if (oldStudentReceive.IdentifyId06 != studentReceive.IdentifyId06)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.IdentifyId06, studentReceive.IdentifyId06);
                    }
                    #endregion

                    #region 補單註記、計算方式、上傳就學貸款金額、可貸金額、學分數、上課時數
                    if (oldStudentReceive.ReissueFlag != studentReceive.ReissueFlag)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.ReissueFlag, studentReceive.ReissueFlag);
                    }
                    if (oldStudentReceive.BillingType != studentReceive.BillingType)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.BillingType, studentReceive.BillingType);
                    }
                    if (oldStudentReceive.Loan != studentReceive.Loan)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Loan, studentReceive.Loan);
                    }
                    if (oldStudentReceive.LoanAmount != studentReceive.LoanAmount)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.LoanAmount, studentReceive.LoanAmount);
                    }
                    if (oldStudentReceive.StuCredit != studentReceive.StuCredit)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.StuCredit, studentReceive.StuCredit);
                    }
                    if (oldStudentReceive.StuHour != studentReceive.StuHour)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.StuHour, studentReceive.StuHour);
                    }
                    #endregion

                    #region [MDY:20190906] (2019擴充案) 新增減免金額
                    if (oldStudentReceive.FeePayable != studentReceive.FeePayable)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.FeePayable, studentReceive.FeePayable);
                    }
                    #endregion

                    #region 收入科目金額
                    if (oldStudentReceive.Receive01 != studentReceive.Receive01)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive01, studentReceive.Receive01);
                    }
                    if (oldStudentReceive.Receive02 != studentReceive.Receive02)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive02, studentReceive.Receive02);
                    }
                    if (oldStudentReceive.Receive03 != studentReceive.Receive03)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive03, studentReceive.Receive03);
                    }
                    if (oldStudentReceive.Receive04 != studentReceive.Receive04)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive04, studentReceive.Receive04);
                    }
                    if (oldStudentReceive.Receive05 != studentReceive.Receive05)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive05, studentReceive.Receive05);
                    }
                    if (oldStudentReceive.Receive06 != studentReceive.Receive06)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive06, studentReceive.Receive06);
                    }
                    if (oldStudentReceive.Receive07 != studentReceive.Receive07)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive07, studentReceive.Receive07);
                    }
                    if (oldStudentReceive.Receive08 != studentReceive.Receive08)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive08, studentReceive.Receive08);
                    }
                    if (oldStudentReceive.Receive09 != studentReceive.Receive09)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive09, studentReceive.Receive09);
                    }
                    if (oldStudentReceive.Receive10 != studentReceive.Receive10)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive10, studentReceive.Receive10);
                    }

                    if (oldStudentReceive.Receive11 != studentReceive.Receive11)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive11, studentReceive.Receive11);
                    }
                    if (oldStudentReceive.Receive12 != studentReceive.Receive12)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive12, studentReceive.Receive12);
                    }
                    if (oldStudentReceive.Receive13 != studentReceive.Receive13)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive13, studentReceive.Receive13);
                    }
                    if (oldStudentReceive.Receive14 != studentReceive.Receive14)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive14, studentReceive.Receive14);
                    }
                    if (oldStudentReceive.Receive15 != studentReceive.Receive15)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive15, studentReceive.Receive15);
                    }
                    if (oldStudentReceive.Receive16 != studentReceive.Receive16)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive16, studentReceive.Receive16);
                    }
                    if (oldStudentReceive.Receive17 != studentReceive.Receive17)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive17, studentReceive.Receive17);
                    }
                    if (oldStudentReceive.Receive18 != studentReceive.Receive18)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive18, studentReceive.Receive18);
                    }
                    if (oldStudentReceive.Receive19 != studentReceive.Receive19)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive19, studentReceive.Receive19);
                    }
                    if (oldStudentReceive.Receive20 != studentReceive.Receive20)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive20, studentReceive.Receive20);
                    }

                    if (oldStudentReceive.Receive21 != studentReceive.Receive21)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive21, studentReceive.Receive21);
                    }
                    if (oldStudentReceive.Receive22 != studentReceive.Receive22)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive22, studentReceive.Receive22);
                    }
                    if (oldStudentReceive.Receive23 != studentReceive.Receive23)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive23, studentReceive.Receive23);
                    }
                    if (oldStudentReceive.Receive24 != studentReceive.Receive24)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive24, studentReceive.Receive24);
                    }
                    if (oldStudentReceive.Receive25 != studentReceive.Receive25)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive25, studentReceive.Receive25);
                    }
                    if (oldStudentReceive.Receive26 != studentReceive.Receive26)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive26, studentReceive.Receive26);
                    }
                    if (oldStudentReceive.Receive27 != studentReceive.Receive27)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive27, studentReceive.Receive27);
                    }
                    if (oldStudentReceive.Receive28 != studentReceive.Receive28)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive28, studentReceive.Receive28);
                    }
                    if (oldStudentReceive.Receive29 != studentReceive.Receive29)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive29, studentReceive.Receive29);
                    }
                    if (oldStudentReceive.Receive30 != studentReceive.Receive30)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive30, studentReceive.Receive30);
                    }

                    if (oldStudentReceive.Receive31 != studentReceive.Receive31)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive31, studentReceive.Receive31);
                    }
                    if (oldStudentReceive.Receive32 != studentReceive.Receive32)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive32, studentReceive.Receive32);
                    }
                    if (oldStudentReceive.Receive33 != studentReceive.Receive33)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive33, studentReceive.Receive33);
                    }
                    if (oldStudentReceive.Receive34 != studentReceive.Receive34)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive34, studentReceive.Receive34);
                    }
                    if (oldStudentReceive.Receive35 != studentReceive.Receive35)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive35, studentReceive.Receive35);
                    }
                    if (oldStudentReceive.Receive36 != studentReceive.Receive36)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive36, studentReceive.Receive36);
                    }
                    if (oldStudentReceive.Receive37 != studentReceive.Receive37)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive37, studentReceive.Receive37);
                    }
                    if (oldStudentReceive.Receive38 != studentReceive.Receive38)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive38, studentReceive.Receive38);
                    }
                    if (oldStudentReceive.Receive39 != studentReceive.Receive39)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive39, studentReceive.Receive39);
                    }
                    if (oldStudentReceive.Receive40 != studentReceive.Receive40)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Receive40, studentReceive.Receive40);
                    }
                    #endregion

                    #region 應繳金額、虛擬帳號、流水號、中信資料發送旗標、上傳資料註記相關
                    if (toGenCancelNo.Value || hasUploadCancelNo)
                    {
                        if (oldStudentReceive.CancelNo != studentReceive.CancelNo)
                        {
                            fieldValues.Add(StudentReceiveEntity.Field.CancelNo, studentReceive.CancelNo);
                        }
                        if (oldStudentReceive.CancelAtmno != studentReceive.CancelAtmno)
                        {
                            fieldValues.Add(StudentReceiveEntity.Field.CancelAtmno, studentReceive.CancelAtmno);
                        }
                        if (oldStudentReceive.CancelSmno != studentReceive.CancelSmno)
                        {
                            fieldValues.Add(StudentReceiveEntity.Field.CancelSmno, studentReceive.CancelSmno);
                        }

                        if (oldStudentReceive.ReceiveAmount != studentReceive.ReceiveAmount)
                        {
                            fieldValues.Add(StudentReceiveEntity.Field.ReceiveAmount, studentReceive.ReceiveAmount);
                        }
                        if (oldStudentReceive.ReceiveAtmamount != studentReceive.ReceiveAtmamount)
                        {
                            fieldValues.Add(StudentReceiveEntity.Field.ReceiveAtmamount, studentReceive.ReceiveAtmamount);
                        }
                        if (oldStudentReceive.ReceiveSmamount != studentReceive.ReceiveSmamount)
                        {
                            fieldValues.Add(StudentReceiveEntity.Field.ReceiveSmamount, studentReceive.ReceiveSmamount);
                        }

                        if (oldStudentReceive.SeriorNo != studentReceive.SeriorNo)
                        {
                            fieldValues.Add(StudentReceiveEntity.Field.SeriorNo, studentReceive.SeriorNo);
                        }
                        if (oldStudentReceive.CFlag != studentReceive.CFlag)
                        {
                            fieldValues.Add(StudentReceiveEntity.Field.CFlag, studentReceive.CFlag);
                        }
                        if (oldStudentReceive.Uploadflag != studentReceive.Uploadflag)
                        {
                            fieldValues.Add(StudentReceiveEntity.Field.Uploadflag, studentReceive.Uploadflag);
                        }
                    }
                    #endregion

                    #region 備註
                    if (oldStudentReceive.Memo01 != studentReceive.Memo01)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo01, studentReceive.Memo01);
                    }
                    if (oldStudentReceive.Memo02 != studentReceive.Memo02)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo02, studentReceive.Memo02);
                    }
                    if (oldStudentReceive.Memo03 != studentReceive.Memo03)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo03, studentReceive.Memo03);
                    }
                    if (oldStudentReceive.Memo04 != studentReceive.Memo04)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo04, studentReceive.Memo04);
                    }
                    if (oldStudentReceive.Memo05 != studentReceive.Memo05)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo05, studentReceive.Memo05);
                    }
                    if (oldStudentReceive.Memo06 != studentReceive.Memo06)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo06, studentReceive.Memo06);
                    }
                    if (oldStudentReceive.Memo07 != studentReceive.Memo07)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo07, studentReceive.Memo07);
                    }
                    if (oldStudentReceive.Memo08 != studentReceive.Memo08)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo08, studentReceive.Memo08);
                    }
                    if (oldStudentReceive.Memo09 != studentReceive.Memo09)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo09, studentReceive.Memo09);
                    }
                    if (oldStudentReceive.Memo10 != studentReceive.Memo10)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo10, studentReceive.Memo10);
                    }
                    if (oldStudentReceive.Memo11 != studentReceive.Memo11)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo11, studentReceive.Memo11);
                    }
                    if (oldStudentReceive.Memo12 != studentReceive.Memo12)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo12, studentReceive.Memo12);
                    }
                    if (oldStudentReceive.Memo13 != studentReceive.Memo13)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo13, studentReceive.Memo13);
                    }
                    if (oldStudentReceive.Memo14 != studentReceive.Memo14)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo14, studentReceive.Memo14);
                    }
                    if (oldStudentReceive.Memo15 != studentReceive.Memo15)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo15, studentReceive.Memo15);
                    }
                    if (oldStudentReceive.Memo16 != studentReceive.Memo16)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo16, studentReceive.Memo16);
                    }
                    if (oldStudentReceive.Memo17 != studentReceive.Memo17)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo17, studentReceive.Memo17);
                    }
                    if (oldStudentReceive.Memo18 != studentReceive.Memo18)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo18, studentReceive.Memo18);
                    }
                    if (oldStudentReceive.Memo19 != studentReceive.Memo19)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo19, studentReceive.Memo19);
                    }
                    if (oldStudentReceive.Memo20 != studentReceive.Memo20)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo20, studentReceive.Memo20);
                    }
                    if (oldStudentReceive.Memo21 != studentReceive.Memo21)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.Memo21, studentReceive.Memo21);
                    }
                    #endregion

                    #region 學生扣款轉帳資料
                    if (oldStudentReceive.DeductBankid != studentReceive.DeductBankid)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.DeductBankid, studentReceive.DeductBankid);
                    }
                    if (oldStudentReceive.DeductAccountno != studentReceive.DeductAccountno)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.DeductAccountno, studentReceive.DeductAccountno);
                    }
                    if (oldStudentReceive.DeductAccountname != studentReceive.DeductAccountname)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.DeductAccountname, studentReceive.DeductAccountname);
                    }
                    if (oldStudentReceive.DeductAccountid != studentReceive.DeductAccountid)
                    {
                        fieldValues.Add(StudentReceiveEntity.Field.DeductAccountid, studentReceive.DeductAccountid);
                    }
                    #endregion
                }

                if (fieldValues.Count > 0)
                {
                    fieldValues.Add(StudentReceiveEntity.Field.UpdateDate, DateTime.Now);

                    int count = 0;
                    result = _Factory.UpdateFields<StudentReceiveEntity>(fieldValues, where, out count);
                    if (result.IsSuccess)
                    {
                        if (count < 1)
                        {
                            result = new Result(false, "更新學生繳費單資料失敗，資料不存在", ErrorCode.D_DATA_NOT_FOUND, null);
                        }
                        else
                        {
                            updateCount++;
                        }
                    }

                    #region 新增日誌資料
                    if (dbLogger != null)
                    {
                        string notation = null;
                        if (result.IsSuccess)
                        {
                            notation = String.Format("[{0}] {1}學生繳費單資料成功 ({2})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, studentReceiveKey);
                        }
                        else
                        {
                            notation = String.Format("[{0}] {1}學生繳費單資料失敗 ({2}，錯誤訊息：{3})", commandAsker.FuncName, LogTypeCodeTexts.UPDATE_TEXT, studentReceiveKey, result.Message);
                        }
                        dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.UPDATE, commandAsker.UserId, notation);
                    }
                    #endregion
                }
            }
            #endregion

            if (result.IsSuccess && updateCount == 0)
            {
                result = new Result(false, "未異動任何資料，無須更新", CoreStatusCode.UNKNOWN_ERROR, null);
            }

            #region 回傳資料
            if (toReturnDatas.Value && result.IsSuccess)
            {
                KeyValueList<string> returnDatas = new KeyValueList<string>(4);

                #region 代收費用檔
                if (schoolRid != null)
                {
                    string xml = null;
                    if (!Common.TryToXmlExplicitly<SchoolRidEntity>(schoolRid, out xml))
                    {
                        result = new Result(false, "資料已更新，但回傳代收費用檔資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                    }
                    returnDatas.Add(SchoolRidEntity.TABLE_NAME, xml);
                }
                #endregion

                #region 學生基本資料
                {
                    StudentMasterEntity newStudentMaster = null;
                    Expression where = new Expression(StudentMasterEntity.Field.ReceiveType, studentMaster.ReceiveType)
                        .And(StudentMasterEntity.Field.DepId, studentMaster.DepId)
                        .And(StudentMasterEntity.Field.Id, studentMaster.Id);
                    Result result2 = _Factory.SelectFirst<StudentMasterEntity>(where, null, out newStudentMaster);
                    if (result2.IsSuccess)
                    {
                        string xml = null;
                        if (!Common.TryToXmlExplicitly<StudentMasterEntity>(newStudentMaster, out xml))
                        {
                            result = new Result(false, "資料已更新，但回傳學生基本資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                        returnDatas.Add(StudentMasterEntity.TABLE_NAME, xml);
                    }
                    else
                    {
                        result = new Result(false, "資料已更新，但讀取更新後的學生基本資料失敗，" + result2.Message, result2.Code, result2.Exception);
                    }
                }
                #endregion

                #region 學生繳費單資料
                {
                    StudentReceiveEntity newStudentReceive = null;
                    Expression where = new Expression(StudentReceiveEntity.Field.ReceiveType, studentReceive.ReceiveType)
                        .And(StudentReceiveEntity.Field.YearId, studentReceive.YearId)
                        .And(StudentReceiveEntity.Field.TermId, studentReceive.TermId)
                        .And(StudentReceiveEntity.Field.DepId, studentReceive.DepId)
                        .And(StudentReceiveEntity.Field.ReceiveId, studentReceive.ReceiveId)
                        .And(StudentReceiveEntity.Field.StuId, studentReceive.StuId)
                        .And(StudentReceiveEntity.Field.OldSeq, studentReceive.OldSeq);
                    Result result2 = _Factory.SelectFirst<StudentReceiveEntity>(where, null, out newStudentReceive);
                    if (result2.IsSuccess)
                    {
                        string xml = null;
                        if (!Common.TryToXmlExplicitly<StudentReceiveEntity>(newStudentReceive, out xml))
                        {
                            result = new Result(false, "學生繳費單資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                        }
                        returnDatas.Add(StudentReceiveEntity.TABLE_NAME, xml);
                    }
                    else
                    {
                        result = new Result(false, "資料已更新，但讀取更新後的學生繳費單資料失敗，" + result2.Message, result2.Code, result2.Exception);
                    }
                }
                #endregion

                #region 合計項目設定
                if (receiveSums != null && receiveSums.Length > 0)
                {
                    string xml = null;
                    if (!Common.TryToXmlExplicitly<ReceiveSumEntity[]>(receiveSums, out xml))
                    {
                        result = new Result(false, "資料已更新，但回傳合計項目設定資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                    }
                    returnDatas.Add(ReceiveSumEntity.TABLE_NAME, xml);
                }
                #endregion

                #region 學生就貸資料
                if (studentLoan != null)
                {
                    string xml = null;
                    if (!Common.TryToXmlExplicitly<StudentLoanEntity>(studentLoan, out xml))
                    {
                        result = new Result(false, "資料已更新，但回傳學生就貸資料無法序列化", ErrorCode.S_SERIALIZED_FAILURE, null);
                    }
                    returnDatas.Add(StudentLoanEntity.TABLE_NAME, xml);
                }
                #endregion

                rtnData = returnDatas.ToArray();
            }
            #endregion

            #region Release DBLogger
            if (dbLogger != null)
            {
                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            return result;
        }
        #endregion

        #region [MDY:20190226] 匯出異業代收款檔資料檔
        /// <summary>
        /// 匯出異業代收款檔資料檔
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="rtnData"></param>
        /// <returns></returns>
        public Result ExportEDPData(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string qEDPChannelId = null;
            string qReceiveType = null;
            DateTime? qSDate = null;
            DateTime? qEDate = null;
            string fileType = null;

            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "EDPCHANNELID":
                        #region 異業管道代碼
                        if (!String.IsNullOrWhiteSpace(argument.Value))
                        {
                            qEDPChannelId = argument.Value.Trim();
                        }
                        #endregion
                        break;
                    case "RECEIVETYPE":
                        #region 商家代號
                        if (!String.IsNullOrWhiteSpace(argument.Value))
                        {
                            qReceiveType = argument.Value.Trim();
                        }
                        #endregion
                        break;
                    case "SDATE":
                        #region 中信帳務處理日區間-起日
                        {
                            DateTime date;
                            if (!String.IsNullOrWhiteSpace(argument.Value) && DateTime.TryParse(argument.Value, out date))
                            {
                                qSDate = date;
                            }
                        }
                        #endregion
                        break;
                    case "EDATE":
                        #region 中信帳務處理日區間-訖日
                        {
                            DateTime date;
                            if (!String.IsNullOrWhiteSpace(argument.Value) && DateTime.TryParse(argument.Value, out date))
                            {
                                qEDate = date;
                            }
                        }
                        #endregion
                        break;
                    case "FILETYPE":
                        #region 檔案格式
                        if (!String.IsNullOrWhiteSpace(argument.Value))
                        {
                            fileType = argument.Value.Trim().ToUpper();
                        }
                        #endregion
                        break;
                }
            }

            if (String.IsNullOrEmpty(qEDPChannelId)           //必要參數且不可為空字串
                || String.IsNullOrEmpty(qReceiveType)         //必要參數且不可為空字串
                || !qSDate.HasValue                           //必要參數
                || !qEDate.HasValue                           //必要參數
                || (fileType != "XLS" && fileType != "ODS"))
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 判斷 qEDPChannelId
            string funcName = null;
            switch (qEDPChannelId)
            {
                case "CNTRUST":
                    funcName = "中國信託繳費資料";
                    break;

                #region [MARK] 目前只提供中國信託
                //case "7111111":
                //    funcName = "統一超商繳費資料";
                //    break;
                //case "TFM":
                //    funcName = "全家超商繳費資料";
                //    break;
                //case "OKCVS":
                //    funcName = "OK超商繳費資料";
                //    break;
                //case "HILIFE":
                //    funcName = "萊爾富超商繳費資料";
                //    break;
                //case "CREDIT":
                //    funcName = "財金信用卡繳費資料";
                //    break;
                #endregion
                default:
                    return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 匯出資料檔
            byte[] outFileContent = null;
            string errmsg = null;
            using (ExportFileHelper helper = new ExportFileHelper(null, this.TempPath))
            {
                errmsg = helper.ExportEDPData(qEDPChannelId, qReceiveType, qSDate.Value, qEDate.Value, fileType, out outFileContent);
            }
            #endregion

            #region 新增日誌資料
            if (dbLogger != null)
            {
                string notation = null;
                if (String.IsNullOrEmpty(errmsg))
                {
                    notation = String.Format("[{0}] 匯出{1}成功", commandAsker.FuncName, funcName);
                }
                else
                {
                    notation = String.Format("[{0}] 匯出{1}失敗 (錯誤訊息：{2})", commandAsker.FuncName, funcName, errmsg);
                }
                dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);

                string logErrmsg = this.ReleaseDBLogger(true);
                dbLogger.Dispose();
                dbLogger = null;
            }
            #endregion

            if (String.IsNullOrEmpty(errmsg))
            {
                rtnData = outFileContent;
                return new Result(true, String.Empty, ErrorCode.NORMAL_STATUS, null);
            }
            else
            {
                return new Result(false, errmsg, CoreStatusCode.UNKNOWN_ERROR, null);
            }
        }
        #endregion

        #region [MDY:20191014] M201910_01 (2019擴充案+小修正) 產生測試繳款單
        public Result GenSMBarcodePDF(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string receiveType = null;
            string channelId = null;
            string barcodeId = null;
            Int32? dataCount = null;
            Int32? billFormId = null;
            DateTime? payDueDate = null;

            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        #region 商家代號
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        #endregion
                        break;
                    case "CHANNELID":
                        #region 管道代碼
                        channelId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        #endregion
                        break;
                    case "BARCODEID":
                        #region 手序費代碼
                        barcodeId = argument.Value == null ? String.Empty : argument.Value.Trim();
                        #endregion
                        break;
                    case "DATACOUNT":
                        #region 產生張數
                        {
                            Int32 value;
                            if (!String.IsNullOrWhiteSpace(argument.Value) && Int32.TryParse(argument.Value, out value))
                            {
                                dataCount = value;
                            }
                        }
                        #endregion
                        break;
                    case "BILLFORMID":
                        #region 繳費單模板編號
                        {
                            Int32 value = 0;
                            if (!String.IsNullOrWhiteSpace(argument.Value) && Int32.TryParse(argument.Value, out value))
                            {
                                billFormId = value;
                            }
                        }
                        #endregion
                        break;
                    case "PAYDUEDATE":
                        #region 繳款期限
                        {
                            DateTime date;
                            if (!String.IsNullOrWhiteSpace(argument.Value) && DateTime.TryParse(argument.Value, out date))
                            {
                                payDueDate = date;
                            }
                        }
                        #endregion
                        break;
                }
            }

            if (String.IsNullOrEmpty(receiveType)          //必要參數且不可為空字串
                || String.IsNullOrEmpty(channelId)         //必要參數且不可為空字串
                || String.IsNullOrEmpty(barcodeId)         //必要參數且不可為空字串
                || !dataCount.HasValue || dataCount.Value < 1 || dataCount.Value > 99    //必要參數且 1 ~ 99
                || !billFormId.HasValue || billFormId.Value <= 0    //必要參數且必須大於 0
                || !payDueDate.HasValue)                   //必要參數
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region [TMP] 取得初始化的資料庫日誌記錄器 (暫時不要記錄這類查詢 Log)
            //DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region [OLD]
            //#region 取得商家代號資料
            //SchoolRTypeEntity schoolData = null;
            //{
            //    Expression where = new Expression(SchoolRTypeEntity.Field.ReceiveType, receiveType);
            //    Result result = _Factory.SelectFirst<SchoolRTypeEntity>(where, null, out schoolData);
            //    if (result.IsSuccess && schoolData == null)
            //    {
            //        result = new Result(false, "查無商家代號資料", CoreStatusCode.S_SELECT_DATA_FAILURE, null);
            //    }

            //    #region [TMP] 新增日誌資料 (暫時不要記錄這類查詢 Log)
            //    //if (dbLogger != null)
            //    //{
            //    //    string notation = null;
            //    //    if (result.IsSuccess)
            //    //    {
            //    //        notation = String.Format("[{0}] {1}商家代號資料成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
            //    //    }
            //    //    else
            //    //    {
            //    //        notation = String.Format("[{0}] {1}商家代號資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
            //    //    }
            //    //    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
            //    //}
            //    #endregion

            //    if (!result.IsSuccess)
            //    {
            //        if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
            //        {
            //            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
            //        }
            //        else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
            //        {
            //            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
            //        }
            //        return result;
            //    }
            //}
            //#endregion

            //#region 取得商家代號管道手續費設定資料
            //ReceiveChannelEntity channelData = null;
            //{
            //    Expression where = new Expression(ReceiveChannelEntity.Field.ReceiveType, receiveType)
            //        .And(ReceiveChannelEntity.Field.ChannelId, channelId)
            //        .And(ReceiveChannelEntity.Field.BarcodeId, barcodeId);
            //    Result result = _Factory.SelectFirst<ReceiveChannelEntity>(where, null, out channelData);
            //    if (result.IsSuccess && channelData == null)
            //    {
            //        result = new Result(false, "查無商家代號管道手續費設定資料", CoreStatusCode.S_SELECT_DATA_FAILURE, null);
            //    }

            //    #region [TMP] 新增日誌資料 (暫時不要記錄這類查詢 Log)
            //    //if (dbLogger != null)
            //    //{
            //    //    string notation = null;
            //    //    if (result.IsSuccess)
            //    //    {
            //    //        notation = String.Format("[{0}] {1}商家代號管道手續費設定資料成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
            //    //    }
            //    //    else
            //    //    {
            //    //        notation = String.Format("[{0}] {1}商家代號管道手續費設定資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
            //    //    }
            //    //    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
            //    //}
            //    #endregion

            //    if (!result.IsSuccess)
            //    {
            //        if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
            //        {
            //            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
            //        }
            //        else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
            //        {
            //            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
            //        }
            //        return result;
            //    }
            //}
            //#endregion

            //#region 取得模板檔
            //byte[] templetContent = null;
            //{
            //    string sql = String.Format(@"SELECT [{0}] FROM [{1}] WHERE  [{2}] = @BillFormType AND [{3}] = @BillFormId"
            //        , BillFormEntity.Field.BillFormImage
            //        , BillFormEntity.TABLE_NAME
            //        , BillFormEntity.Field.BillFormType
            //        , BillFormEntity.Field.BillFormId);
            //    KeyValueList parameters = new KeyValueList(2);
            //    parameters.Add("@BillFormType", BillFormTypeCodeTexts.BILLING);
            //    parameters.Add("@BillFormId", billFormId);

            //    object value = null;
            //    Result result = _Factory.ExecuteScalar(sql, parameters, out value);
            //    if (result.IsSuccess)
            //    {
            //        templetContent = value as byte[];
            //        if (templetContent == null || templetContent.Length == 0)
            //        {
            //            result = new Result(false, "查無繳費單模板資料", CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
            //        }
            //    }

            //    #region [TMP] 新增日誌資料 (暫時不要記錄這類查詢 Log)
            //    //if (dbLogger != null)
            //    //{
            //    //    string notation = null;
            //    //    if (result.IsSuccess)
            //    //    {
            //    //        notation = String.Format("[{0}] {1}繳費單模板資料成功", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT);
            //    //    }
            //    //    else
            //    //    {
            //    //        notation = String.Format("[{0}] {1}繳費單模板資料失敗 (錯誤訊息：{2})", commandAsker.FuncName, LogTypeCodeTexts.SELECT_TEXT, result.Message);
            //    //    }
            //    //    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.SELECT, commandAsker.UserId, notation);
            //    //}
            //    #endregion

            //    if (!result.IsSuccess)
            //    {
            //        if (result.Code == CoreStatusCode.UNKNOWN_EXCEPTION)
            //        {
            //            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.E_SELECT_DATA_EXCEPTION, result.Exception);
            //        }
            //        else if (result.Code == CoreStatusCode.UNKNOWN_ERROR)
            //        {
            //            result = new Result(result.IsSuccess, result.Message, CoreStatusCode.S_SELECT_DATA_FAILURE, result.Exception);
            //        }
            //        return result;
            //    }
            //}
            //#endregion
            #endregion

            #region 產生 PDF
            {
                byte[] outPDFContent = null;
                GenPDFHelper helper = new GenPDFHelper();
                Result result = helper.GenSMBarcodePDF(_Factory, receiveType, channelId, barcodeId, dataCount.Value, billFormId.Value, payDueDate.Value, this.TempPath, out outPDFContent);

                if (result.IsSuccess)
                {
                    try
                    {
                        if (outPDFContent == null || outPDFContent.Length == 0)
                        {
                            result = new Result(false, "無法讀取產生的 PDF 檔，檔案無內容", CoreStatusCode.UNKNOWN_ERROR, null);
                        }
                        else
                        {
                            rtnData = outPDFContent;
                        }
                    }
                    catch (Exception ex)
                    {
                        result = new Result(false, "讀取產生的 PDF 檔失敗，錯誤訊息：" + ex.Message, CoreStatusCode.UNKNOWN_EXCEPTION, ex);
                    }
                }
                return result;
            }
            #endregion

            #region [TMP] 儲存日誌資料並釋放資料庫日誌記錄器 (暫時不要記錄這類查詢 Log)
            //if (dbLogger != null)
            //{
            //    string logErrmsg = this.ReleaseDBLogger(true);
            //    dbLogger.Dispose();
            //    dbLogger = null;
            //}
            #endregion
        }
        #endregion

        #region [MDY:202203XX] 2022擴充案 取得商家代號是否啟用英文資料
        /// <summary>
        /// 取得指定商家代號是否啟用英文資料
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="rtnData"></param>
        /// <returns></returns>
        public Result GetReceiveTypeEngEabled(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string receiveType = null;

            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVETYPE":
                        #region 商家代號
                        receiveType = argument.Value == null ? String.Empty : argument.Value.Trim();
                        #endregion
                        break;
                }
            }

            if (String.IsNullOrEmpty(receiveType))          //必要參數且不可為空字串
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            Result result = null;

            #region [TMP] 取得初始化的資料庫日誌記錄器 (暫時不要記錄這類查詢 Log)
            //DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 取資料
            {
                string sql = $@"
SELECT ISNULL({SchoolRTypeEntity.Field.EngEnabled}, 'N') AS EngEnabled
  FROM {SchoolRTypeEntity.TABLE_NAME}
  WHERE {SchoolRTypeEntity.Field.ReceiveType} = @RECEIVE_TYPE".Trim();
                KeyValue[] parameters = new KeyValue[1]
                {
                    new KeyValue("@RECEIVE_TYPE", receiveType)
                };
                object value = null;
                result = _Factory.ExecuteScalar(sql, parameters, out value);
                if (result.IsSuccess)
                {
                    rtnData = "Y".Equals((value as string), StringComparison.InvariantCultureIgnoreCase) ? "Y" : "N";
                }
            }
            #endregion

            #region [TMP] 儲存日誌資料並釋放資料庫日誌記錄器 (暫時不要記錄這類查詢 Log)
            //if (dbLogger != null)
            //{
            //    string logErrmsg = this.ReleaseDBLogger(true);
            //    dbLogger.Dispose();
            //    dbLogger = null;
            //}
            #endregion

            return result;
        }
        #endregion

        #region [MDY:202203XX] 2022擴充案 學生專區取得繳費單相關
        /// <summary>
        /// 學生專區取得指定學號的繳費單清單
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="rtnData"></param>
        /// <returns></returns>
        public Result GetStudentReceiveViews(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string studentId = null;
            string[] receiveTypes = null;
            bool? isEngUI = null;

            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "STUDENT_ID":
                        #region 學號
                        if (!String.IsNullOrWhiteSpace(argument.Value))
                        {
                            studentId = argument.Value.Trim();
                        }
                        #endregion
                        break;
                    case "RECEIVE_TYPES":
                        #region 商家代號清單
                        if (!String.IsNullOrWhiteSpace(argument.Value))
                        {
                            receiveTypes = argument.Value.Replace(" ", "").Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
                        }
                        #endregion
                        break;
                    case "IS_ENG_UI":
                        #region 是否英文介面
                        if ("Y".Equals(argument.Value))
                        {
                            isEngUI = true;
                        }
                        else if ("N".Equals(argument.Value))
                        {
                            isEngUI = false;
                        }
                        #endregion
                        break;
                }
            }

            //必要參數
            if (String.IsNullOrEmpty(studentId)
                || (receiveTypes == null || receiveTypes.Length == 0)
                || !isEngUI.HasValue)
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region [TMP] 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 取資料
            {
                #region 組 SQL
                KeyValueList parameters = new KeyValueList(receiveTypes.Length + 1);

                parameters.Add("@STUDENT_ID", studentId);

                foreach (string receiveType in receiveTypes)
                {
                    parameters.Add($"@RECEIVE_TYPE_{parameters.Count}", receiveType);
                }
                string receiveTypeSql = String.Join(",", parameters.Keys, 1, receiveTypes.Length);

                parameters.Add("@OPEN_DATE8", Common.GetDate8(DateTime.Today));

                //不取未到「開放列印日」的資料
                string sql = null;
                if (isEngUI.Value)
                {
                    sql = $@"
SELECT SR.*
     , ISNULL(RI.[Bill_Valid_Date], '')    AS [Bill_Valid_Date]
     , ISNULL(RI.[Bill_Close_Date], '')    AS [Bill_Close_Date]
     , ISNULL(RI.[Invoice_Close_Date], '') AS [Invoice_Close_Date]
     , ISNULL(RI.[Pay_Date], '')           AS [Pay_Due_Date1]
     , ISNULL(RI.[Pay_Due_Date2], '')      AS [Pay_Due_Date2]
     , ISNULL(RI.[Pay_Due_Date3], '')      AS [Pay_Due_Date3]
     , ISNULL((SELECT [Stu_Name] FROM [{StudentMasterEntity.TABLE_NAME}] AS SM WHERE SM.[Receive_Type] = SR.[Receive_Type] AND SM.[Dep_Id] = SR.[Dep_Id] AND SM.[Stu_Id] = SR.[Stu_Id]), '') AS [Stu_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Year_EName],     [Year_Name])     ELSE [Year_Name]     END) FROM [Year_List]      AS YL  WHERE YL.[Year_Id]       = SR.[Year_Id]), '' ) AS [Year_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Term_EName],     [Term_Name])     ELSE [Term_Name]     END) FROM [Term_List]      AS TL  WHERE TL.[Receive_Type]  = SR.[Receive_Type] AND TL.[Year_Id]  = SR.[Year_Id] AND TL.[Term_Id]  = SR.[Term_Id]), '')                                                                            AS [Term_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Dept_EName],     [Dept_Name])     ELSE [Dept_Name]     END) FROM [Dept_List]      AS DTL WHERE DTL.[Receive_Type] = SR.[Receive_Type] AND DTL.[Year_Id] = SR.[Year_Id] AND DTL.[Term_Id] = SR.[Term_Id] AND DTL.[Dept_Id] = SR.[Dept_Id]), '')                                           AS [Dept_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Receive_EName],  [Receive_Name])  ELSE [Receive_Name]  END) FROM [Receive_List]   AS RL  WHERE RL.[Receive_Type]  = SR.[Receive_Type] AND RL.[Year_Id]  = SR.[Year_Id] AND RL.[Term_Id]  = SR.[Term_Id] AND RL.[Dep_Id]   = SR.[Dep_Id] AND RL.[Receive_Id]   = SR.[Receive_Id]), '')    AS [Receive_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([College_EName],  [College_Name])  ELSE [College_Name]  END) FROM [College_List]   AS CL  WHERE CL.[Receive_Type]  = SR.[Receive_Type] AND CL.[Year_Id]  = SR.[Year_Id] AND CL.[Term_Id]  = SR.[Term_Id] AND CL.[Dep_Id]   = SR.[Dep_Id] AND CL.[College_Id]   = SR.[College_Id]), '')    AS [College_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Major_EName],    [Major_Name])    ELSE [Major_Name]    END) FROM [Major_List]     AS ML  WHERE ML.[Receive_Type]  = SR.[Receive_Type] AND ML.[Year_Id]  = SR.[Year_Id] AND ML.[Term_Id]  = SR.[Term_Id] AND ML.[Dep_Id]   = SR.[Dep_Id] AND ML.[Major_Id]     = SR.[Major_Id]), '')      AS [Major_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Class_EName],    [Class_Name])    ELSE [Class_Name]    END) FROM [Class_List]     AS CL  WHERE CL.[Receive_Type]  = SR.[Receive_Type] AND CL.[Year_Id]  = SR.[Year_Id] AND CL.[Term_Id]  = SR.[Term_Id] AND CL.[Dep_Id]   = SR.[Dep_Id] AND CL.[Class_Id]     = SR.[Class_Id]), '')      AS [Class_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Reduce_EName],   [Reduce_Name])   ELSE [Reduce_Name]   END) FROM [Reduce_List]    AS RL  WHERE RL.[Receive_Type]  = SR.[Receive_Type] AND RL.[Year_Id]  = SR.[Year_Id] AND RL.[Term_Id]  = SR.[Term_Id] AND RL.[Dep_Id]   = SR.[Dep_Id] AND RL.[Reduce_Id]    = SR.[Reduce_Id]), '')     AS [Reduce_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Dorm_EName],     [Dorm_Name])     ELSE [Dorm_Name]     END) FROM [Dorm_List]      AS DL  WHERE DL.[Receive_Type]  = SR.[Receive_Type] AND DL.[Year_Id]  = SR.[Year_Id] AND DL.[Term_Id]  = SR.[Term_Id] AND DL.[Dep_Id]   = SR.[Dep_Id] AND DL.[Dorm_Id]      = SR.[Dorm_Id]), '')       AS [Dorm_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Loan_EName],     [Loan_Name])     ELSE [Loan_Name]     END) FROM [Loan_List]      AS LL  WHERE LL.[Receive_Type]  = SR.[Receive_Type] AND LL.[Year_Id]  = SR.[Year_Id] AND LL.[Term_Id]  = SR.[Term_Id] AND LL.[Dep_Id]   = SR.[Dep_Id] AND LL.[Loan_Id]      = SR.[Loan_Id]), '')       AS [Loan_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Identify_EName], [Identify_Name]) ELSE [Identify_Name] END) FROM [Identify_List1] AS IL1 WHERE IL1.[Receive_Type] = SR.[Receive_Type] AND IL1.[Year_Id] = SR.[Year_Id] AND IL1.[Term_Id] = SR.[Term_Id] AND IL1.[Dep_Id]  = SR.[Dep_Id] AND IL1.[Identify_Id] = SR.[Identify_Id01]), '') AS [Identify_Name01]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Identify_EName], [Identify_Name]) ELSE [Identify_Name] END) FROM [Identify_List2] AS IL2 WHERE IL2.[Receive_Type] = SR.[Receive_Type] AND IL2.[Year_Id] = SR.[Year_Id] AND IL2.[Term_Id] = SR.[Term_Id] AND IL2.[Dep_Id]  = SR.[Dep_Id] AND IL2.[Identify_Id] = SR.[Identify_Id02]), '') AS [Identify_Name02]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Identify_EName], [Identify_Name]) ELSE [Identify_Name] END) FROM [Identify_List3] AS IL3 WHERE IL3.[Receive_Type] = SR.[Receive_Type] AND IL3.[Year_Id] = SR.[Year_Id] AND IL3.[Term_Id] = SR.[Term_Id] AND IL3.[Dep_Id]  = SR.[Dep_Id] AND IL3.[Identify_Id] = SR.[Identify_Id03]), '') AS [Identify_Name03]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Identify_EName], [Identify_Name]) ELSE [Identify_Name] END) FROM [Identify_List4] AS IL4 WHERE IL4.[Receive_Type] = SR.[Receive_Type] AND IL4.[Year_Id] = SR.[Year_Id] AND IL4.[Term_Id] = SR.[Term_Id] AND IL4.[Dep_Id]  = SR.[Dep_Id] AND IL4.[Identify_Id] = SR.[Identify_Id04]), '') AS [Identify_Name04]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Identify_EName], [Identify_Name]) ELSE [Identify_Name] END) FROM [Identify_List5] AS IL5 WHERE IL5.[Receive_Type] = SR.[Receive_Type] AND IL5.[Year_Id] = SR.[Year_Id] AND IL5.[Term_Id] = SR.[Term_Id] AND IL5.[Dep_Id]  = SR.[Dep_Id] AND IL5.[Identify_Id] = SR.[Identify_Id05]), '') AS [Identify_Name05]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Identify_EName], [Identify_Name]) ELSE [Identify_Name] END) FROM [Identify_List6] AS IL6 WHERE IL6.[Receive_Type] = SR.[Receive_Type] AND IL6.[Year_Id] = SR.[Year_Id] AND IL6.[Term_Id] = SR.[Term_Id] AND IL6.[Dep_Id]  = SR.[Dep_Id] AND IL6.[Identify_Id] = SR.[Identify_Id06]), '') AS [Identify_Name06]
     , ISNULL((SELECT [Channel_Name] FROM [{ChannelSetEntity.TABLE_NAME}] AS CS WHERE CS.[Channel_Id] = SR.[Receive_Way]), '') AS [Receive_Way_Name]
  FROM [{StudentReceiveEntity.TABLE_NAME}] AS SR
  LEFT JOIN [{SchoolRidEntity.TABLE_NAME}] AS RI ON RI.[Receive_Type] = SR.[Receive_Type] AND RI.[Year_Id] = SR.[Year_Id] AND RI.[Term_Id] = SR.[Term_Id] AND RI.[Dep_Id] = SR.[Dep_Id] AND RI.[Receive_Id] = SR.[Receive_Id]
  LEFT JOIN [{SchoolRTypeEntity.TABLE_NAME}] AS SC ON SC.[Receive_Type] = SR.[Receive_Type]
 WHERE SR.[Stu_Id] = @STUDENT_ID AND SR.[Receive_Type] IN ({receiveTypeSql})
   AND RI.[Bill_Valid_Date] <= @OPEN_DATE8
 ORDER BY SR.[Year_Id] DESC, SR.[Term_Id] DESC, SR.[Receive_Id], SR.[create_date] DESC, SR.[Old_Seq] DESC".Trim();
                }
                else
                {
                    sql = $@"
SELECT SR.*
     , ISNULL(RI.[Bill_Valid_Date], '')    AS [Bill_Valid_Date]
     , ISNULL(RI.[Bill_Close_Date], '')    AS [Bill_Close_Date]
     , ISNULL(RI.[Invoice_Close_Date], '') AS [Invoice_Close_Date]
     , ISNULL(RI.[Pay_Date], '')           AS [Pay_Due_Date1]
     , ISNULL(RI.[Pay_Due_Date2], '')      AS [Pay_Due_Date2]
     , ISNULL(RI.[Pay_Due_Date3], '')      AS [Pay_Due_Date3]
     , ISNULL((SELECT [Stu_Name] FROM [{StudentMasterEntity.TABLE_NAME}] AS SM WHERE SM.[Receive_Type] = SR.[Receive_Type] AND SM.[Dep_Id] = SR.[Dep_Id] AND SM.[Stu_Id] = SR.[Stu_Id]), '') AS [Stu_Name]
     , ISNULL((SELECT [Year_Name]     FROM [Year_List]      AS YL  WHERE YL.[Year_Id]       = SR.[Year_Id]), '') AS [Year_Name]
     , ISNULL((SELECT [Term_Name]     FROM [Term_List]      AS TL  WHERE TL.[Receive_Type]  = SR.[Receive_Type] AND TL.[Year_Id]  = SR.[Year_Id] AND TL.[Term_Id]  = SR.[Term_Id]), '')                                                                            AS [Term_Name]
     , ISNULL((SELECT [Dept_Name]     FROM [Dept_List]      AS DTL WHERE DTL.[Receive_Type] = SR.[Receive_Type] AND DTL.[Year_Id] = SR.[Year_Id] AND DTL.[Term_Id] = SR.[Term_Id] AND DTL.[Dept_Id] = SR.[Dept_Id]), '')                                           AS [Dept_Name]
     , ISNULL((SELECT [Receive_Name]  FROM [Receive_List]   AS RL  WHERE RL.[Receive_Type]  = SR.[Receive_Type] AND RL.[Year_Id]  = SR.[Year_Id] AND RL.[Term_Id]  = SR.[Term_Id] AND RL.[Dep_Id]   = SR.[Dep_Id] AND RL.[Receive_Id]   = SR.[Receive_Id]), '')    AS [Receive_Name]
     , ISNULL((SELECT [College_Name]  FROM [College_List]   AS CL  WHERE CL.[Receive_Type]  = SR.[Receive_Type] AND CL.[Year_Id]  = SR.[Year_Id] AND CL.[Term_Id]  = SR.[Term_Id] AND CL.[Dep_Id]   = SR.[Dep_Id] AND CL.[College_Id]   = SR.[College_Id]), '')    AS [College_Name]
     , ISNULL((SELECT [Major_Name]    FROM [Major_List]     AS ML  WHERE ML.[Receive_Type]  = SR.[Receive_Type] AND ML.[Year_Id]  = SR.[Year_Id] AND ML.[Term_Id]  = SR.[Term_Id] AND ML.[Dep_Id]   = SR.[Dep_Id] AND ML.[Major_Id]     = SR.[Major_Id]), '')      AS [Major_Name]
     , ISNULL((SELECT [Class_Name]    FROM [Class_List]     AS CL  WHERE CL.[Receive_Type]  = SR.[Receive_Type] AND CL.[Year_Id]  = SR.[Year_Id] AND CL.[Term_Id]  = SR.[Term_Id] AND CL.[Dep_Id]   = SR.[Dep_Id] AND CL.[Class_Id]     = SR.[Class_Id]), '')      AS [Class_Name]
     , ISNULL((SELECT [Reduce_Name]   FROM [Reduce_List]    AS RL  WHERE RL.[Receive_Type]  = SR.[Receive_Type] AND RL.[Year_Id]  = SR.[Year_Id] AND RL.[Term_Id]  = SR.[Term_Id] AND RL.[Dep_Id]   = SR.[Dep_Id] AND RL.[Reduce_Id]    = SR.[Reduce_Id]), '')     AS [Reduce_Name]
     , ISNULL((SELECT [Dorm_Name]     FROM [Dorm_List]      AS DL  WHERE DL.[Receive_Type]  = SR.[Receive_Type] AND DL.[Year_Id]  = SR.[Year_Id] AND DL.[Term_Id]  = SR.[Term_Id] AND DL.[Dep_Id]   = SR.[Dep_Id] AND DL.[Dorm_Id]      = SR.[Dorm_Id]), '')       AS [Dorm_Name]
     , ISNULL((SELECT [Loan_Name]     FROM [Loan_List]      AS LL  WHERE LL.[Receive_Type]  = SR.[Receive_Type] AND LL.[Year_Id]  = SR.[Year_Id] AND LL.[Term_Id]  = SR.[Term_Id] AND LL.[Dep_Id]   = SR.[Dep_Id] AND LL.[Loan_Id]      = SR.[Loan_Id]), '')       AS [Loan_Name]
     , ISNULL((SELECT [Identify_Name] FROM [Identify_List1] AS IL1 WHERE IL1.[Receive_Type] = SR.[Receive_Type] AND IL1.[Year_Id] = SR.[Year_Id] AND IL1.[Term_Id] = SR.[Term_Id] AND IL1.[Dep_Id]  = SR.[Dep_Id] AND IL1.[Identify_Id] = SR.[Identify_Id01]), '') AS [Identify_Name01]
     , ISNULL((SELECT [Identify_Name] FROM [Identify_List2] AS IL2 WHERE IL2.[Receive_Type] = SR.[Receive_Type] AND IL2.[Year_Id] = SR.[Year_Id] AND IL2.[Term_Id] = SR.[Term_Id] AND IL2.[Dep_Id]  = SR.[Dep_Id] AND IL2.[Identify_Id] = SR.[Identify_Id02]), '') AS [Identify_Name02]
     , ISNULL((SELECT [Identify_Name] FROM [Identify_List3] AS IL3 WHERE IL3.[Receive_Type] = SR.[Receive_Type] AND IL3.[Year_Id] = SR.[Year_Id] AND IL3.[Term_Id] = SR.[Term_Id] AND IL3.[Dep_Id]  = SR.[Dep_Id] AND IL3.[Identify_Id] = SR.[Identify_Id03]), '') AS [Identify_Name03]
     , ISNULL((SELECT [Identify_Name] FROM [Identify_List4] AS IL4 WHERE IL4.[Receive_Type] = SR.[Receive_Type] AND IL4.[Year_Id] = SR.[Year_Id] AND IL4.[Term_Id] = SR.[Term_Id] AND IL4.[Dep_Id]  = SR.[Dep_Id] AND IL4.[Identify_Id] = SR.[Identify_Id04]), '') AS [Identify_Name04]
     , ISNULL((SELECT [Identify_Name] FROM [Identify_List5] AS IL5 WHERE IL5.[Receive_Type] = SR.[Receive_Type] AND IL5.[Year_Id] = SR.[Year_Id] AND IL5.[Term_Id] = SR.[Term_Id] AND IL5.[Dep_Id]  = SR.[Dep_Id] AND IL5.[Identify_Id] = SR.[Identify_Id05]), '') AS [Identify_Name05]
     , ISNULL((SELECT [Identify_Name] FROM [Identify_List6] AS IL6 WHERE IL6.[Receive_Type] = SR.[Receive_Type] AND IL6.[Year_Id] = SR.[Year_Id] AND IL6.[Term_Id] = SR.[Term_Id] AND IL6.[Dep_Id]  = SR.[Dep_Id] AND IL6.[Identify_Id] = SR.[Identify_Id06]), '') AS [Identify_Name06]
     , ISNULL((SELECT [Channel_Name] FROM [{ChannelSetEntity.TABLE_NAME}] AS CS WHERE CS.[Channel_Id] = SR.[Receive_Way]), '') AS [Receive_Way_Name]
  FROM [{StudentReceiveEntity.TABLE_NAME}] AS SR
  LEFT JOIN [{SchoolRidEntity.TABLE_NAME}] AS RI ON RI.[Receive_Type] = SR.[Receive_Type] AND RI.[Year_Id] = SR.[Year_Id] AND RI.[Term_Id] = SR.[Term_Id] AND RI.[Dep_Id] = SR.[Dep_Id] AND RI.[Receive_Id] = SR.[Receive_Id]
 WHERE SR.[Stu_Id] = @STUDENT_ID AND SR.[Receive_Type] IN ({receiveTypeSql})
   AND RI.[Bill_Valid_Date] <= @OPEN_DATE8
 ORDER BY SR.[Year_Id] DESC, SR.[Term_Id] DESC, SR.[Receive_Id], SR.[create_date] DESC, SR.[Old_Seq] DESC".Trim();
                }
                #endregion

                StudentReceiveView[] datas = null;
                Result result = _Factory.SelectSql<StudentReceiveView>(sql, parameters, 0, 0, out datas);

                if (result.IsSuccess)
                {
                    rtnData = datas;
                }

                #region 儲存日誌資料並釋放資料庫日誌記錄器
                if (dbLogger != null)
                {
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        int count = datas == null ? 0 : datas.Length;
                        notation = $"[{commandAsker.FuncName}] {LogTypeCodeTexts.SELECT_TEXT} {studentId} 繳費單清單成功 (共{count}筆)";
                    }
                    else
                    {
                        notation = $"[{commandAsker.FuncName}] {LogTypeCodeTexts.SELECT_TEXT} {studentId} 繳費單清單失敗 (錯誤訊息：{result.Message})";
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);

                    string logErrmsg = this.ReleaseDBLogger(true);
                    dbLogger.Dispose();
                    dbLogger = null;
                }
                #endregion

                return result;
            }
            #endregion
        }

        /// <summary>
        /// 取得指定商家代號、學年、學期、費用別、學號、序號的繳費單
        /// </summary>
        /// <param name="commandAsker"></param>
        /// <param name="arguments"></param>
        /// <param name="rtnData"></param>
        /// <returns></returns>
        public Result GetStudentReceiveView(CommandAsker commandAsker, ICollection<KeyValue<string>> arguments, out object rtnData)
        {
            rtnData = null;

            if (arguments == null || arguments.Count == 0)
            {
                return new Result(false, "缺少呼叫方法的參數", CoreStatusCode.INVALID_PARAMETER, null);
            }

            #region 取得執行參數
            string receiveType = null, yearId = null, termId = null, receiveId = null, stuId = null;
            int? oldSeq = null;
            bool? isEngUI = null;
            string depId = String.Empty;  //土銀不用 depId 部門，所以固定空白

            foreach (KeyValue<string> argument in arguments)
            {
                string argName = argument.Key.ToUpper();
                switch (argName)
                {
                    case "RECEIVE_TYPE":
                        #region 學號
                        if (!String.IsNullOrWhiteSpace(argument.Value))
                        {
                            receiveType = argument.Value.Trim();
                        }
                        #endregion
                        break;
                    case "YEAR_ID":
                        #region 學號
                        if (!String.IsNullOrWhiteSpace(argument.Value))
                        {
                            yearId = argument.Value.Trim();
                        }
                        #endregion
                        break;
                    case "TERM_ID":
                        #region 學號
                        if (!String.IsNullOrWhiteSpace(argument.Value))
                        {
                            termId = argument.Value.Trim();
                        }
                        #endregion
                        break;
                    case "RECEIVE_ID":
                        #region 學號
                        if (!String.IsNullOrWhiteSpace(argument.Value))
                        {
                            receiveId = argument.Value.Trim();
                        }
                        #endregion
                        break;
                    case "STU_ID":
                        #region 學號
                        if (!String.IsNullOrWhiteSpace(argument.Value))
                        {
                            stuId = argument.Value.Trim();
                        }
                        #endregion
                        break;
                    case "OLD_SEQ":
                        #region 商家代號清單
                        Int32 value = 0;
                        if (Common.IsInt32(argument.Value, out value) && value >= 0)
                        {
                            oldSeq = value;
                        }
                        #endregion
                        break;
                    case "IS_ENG_UI":
                        #region 是否英文介面
                        if ("Y".Equals(argument.Value))
                        {
                            isEngUI = true;
                        }
                        else if ("N".Equals(argument.Value))
                        {
                            isEngUI = false;
                        }
                        #endregion
                        break;
                }
            }

            //必要參數
            if (String.IsNullOrEmpty(receiveType)
                || String.IsNullOrEmpty(yearId)
                || String.IsNullOrEmpty(termId)
                || String.IsNullOrEmpty(receiveId)
                || String.IsNullOrEmpty(stuId)
                || !oldSeq.HasValue || oldSeq.Value < 0
                || !isEngUI.HasValue)
            {
                return new Result(false, "缺少或無效的方法參數", CoreStatusCode.INVALID_PARAMETER, null);
            }
            #endregion

            #region [TMP] 取得初始化的資料庫日誌記錄器
            DBLogger dbLogger = this.InitialDBLogger(commandAsker);
            #endregion

            #region 取資料
            {
                StudentReceiveView data = null;
                Result result = this.GetStudentReceiveView(receiveType, yearId, termId, depId, receiveId, stuId, oldSeq.Value, isEngUI.Value, out data);

                #region 儲存日誌資料並釋放資料庫日誌記錄器
                if (dbLogger != null)
                {
                    string key = $"{receiveType}, {yearId}, {termId}, {depId}, {receiveId}, {stuId}, {oldSeq}";
                    string notation = null;
                    if (result.IsSuccess)
                    {
                        rtnData = data;

                        int count = data == null ? 0 : 1;
                        notation = $"[{commandAsker.FuncName}] {LogTypeCodeTexts.SELECT_TEXT} {key} 繳費單資料成功 (共{count}筆)";
                    }
                    else
                    {
                        notation = $"[{commandAsker.FuncName}] {LogTypeCodeTexts.SELECT_TEXT} {key} 繳費單資料失敗 (錯誤訊息：{result.Message})";
                    }
                    dbLogger.AppendLog(commandAsker.UserQual, commandAsker.UnitId, commandAsker.FuncId, LogTypeCodeTexts.DELETE, commandAsker.UserId, notation);

                    string logErrmsg = this.ReleaseDBLogger(true);
                    dbLogger.Dispose();
                    dbLogger = null;
                }
                #endregion
                return result;
            }
            #endregion
        }
        #endregion

        #region [MDY:202203XX] 2022擴充案 取得繳費單資料 Private Method
        private Result GetStudentReceiveView(string receiveType, string yearId, string termId, string depId, string receiveId, string stuId
            , int oldSeq, bool isEngUI, out StudentReceiveView data)
        {
            data = null;

            #region 組 SQL
            KeyValueList parameters = new KeyValueList(6);

            parameters.Add("@RECEIVE_TYPE", receiveType);
            parameters.Add("@YEAR_ID", yearId);
            parameters.Add("@TERM_ID", termId);
            parameters.Add("@DEP_ID", depId);
            parameters.Add("@RECEIVE_ID", receiveId);
            parameters.Add("@STU_ID", stuId);
            parameters.Add("@OLD_SEQ", oldSeq);

            //不取未到「開放列印日」的資料
            string sql = null;
            if (isEngUI)
            {
                sql = $@"
SELECT SR.*
     , ISNULL(RI.[Bill_Valid_Date], '')    AS [Bill_Valid_Date]
     , ISNULL(RI.[Bill_Close_Date], '')    AS [Bill_Close_Date]
     , ISNULL(RI.[Invoice_Close_Date], '') AS [Invoice_Close_Date]
     , ISNULL(RI.[Pay_Date], '')           AS [Pay_Due_Date1]
     , ISNULL(RI.[Pay_Due_Date2], '')      AS [Pay_Due_Date2]
     , ISNULL(RI.[Pay_Due_Date3], '')      AS [Pay_Due_Date3]
     , ISNULL((SELECT [Stu_Name] FROM [{StudentMasterEntity.TABLE_NAME}] AS SM WHERE SM.[Receive_Type] = SR.[Receive_Type] AND SM.[Dep_Id] = SR.[Dep_Id] AND SM.[Stu_Id] = SR.[Stu_Id]), '') AS [Stu_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Year_EName],     [Year_Name])     ELSE [Year_Name]     END) FROM [Year_List]      AS YL  WHERE YL.[Year_Id]       = SR.[Year_Id]), '')                                                                                                                                                   AS [Year_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Term_EName],     [Term_Name])     ELSE [Term_Name]     END) FROM [Term_List]      AS TL  WHERE TL.[Receive_Type]  = SR.[Receive_Type] AND TL.[Year_Id]  = SR.[Year_Id] AND TL.[Term_Id]  = SR.[Term_Id]), '')                                                                            AS [Term_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Dept_EName],     [Dept_Name])     ELSE [Dept_Name]     END) FROM [Dept_List]      AS DTL WHERE DTL.[Receive_Type] = SR.[Receive_Type] AND DTL.[Year_Id] = SR.[Year_Id] AND DTL.[Term_Id] = SR.[Term_Id] AND DTL.[Dept_Id] = SR.[Dept_Id]), '')                                           AS [Dept_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Receive_EName],  [Receive_Name])  ELSE [Receive_Name]  END) FROM [Receive_List]   AS RL  WHERE RL.[Receive_Type]  = SR.[Receive_Type] AND RL.[Year_Id]  = SR.[Year_Id] AND RL.[Term_Id]  = SR.[Term_Id] AND RL.[Dep_Id]   = SR.[Dep_Id] AND RL.[Receive_Id]   = SR.[Receive_Id]), '')    AS [Receive_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([College_EName],  [College_Name])  ELSE [College_Name]  END) FROM [College_List]   AS CL  WHERE CL.[Receive_Type]  = SR.[Receive_Type] AND CL.[Year_Id]  = SR.[Year_Id] AND CL.[Term_Id]  = SR.[Term_Id] AND CL.[Dep_Id]   = SR.[Dep_Id] AND CL.[College_Id]   = SR.[College_Id]), '')    AS [College_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Major_EName],    [Major_Name])    ELSE [Major_Name]    END) FROM [Major_List]     AS ML  WHERE ML.[Receive_Type]  = SR.[Receive_Type] AND ML.[Year_Id]  = SR.[Year_Id] AND ML.[Term_Id]  = SR.[Term_Id] AND ML.[Dep_Id]   = SR.[Dep_Id] AND ML.[Major_Id]     = SR.[Major_Id]), '')      AS [Major_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Class_EName],    [Class_Name])    ELSE [Class_Name]    END) FROM [Class_List]     AS CL  WHERE CL.[Receive_Type]  = SR.[Receive_Type] AND CL.[Year_Id]  = SR.[Year_Id] AND CL.[Term_Id]  = SR.[Term_Id] AND CL.[Dep_Id]   = SR.[Dep_Id] AND CL.[Class_Id]     = SR.[Class_Id]), '')      AS [Class_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Reduce_EName],   [Reduce_Name])   ELSE [Reduce_Name]   END) FROM [Reduce_List]    AS RL  WHERE RL.[Receive_Type]  = SR.[Receive_Type] AND RL.[Year_Id]  = SR.[Year_Id] AND RL.[Term_Id]  = SR.[Term_Id] AND RL.[Dep_Id]   = SR.[Dep_Id] AND RL.[Reduce_Id]    = SR.[Reduce_Id]), '')     AS [Reduce_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Dorm_EName],     [Dorm_Name])     ELSE [Dorm_Name]     END) FROM [Dorm_List]      AS DL  WHERE DL.[Receive_Type]  = SR.[Receive_Type] AND DL.[Year_Id]  = SR.[Year_Id] AND DL.[Term_Id]  = SR.[Term_Id] AND DL.[Dep_Id]   = SR.[Dep_Id] AND DL.[Dorm_Id]      = SR.[Dorm_Id]), '')       AS [Dorm_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Loan_EName],     [Loan_Name])     ELSE [Loan_Name]     END) FROM [Loan_List]      AS LL  WHERE LL.[Receive_Type]  = SR.[Receive_Type] AND LL.[Year_Id]  = SR.[Year_Id] AND LL.[Term_Id]  = SR.[Term_Id] AND LL.[Dep_Id]   = SR.[Dep_Id] AND LL.[Loan_Id]      = SR.[Loan_Id]), '')       AS [Loan_Name]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Identify_EName], [Identify_Name]) ELSE [Identify_Name] END) FROM [Identify_List1] AS IL1 WHERE IL1.[Receive_Type] = SR.[Receive_Type] AND IL1.[Year_Id] = SR.[Year_Id] AND IL1.[Term_Id] = SR.[Term_Id] AND IL1.[Dep_Id]  = SR.[Dep_Id] AND IL1.[Identify_Id] = SR.[Identify_Id01]), '') AS [Identify_Name01]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Identify_EName], [Identify_Name]) ELSE [Identify_Name] END) FROM [Identify_List2] AS IL2 WHERE IL2.[Receive_Type] = SR.[Receive_Type] AND IL2.[Year_Id] = SR.[Year_Id] AND IL2.[Term_Id] = SR.[Term_Id] AND IL2.[Dep_Id]  = SR.[Dep_Id] AND IL2.[Identify_Id] = SR.[Identify_Id02]), '') AS [Identify_Name02]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Identify_EName], [Identify_Name]) ELSE [Identify_Name] END) FROM [Identify_List3] AS IL3 WHERE IL3.[Receive_Type] = SR.[Receive_Type] AND IL3.[Year_Id] = SR.[Year_Id] AND IL3.[Term_Id] = SR.[Term_Id] AND IL3.[Dep_Id]  = SR.[Dep_Id] AND IL3.[Identify_Id] = SR.[Identify_Id03]), '') AS [Identify_Name03]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Identify_EName], [Identify_Name]) ELSE [Identify_Name] END) FROM [Identify_List4] AS IL4 WHERE IL4.[Receive_Type] = SR.[Receive_Type] AND IL4.[Year_Id] = SR.[Year_Id] AND IL4.[Term_Id] = SR.[Term_Id] AND IL4.[Dep_Id]  = SR.[Dep_Id] AND IL4.[Identify_Id] = SR.[Identify_Id04]), '') AS [Identify_Name04]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Identify_EName], [Identify_Name]) ELSE [Identify_Name] END) FROM [Identify_List5] AS IL5 WHERE IL5.[Receive_Type] = SR.[Receive_Type] AND IL5.[Year_Id] = SR.[Year_Id] AND IL5.[Term_Id] = SR.[Term_Id] AND IL5.[Dep_Id]  = SR.[Dep_Id] AND IL5.[Identify_Id] = SR.[Identify_Id05]), '') AS [Identify_Name05]
     , ISNULL((SELECT (CASE WHEN SC.Eng_Enabled = 'Y' THEN ISNULL([Identify_EName], [Identify_Name]) ELSE [Identify_Name] END) FROM [Identify_List6] AS IL6 WHERE IL6.[Receive_Type] = SR.[Receive_Type] AND IL6.[Year_Id] = SR.[Year_Id] AND IL6.[Term_Id] = SR.[Term_Id] AND IL6.[Dep_Id]  = SR.[Dep_Id] AND IL6.[Identify_Id] = SR.[Identify_Id06]), '') AS [Identify_Name06]
     , ISNULL((SELECT [Channel_Name] FROM [{ChannelSetEntity.TABLE_NAME}] AS CS WHERE CS.[Channel_Id] = SR.[Receive_Way]), '') AS [Receive_Way_Name]
  FROM [{StudentReceiveEntity.TABLE_NAME}] AS SR
  LEFT JOIN [{SchoolRidEntity.TABLE_NAME}] AS RI ON RI.[Receive_Type] = SR.[Receive_Type] AND RI.[Year_Id] = SR.[Year_Id] AND RI.[Term_Id] = SR.[Term_Id] AND RI.[Dep_Id] = SR.[Dep_Id] AND RI.[Receive_Id] = SR.[Receive_Id]
  LEFT JOIN [{SchoolRTypeEntity.TABLE_NAME}] AS SC ON SC.[Receive_Type] = SR.[Receive_Type]
 WHERE SR.[Receive_Type] = @RECEIVE_TYPE AND SR.[Year_Id] = @YEAR_ID AND SR.[Term_Id] = @TERM_ID AND SR.[Dep_Id] = @DEP_ID AND SR.[Receive_Id] = @RECEIVE_ID AND SR.[Stu_Id] = @STU_ID AND SR.[Old_Seq] = @OLD_SEQ
 ORDER BY SR.[Year_Id] DESC, SR.[Term_Id] DESC, SR.[Receive_Id], SR.[create_date] DESC, SR.[Old_Seq] DESC".Trim();
            }
            else
            {
                sql = $@"
SELECT SR.*
     , ISNULL(RI.[Bill_Valid_Date], '')    AS [Bill_Valid_Date]
     , ISNULL(RI.[Bill_Close_Date], '')    AS [Bill_Close_Date]
     , ISNULL(RI.[Invoice_Close_Date], '') AS [Invoice_Close_Date]
     , ISNULL(RI.[Pay_Date], '')           AS [Pay_Due_Date1]
     , ISNULL(RI.[Pay_Due_Date2], '')      AS [Pay_Due_Date2]
     , ISNULL(RI.[Pay_Due_Date3], '')      AS [Pay_Due_Date3]
     , ISNULL((SELECT [Stu_Name] FROM [{StudentMasterEntity.TABLE_NAME}] AS SM WHERE SM.[Receive_Type] = SR.[Receive_Type] AND SM.[Dep_Id] = SR.[Dep_Id] AND SM.[Stu_Id] = SR.[Stu_Id]), '') AS [Stu_Name]
     , ISNULL((SELECT [Year_Name]     FROM [Year_List]      AS YL  WHERE YL.[Year_Id]       = SR.[Year_Id]), '')                                                                                                                                                   AS [Year_Name]
     , ISNULL((SELECT [Term_Name]     FROM [Term_List]      AS TL  WHERE TL.[Receive_Type]  = SR.[Receive_Type] AND TL.[Year_Id]  = SR.[Year_Id] AND TL.[Term_Id]  = SR.[Term_Id]), '')                                                                            AS [Term_Name]
     , ISNULL((SELECT [Dept_Name]     FROM [Dept_List]      AS DTL WHERE DTL.[Receive_Type] = SR.[Receive_Type] AND DTL.[Year_Id] = SR.[Year_Id] AND DTL.[Term_Id] = SR.[Term_Id] AND DTL.[Dept_Id] = SR.[Dept_Id]), '')                                           AS [Dept_Name]
     , ISNULL((SELECT [Receive_Name]  FROM [Receive_List]   AS RL  WHERE RL.[Receive_Type]  = SR.[Receive_Type] AND RL.[Year_Id]  = SR.[Year_Id] AND RL.[Term_Id]  = SR.[Term_Id] AND RL.[Dep_Id]   = SR.[Dep_Id] AND RL.[Receive_Id]   = SR.[Receive_Id]), '')    AS [Receive_Name]
     , ISNULL((SELECT [College_Name]  FROM [College_List]   AS CL  WHERE CL.[Receive_Type]  = SR.[Receive_Type] AND CL.[Year_Id]  = SR.[Year_Id] AND CL.[Term_Id]  = SR.[Term_Id] AND CL.[Dep_Id]   = SR.[Dep_Id] AND CL.[College_Id]   = SR.[College_Id]), '')    AS [College_Name]
     , ISNULL((SELECT [Major_Name]    FROM [Major_List]     AS ML  WHERE ML.[Receive_Type]  = SR.[Receive_Type] AND ML.[Year_Id]  = SR.[Year_Id] AND ML.[Term_Id]  = SR.[Term_Id] AND ML.[Dep_Id]   = SR.[Dep_Id] AND ML.[Major_Id]     = SR.[Major_Id]), '')      AS [Major_Name]
     , ISNULL((SELECT [Class_Name]    FROM [Class_List]     AS CL  WHERE CL.[Receive_Type]  = SR.[Receive_Type] AND CL.[Year_Id]  = SR.[Year_Id] AND CL.[Term_Id]  = SR.[Term_Id] AND CL.[Dep_Id]   = SR.[Dep_Id] AND CL.[Class_Id]     = SR.[Class_Id]), '')      AS [Class_Name]
     , ISNULL((SELECT [Reduce_Name]   FROM [Reduce_List]    AS RL  WHERE RL.[Receive_Type]  = SR.[Receive_Type] AND RL.[Year_Id]  = SR.[Year_Id] AND RL.[Term_Id]  = SR.[Term_Id] AND RL.[Dep_Id]   = SR.[Dep_Id] AND RL.[Reduce_Id]    = SR.[Reduce_Id]), '')     AS [Reduce_Name]
     , ISNULL((SELECT [Dorm_Name]     FROM [Dorm_List]      AS DL  WHERE DL.[Receive_Type]  = SR.[Receive_Type] AND DL.[Year_Id]  = SR.[Year_Id] AND DL.[Term_Id]  = SR.[Term_Id] AND DL.[Dep_Id]   = SR.[Dep_Id] AND DL.[Dorm_Id]      = SR.[Dorm_Id]), '')       AS [Dorm_Name]
     , ISNULL((SELECT [Loan_Name]     FROM [Loan_List]      AS LL  WHERE LL.[Receive_Type]  = SR.[Receive_Type] AND LL.[Year_Id]  = SR.[Year_Id] AND LL.[Term_Id]  = SR.[Term_Id] AND LL.[Dep_Id]   = SR.[Dep_Id] AND LL.[Loan_Id]      = SR.[Loan_Id]), '')       AS [Loan_Name]
     , ISNULL((SELECT [Identify_Name] FROM [Identify_List1] AS IL1 WHERE IL1.[Receive_Type] = SR.[Receive_Type] AND IL1.[Year_Id] = SR.[Year_Id] AND IL1.[Term_Id] = SR.[Term_Id] AND IL1.[Dep_Id]  = SR.[Dep_Id] AND IL1.[Identify_Id] = SR.[Identify_Id01]), '') AS [Identify_Name01]
     , ISNULL((SELECT [Identify_Name] FROM [Identify_List2] AS IL2 WHERE IL2.[Receive_Type] = SR.[Receive_Type] AND IL2.[Year_Id] = SR.[Year_Id] AND IL2.[Term_Id] = SR.[Term_Id] AND IL2.[Dep_Id]  = SR.[Dep_Id] AND IL2.[Identify_Id] = SR.[Identify_Id02]), '') AS [Identify_Name02]
     , ISNULL((SELECT [Identify_Name] FROM [Identify_List3] AS IL3 WHERE IL3.[Receive_Type] = SR.[Receive_Type] AND IL3.[Year_Id] = SR.[Year_Id] AND IL3.[Term_Id] = SR.[Term_Id] AND IL3.[Dep_Id]  = SR.[Dep_Id] AND IL3.[Identify_Id] = SR.[Identify_Id03]), '') AS [Identify_Name03]
     , ISNULL((SELECT [Identify_Name] FROM [Identify_List4] AS IL4 WHERE IL4.[Receive_Type] = SR.[Receive_Type] AND IL4.[Year_Id] = SR.[Year_Id] AND IL4.[Term_Id] = SR.[Term_Id] AND IL4.[Dep_Id]  = SR.[Dep_Id] AND IL4.[Identify_Id] = SR.[Identify_Id04]), '') AS [Identify_Name04]
     , ISNULL((SELECT [Identify_Name] FROM [Identify_List5] AS IL5 WHERE IL5.[Receive_Type] = SR.[Receive_Type] AND IL5.[Year_Id] = SR.[Year_Id] AND IL5.[Term_Id] = SR.[Term_Id] AND IL5.[Dep_Id]  = SR.[Dep_Id] AND IL5.[Identify_Id] = SR.[Identify_Id05]), '') AS [Identify_Name05]
     , ISNULL((SELECT [Identify_Name] FROM [Identify_List6] AS IL6 WHERE IL6.[Receive_Type] = SR.[Receive_Type] AND IL6.[Year_Id] = SR.[Year_Id] AND IL6.[Term_Id] = SR.[Term_Id] AND IL6.[Dep_Id]  = SR.[Dep_Id] AND IL6.[Identify_Id] = SR.[Identify_Id06]), '') AS [Identify_Name06]
     , ISNULL((SELECT [Channel_Name] FROM [{ChannelSetEntity.TABLE_NAME}] AS CS WHERE CS.[Channel_Id] = SR.[Receive_Way]), '') AS [Receive_Way_Name]
  FROM [{StudentReceiveEntity.TABLE_NAME}] AS SR
  LEFT JOIN [{SchoolRidEntity.TABLE_NAME}] AS RI ON RI.[Receive_Type] = SR.[Receive_Type] AND RI.[Year_Id] = SR.[Year_Id] AND RI.[Term_Id] = SR.[Term_Id] AND RI.[Dep_Id] = SR.[Dep_Id] AND RI.[Receive_Id] = SR.[Receive_Id]
 WHERE SR.[Receive_Type] = @RECEIVE_TYPE AND SR.[Year_Id] = @YEAR_ID AND SR.[Term_Id] = @TERM_ID AND SR.[Dep_Id] = @DEP_ID AND SR.[Receive_Id] = @RECEIVE_ID AND SR.[Stu_Id] = @STU_ID AND SR.[Old_Seq] = @OLD_SEQ
 ORDER BY SR.[Year_Id] DESC, SR.[Term_Id] DESC, SR.[Receive_Id], SR.[create_date] DESC, SR.[Old_Seq] DESC".Trim();
            }
            #endregion

            StudentReceiveView[] datas = null;
            Result result = _Factory.SelectSql<StudentReceiveView>(sql, parameters, 0, 1, out datas);

            if (result.IsSuccess && datas != null && datas.Length > 0)
            {
                data = datas[0];
            }

            return result;
        }
        #endregion
    }

    #region [MDY:20210301] 除錯日誌紀錄器
    class DebugLogger : IDisposable
    {
        #region Member
        /// <summary>
        /// 日誌內容暫存
        /// </summary>
        private System.Text.StringBuilder _Buffer = null;

        /// <summary>
        /// 日誌內容暫存 Size
        /// </summary>
        private int _BufferSize = 50 * 1024;  //50K Byte
        #endregion

        #region Property
        /// <summary>
        /// 使用者資訊
        /// </summary>
        public string UserInfo
        {
            get;
            private set;
        }

        /// <summary>
        /// 目前任務代碼
        /// </summary>
        public string TaskId
        {
            get;
            private set;
        }

        /// <summary>
        /// 目前日誌內容區塊編號
        /// </summary>
        public int BlockNo
        {
            get;
            private set;
        }

        /// <summary>
        /// 日誌檔資訊
        /// </summary>
        public System.IO.FileInfo FileInfo
        {
            get;
            private set;
        }

        /// <summary>
        /// 是否可寫入日誌
        /// </summary>
        public bool CanWrite
        {
            get;
            private set;
        }
        #endregion

        #region Constructor
        /// <summary>
        /// 建構 虛假的 除錯日誌紀錄器 物件
        /// </summary>
        public DebugLogger()
        {
            this.Initial(null);
        }

        /// <summary>
        /// 建構 除錯日誌紀錄器 物件
        /// </summary>
        /// <param name="userInfo">指定使用者資訊</param>
        public DebugLogger(string userInfo)
        {
            this.Initial(userInfo);
        }
        #endregion

        #region Destructor
        /// <summary>
        /// 解構 除錯日誌紀錄器 物件
        /// </summary>
        ~DebugLogger()
        {
            Dispose(false);
        }
        #endregion

        #region Implement IDisposable
        /// <summary>
        /// Track whether Dispose has been called.
        /// </summary>
        private bool _Disposed = false;

        /// <summary>
        /// 執行與釋放 (Free)、釋放 (Release) 或重設 Unmanaged 資源相關聯之應用程式定義的工作
        /// </summary>
        public void Dispose()
        {
            Dispose(true);
            GC.SuppressFinalize(this);
        }

        /// <summary>
        /// 釋放資源
        /// </summary>
        /// <param name="disposing">指定是否釋放資源。</param>
        private void Dispose(bool disposing)
        {
            if (!_Disposed)
            {
                if (disposing)
                {
                    if (_Buffer != null && _Buffer.Length > 0)
                    {
                        this.WriteToFile();
                        _Buffer.Clear();
                        _Buffer = null;
                    }
                }
                _Disposed = true;
            }
        }
        #endregion

        #region Private Method
        /// <summary>
        /// 初始化
        /// </summary>
        /// <param name="userInfo">指定使用者資訊</param>
        private void Initial(string userInfo)
        {
            if (String.IsNullOrWhiteSpace(userInfo))
            {
                this.UserInfo = null;
                this.TaskId = null;
                this.BlockNo = 0;
                this.FileInfo = null;
                this.CanWrite = false;
            }
            else
            {
                DateTime now = DateTime.Now;
                System.IO.FileInfo fileInfo = null;
                try
                {
                    string fileName = String.Format("WebAPDebug_{0:yyyyMMdd}.log", now);
                    string filePath = System.Configuration.ConfigurationManager.AppSettings.Get("LOG_PATH");
                    if (!String.IsNullOrWhiteSpace(filePath))
                    {
                        System.IO.DirectoryInfo pathInfo = new System.IO.DirectoryInfo(filePath);
                        if (pathInfo.FullName.Equals(filePath, StringComparison.CurrentCultureIgnoreCase))
                        {
                            if (!pathInfo.Exists)
                            {
                                pathInfo.Create();
                            }
                            fileInfo = new System.IO.FileInfo(System.IO.Path.Combine(pathInfo.FullName, fileName));
                            _Buffer = new System.Text.StringBuilder(_BufferSize + 1024);
                        }
                    }
                }
                catch (Exception)
                {
                    fileInfo = null;
                }
                finally
                {
                    this.UserInfo = userInfo.Trim();
                    this.TaskId = this.GenTaskId(now);
                    this.BlockNo = 0;
                    this.FileInfo = fileInfo;
                    this.CanWrite = (fileInfo != null && _Buffer != null);
                }
            }
        }

        /// <summary>
        /// 產生任務代碼
        /// </summary>
        /// <param name="now"></param>
        /// <returns></returns>
        private string GenTaskId(DateTime now)
        {
            return String.Format("{0:X4}-{1:000}-{2:0000}-{3:X4}", now.Year, now.DayOfYear, (now.Hour * 100 + now.Minute), (now.Second * 1000 + now.Millisecond));
        }

        /// <summary>
        /// 寫入除錯日誌檔
        /// </summary>
        private void WriteToFile()
        {
            if (this.CanWrite && _Buffer.Length > 0)
            {
                try
                {
                    using (System.IO.StreamWriter sw = new System.IO.StreamWriter(this.FileInfo.FullName, true, System.Text.Encoding.Default))
                    {
                        this.BlockNo++;
                        sw.WriteLine("[UserInfo = {0}; TaskId = {1}; 日誌內容 {2} 開始 ========\\", this.UserInfo, this.TaskId, this.BlockNo);
                        sw.Write(_Buffer);
                        sw.WriteLine("[UserInfo = {0}; TaskId = {1}; 日誌內容 {2} 結束 ========//", this.UserInfo, this.TaskId, this.BlockNo);
                        sw.WriteLine();
                    }
                    _Buffer.Clear();
                }
                catch
                {

                }
            }
        }
        #endregion

        #region Public Method
        public DebugLogger Flush()
        {
            this.WriteToFile();
            return this;
        }

        public DebugLogger Append(string msg, bool autoFlush = true)
        {
            if (this.CanWrite && !String.IsNullOrWhiteSpace(msg))
            {
                try
                {
                    _Buffer.Append(msg);
                    if (autoFlush && _Buffer.Length > _BufferSize)
                    {
                        this.WriteToFile();
                    }
                }
                catch (Exception)
                {
                }
            }
            return this;
        }

        public DebugLogger AppendLine(string msg, bool autoFlush = true)
        {
            if (this.CanWrite && !String.IsNullOrWhiteSpace(msg))
            {
                try
                {
                    _Buffer.AppendLine(msg);
                    if (autoFlush && _Buffer.Length > _BufferSize)
                    {
                        this.WriteToFile();
                    }
                }
                catch (Exception)
                {
                }
            }
            return this;
        }

        public DebugLogger AppendLine(bool autoFlush = true)
        {
            if (this.CanWrite)
            {
                try
                {
                    _Buffer.AppendLine();
                    if (autoFlush && _Buffer.Length > _BufferSize)
                    {
                        this.WriteToFile();
                    }
                }
                catch (Exception)
                {
                }
            }
            return this;
        }

        public DebugLogger AppendFormat(string format, params object[] args)
        {
            if (this.CanWrite && !String.IsNullOrWhiteSpace(format) && args != null)
            {
                try
                {
                    _Buffer.AppendFormat(format, args);
                }
                catch (Exception)
                {
                }
            }
            return this;
        }

        /// <summary>
        /// 重新（初始化）產生任務代碼、日誌檔檔名（如果暫存有資料會先寫入日誌檔）
        /// </summary>
        public void ReNew()
        {
            this.WriteToFile();
            if (!String.IsNullOrWhiteSpace(this.UserInfo))
            {
                DateTime now = DateTime.Now;
                System.IO.FileInfo fileInfo = null;
                try
                {
                    string fileName = String.Format("WebDebug_{0:yyyyMMdd}.log", now);
                    string filePath = System.Configuration.ConfigurationManager.AppSettings.Get("LOG_PATH");
                    if (!String.IsNullOrWhiteSpace(filePath))
                    {
                        System.IO.DirectoryInfo pathInfo = new System.IO.DirectoryInfo(filePath);
                        if (pathInfo.FullName.Equals(filePath, StringComparison.CurrentCultureIgnoreCase))
                        {
                            if (!pathInfo.Exists)
                            {
                                pathInfo.Create();
                            }
                            fileInfo = new System.IO.FileInfo(System.IO.Path.Combine(pathInfo.FullName, fileName));
                        }
                    }
                }
                catch (Exception)
                {
                    fileInfo = null;
                }
                finally
                {
                    this.TaskId = this.GenTaskId(now);
                    this.BlockNo = 0;
                    this.FileInfo = fileInfo;
                    this.CanWrite = (fileInfo != null && _Buffer != null);
                }
            }
        }
        #endregion

        #region Static Method
        /// <summary>
        /// 建立 除錯日誌紀錄器 物件
        /// </summary>
        /// <param name="user"></param>
        /// <param name="sessionId"></param>
        /// <returns></returns>
        public static DebugLogger Create(CommandAsker asker, string clientTaskId)
        {
            string userInfo = asker == null ? null : String.Format("{0} | {1} | {2} | {3}", asker.UserQual, asker.UnitId, asker.UserId, clientTaskId);
            return new DebugLogger(userInfo);
        }
        #endregion
    }
    #endregion
}
